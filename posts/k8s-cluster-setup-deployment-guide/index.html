<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>k8s集群搭建与部署详解 | Bestzy's Blog</title><link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/><meta name=author content="bestzy"><meta name=description content="本文详细描述了部署K8s集群的步骤
"><meta name=keywords content="K8s"><meta name=generator content="Hugo 0.148.2"><meta property="og:url" content="https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="k8s集群搭建与部署详解"><meta property="og:description" content="本文详细描述了部署K8s集群的步骤"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-12T21:18:28+08:00"><meta property="article:modified_time" content="2025-05-12T21:18:28+08:00"><meta property="article:tag" content="K8s"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="k8s集群搭建与部署详解"><meta name=twitter:description content="本文详细描述了部署K8s集群的步骤"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">🚀先行其事，后臻其善，再求其优！</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=搜索><ion-icon name=search></ion-icon>搜索</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=搜索><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="k8s集群搭建与部署详解"><meta itemprop=description content="本文详细描述了部署K8s集群的步骤"><meta itemprop=datePublished content="2025-05-12T21:18:28+08:00"><meta itemprop=dateModified content="2025-05-12T21:18:28+08:00"><meta itemprop=wordCount content="4211"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="K8s"><header><h1 itemprop=headline>k8s集群搭建与部署详解</h1><p class=text-sm><span data-format=luxon>2025-05-12T21:18:28+08:00</span>
| <span>9分钟阅读</span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0! src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=k8s%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba%e4%b8%8e%e9%83%a8%e7%bd%b2%e8%af%a6%e8%a7%a3&amp;url=https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://i0.hdslb.com/bfs/openplatform/0ce8c5f06ceb47f7f2a7547eacf89832b3366a34.jpg alt=k8s集群搭建与部署详解><p>本文详细描述了部署K8s集群的步骤</p><h2 id=前期准备>前期准备</h2><p>本文使用K8s的1.28版本。注意，在早期，Docker 是 Kubernetes 主要支持的运行时，Kubernetes 使用了一个叫做 dockershim 的内置组件来连接到 Docker Engine 的 API。但从 Kubernetes 1.24 版本开始，dockershim 被移除了。 这意味着 Kubelet 不再内置与 Docker API 直接通信的能力。本文不使用docker容器运行时，而使用contained。</p><h3 id=服务器配置>服务器配置</h3><table><thead><tr><th>主机名称</th><th>IP</th><th>OS</th><th>CPU</th><th>内存</th><th>磁盘</th></tr></thead><tbody><tr><td>bestzy-master</td><td>192.168.154.100</td><td>Ubuntu-22.04-live-server</td><td>2核</td><td>2G</td><td>30GB</td></tr><tr><td>bestzy-node1</td><td>192.168.154.101</td><td>Ubuntu-22.04-live-server</td><td>2核</td><td>2G</td><td>30GB</td></tr><tr><td>bestzy-node2</td><td>192.168.154.102</td><td>Ubuntu-22.04-live-server</td><td>2核</td><td>2G</td><td>30GB</td></tr></tbody></table><h3 id=更换apt镜像源>更换apt镜像源</h3><p>如果镜像源是国外的，建议更换为国内的阿里云。</p><p>apt镜像源文件一般是<code>/etc/apt/sources.list</code>，建议修改之前先备份该文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>cp /etc/apt/sources.list /etc/apt/sources.list.bak
</span></span></code></pre></div><p>然后将用以下内容替换掉<code>/etc/apt/sources.list</code>中的内容。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
</span></span></code></pre></div><h3 id=固定ip>固定IP</h3><p>Netplan 这是 Ubuntu 18.04 LTS 及以后版本使用的默认网络管理工具。它使用 YAML 文件进行配置。</p><p>进入<code>/etc/netplan</code>，找到目录下的<code>*.yaml</code>文件，建议先将文件备份。</p><p><img src=https://i0.hdslb.com/bfs/openplatform/1b4629a8b66d83eaa3febb6cefec0f1df1813152.png alt></p><p>修改<code>addresses</code>，如下图所示。</p><p><img src=https://i0.hdslb.com/bfs/openplatform/ed2d4043669c56b73d73da3b8fd1973494a5e308.png alt></p><p>修改了<code>/etc/netplan/*.yaml</code>文件后，先执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo netplan try
</span></span></code></pre></div><blockquote><p>这个命令会测试你的 YAML 配置文件的语法是否正确，并尝试应用配置。如果新的配置导致网络中断，它会在指定的时间后自动回滚到之前的配置。这是一个非常有用的安全措施，以防你不小心把自己锁在服务器外面。如果测试成功，它会提示你 &ldquo;Configuration accepted.&rdquo; 并让你按 Enter 确认。</p></blockquote><p>然后再执行即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo netplan apply
</span></span></code></pre></div><blockquote><p>这个命令会检查你的 YAML 配置文件的语法，将其翻译成后端（systemd-networkd 或 NetworkManager）可以理解的配置，然后指示后端去应用这些配置。</p></blockquote><p>不过，注释<strong>警告</strong>说，如果你直接修改这个文件，你的修改可能在系统重启后失效，因为 cloud-init 可能会重新生成或覆盖它。</p><p>如果你希望这个静态 IP 配置在重启后依然生效，并且你确定不需要 cloud-init 来管理网络（或者你想通过 cloud-init 的方式去指定这个静态 IP，但这超出了基础的网络文件配置范畴），你需要按照注释中的建议，创建一个文件（例如 /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg）并写入 network: {config: disabled} 来禁用 cloud-init 的网络配置功能。</p><h3 id=禁用swap分区>禁用swap分区</h3><p>在/etc/fstab文件中注视掉交换内存</p><p><img src=https://i0.hdslb.com/bfs/openplatform/f1b8e01e0a522a68ee406e4f2368d43736ffb86a.png alt></p><h3 id=将桥接的ipv4流量传递到iptables的链>将桥接的IPv4流量传递到iptables的链</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 确保 br_netfilter 模块已加载</span>
</span></span><span style=display:flex><span>sudo modprobe br_netfilter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 创建或编辑 sysctl 配置文件</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;net.bridge.bridge-nf-call-iptables = 1&#34;</span> | sudo tee /etc/sysctl.d/k8s.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;net.bridge.bridge-nf-call-ip6tables = 1&#34;</span> | sudo tee -a /etc/sysctl.d/k8s.conf <span style=color:#75715e># -a 参数表示追加而非覆盖</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 应用 sysctl 配置</span>
</span></span><span style=display:flex><span>sudo sysctl --system
</span></span></code></pre></div><ul><li><strong>br_netfilter 模块</strong>： 这个内核模块是实现网络桥接流量与 netfilter(iptables) 框架集成的关键。加载这个模块后，Linux 内核就具备了让桥接流量通过 iptables 的能力。</li><li><strong>net.bridge.bridge-nf-call-iptables = 1</strong>： 这个内核参数（通过 sysctl 设置）是告诉内核，当 br_netfilter 模块加载时，对于桥接流量，是否要将它们传递给 iptables 的链进行处理。设置为 1 表示“是，将桥接流量也发送给 iptables 处理”。</li></ul><p>当一个 Pod 尝试访问同一节点上的另一个 Pod 通过其 Service IP 时，流量可能会通过本地的网络桥接。Linux 内核的 iptables/netfilter 框架非常强大，可以检查和修改网络数据包。然而，默认情况下，流经<strong>网络桥接</strong>的流量可能 <strong>不会</strong>经过标准的 iptables 链。它们可能在网络桥接内部就被直接转发了。</p><p>如果 <code>bridge-nf-call-iptables</code> 没有启用 (=0)，那么这个流量在经过桥接时，很可能就不会被 kube-proxy 设置的那些将 Service IP 转发到 Pod IP 的 iptables 规则所捕获和处理。结果就是，访问 Service IP 的请求无法正确地转发到后端的 Pod，导致网络不通或服务访问失败。</p><p>启用 <code>bridge-nf-call-iptables=1</code> 确保了即使是流经网络桥接的数据包，也会被 iptables 规则检查到，这样 kube-proxy 设置的 Service 转发规则才能正确应用，保证集群内部 Service 的可达性。</p><h2 id=安装>安装</h2><h3 id=kube三件套>Kube三件套</h3><p>kubectl kubelet kubeadm 三件套需要安装公共签名密钥</p><table><thead><tr><th>特性</th><th>kubeadm</th><th>kubectl</th><th>kubelet</th></tr></thead><tbody><tr><td>主要角色</td><td>集群引导/安装工具</td><td>集群命令行客户端/管理工具</td><td>节点代理/执行者</td></tr><tr><td>做什么</td><td>搭建集群骨架，安装配置核心组件/节点</td><td>与 API Server 交互，管理应用和集群资源</td><td>运行在节点上，根据 API Server 指令管理容器</td></tr><tr><td>在哪里运行</td><td>在需要安装/加入集群的服务器上手动执行</td><td>在用户的本地机器或管理服务器上执行</td><td>集群的每个节点上 作为一个服务持续运行</td></tr><tr><td>谁使用</td><td>集群管理员/搭建者</td><td>所有与集群交互的用户（开发者、运维、管理员）</td><td>Kubernetes 系统本身（内部组件）</td></tr><tr><td>与谁交互</td><td>系统服务、容器运行时、生成配置/证书等</td><td>Kubernetes API Server</td><td>API Server 和 容器运行时</td></tr><tr><td>生命周期</td><td>执行命令时运行</td><td>执行命令时运行</td><td>节点运行期间持续运行为一个服务</td></tr><tr><td>目的</td><td>集群 Setup</td><td>集群 Operation/Management</td><td>节点 Pod/Container Execution</td></tr></tbody></table><ol><li>安装必要的包</li></ol><p>先更新包版本，安装一些必须的包——apt-transport-https、ca-certificates、curl、gpg，</p><ul><li><strong>apt-transport-https</strong>: 如果需要的话，安装这个包以支持 HTTPS 协议的软件源。<ul><li>一般较新的apt通常已经内置了 HTTPS 支持，<strong>所以这个包有时是虚拟的或不必要的</strong>。如果是的话，我们可以跳过这个包。</li></ul></li><li><strong>ca-certificates</strong>: 安装包含公共证书颁发机构证书的软件包。这让你的系统能够验证通过 SSL/TLS 连接（如 HTTPS）下载的数据的来源是否可信。</li><li><strong>curl</strong>: 安装一个强大的命令行工具，用于通过各种协议（包括 HTTPS）传输数据。这里用于下载 Kubernetes 软件源的 GPG 密钥。</li><li><strong>gpg</strong>: 安装 GNU Privacy Guard 工具，用于处理加密签名。这里用于处理下载的 GPG 密钥，以便 apt 能够验证软件包的真实性。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install -y apt-transport-https ca-certificates curl gpg
</span></span></code></pre></div><ol><li>添加GPG签名密钥</li></ol><p>从阿里云下载用于验证其软件包的公钥，并将其安全地存储到 APT 的密钥环目录中，以便 apt 在下载和安装 Kubernetes 软件包时可以验证其签名。</p><p>注意： 这里的 URL ( /v1.28/ ) 指定了是针对 v1.28 版本的密钥，这表明你后续安装的软件包将是 v1.28 或兼容版本。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span></code></pre></div><ol><li>添加镜像源</li></ol><p>将 Kubernetes 软件包源的配置信息（指向阿里云镜像站的 v1.28 版本源，并指定用于验证签名的 GPG 密钥文件）写入到 /etc/apt/sources.list.d/ 目录下的 kubernetes.list 文件中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/ /&#34;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span></code></pre></div><ol><li>安装三件套</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install -y kubelet kubeadm kubectl
</span></span></code></pre></div><p>安装完成后运行kubelet</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable kubelet
</span></span><span style=display:flex><span>sudo systemctl start kubelet
</span></span></code></pre></div><h3 id=安装containerd>安装Containerd</h3><p>安装<code>containerd</code>与安装<code>docker</code>流程基本一致，差别在于不需要安装docker-ce。</p><ol><li>安装必要的包</li></ol><p><code>lsb-release</code>显示关于 Linux Standard Base (LSB) 和 Linux 发行版的信息。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt install lsb-release
</span></span></code></pre></div><ol><li>添加GPG签名</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker-apt-keyring.gpg
</span></span></code></pre></div><ol><li>添加镜像仓库</li></ol><p>使用 $(lsb_release -cs) 可以确保 APT 仓库的配置指向适用于你当前 Ubuntu 版本的 Docker 软件包目录，避免安装了不兼容的软件包。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb [arch=</span><span style=color:#66d9ef>$(</span>dpkg --print-architecture<span style=color:#66d9ef>)</span><span style=color:#e6db74> signed-by=/etc/apt/keyrings/docker-apt-keyring.gpg] https://download.docker.com/linux/ubuntu </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list
</span></span></code></pre></div><ol><li>安装</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install -y containerd.io
</span></span></code></pre></div><p>查看运行状态</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable containerd
</span></span><span style=display:flex><span>sudo systemctl start containerd
</span></span><span style=display:flex><span>sudo systemctl status containerd
</span></span></code></pre></div><ol><li>修改配置</li></ol><p>先生成containerd的默认配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo containerd config default | sudo tee /etc/containerd/config.toml
</span></span></code></pre></div><p>再修改CgroupDriver为systemd，k8s官方推荐使用systemd类型的CgroupDriver</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>containerd</span>.<span style=color:#a6e22e>runtimes</span>.<span style=color:#a6e22e>runc</span>]
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>containerd</span>.<span style=color:#a6e22e>runtimes</span>.<span style=color:#a6e22e>runc</span>.<span style=color:#a6e22e>options</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SystemdCgroup</span> = <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>接下来修改镜像源，找到<code>registry.mirrors</code>所在位置，添加如下所示配置。</p><ul><li><code>docker.io</code> 是 Docker Hub 的官方地址，绝大多数公共镜像都来源于此，配置 <code>docker.io</code> 的加速器是最常见的需求。</li><li>对于 Kubernetes 自己的核心镜像 (如 kube-apiserver, kube-controller-manager 等)，在 Kubernetes 1.25 之前它们主要托管在 <code>k8s.gcr.io</code>，1.25 及之后迁移到了 <code>registry.k8s.io</code>。我们将<code>registry.k8s.io</code>加速。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>    [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>]
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>config_path</span> = <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>auths</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>configs</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>headers</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>mirrors</span>]
</span></span><span style=display:flex><span>       [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>mirrors</span>.<span style=color:#e6db74>&#34;docker.io&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endpoint</span>=[<span style=color:#e6db74>&#34;https://docker.m.daocloud.io&#34;</span>]
</span></span><span style=display:flex><span>       [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>mirrors</span>.<span style=color:#e6db74>&#34;registry.k8s.io&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endpoint</span>=[<span style=color:#e6db74>&#34;https://k8s.m.daocloud.io&#34;</span>]
</span></span></code></pre></div><p>最后，重启containerd</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl restart containerd
</span></span></code></pre></div><p>可以执行以下命令查看是否将镜像修改成功。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo crictl info
</span></span></code></pre></div><p>如下图所示，表示成功了。</p><p><img src=https://i0.hdslb.com/bfs/openplatform/a0ab7c3dc1c12f60f0a1c391c6ea3dc173523cf4.png alt></p><h2 id=部署>部署</h2><h3 id=master节点初始化>Master节点初始化</h3><p>在<code>bestzy-master</code>主机上，执行以下代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo kubeadm init <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --apiserver-advertise-address<span style=color:#f92672>=</span>192.168.154.100 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --image-repository registry.aliyuncs.com/google_containers <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubernetes-version v1.28.15 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --service-cidr<span style=color:#f92672>=</span>10.96.0.0/12 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --pod-network-cidr<span style=color:#f92672>=</span>10.244.0.0/16
</span></span></code></pre></div><ul><li><strong>&ndash;apiserver-advertise-address</strong> : 填控制平面节点本机的、其他节点可以访问到的 IP 地址。<ul><li>用 <code>ip a</code> 或 <code>ifconfig</code> 查看。在输出中找到你连接内网的那个网络接口（比如 eth0 或 ens33 等），找到它对应的 inet 地址。这个地址就是你可以填写的 <code>--apiserver-advertise-address</code>。</li></ul></li><li><strong>&ndash;image-repository</strong> ：使用这个参数指定其他的镜像仓库，例如阿里云的 <code>registry.aliyuncs.com/google_containers</code>。这样 kubeadm 就会从这里拉取控制平面组件的镜像。</li><li><strong>&ndash;kubernetes-version</strong> : 指定要安装的 Kubernetes 版本，例如 v1.28.15。如果不指定，会使用当前安装的 kubeadm 适配的默认版本。</li><li><strong>&ndash;pod-network-cidr</strong> : 填一个为 Pod 准备的、未被占用的、不与你的宿主机网络和 Service 网络冲突 的 IP 地址段。这个参数通常取决于你选择的 CNI 插件，例如 Flannel 的 10.244.0.0/16 或 Calico 的 192.168.0.0/16。</li><li><strong>&ndash;service-cidr</strong> : 填一个为 Service 准备的、未被占用的、不与你的宿主机网络和 Pod 网络冲突 的 IP 地址段。常见的选择是 10.96.0.0/12。</li></ul><p>显示 successfully 表示初始化成功</p><p><img src=https://i0.hdslb.com/bfs/openplatform/25d7f1d9f024d00f249ff341528dec4626e30393.png alt></p><h3 id=修改目录权限>修改目录权限</h3><p>要想使相关的组件可以正常使用，我们还需要按提示将目录、权限设置成功。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span></code></pre></div><h3 id=添加node节点>添加Node节点</h3><p>如提示所示，我们需要在<code>bestzy-node1</code>、<code>bestzy-node2</code>主机上，分别执行以下命令。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubeadm join 192.168.154.100:6443 --token h1wtmw.rr8v9m4ym61wsd6d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --discovery-token-ca-cert-hash sha256:5b4156b9e5849143330015a8e5912ec7ae345d3783a783a3872aa152a85df0c4
</span></span></code></pre></div><p>但默认的token有效期为24小时，当过期之后，该token就不能用了，这时可以使用如下的命令创建token：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubeadm token create --print-join-command
</span></span></code></pre></div><p>成功添加Node节点后会显示如下文字。</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=OGI1NDY4NzMwYjgxNWQyZjQxMjNhMmFjNjcxNmY2NDhfdGtkaFhMd0Y2NW1RbXJaWFkzdzlmb1N4bm1nRUZnb0JfVG9rZW46WVgwRWIyZEpUb3pRQ054OEN2OWMzRTlSbjhmXzE3NDcwNTQ1Mjc6MTc0NzA1ODEyN19WNA" alt=img></p><h3 id=部署cni网络插件>部署CNI网络插件</h3><p>根据提示，在Master节点使用kubectl工具查看节点状态：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img src=https://i0.hdslb.com/bfs/openplatform/d66080c573357cbbc97187d3976ab1f27ede090d.png alt></p><p><code>kubeadm init</code> 命令负责初始化 Kubernetes 控制平面。它会下载并启动控制平面所需的组件：kube-apiserver, kube-controller-manager, kube-scheduler, etcd 等。</p><p>但<code>kubeadm init</code>并没有部署一个实际的 Pod 网络 来满足上面提到的 Pod 之间直接通信的要求。它设置了网络环境的基础，但它没有提供一个具体的网络实现方案来分配 Pod IP 并处理跨节点的数据包转发。</p><p>总而言之，<code>kubeadm init</code> 只搭建了骨架，如果没有部署 CNI 插件，那么 kubelet 在尝试启动 Pod 时，会发现没有组件可以为其配置网络接口和 IP 地址（这是 Pod 启动流程中的关键一步）。</p><p>此处，我们选择https://github.com/flannel-io/flannel，进行快速部署</p><blockquote><p>注意，该命令不能使用sudo，当你使用 sudo 执行 kubectl 命令时，命令是以 root 用户的身份运行的。 kubectl 在查找其配置（kubeconfig 文件，通常是 ~/.kube/config）时，会去 root 用户的home目录，也就是 /root/.kube/config。而我们之前配置 kubectl 的步骤（将 /etc/kubernetes/admin.conf 复制到 ~/.kube/config 并修改权限）这些命令是为当前登录用户配置的。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
</span></span></code></pre></div><p><img src=https://i0.hdslb.com/bfs/openplatform/430c39db3967c1c44d3afa2dc7a02872d009d4a0.png alt></p><h3 id=去除污点>去除污点</h3><p>污点（Taint）是标记节点的一种方式，用来阻止某些 Pod 调度到该节点上。</p><p>初始情况下，master是污点节点，我们可以选择性的为它去除污点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl describe node bestzy-master | grep -i taint
</span></span></code></pre></div><p>命令将输出：</p><p><img src=https://i0.hdslb.com/bfs/openplatform/b1e8dc9cd3014f26f4dc89c9802979d2c445a5de.png alt></p><p>执行以下命令（注意末尾的<code>-</code>）将移除污点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl taint node bestzy-master node-role.kubernetes.io/control-plane:NoSchedule-
</span></span></code></pre></div><h2 id=测试>测试</h2><h3 id=部署nginx>部署nginx</h3><p>尝试部署一个简单的应用程序，验证 Pod 是否可以被调度到节点上并成功运行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl create deployment nginx --image<span style=color:#f92672>=</span>nginx
</span></span></code></pre></div><p><strong>预期输出</strong>： 会创建名为 nginx 的 Deployment。</p><h3 id=检查状态>检查状态</h3><p>检查 <code>nginx Deployment</code> 的状态，以及它创建的 Pod 的状态。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get deployments
</span></span><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>Pod 的状态应该最终变为 Running。</p><p><code>kubectl get pods -o wide</code> 可以看到 Pod 被调度到了哪个节点上。</p><p><img src=https://i0.hdslb.com/bfs/openplatform/1f8f0c72f4ec76e1b6094261c93ef13828bc3632.png alt></p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://developer.aliyun.com/mirror/kubernetes/ target=_blank>https://developer.aliyun.com/mirror/kubernetes/</a></li><li><a href=https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/ target=_blank>https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/</a></li></ul></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#前期准备>前期准备</a><ul><li><a href=#服务器配置>服务器配置</a></li><li><a href=#更换apt镜像源>更换apt镜像源</a></li><li><a href=#固定ip>固定IP</a></li><li><a href=#禁用swap分区>禁用swap分区</a></li><li><a href=#将桥接的ipv4流量传递到iptables的链>将桥接的IPv4流量传递到iptables的链</a></li></ul></li><li><a href=#安装>安装</a><ul><li><a href=#kube三件套>Kube三件套</a></li><li><a href=#安装containerd>安装Containerd</a></li></ul></li><li><a href=#部署>部署</a><ul><li><a href=#master节点初始化>Master节点初始化</a></li><li><a href=#修改目录权限>修改目录权限</a></li><li><a href=#添加node节点>添加Node节点</a></li><li><a href=#部署cni网络插件>部署CNI网络插件</a></li><li><a href=#去除污点>去除污点</a></li></ul></li><li><a href=#测试>测试</a><ul><li><a href=#部署nginx>部署nginx</a></li><li><a href=#检查状态>检查状态</a></li></ul></li><li><a href=#参考链接>参考链接</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>👋 Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyy年MM月dd日")})}</script><script src=/js/toc.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>