<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ã€MIT6.5840ã€‘Lab5-Sharded Key/Value Service | Bestzy's Blog</title>
<link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/><meta name=author content="bestzy"><meta name=description content="æœ¬æ–‡å°†ä»‹ç»MIT6.5840çš„Lab5çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œå®Œæ•´ä»£ç è§Githubã€‚
"><meta name=keywords content="Shard Key/Value Service"><meta name=generator content="Hugo 0.146.3"><meta property="og:url" content="https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="ã€MIT6.5840ã€‘Lab5-Sharded Key/Value Service"><meta property="og:description" content="æœ¬æ–‡å°†ä»‹ç»MIT6.5840çš„Lab5çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œå®Œæ•´ä»£ç è§Githubã€‚"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-16T22:48:11+08:00"><meta property="article:modified_time" content="2025-03-16T22:48:11+08:00"><meta property="article:tag" content="Shard Key/Value Service"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="ã€MIT6.5840ã€‘Lab5-Sharded Key/Value Service"><meta name=twitter:description content="æœ¬æ–‡å°†ä»‹ç»MIT6.5840çš„Lab5çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œå®Œæ•´ä»£ç è§Githubã€‚"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=ç¿»è½¬ä¸€ä¸‹ï¼><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">ğŸš€å…ˆè¡Œå…¶äº‹ï¼Œåè‡»å…¶å–„ï¼Œå†æ±‚å…¶ä¼˜ï¼</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=æœç´¢><ion-icon name=search></ion-icon>æœç´¢</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=æœç´¢><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="ã€MIT6.5840ã€‘Lab5-Sharded Key/Value Service"><meta itemprop=description content="æœ¬æ–‡å°†ä»‹ç»MIT6.5840çš„Lab5çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œå®Œæ•´ä»£ç è§Githubã€‚"><meta itemprop=datePublished content="2025-03-16T22:48:11+08:00"><meta itemprop=dateModified content="2025-03-16T22:48:11+08:00"><meta itemprop=wordCount content="6515"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="Shard Key/Value Service"><header><h1 itemprop=headline>ã€MIT6.5840ã€‘Lab5-Sharded Key/Value Service</h1><p class=text-sm><span data-format=luxon>2025-03-16T22:48:11+08:00</span>
| <span>14åˆ†é’Ÿé˜…è¯»</span>
| <span>æ›´æ–°äº
<span data-format=luxon>2025-03-16T22:48:11+08:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0! src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e3%80%90MIT6.5840%e3%80%91Lab5-Sharded%20Key/Value%20Service&amp;url=https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://i0.hdslb.com/bfs/article/2ae63f480f1b505eefd034268b52b9a42099359.jpg@1e_1c.webp alt="ã€MIT6.5840ã€‘Lab5-Sharded Key/Value Service"><p>æœ¬æ–‡å°†ä»‹ç»MIT6.5840çš„Lab5çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œå®Œæ•´ä»£ç è§Githubã€‚</p><p><a href=https://github.com/bestzy6/MIT6.5840 target=_blank>https://github.com/bestzy6/MIT6.5840</a></p><p>æ•´ä¸ªLab5ä¸­ï¼Œå„éƒ¨åˆ†çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<code>Shardctrler-Cluster</code>å­˜å‚¨äº†é…ç½®æƒ…å†µï¼Œ<code>Client</code>å’Œ<code>Server</code>ä»ä¸­è·å–é…ç½®å¹¶å®Œæˆä¸€ç³»åˆ—é€»è¾‘æ“ä½œã€‚</p><p><img src=https://i0.hdslb.com/bfs/article/3b504ea45a94c49aae3e51c1bdae02912099359.png@1e_1c.webp alt></p><h2 id=lab5a>Lab5A</h2><h3 id=shardctrlerä»£ç å®ç°>ShardCtrlerä»£ç å®ç°</h3><p>ShardCtrlerå‡ ä¹å¯ä»¥æ— è„‘å¤åˆ¶Lab4çš„ä»£ç ï¼ŒClientä¸Serverçš„ä¸»è¦æµç¨‹æ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·éœ€è¦æ³¨æ„å»é‡ï¼ŒRPCè¯·æ±‚éœ€è¦å¢åŠ <code>ClerkID</code>ä¸<code>ReqID</code>ï¼Œä½†<strong>æ— éœ€è€ƒè™‘å¿«ç…§</strong>ã€‚æ­¤æ–‡åªè®²è§£æ ¸å¿ƒå®ç°ï¼Œå…·ä½“å¯å‚è€ƒä»£ç ã€‚</p><p>Opç»“æ„ä½“å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Op</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Servers</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span> <span style=color:#75715e>//Join</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GIDs</span>    []<span style=color:#66d9ef>int</span>            <span style=color:#75715e>//Leave</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Shard</span>   <span style=color:#66d9ef>int</span>              <span style=color:#75715e>//Move</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GID</span>     <span style=color:#66d9ef>int</span>              <span style=color:#75715e>//Move</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Num</span>     <span style=color:#66d9ef>int</span>              <span style=color:#75715e>//Query</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkId</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç›¸è¾ƒäºLab4ï¼Œ<code>handleOperation</code>æ–¹æ³•ä¸­çš„æ•°æ®åº“æ“ä½œå˜æ›´ä¸º<code>opExecutor</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>opExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>Config</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Join</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>joinExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span> = append(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>, <span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Leave</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>leaveExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span> = append(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>, <span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Move</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>moveExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span> = append(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>, <span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Query</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>queryExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Config</span>{}, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ ¹æ®ä»»åŠ¡è¦æ±‚ï¼Œåœ¨è¿›è¡ŒJoinã€Leaveæ“ä½œåéœ€è¦è´Ÿè½½å‡è¡¡å¤„ç†ã€‚ä»¥ä¸‹è§£é‡Š4ä¸ªæ“ä½œé€»è¾‘ã€‚</p><h4 id=joinleave>Join&amp;Leave</h4><blockquote><p>Join RPC ç”±ç®¡ç†å‘˜ç”¨äºæ·»åŠ æ–°çš„å‰¯æœ¬ç»„ã€‚å…¶å‚æ•°æ˜¯ä¸€ç»„ä»å”¯ä¸€ä¸”éé›¶çš„å‰¯æœ¬ç»„æ ‡è¯†ç¬¦ï¼ˆGIDsï¼‰åˆ°æœåŠ¡å™¨åç§°åˆ—è¡¨çš„æ˜ å°„ã€‚shardctrler åº”é€šè¿‡åˆ›å»ºåŒ…å«æ–°å‰¯æœ¬ç»„çš„æ–°é…ç½®æ¥å“åº”ã€‚æ–°é…ç½®åº”å°½å¯èƒ½å‡åŒ€åœ°åœ¨æ‰€æœ‰ç»„ä¹‹é—´åˆ†é…åˆ†ç‰‡ï¼Œå¹¶ä¸”åº”å°½å¯èƒ½å°‘åœ°ç§»åŠ¨åˆ†ç‰‡ä»¥å®ç°è¯¥ç›®æ ‡ã€‚å¦‚æœ GID ä¸æ˜¯å½“å‰é…ç½®çš„ä¸€éƒ¨åˆ†ï¼Œshardctrler åº”å…è®¸é‡æ–°ä½¿ç”¨ GIDï¼ˆå³ï¼Œåº”å…è®¸ GID å…ˆåŠ å…¥ï¼Œç„¶åç¦»å¼€ï¼Œå†é‡æ–°åŠ å…¥ï¼‰ã€‚</p><p>Leave RPC çš„å‚æ•°æ˜¯ä¹‹å‰åŠ å…¥çš„ç»„çš„ GID åˆ—è¡¨ã€‚shardctrler åº”åˆ›å»ºä¸€ä¸ªä¸åŒ…å«è¿™äº›ç»„çš„æ–°é…ç½®ï¼Œå¹¶å°†è¿™äº›ç»„çš„åˆ†ç‰‡åˆ†é…ç»™å‰©ä½™çš„ç»„ã€‚æ–°é…ç½®åº”å°½å¯èƒ½å‡åŒ€åœ°åœ¨ç»„ä¹‹é—´åˆ†é…åˆ†ç‰‡ï¼Œå¹¶åº”å°½å¯èƒ½å°‘åœ°ç§»åŠ¨åˆ†ç‰‡ä»¥å®ç°è¯¥ç›®æ ‡ã€‚</p></blockquote><p>é€‰å–æœ€åçš„é…ç½®å¹¶åŠ å…¥æˆ–ç§»é™¤Groupï¼Œæ“ä½œåçš„è´Ÿè½½å‡è¡¡åç»­è¿›è¡Œè¯¦è§£ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–°é…ç½®çš„<code>map</code>å¿…é¡»<strong>æ·±æ‹·è´</strong>ï¼Œå¦åˆ™å½“å‰çš„å˜åŠ¨ä¼šå½±å“åˆ°ä¹‹å‰çš„é…ç½®ã€‚ä»¥ä¸‹ç»™å‡ºJoinçš„ä»£ç ï¼Œ<strong>Leaveä¸Joinç›¸ä¼¼</strong>ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>joinExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>servers</span> = <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Servers</span> <span style=color:#75715e>//GID -&gt; æœåŠ¡åç§°</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfgNum</span>  = len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastCfg</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>cfgNum</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ·±æ‹·è´ï¼Œåˆ›å»ºæ–°çš„Groups</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] %v Join, Origin Shards:%v&#34;</span>, <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Shards</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newGroups</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span>, len(<span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Groups</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>srvs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Groups</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>newServices</span> = make([]<span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>srvs</span>))         <span style=color:#75715e>// æœåŠ¡åç§°</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ServicesMap</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span>{}, len(<span style=color:#a6e22e>srvs</span>)) <span style=color:#75715e>// æœåŠ¡åç§°Setï¼Œç”¨äºå»é‡</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>srvs</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>newServices</span> = append(<span style=color:#a6e22e>newServices</span>, <span style=color:#a6e22e>srv</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ServicesMap</span>[<span style=color:#a6e22e>srv</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tmpServices</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>gid</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tmpService</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tmpServices</span> {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// åˆ¤æ–­æ˜¯å¦é‡å¤</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exist</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ServicesMap</span>[<span style=color:#a6e22e>tmpService</span>]; <span style=color:#a6e22e>exist</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>newServices</span> = append(<span style=color:#a6e22e>newServices</span>, <span style=color:#a6e22e>tmpService</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#75715e>// åˆ é™¤GIDï¼Œè¡¨ç¤ºå·²ç»æ·»åŠ </span>
</span></span><span style=display:flex><span>          delete(<span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>gid</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newGroups</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>newServices</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœserversä¸­çš„GIDåœ¨åŸç»„ä¸­ä¸å­˜åœ¨ï¼Œåˆ™serversé•¿åº¦ä¸ä¸º0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>srvs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>servers</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newGroups</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>srvs</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] %v Join newGroups: %v&#34;</span>, <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>newGroups</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewBalancer</span>(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>).<span style=color:#a6e22e>ReBalanceShards</span>(<span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Shards</span>, <span style=color:#a6e22e>newGroups</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] %v Join balanced Shards: %v&#34;</span>, <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>shards</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Num</span>:    <span style=color:#a6e22e>cfgNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shards</span>: <span style=color:#a6e22e>shards</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Groups</span>: <span style=color:#a6e22e>newGroups</span>,
</span></span><span style=display:flex><span>    }, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=move>Move</h4><blockquote><p>Move RPC çš„å‚æ•°æ˜¯ä¸€ä¸ªåˆ†ç‰‡ç¼–å·å’Œä¸€ä¸ª GIDã€‚shardctrler åº”åˆ›å»ºä¸€ä¸ªæ–°é…ç½®ï¼Œå°†åˆ†ç‰‡åˆ†é…ç»™è¯¥ç»„ã€‚ Move çš„ç›®çš„æ˜¯è®©æˆ‘ä»¬èƒ½å¤Ÿæµ‹è¯•æ‚¨çš„è½¯ä»¶ã€‚åœ¨ Move ä¹‹åçš„ Join æˆ– Leave å¯èƒ½ä¼šæ’¤é”€ Move ï¼Œå› ä¸º Join å’Œ Leave ä¼šé‡æ–°å¹³è¡¡ã€‚</p></blockquote><p>å¹¶æ²¡æœ‰éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ç‚¹ï¼Œä¸Join&amp;Leaveä¸€æ ·æ·±æ‹·è´Groupså­—æ®µå³å¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>moveExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>shard</span>  = <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Shard</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>gid</span>    = <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>GID</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfgNum</span> = len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>    = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>cfgNum</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ·±æ‹·è´</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newGroups</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span>, len(<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Groups</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>srvs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Groups</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newSrvs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>string</span>, len(<span style=color:#a6e22e>srvs</span>))
</span></span><span style=display:flex><span>       copy(<span style=color:#a6e22e>newSrvs</span>, <span style=color:#a6e22e>srvs</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newGroups</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#a6e22e>newSrvs</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>newShards</span> [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Shards</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>shard</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>newShards</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>gid</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newShards</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Shards</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newConfig</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Num</span>:    <span style=color:#a6e22e>cfgNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shards</span>: <span style=color:#a6e22e>newShards</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Groups</span>: <span style=color:#a6e22e>newGroups</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newConfig</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=query>Query</h4><blockquote><p>Query RPC çš„å‚æ•°æ˜¯ä¸€ä¸ªé…ç½®ç¼–å·ã€‚shardctrler ä¼šå›å¤å…·æœ‰è¯¥ç¼–å·çš„é…ç½®ã€‚å¦‚æœç¼–å·ä¸º -1 æˆ–å¤§äºå·²çŸ¥çš„æœ€å¤§é…ç½®ç¼–å·ï¼Œshardctrler åº”å›å¤æœ€æ–°çš„é…ç½®ã€‚ Query(-1) çš„ç»“æœåº”åæ˜  shardctrler åœ¨æ¥æ”¶ Query(-1) RPC ä¹‹å‰å®Œæˆå¤„ç†çš„æ¯ä¸ª Join ã€ Leave æˆ– Move RPCã€‚</p></blockquote><p>ç”¨äºæŸ¥è¯¢æŒ‡å®šç¼–å·çš„é…ç½®ã€‚æ ¹æ®ä»»åŠ¡çš„è¦æ±‚ï¼Œå¦‚æœåºå·ä¼ å…¥-1æˆ–è€…å¤§äºé…ç½®å·ï¼Œåˆ™è¿”å›æœ€æ–°çš„é…ç½®ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>queryExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>num</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Num</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>num</span> &lt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>num</span> <span style=color:#f92672>&gt;=</span> len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>num</span>], <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=shardctrlerè´Ÿè½½å‡è¡¡>ShardCtrlerè´Ÿè½½å‡è¡¡</h3><p>Lab5Aä¸­çš„éš¾ç‚¹æ˜¯å®ç°è´Ÿè½½å‡è¡¡ã€‚å‡è®¾å­˜åœ¨4ä¸ªGroupï¼Œä»¥åŠ10ä¸ªShardï¼Œå°†GroupæŒ‰ç…§Shardæ•°é‡å€’åºæ’åºï¼Œæ­¤æ—¶è´Ÿè½½çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://i0.hdslb.com/bfs/article/5e00a2f7924d7a3b5bd44b482aaa1c702099359.png@1e_1c.webp alt></p><p>æ˜¾ç„¶Groupçš„å¹³å‡Shardæ•°ä¸º2ï¼ˆ10/4=2ï¼‰ã€‚å¦‚æœæˆ‘ä»¬å°†Groupä¸­å¤§äºAvgçš„Shardæˆªå–ï¼Œå†å°†æˆªå–çš„Shardåˆ†é…ç»™Shardæ•°é‡å°äºç­‰äºAvgçš„Groupä¸­ï¼Œé‚£ä¹ˆä»¥ä¸Šè´Ÿè½½çŠ¶æ€å°†ä¼šå¤šå‡º2ä¸ªShardï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://i0.hdslb.com/bfs/article/c2f13e7beacc6eadf788e4807ee1bdf72099359.png@1e_1c.webp alt></p><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä½¿Shardå°½å¯èƒ½ä¸ç§»åŠ¨ï¼Œå› æ­¤æœ€ä½³çš„è´Ÿè½½çŠ¶æ€æ˜¯S3å’ŒS4ä¿æŒåŸæ ·ï¼Œè€ŒS7å’ŒS8ç§»åŠ¨è‡³G3ã€G4ã€‚æ­¤æ—¶è´Ÿè½½çŠ¶æ€ä¸ºï¼š</p><p><img src=https://i0.hdslb.com/bfs/article/40927383783bd301685f9c6624e9892c2099359.png@1e_1c.webp alt></p><p>è¦ä½¿Groupè¾¾åˆ°å¦‚ä¸Šè´Ÿè½½å‡è¡¡ï¼Œä¸€ç§æœ´ç´ çš„æ–¹æ³•æ˜¯æ±‚å‡ºShardå¹³å‡å€¼ï¼Œä»¥åŠShardå–æ¨¡ï¼ŒåŸºäºæ¨¡é•¿ï¼ŒåŠ¨æ€è°ƒæ•´Groupçš„æœ€å¤§Shardå€¼ï¼Œä¿è¯å„ä¸ªGroupæ‰€åˆ†é…çš„æœ€å¤§ä¸æœ€å°Shardæ•°é‡å·®å€¼ä¸º1ã€‚å…·ä½“åšæ³•å¦‚ä¸‹ï¼š</p><ol><li>æ±‚å‡ºAvgï¼Œä¸Šè¿°æƒ…å†µä¸º <code>10 / 4 = 2</code></li><li>æ±‚å‡ºModï¼Œä¸Šè¿°æƒ…å†µä¸º <code>10 % 4 = 2</code></li><li>å°†Groupåºåˆ—ä¸­å‰<code>Mod</code>ä¸ªGroupçš„ä¿ç•™é•¿åº¦è®¾ç½®ä¸º<code>Avg + 1</code>ï¼Œå…¶ä½™Groupçš„ä¿ç•™é•¿åº¦ä¸º<code>Avg</code>ã€‚</li></ol><h4 id=balancer>Balancer</h4><p>ä¸ºä¿è¯å•ä¸€åŸåˆ™ï¼Œæˆ‘ä»¬å°†è´Ÿè½½å‡è¡¡é€»è¾‘æŠ½ç¦»ã€‚Balancerç»“æ„ä½“ï¼ˆç±»ï¼‰æ˜¯è´Ÿè½½å‡è¡¡å¤„ç†å™¨ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Balancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewBalancer</span>(<span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Balancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Balancer</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>me</span>: <span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Balancerå®ç°äº†<code>ReBalanceShards</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¦æ±‚ä¼ å…¥æœ€åä¸€ä¸ªé…ç½®çš„Shardæ•°ç»„<code>oldShards</code>ï¼Œä»¥åŠæœ€æ–°çš„Groupsã€‚é€»è¾‘æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºGroup-Shardé“¾è¡¨ç»“æ„<code>grpShardMap</code>ï¼Œè¡¨ç¤ºGroupè´Ÿè´£çš„Shardåºå·ï¼Œå…¶ä¸­Keyä¸ºGIDï¼Œè€ŒValueä¸ºShardåˆ‡ç‰‡ï¼Œæ³¨æ„<strong>åˆ‡ç‰‡æŒ‰ç…§Shardåºå·é¡ºåºæ’åº</strong>ã€‚</li><li>å°†GroupæŒ‰ç…§Shardæ•°é‡å€’åºæ’åºï¼ŒShardæ•°é‡ä¸€è‡´æ—¶æŒ‰GIDé¡ºåºæ’åºï¼Œä»¥æ­¤<strong>ä¿è¯æ’åºç»“æœçš„ç¨³å®šæ€§</strong>ã€‚</li><li>ç­›é€‰å‡ºéœ€è¦ä¼‘çœ çš„Groupï¼Œå³æ’åºåºå·å¤§äºç­‰äº<code>NShards</code>æ•°é‡çš„Groupã€‚å› ä¸ºè¿™äº›Groupæ— æ³•åˆ†åˆ°Shardã€‚</li><li>å°†â€œè¶…å‡ºGroupå®¹é‡çš„Shardâ€ã€â€œä¼‘çœ Groupçš„æ‰€æœ‰Shardâ€æ”¾ç½®åœ¨<code>freeShards</code>ä¸­ï¼Œ<code>freeShards</code>å±äºè‡ªå®šä¹‰Setç±»å‹ï¼Œå…·ä½“å‚è€ƒä»£ç ã€‚</li><li>å°†<code>freeShards</code>æ’åºï¼ŒæŒ‰åºåˆ—æ”¾åˆ°æœªè¶…å®¹é‡çš„Groupä¸­ã€‚</li><li>æ ¹æ®<code>grpShardMap</code>é‡æ–°ç”ŸæˆShardsæ•°ç»„ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Balancer</span>) <span style=color:#a6e22e>ReBalanceShards</span>(<span style=color:#a6e22e>oldShards</span> [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>groups</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span>) [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>groups</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span>{}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆå§‹æƒ…å†µä¸‹ï¼Œä¸å­˜åœ¨GIDçš„Shardåº”è¯¥å½’å±äº0</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// oldShardså¯èƒ½è¢«åˆ†é…è‡³å·²ç»ä¸å­˜åœ¨çš„Group</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grpShardMap</span>, <span style=color:#a6e22e>freeShards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>groupShardMap</span>(<span style=color:#a6e22e>oldShards</span>, <span style=color:#a6e22e>groups</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sortedGid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>sortGroupByShard</span>(<span style=color:#a6e22e>grpShardMap</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sleepGid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>getSleepGid</span>(<span style=color:#a6e22e>sortedGid</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] ReBalanceShards sortedGid:%v ; sleepGid:%v ; freeShards: %v&#34;</span>, <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>sortedGid</span>, <span style=color:#a6e22e>sleepGid</span>, <span style=color:#a6e22e>freeShards</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—Shardå¹³å‡æ•°é‡ï¼Œå¹³å‡å€¼æœ€å°ä¸º1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>avgShardNum</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NShards</span> <span style=color:#f92672>/</span> (len(<span style=color:#a6e22e>sortedGid</span>) <span style=color:#f92672>-</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Len</span>())
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>modShardNum</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NShards</span> <span style=color:#f92672>%</span> (len(<span style=color:#a6e22e>sortedGid</span>) <span style=color:#f92672>-</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Len</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°†è¶…è¿‡å¹³å‡å€¼çš„Shardæ”¾ç½®åœ¨freeShardsä¸­</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>gid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>sortedGid</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>]
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœGIDåœ¨sleepGidä¸­ï¼Œåˆ™å°†Shardæ”¾ç½®åœ¨freeShardsä¸­</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Contain</span>(<span style=color:#a6e22e>gid</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>freeShards</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>shards</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// è®¡ç®—å½“å‰GIDåº”è¯¥æ‹¥æœ‰çš„Shardæ•°é‡</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pos</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>modShardNum</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœShardæ•°é‡å¤§äºposå€¼ï¼Œåˆ™å°†å¤šä½™çš„Shardæ”¾ç½®åœ¨freeShardsä¸­</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>shards</span>) &gt; <span style=color:#a6e22e>pos</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>freeShards</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>shards</span>[<span style=color:#a6e22e>pos</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>shards</span>[:<span style=color:#a6e22e>pos</span>]
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¿è¯æ¯æ¬¡åˆ†é…Shardæ—¶å–å‡ºçš„Shardæ˜¯æœ‰åºçš„ï¼Œä»¥æ­¤ç¡®ä¿å‰¯æœ¬çš„ä¸€è‡´æ€§</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unAsgnShards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>freeShards</span>.<span style=color:#a6e22e>SortedSlice</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é‡æ–°åˆ†é…Shards</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>gid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>sortedGid</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Contain</span>(<span style=color:#a6e22e>gid</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pos</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>modShardNum</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœShardæ•°é‡å°äºå¹³å‡å€¼ï¼Œåˆ™ä»unAsgnShardsä¸­å–å‡ºShardè¿›è¡Œåˆ†é…</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>shards</span>) &lt; <span style=color:#a6e22e>pos</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>unAsgnShards</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>shards</span> = append(<span style=color:#a6e22e>shards</span>, <span style=color:#a6e22e>unAsgnShards</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>unAsgnShards</span> = <span style=color:#a6e22e>unAsgnShards</span>[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>shards</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] ReBalanceShards grpShardMap: %v&#34;</span>, <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>grpShardMap</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>genNShards</span>(<span style=color:#a6e22e>grpShardMap</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>shards</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=serveræ ¸å¿ƒä»£ç å®ç°>Serveræ ¸å¿ƒä»£ç å®ç°</h3><p>ä»£ç æ•´ä½“ä¸Šä¸Lab4ç›¸åŒï¼Œå…·ä½“çš„å¯å‚è€ƒ<a href=https://github.com/bestzy6/MIT6.5840 target=_blank>ä»£ç ä»“åº“</a>
ã€‚</p><h4 id=æ›´æ–°é…ç½®>æ›´æ–°é…ç½®</h4><p>Serverçš„Opç»“æ„ä½“å¦‚ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ Configå­—æ®µï¼Œä»¥ä¾¿å°†é…ç½®ä¼ é€’ç»™Followerã€‚ç›¸åŒçš„ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ *<code>OpTypeConfig</code>*<em>ç±»å‹æ¥è¡¨ç¤ºå½“å‰Opç»“æ„ä½“æ˜¯é…ç½®ç±»å‹</em>ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Op</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Field names must start with capital letters,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// otherwise RPC will break.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span>     <span style=color:#66d9ef>string</span> <span style=color:#75715e>// OpTypeGet, OpTypePut, OpTypeAppend</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>   <span style=color:#66d9ef>string</span> <span style=color:#75715e>// OpTypeGet, OpTypePut, OpTypeAppend</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Config</span>  <span style=color:#a6e22e>shardctrler</span>.<span style=color:#a6e22e>Config</span> <span style=color:#75715e>// OpTypeConfig</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨<code>handleOperation</code>æ–¹æ³•ä¸­ï¼Œä¹Ÿè¦å¢åŠ é…ç½®ç±»å‹çš„å¤„ç†é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeGet</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypePut</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeAppend</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeConfig</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>UpdateConfig</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Config</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>updateConfig</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>UpdateConfig</span>(<span style=color:#a6e22e>newCfg</span> <span style=color:#a6e22e>shardctrler</span>.<span style=color:#a6e22e>Config</span>) <span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Config Num[%d] &gt;= New Config Num[%d], Do not need to Update&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span><span style=color:#f92672>-</span><span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrWrongConfigNum</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Config is NIL, Apply Config, Update :[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>newCfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span> = <span style=color:#a6e22e>newCfg</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span> = <span style=color:#a6e22e>newCfg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Update Config Success:[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>newCfg</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ç›‘å¬é…ç½®>ç›‘å¬é…ç½®</h4><p>å¯¹äºæ— éœ€æ¯æ¬¡éƒ½æŸ¥è¯¢ShardCtrlerï¼Œåœ¨Lab5Bä¸­ï¼Œä»»åŠ¡æœŸæœ›æˆ‘ä»¬ä»¥100msé—´éš”è½®è¯¢ã€‚å› æ­¤åœ¨å®ç°ä¸Šï¼Œæˆ‘ä»¬å¼€å¯ä¸€ä¸ªåç¨‹ï¼Œæ¯éš”100msè·å–ä¸€æ¬¡é…ç½®ï¼Œå¦‚éœ€è¦æ›´æ–°é…ç½®ï¼Œåˆ™åˆ›å»ºOpç»“æ„ä½“å¹¶å‘é€è‡³Raftã€‚</p><p>ç‰¹åˆ«éœ€è¦æ³¨æ„é”çš„è·å–å’Œé‡Šæ”¾ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>PollConfig</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>update</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>nextCfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mck</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#a6e22e>nextCfg</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Num</span> &gt; <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>update</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>update</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Type</span>:    <span style=color:#a6e22e>OpTypeConfig</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ReqId</span>:   <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>nextId</span>(),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Config</span>:  <span style=color:#a6e22e>cfg</span>,
</span></span><span style=display:flex><span>             })
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Push Config Op Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=æ˜“é”™ç‚¹>æ˜“é”™ç‚¹</h3><p>æ€»ç»“ä¸€ä¸‹æ˜“é”™ç‚¹ï¼Œå¦‚ä¸‹ï¼š</p><ol><li>æ’åºç®—æ³•çš„ç¨³å®šæ€§<ol><li>è¦ä¿è¯å„å‰¯æœ¬Shardæ•°ç»„çš„ä¸€è‡´æ€§ï¼Œä½¿ç”¨æ’åºæ—¶å¿…é¡»ä¿è¯ç»“æœçš„ç¨³å®šæ€§ã€‚</li></ol></li><li>mapè¿­ä»£é¡ºåºçš„æ— åºæ€§<ol><li>mapæœ¬èº«æ˜¯æ— åºçš„ï¼Œè‹¥ä¸è€ƒè™‘è¿™ç‚¹ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‰¯æœ¬Shardæ•°ç»„ä¸ä¸€è‡´ã€‚</li></ol></li><li>Groupæ•°é‡ä¸NShardçš„å…³ç³»<ol><li>è‹¥Groupæ•°é‡å¤§äºNshardï¼Œé‚£ä¹ˆå¿…ç„¶ä¼šå­˜åœ¨éƒ¨åˆ†Groupæ— æ³•åˆ†é…åˆ°Shardã€‚</li></ol></li><li>æ›´æ–°Configéœ€è¦ç”±Leaderé€šè¿‡RaftåŒæ­¥è‡³å„Follower<ol><li>æ­¤ä¸¾æ‰èƒ½ä¿è¯çº¿æ€§ä¸€è‡´æ€§ã€‚</li></ol></li><li>å¿…é¡»æŒ‰é…ç½®ç¼–å·é¡ºåºåœ°æ›´æ–°<ol><li>ä¸ç„¶ä¼šå‡ºç°é…ç½®ä¸ä¸€è‡´çš„bugï¼Œæ‰€ä»¥æ¯æ¬¡å‘ShardCtrleræ‹‰å–çš„éƒ½æ˜¯å½“å‰cfgç¼–å·+1çš„é…ç½®ã€‚</li></ol></li></ol><h2 id=lab5b>Lab5B</h2><p>è¿™ä¸€éƒ¨åˆ†çš„ä¸»è¦ä»»åŠ¡æ˜¯åœ¨æ§åˆ¶å™¨æ›´æ”¹åˆ†ç‰‡æ—¶ï¼Œåœ¨<strong>å‰¯æœ¬ç»„ä¹‹é—´ç§»åŠ¨åˆ†ç‰‡</strong>ï¼Œå¹¶ä»¥<strong>æä¾›çº¿æ€§åŒ– k/v å®¢æˆ·ç«¯æ“ä½œ</strong>çš„æ–¹å¼è¿›è¡Œã€‚Lab5B é™„æœ‰ä¸¤ä¸ª challengesï¼Œåˆ†åˆ«è¦æ±‚æˆ‘ä»¬å®ç°</p><ol><li>å¤±æ•ˆæ•°æ®çš„æ¸…é™¤ï¼ˆChallenge 1ï¼‰</li><li>å¼‚æ­¥å˜æ›´é…ç½®çš„ shardkvï¼ˆChallenge 2ï¼‰ã€‚</li></ol><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å®ç°ä¸¤ä¸ªChallengeï¼Œå› æ­¤åœ¨è®¾è®¡ä¹‹åˆå°±éœ€è¦è€ƒè™‘ã€‚</p><h3 id=é…ç½®æ›´æ–°ç­–ç•¥>é…ç½®æ›´æ–°ç­–ç•¥</h3><p>æ¯ä¸ªGroupçš„é…ç½®å¿…é¡»æŒ‰ç…§ä¸¥æ ¼çš„ç‰ˆæœ¬å·é¡ºåºå¤„ç†ï¼ˆC1â†’C2â†’C3ï¼‰ï¼Œè¿™ç¡®ä¿äº†ç³»ç»ŸçŠ¶æ€çš„ä¸€è‡´æ€§å’Œå¯é¢„æµ‹æ€§ã€‚</p><p>è€Œå¯¹äºGroupå†…éƒ¨çš„æ›´æ–°ç­–ç•¥ï¼Œæˆ‘æœ€åˆçš„è€ƒè™‘æ˜¯è¿™æ ·çš„ï¼šå½“éœ€è¦æ›´æ–°çš„é…ç½®ä¸å½“å‰é…ç½®çš„å·®å¼‚ä¸ä¸ä¹‹å‰çš„å·®å¼‚å†²çªæ—¶ï¼Œå°±å…è®¸æ›´æ–°ï¼Œå³â€œéå†²çªdiffå¯æ¥å—â€çš„åŸåˆ™ã€‚è¿™ç§åšæ³•çš„ä¼˜ç‚¹åŒ…æ‹¬ï¼š</p><ol><li>æé«˜äº†å¹¶å‘æ›´æ–°çš„å¯èƒ½æ€§ï¼›</li><li>å¯¹äºäº’ä¸å½±å“çš„é…ç½®é¡¹å˜æ›´å¯ä»¥ç‹¬ç«‹è¿›è¡Œ</li></ol><p>ä½†ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå®ç°è¯¥ç­–ç•¥çš„å¤æ‚æ€§æ— æ¯”å·¨å¤§ï¼Œéœ€è¦è€ƒè™‘å¤šä¸ªGroupä¹‹é—´çš„é…ç½®åŒæ­¥ï¼Œè€Œä¸”å¯èƒ½å¼•å…¥éš¾ä»¥è°ƒè¯•çš„ç«æ€æ¡ä»¶ã€‚</p><p>äºæ˜¯æˆ‘è½¬æ¢äº†ç­–ç•¥ï¼Œå³<strong>Groupå¿…é¡»å®Œå…¨å¤„ç†å®Œå½“å‰é…ç½®å˜æ›´åï¼Œæ‰è¿›å…¥ä¸‹ä¸€é…ç½®</strong>ã€‚è¿™ç§è®¾è®¡ä¹Ÿåæ˜ äº†åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­çš„é‡è¦åŸåˆ™ï¼šæœ‰æ—¶å€™æ›´ç®€å•çš„æ–¹æ³•è™½ç„¶çœ‹èµ·æ¥æ•ˆç‡è¾ƒä½ï¼Œä½†å®é™…ä¸Šèƒ½å¤Ÿæ˜¾è‘—é™ä½å‡ºé”™é£é™©ã€‚</p><p>Challengeè¦æ±‚å·²ç»è¿ç§»çš„åˆ†ç‰‡èƒ½ç«‹å³æŠ•å…¥æœåŠ¡ï¼Œæ— éœ€ç­‰å¾…æ‰€æœ‰åˆ†ç‰‡è¿ç§»å®Œæ¯•ã€‚ä¸ºäº†æ»¡è¶³Challengeçš„è¦æ±‚ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªShardçŠ¶æ€æ•°ç»„æ¥æ ‡æ˜çŠ¶æ€ï¼ŒåŒ…æ‹¬<code>Serving</code>ã€<code>Sending</code>å’Œ<code>Receiving</code>ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ShardStatus</span> <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ShardStatusServing</span>   <span style=color:#a6e22e>ShardStatus</span> = <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// æ­£åœ¨æä¾›æœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ShardStatusSending</span>               = <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// æ­£åœ¨å‘é€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ShardStatusReceiving</span>             = <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// æ­£åœ¨æ¥æ”¶</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=åˆ†ç‰‡è¿ç§»ç­–ç•¥>åˆ†ç‰‡è¿ç§»ç­–ç•¥</h3><p>å‡è®¾æ ¹æ®æ–°çš„é…ç½®ï¼ŒæŸShardéœ€è¦ä»Server1è¿ç§»è‡³Server2ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•è¿›è¡Œè¿ç§»ï¼Ÿ</p><p>ç½‘ä¸Šå¤§å¤šæ•°æ–‡ç« éƒ½é‡‡ç”¨Pullæ¨¡å¼ï¼Œå³è®©Server2ä¸»åŠ¨å‘Server1å‘èµ·è¯·æ±‚ï¼Œä»¥è·å–åˆ†ç‰‡æ•°æ®ã€‚ä½†æ­¤æ–¹æ³•ä¸èƒ½å¾ˆå¥½çš„è®©Server1åˆ¤æ–­Shardæ˜¯å¦è¿ç§»å®Œæ¯•ï¼Œå› ä¸ºServer2ä¸»åŠ¨è¯·æ±‚ï¼ŒServer1æˆåŠŸè¿”å›æ•°æ®åï¼ŒServer1æ— æ³•ç¡®å®šServer2æ˜¯å¦æ”¶åˆ°æ•°æ®ï¼Œå› æ­¤ä¸èƒ½æ›´æ”¹è‡ªèº«çš„çŠ¶æ€ã€‚é‚£ä¹ˆï¼ŒServer1å°±éœ€è¦ä¸»åŠ¨å‘é€RPCè¯·æ±‚è‡³Server2ï¼Œæ¥åˆ¤æ–­Server2æ˜¯å¦è·å–æ•°æ®ã€‚</p><p>å› æ­¤ï¼Œæˆ‘é‡‡ç”¨çš„ç­–ç•¥æ˜¯Pushæ–¹æ³•ï¼Œä½¿ç”¨Pushæ–¹æ³•ä¼šæ¯”è¾ƒæ–¹ä¾¿çš„åŒæ­¥Serverçš„ShardçŠ¶æ€ï¼Œå‘é€ä¸€æ¬¡è¯·æ±‚å³å¯ä¿®æ”¹Server1ã€Server2çš„ShardçŠ¶æ€ï¼Œæ—¶åºå›¾å¦‚ä¸‹ã€‚</p><p>è‡³äºä¸¤ç§æ–¹æ³•çš„éš¾æ˜“ç¨‹åº¦ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºä¸¤è€…çš„éš¾æ˜“ç¨‹åº¦ç›¸å½“ã€‚</p><p><img src=https://i0.hdslb.com/bfs/article/72d94ed4c118d2eeceb51ea98a57008c2099359.png@1e_1c.webp alt></p><p>æ—¶åºå›¾çš„åœºæ™¯æ˜¯æ­£å¸¸æƒ…å†µï¼Œä½†æˆ‘ä»¬ä¸åº”è¯¥å‡è®¾ç½‘ç»œéƒ½æ˜¯æ­£å¸¸çš„ï¼Œå› æ­¤ä¸Šè¿°2ã€4æ­¥éª¤å¾ˆæœ‰å¯èƒ½å‘ç”Ÿé”™è¯¯ã€‚</p><ol><li>æ­¥éª¤2å‘ç”Ÿé”™è¯¯æ—¶ï¼ŒServer1è¿›è¡Œé‡ä¼ </li><li>æ­¥éª¤4å‘ç”Ÿé”™è¯¯æ—¶ï¼ŒServer1è¿›è¡Œé‡ä¼ ï¼Œä½†Server2éœ€è¦é¢å¤–çš„åˆ¤æ–­æ¥ä¿è¯ä¸ä¼šå‡ºé”™ã€‚<ol><li>å½“Server1 RPCçš„ConfigNum å°äº Server2çš„ConfigNumæ—¶ï¼ŒServerè¿”å›OKï¼Œå› ä¸ºé»˜è®¤æ•°æ®è¿ç§»å®Œæ¯•åæ‰èƒ½æ›´æ–°ConfigNumï¼›</li><li>å½“Server1 RPCçš„ConfigNum ç­‰äº Server2çš„ConfigNumæ—¶ï¼Œæ£€æŸ¥ShardçŠ¶æ€ï¼Œå¦‚æœä¸ºServingï¼Œåˆ™è¿”å›OKã€‚</li><li>å½“Server1 RPCçš„ConfigNum å¤§äº Server2çš„ConfigNumæ—¶ï¼Œè¿”å›Errã€‚</li></ol></li></ol><h3 id=è¿ç§»åˆ†ç‰‡åçš„å»é‡å¤„ç†>è¿ç§»åˆ†ç‰‡åçš„å»é‡å¤„ç†</h3><p>æˆ‘åœ¨å®ç°æ—¶ï¼Œé‡åˆ°äº†ç§»åŠ¨åˆ†ç‰‡åæ— æ³•å»é‡çš„é—®é¢˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src=https://i0.hdslb.com/bfs/article/b97272ceb3446e62571e5e32f3cd65d12099359.png@1e_1c.webp alt></p><ol><li>Clientå‘èµ·<code>Append "AB"</code>è¯·æ±‚ï¼Œæ­¤æ—¶è¯·æ±‚ç”±G1å¤„ç†ï¼›</li><li>G1å¤„ç†å®Œæˆï¼Œä½†è¶…æ—¶ã€‚Clientå°†ä¼šé‡æ–°å‘èµ·è¯·æ±‚ï¼›</li><li>Clientè¿˜æœªå‘èµ·è¯·æ±‚ï¼Œå‘ç”Ÿåˆ†ç‰‡è¿ç§»ï¼Œ&ldquo;AB"è¿ç§»è‡³G2å¤„ç†ï¼›</li><li>Clientå‘èµ·Appendè¯·æ±‚ï¼Œæ­¤æ—¶ç”±G2å¤„ç†ï¼ŒG2é‡å¤å¤„ç†åè¿”å›æˆåŠŸä¿¡æ¯ç»™Clientã€‚</li></ol><p>å¯¹Clientè€Œè¨€ï¼ŒåªæˆåŠŸæäº¤äº†ä¸€æ¬¡ï¼Œä½†æ˜¯å¯¹äºServerè€Œè¨€æˆåŠŸAppendäº†ä¸¤æ¬¡ï¼Œä½¿å¾—ç»“æœå‡ºé”™ã€‚</p><p><strong>å¤„ç†æ–¹æ³•</strong></p><p>åœ¨è¿ç§»æ•°æ®æ—¶ï¼Œ<strong>å°†å·²ç»åº”ç”¨çš„æ—¥å¿—ä¿¡æ¯AppliedLogä¹Ÿè¿›è¡Œè¿ç§»</strong>ï¼Œæ–°çš„Groupæ”¶åˆ°AppliedLogååˆå¹¶è‡³è‡ªèº«AppliedLogã€‚</p><h3 id=åˆ†ç‰‡è¿ç§»æ•°æ®ä¸¢å¤±é—®é¢˜>åˆ†ç‰‡è¿ç§»æ•°æ®ä¸¢å¤±é—®é¢˜</h3><p>å‘ç”Ÿåˆ†ç‰‡è¿ç§»ä¹‹åï¼Œä¼¼ä¹åŸå…ˆçš„æ•°æ®ä¸¢å¤±äº†ï¼Ÿåˆ†ç‰‡è¿ç§»æ—¶ä¼¼ä¹æ²¡æœ‰æŠŠæœ€æ–°çš„æ•°æ®è¿ç§»è¿‡æ¥ã€‚</p><p><img src=https://i0.hdslb.com/bfs/article/6c95d7b9052bfac722f90d4e199faba52099359.png@1e_1c.webp alt=img></p><p>é—®é¢˜ï¼šG1æ”¶åˆ°äº†æ–°çš„Configï¼Œæ­£åœ¨å‘ç”Ÿè¿ç§»Shard1è‡³G2ï¼Œæ­¤æ—¶Shard1çš„çŠ¶æ€ä¸ºâ€œsendingâ€ï¼Œå½“Shard1ç”±G1å‘é€è‡³G2ä¹‹åï¼ŒG1å°†Shard1çš„çŠ¶æ€æ”¹ä¸ºServingï¼Œå½“ä¿®æ”¹Shard1çš„è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ£€æŸ¥åˆ°Shard1çš„çŠ¶æ€ä¸ºServingï¼Œåˆ™ä¿®æ”¹Shard1äº†ï¼Œå¯¼è‡´é”™è¯¯ï¼</p><p>å¼•èµ·é—®é¢˜çš„åŸå› å¦‚ä¸‹ï¼š</p><ol><li>G1å‡ ä¹åŒæ—¶æ›´æ–°<code>Config</code>å’Œ<code>Append Shard1</code>æ¶ˆæ¯ï¼Œ<code>Config</code>å’Œ<code>Append Shard1</code>éƒ½è¿›å…¥Raftç­‰å¾…æäº¤ï¼›</li><li>G1æ”¶åˆ°æ›´æ–°Configå‘½ä»¤ï¼Œå°†Shard1è¿ç§»è‡³G2ï¼Œæ­¤æ—¶Shard1çš„çŠ¶æ€ä¿®æ”¹ä¸ºSendingï¼›</li><li>G1å°†Shard1è¿ç§»å®Œæ¯•ï¼ŒShard1çŠ¶æ€ä¿®æ”¹ä¸ºServingï¼›</li><li>G1æ”¶åˆ°Raftæäº¤çš„Append Shard1å‘½ä»¤ï¼Œæ‰§è¡ŒæˆåŠŸåè¿”å›è‡³å®¢æˆ·ç«¯ï¼Œ<strong>äº§ç”Ÿçº¿æ€§ä¸ä¸€è‡´é—®é¢˜</strong>ã€‚</li></ol><p>åœ¨æ­¥éª¤4ä¸­ï¼ŒG1æ”¶åˆ°Raftæäº¤çš„Append Shard1å‘½ä»¤åï¼Œä¸åº”è¯¥æ‰§è¡Œå‘½ä»¤ï¼Œåº”è¯¥è¿”å›é”™è¯¯ã€‚</p><p><strong>å¤„ç†æ–¹æ³•</strong></p><p>åœ¨<code>handleOperation</code>ä¸­ï¼Œé™¤äº†å¤„ç†é‡å¤å€¼å¤–ï¼Œè¿˜éœ€è¦åˆ¤æ–­Shardçš„åˆ†é…çŠ¶æ€ã€‚</p><h3 id=æ ¸å¿ƒä»£ç å®ç°>æ ¸å¿ƒä»£ç å®ç°</h3><h4 id=åˆ†ç‰‡è¿ç§»>åˆ†ç‰‡è¿ç§»</h4><blockquote><p>åˆ†ç‰‡è¿ç§»çš„å¼•å…¥ä¼šæ”¹å˜<code>handleOperation</code>æ–¹æ³•çš„é€»è¾‘ï¼Œå¯ä»¥å‚è€ƒ<a href=https://github.com/bestzy6/MIT6.5840 target=_blank>ä»“åº“ä»£ç </a>
ã€‚</p></blockquote><p>è¿ç§»çš„RPCçš„è¯·æ±‚å“åº”ç»“æ„ä½“å¦‚ä¸‹ï¼Œåœ¨è¯·æ±‚ä¸­ï¼Œé™¤å»å¿…è¦çš„Shardã€ConfigNumå’ŒKVsä»¥å¤–ï¼ŒClerkIdå’ŒReqIdç”¨äºå»é‡ï¼ŒAppliedç”¨äºè¿ç§»åçš„å»é‡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MigrateShardArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Shard</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConfigNum</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>KVs</span>       []<span style=color:#a6e22e>KV</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Applied</span>   <span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkId</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MigrateShardReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConfigNum</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Err</span>       <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»¥ä¸‹æ˜¯<code>MigrateShard</code>RPCæ–¹æ³•å®ç°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>MigrateShard</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MigrateShardArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MigrateShardReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] not Leader&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>ErrWrongLeader</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>ConfigNum</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Current ConfigNum:[%d] &lt; ConfigNum:[%d]&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>ErrWrongConfigNum</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> &gt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Current ConfigNum:[%d] &gt; ConfigNum:[%d]&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ShardsStatus</span>[<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>ShardStatusServing</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Already Serving&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Type</span>:       <span style=color:#a6e22e>OpTypeAddShard</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>:    <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:      <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shard</span>:      <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ShardData</span>:  <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>KVs</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ConfigNum</span>:  <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>AppliedLog</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Applied</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Success&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>SendShard</code>æœ‰æ„ŸçŸ¥åˆ°è‡ªèº«Shardå‘ç”Ÿå˜åŒ–çš„Leaderä¸»åŠ¨è°ƒç”¨ï¼Œå°†Shardæ•°æ®å‘é€è‡³æ–°çš„Serverã€‚åªæœ‰å½“RPCå“åº”æˆåŠŸåï¼Œæ‰ä¼šå°†æ•°æ®åº“ä¸­çš„Shardæ•°æ®åˆ é™¤ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>SendShard</span>(<span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>configNum</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>applied</span> <span style=color:#a6e22e>AppliedLog</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d not Leader&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>MigrateShardReply</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MigrateShardArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shard</span>:     <span style=color:#a6e22e>shard</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ConfigNum</span>: <span style=color:#a6e22e>configNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Applied</span>:   <span style=color:#a6e22e>applied</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>KVs</span>:       <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkId</span>:   <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:     <span style=color:#a6e22e>reqId</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>KVs</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>GetByShard</span>(<span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Shards</span>[<span style=color:#a6e22e>shard</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Groups</span>[<span style=color:#a6e22e>gid</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>servers</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>make_end</span>(<span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d To %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ok</span> = <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;ShardKV.MigrateShard&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d RPC failed&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OK</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d To %s Success&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>Type</span>:      <span style=color:#a6e22e>OpTypeRemoveShard</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ClerkID</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ReqId</span>:     <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqId</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>Shard</span>:     <span style=color:#a6e22e>shard</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ConfigNum</span>: <span style=color:#a6e22e>configNum</span>,
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] handle Op failed, Err: %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d Success&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrWrongLeader</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d failed,Err:%s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=åˆ†ç‰‡ç›‘å¬>åˆ†ç‰‡ç›‘å¬</h4><p>åŒç†ï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ¯50msç›‘å¬ä¸€æ¬¡ShardçŠ¶æ€ï¼Œå¦‚æœå­˜åœ¨éœ€è¦<code>Sending</code>çš„Shardï¼Œåˆ™ä¸»åŠ¨å‘é€RPCè¯·æ±‚ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>ShardWatcher</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ShardsStatus</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>ShardStatusSending</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] ShardWatcher is Preparing to Send Shard&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>NextReqId</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>SendShard</span>(<span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Copy</span>(), <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>NextReqId</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=æ˜“é”™ç‚¹-1>æ˜“é”™ç‚¹</h3><ol><li>åªæœ‰æ‰€æœ‰Shardsä¸å­˜åœ¨å¤„äºSendçš„çŠ¶æ€æ—¶ï¼Œå¯ä»¥æ›´æ–°Configï¼›</li><li>è¿ç§»åˆ†ç‰‡åè¦ä¿è¯å¹‚ç­‰æ€§ï¼›</li><li>æ—§é…ç½®çš„Serverä¸å…è®¸å¤„ç†æ–°é…ç½®çš„è¯·æ±‚ã€‚</li></ol></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#lab5a>Lab5A</a><ul><li><a href=#shardctrlerä»£ç å®ç°>ShardCtrlerä»£ç å®ç°</a></li><li><a href=#shardctrlerè´Ÿè½½å‡è¡¡>ShardCtrlerè´Ÿè½½å‡è¡¡</a></li><li><a href=#serveræ ¸å¿ƒä»£ç å®ç°>Serveræ ¸å¿ƒä»£ç å®ç°</a></li><li><a href=#æ˜“é”™ç‚¹>æ˜“é”™ç‚¹</a></li></ul></li><li><a href=#lab5b>Lab5B</a><ul><li><a href=#é…ç½®æ›´æ–°ç­–ç•¥>é…ç½®æ›´æ–°ç­–ç•¥</a></li><li><a href=#åˆ†ç‰‡è¿ç§»ç­–ç•¥>åˆ†ç‰‡è¿ç§»ç­–ç•¥</a></li><li><a href=#è¿ç§»åˆ†ç‰‡åçš„å»é‡å¤„ç†>è¿ç§»åˆ†ç‰‡åçš„å»é‡å¤„ç†</a></li><li><a href=#åˆ†ç‰‡è¿ç§»æ•°æ®ä¸¢å¤±é—®é¢˜>åˆ†ç‰‡è¿ç§»æ•°æ®ä¸¢å¤±é—®é¢˜</a></li><li><a href=#æ ¸å¿ƒä»£ç å®ç°>æ ¸å¿ƒä»£ç å®ç°</a></li><li><a href=#æ˜“é”™ç‚¹-1>æ˜“é”™ç‚¹</a></li></ul></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>ğŸ‘‹ Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyyå¹´MMæœˆddæ—¥")})}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>