<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>k8sé›†ç¾¤æ­å»ºä¸éƒ¨ç½²è¯¦è§£ | Bestzy's Blog</title><link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/><meta name=author content="bestzy"><meta name=description content="æœ¬æ–‡è¯¦ç»†æè¿°äº†éƒ¨ç½²K8sé›†ç¾¤çš„æ­¥éª¤
"><meta name=keywords content="K8s"><meta name=generator content="Hugo 0.148.2"><meta property="og:url" content="https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="k8sé›†ç¾¤æ­å»ºä¸éƒ¨ç½²è¯¦è§£"><meta property="og:description" content="æœ¬æ–‡è¯¦ç»†æè¿°äº†éƒ¨ç½²K8sé›†ç¾¤çš„æ­¥éª¤"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-12T21:18:28+08:00"><meta property="article:modified_time" content="2025-05-12T21:18:28+08:00"><meta property="article:tag" content="K8s"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="k8sé›†ç¾¤æ­å»ºä¸éƒ¨ç½²è¯¦è§£"><meta name=twitter:description content="æœ¬æ–‡è¯¦ç»†æè¿°äº†éƒ¨ç½²K8sé›†ç¾¤çš„æ­¥éª¤"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=ç¿»è½¬ä¸€ä¸‹ï¼><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">ğŸš€å…ˆè¡Œå…¶äº‹ï¼Œåè‡»å…¶å–„ï¼Œå†æ±‚å…¶ä¼˜ï¼</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=æœç´¢><ion-icon name=search></ion-icon>æœç´¢</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=æœç´¢><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="k8sé›†ç¾¤æ­å»ºä¸éƒ¨ç½²è¯¦è§£"><meta itemprop=description content="æœ¬æ–‡è¯¦ç»†æè¿°äº†éƒ¨ç½²K8sé›†ç¾¤çš„æ­¥éª¤"><meta itemprop=datePublished content="2025-05-12T21:18:28+08:00"><meta itemprop=dateModified content="2025-05-12T21:18:28+08:00"><meta itemprop=wordCount content="4211"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="K8s"><header><h1 itemprop=headline>k8sé›†ç¾¤æ­å»ºä¸éƒ¨ç½²è¯¦è§£</h1><p class=text-sm><span data-format=luxon>2025-05-12T21:18:28+08:00</span>
| <span>9åˆ†é’Ÿé˜…è¯»</span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0! src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=k8s%e9%9b%86%e7%be%a4%e6%90%ad%e5%bb%ba%e4%b8%8e%e9%83%a8%e7%bd%b2%e8%af%a6%e8%a7%a3&amp;url=https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/k8s-cluster-setup-deployment-guide/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://i0.hdslb.com/bfs/openplatform/0ce8c5f06ceb47f7f2a7547eacf89832b3366a34.jpg alt=k8sé›†ç¾¤æ­å»ºä¸éƒ¨ç½²è¯¦è§£><p>æœ¬æ–‡è¯¦ç»†æè¿°äº†éƒ¨ç½²K8sé›†ç¾¤çš„æ­¥éª¤</p><h2 id=å‰æœŸå‡†å¤‡>å‰æœŸå‡†å¤‡</h2><p>æœ¬æ–‡ä½¿ç”¨K8sçš„1.28ç‰ˆæœ¬ã€‚æ³¨æ„ï¼Œåœ¨æ—©æœŸï¼ŒDocker æ˜¯ Kubernetes ä¸»è¦æ”¯æŒçš„è¿è¡Œæ—¶ï¼ŒKubernetes ä½¿ç”¨äº†ä¸€ä¸ªå«åš dockershim çš„å†…ç½®ç»„ä»¶æ¥è¿æ¥åˆ° Docker Engine çš„ APIã€‚ä½†ä» Kubernetes 1.24 ç‰ˆæœ¬å¼€å§‹ï¼Œdockershim è¢«ç§»é™¤äº†ã€‚ è¿™æ„å‘³ç€ Kubelet ä¸å†å†…ç½®ä¸ Docker API ç›´æ¥é€šä¿¡çš„èƒ½åŠ›ã€‚æœ¬æ–‡ä¸ä½¿ç”¨dockerå®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œä½¿ç”¨containedã€‚</p><h3 id=æœåŠ¡å™¨é…ç½®>æœåŠ¡å™¨é…ç½®</h3><table><thead><tr><th>ä¸»æœºåç§°</th><th>IP</th><th>OS</th><th>CPU</th><th>å†…å­˜</th><th>ç£ç›˜</th></tr></thead><tbody><tr><td>bestzy-master</td><td>192.168.154.100</td><td>Ubuntu-22.04-live-server</td><td>2æ ¸</td><td>2G</td><td>30GB</td></tr><tr><td>bestzy-node1</td><td>192.168.154.101</td><td>Ubuntu-22.04-live-server</td><td>2æ ¸</td><td>2G</td><td>30GB</td></tr><tr><td>bestzy-node2</td><td>192.168.154.102</td><td>Ubuntu-22.04-live-server</td><td>2æ ¸</td><td>2G</td><td>30GB</td></tr></tbody></table><h3 id=æ›´æ¢apté•œåƒæº>æ›´æ¢apté•œåƒæº</h3><p>å¦‚æœé•œåƒæºæ˜¯å›½å¤–çš„ï¼Œå»ºè®®æ›´æ¢ä¸ºå›½å†…çš„é˜¿é‡Œäº‘ã€‚</p><p>apté•œåƒæºæ–‡ä»¶ä¸€èˆ¬æ˜¯<code>/etc/apt/sources.list</code>ï¼Œå»ºè®®ä¿®æ”¹ä¹‹å‰å…ˆå¤‡ä»½è¯¥æ–‡ä»¶ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>cp /etc/apt/sources.list /etc/apt/sources.list.bak
</span></span></code></pre></div><p>ç„¶åå°†ç”¨ä»¥ä¸‹å†…å®¹æ›¿æ¢æ‰<code>/etc/apt/sources.list</code>ä¸­çš„å†…å®¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
</span></span><span style=display:flex><span>deb http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
</span></span><span style=display:flex><span>deb-src http://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
</span></span></code></pre></div><h3 id=å›ºå®šip>å›ºå®šIP</h3><p>Netplan è¿™æ˜¯ Ubuntu 18.04 LTS åŠä»¥åç‰ˆæœ¬ä½¿ç”¨çš„é»˜è®¤ç½‘ç»œç®¡ç†å·¥å…·ã€‚å®ƒä½¿ç”¨ YAML æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚</p><p>è¿›å…¥<code>/etc/netplan</code>ï¼Œæ‰¾åˆ°ç›®å½•ä¸‹çš„<code>*.yaml</code>æ–‡ä»¶ï¼Œå»ºè®®å…ˆå°†æ–‡ä»¶å¤‡ä»½ã€‚</p><p><img src=https://i0.hdslb.com/bfs/openplatform/1b4629a8b66d83eaa3febb6cefec0f1df1813152.png alt></p><p>ä¿®æ”¹<code>addresses</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src=https://i0.hdslb.com/bfs/openplatform/ed2d4043669c56b73d73da3b8fd1973494a5e308.png alt></p><p>ä¿®æ”¹äº†<code>/etc/netplan/*.yaml</code>æ–‡ä»¶åï¼Œå…ˆæ‰§è¡Œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo netplan try
</span></span></code></pre></div><blockquote><p>è¿™ä¸ªå‘½ä»¤ä¼šæµ‹è¯•ä½ çš„ YAML é…ç½®æ–‡ä»¶çš„è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œå¹¶å°è¯•åº”ç”¨é…ç½®ã€‚å¦‚æœæ–°çš„é…ç½®å¯¼è‡´ç½‘ç»œä¸­æ–­ï¼Œå®ƒä¼šåœ¨æŒ‡å®šçš„æ—¶é—´åè‡ªåŠ¨å›æ»šåˆ°ä¹‹å‰çš„é…ç½®ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å®‰å…¨æªæ–½ï¼Œä»¥é˜²ä½ ä¸å°å¿ƒæŠŠè‡ªå·±é”åœ¨æœåŠ¡å™¨å¤–é¢ã€‚å¦‚æœæµ‹è¯•æˆåŠŸï¼Œå®ƒä¼šæç¤ºä½  &ldquo;Configuration accepted.&rdquo; å¹¶è®©ä½ æŒ‰ Enter ç¡®è®¤ã€‚</p></blockquote><p>ç„¶åå†æ‰§è¡Œå³å¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo netplan apply
</span></span></code></pre></div><blockquote><p>è¿™ä¸ªå‘½ä»¤ä¼šæ£€æŸ¥ä½ çš„ YAML é…ç½®æ–‡ä»¶çš„è¯­æ³•ï¼Œå°†å…¶ç¿»è¯‘æˆåç«¯ï¼ˆsystemd-networkd æˆ– NetworkManagerï¼‰å¯ä»¥ç†è§£çš„é…ç½®ï¼Œç„¶åæŒ‡ç¤ºåç«¯å»åº”ç”¨è¿™äº›é…ç½®ã€‚</p></blockquote><p>ä¸è¿‡ï¼Œæ³¨é‡Š<strong>è­¦å‘Š</strong>è¯´ï¼Œå¦‚æœä½ ç›´æ¥ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Œä½ çš„ä¿®æ”¹å¯èƒ½åœ¨ç³»ç»Ÿé‡å¯åå¤±æ•ˆï¼Œå› ä¸º cloud-init å¯èƒ½ä¼šé‡æ–°ç”Ÿæˆæˆ–è¦†ç›–å®ƒã€‚</p><p>å¦‚æœä½ å¸Œæœ›è¿™ä¸ªé™æ€ IP é…ç½®åœ¨é‡å¯åä¾ç„¶ç”Ÿæ•ˆï¼Œå¹¶ä¸”ä½ ç¡®å®šä¸éœ€è¦ cloud-init æ¥ç®¡ç†ç½‘ç»œï¼ˆæˆ–è€…ä½ æƒ³é€šè¿‡ cloud-init çš„æ–¹å¼å»æŒ‡å®šè¿™ä¸ªé™æ€ IPï¼Œä½†è¿™è¶…å‡ºäº†åŸºç¡€çš„ç½‘ç»œæ–‡ä»¶é…ç½®èŒƒç•´ï¼‰ï¼Œä½ éœ€è¦æŒ‰ç…§æ³¨é‡Šä¸­çš„å»ºè®®ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼ˆä¾‹å¦‚ /etc/cloud/cloud.cfg.d/99-disable-network-config.cfgï¼‰å¹¶å†™å…¥ network: {config: disabled} æ¥ç¦ç”¨ cloud-init çš„ç½‘ç»œé…ç½®åŠŸèƒ½ã€‚</p><h3 id=ç¦ç”¨swapåˆ†åŒº>ç¦ç”¨swapåˆ†åŒº</h3><p>åœ¨/etc/fstabæ–‡ä»¶ä¸­æ³¨è§†æ‰äº¤æ¢å†…å­˜</p><p><img src=https://i0.hdslb.com/bfs/openplatform/f1b8e01e0a522a68ee406e4f2368d43736ffb86a.png alt></p><h3 id=å°†æ¡¥æ¥çš„ipv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾>å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ç¡®ä¿ br_netfilter æ¨¡å—å·²åŠ è½½</span>
</span></span><span style=display:flex><span>sudo modprobe br_netfilter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºæˆ–ç¼–è¾‘ sysctl é…ç½®æ–‡ä»¶</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;net.bridge.bridge-nf-call-iptables = 1&#34;</span> | sudo tee /etc/sysctl.d/k8s.conf
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;net.bridge.bridge-nf-call-ip6tables = 1&#34;</span> | sudo tee -a /etc/sysctl.d/k8s.conf <span style=color:#75715e># -a å‚æ•°è¡¨ç¤ºè¿½åŠ è€Œéè¦†ç›–</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åº”ç”¨ sysctl é…ç½®</span>
</span></span><span style=display:flex><span>sudo sysctl --system
</span></span></code></pre></div><ul><li><strong>br_netfilter æ¨¡å—</strong>ï¼š è¿™ä¸ªå†…æ ¸æ¨¡å—æ˜¯å®ç°ç½‘ç»œæ¡¥æ¥æµé‡ä¸ netfilter(iptables) æ¡†æ¶é›†æˆçš„å…³é”®ã€‚åŠ è½½è¿™ä¸ªæ¨¡å—åï¼ŒLinux å†…æ ¸å°±å…·å¤‡äº†è®©æ¡¥æ¥æµé‡é€šè¿‡ iptables çš„èƒ½åŠ›ã€‚</li><li><strong>net.bridge.bridge-nf-call-iptables = 1</strong>ï¼š è¿™ä¸ªå†…æ ¸å‚æ•°ï¼ˆé€šè¿‡ sysctl è®¾ç½®ï¼‰æ˜¯å‘Šè¯‰å†…æ ¸ï¼Œå½“ br_netfilter æ¨¡å—åŠ è½½æ—¶ï¼Œå¯¹äºæ¡¥æ¥æµé‡ï¼Œæ˜¯å¦è¦å°†å®ƒä»¬ä¼ é€’ç»™ iptables çš„é“¾è¿›è¡Œå¤„ç†ã€‚è®¾ç½®ä¸º 1 è¡¨ç¤ºâ€œæ˜¯ï¼Œå°†æ¡¥æ¥æµé‡ä¹Ÿå‘é€ç»™ iptables å¤„ç†â€ã€‚</li></ul><p>å½“ä¸€ä¸ª Pod å°è¯•è®¿é—®åŒä¸€èŠ‚ç‚¹ä¸Šçš„å¦ä¸€ä¸ª Pod é€šè¿‡å…¶ Service IP æ—¶ï¼Œæµé‡å¯èƒ½ä¼šé€šè¿‡æœ¬åœ°çš„ç½‘ç»œæ¡¥æ¥ã€‚Linux å†…æ ¸çš„ iptables/netfilter æ¡†æ¶éå¸¸å¼ºå¤§ï¼Œå¯ä»¥æ£€æŸ¥å’Œä¿®æ”¹ç½‘ç»œæ•°æ®åŒ…ã€‚ç„¶è€Œï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæµç»<strong>ç½‘ç»œæ¡¥æ¥</strong>çš„æµé‡å¯èƒ½ <strong>ä¸ä¼š</strong>ç»è¿‡æ ‡å‡†çš„ iptables é“¾ã€‚å®ƒä»¬å¯èƒ½åœ¨ç½‘ç»œæ¡¥æ¥å†…éƒ¨å°±è¢«ç›´æ¥è½¬å‘äº†ã€‚</p><p>å¦‚æœ <code>bridge-nf-call-iptables</code> æ²¡æœ‰å¯ç”¨ (=0)ï¼Œé‚£ä¹ˆè¿™ä¸ªæµé‡åœ¨ç»è¿‡æ¡¥æ¥æ—¶ï¼Œå¾ˆå¯èƒ½å°±ä¸ä¼šè¢« kube-proxy è®¾ç½®çš„é‚£äº›å°† Service IP è½¬å‘åˆ° Pod IP çš„ iptables è§„åˆ™æ‰€æ•è·å’Œå¤„ç†ã€‚ç»“æœå°±æ˜¯ï¼Œè®¿é—® Service IP çš„è¯·æ±‚æ— æ³•æ­£ç¡®åœ°è½¬å‘åˆ°åç«¯çš„ Podï¼Œå¯¼è‡´ç½‘ç»œä¸é€šæˆ–æœåŠ¡è®¿é—®å¤±è´¥ã€‚</p><p>å¯ç”¨ <code>bridge-nf-call-iptables=1</code> ç¡®ä¿äº†å³ä½¿æ˜¯æµç»ç½‘ç»œæ¡¥æ¥çš„æ•°æ®åŒ…ï¼Œä¹Ÿä¼šè¢« iptables è§„åˆ™æ£€æŸ¥åˆ°ï¼Œè¿™æ · kube-proxy è®¾ç½®çš„ Service è½¬å‘è§„åˆ™æ‰èƒ½æ­£ç¡®åº”ç”¨ï¼Œä¿è¯é›†ç¾¤å†…éƒ¨ Service çš„å¯è¾¾æ€§ã€‚</p><h2 id=å®‰è£…>å®‰è£…</h2><h3 id=kubeä¸‰ä»¶å¥—>Kubeä¸‰ä»¶å¥—</h3><p>kubectl kubelet kubeadm ä¸‰ä»¶å¥—éœ€è¦å®‰è£…å…¬å…±ç­¾åå¯†é’¥</p><table><thead><tr><th>ç‰¹æ€§</th><th>kubeadm</th><th>kubectl</th><th>kubelet</th></tr></thead><tbody><tr><td>ä¸»è¦è§’è‰²</td><td>é›†ç¾¤å¼•å¯¼/å®‰è£…å·¥å…·</td><td>é›†ç¾¤å‘½ä»¤è¡Œå®¢æˆ·ç«¯/ç®¡ç†å·¥å…·</td><td>èŠ‚ç‚¹ä»£ç†/æ‰§è¡Œè€…</td></tr><tr><td>åšä»€ä¹ˆ</td><td>æ­å»ºé›†ç¾¤éª¨æ¶ï¼Œå®‰è£…é…ç½®æ ¸å¿ƒç»„ä»¶/èŠ‚ç‚¹</td><td>ä¸ API Server äº¤äº’ï¼Œç®¡ç†åº”ç”¨å’Œé›†ç¾¤èµ„æº</td><td>è¿è¡Œåœ¨èŠ‚ç‚¹ä¸Šï¼Œæ ¹æ® API Server æŒ‡ä»¤ç®¡ç†å®¹å™¨</td></tr><tr><td>åœ¨å“ªé‡Œè¿è¡Œ</td><td>åœ¨éœ€è¦å®‰è£…/åŠ å…¥é›†ç¾¤çš„æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨æ‰§è¡Œ</td><td>åœ¨ç”¨æˆ·çš„æœ¬åœ°æœºå™¨æˆ–ç®¡ç†æœåŠ¡å™¨ä¸Šæ‰§è¡Œ</td><td>é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Š ä½œä¸ºä¸€ä¸ªæœåŠ¡æŒç»­è¿è¡Œ</td></tr><tr><td>è°ä½¿ç”¨</td><td>é›†ç¾¤ç®¡ç†å‘˜/æ­å»ºè€…</td><td>æ‰€æœ‰ä¸é›†ç¾¤äº¤äº’çš„ç”¨æˆ·ï¼ˆå¼€å‘è€…ã€è¿ç»´ã€ç®¡ç†å‘˜ï¼‰</td><td>Kubernetes ç³»ç»Ÿæœ¬èº«ï¼ˆå†…éƒ¨ç»„ä»¶ï¼‰</td></tr><tr><td>ä¸è°äº¤äº’</td><td>ç³»ç»ŸæœåŠ¡ã€å®¹å™¨è¿è¡Œæ—¶ã€ç”Ÿæˆé…ç½®/è¯ä¹¦ç­‰</td><td>Kubernetes API Server</td><td>API Server å’Œ å®¹å™¨è¿è¡Œæ—¶</td></tr><tr><td>ç”Ÿå‘½å‘¨æœŸ</td><td>æ‰§è¡Œå‘½ä»¤æ—¶è¿è¡Œ</td><td>æ‰§è¡Œå‘½ä»¤æ—¶è¿è¡Œ</td><td>èŠ‚ç‚¹è¿è¡ŒæœŸé—´æŒç»­è¿è¡Œä¸ºä¸€ä¸ªæœåŠ¡</td></tr><tr><td>ç›®çš„</td><td>é›†ç¾¤ Setup</td><td>é›†ç¾¤ Operation/Management</td><td>èŠ‚ç‚¹ Pod/Container Execution</td></tr></tbody></table><ol><li>å®‰è£…å¿…è¦çš„åŒ…</li></ol><p>å…ˆæ›´æ–°åŒ…ç‰ˆæœ¬ï¼Œå®‰è£…ä¸€äº›å¿…é¡»çš„åŒ…â€”â€”apt-transport-httpsã€ca-certificatesã€curlã€gpgï¼Œ</p><ul><li><strong>apt-transport-https</strong>: å¦‚æœéœ€è¦çš„è¯ï¼Œå®‰è£…è¿™ä¸ªåŒ…ä»¥æ”¯æŒ HTTPS åè®®çš„è½¯ä»¶æºã€‚<ul><li>ä¸€èˆ¬è¾ƒæ–°çš„apté€šå¸¸å·²ç»å†…ç½®äº† HTTPS æ”¯æŒï¼Œ<strong>æ‰€ä»¥è¿™ä¸ªåŒ…æœ‰æ—¶æ˜¯è™šæ‹Ÿçš„æˆ–ä¸å¿…è¦çš„</strong>ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥è·³è¿‡è¿™ä¸ªåŒ…ã€‚</li></ul></li><li><strong>ca-certificates</strong>: å®‰è£…åŒ…å«å…¬å…±è¯ä¹¦é¢å‘æœºæ„è¯ä¹¦çš„è½¯ä»¶åŒ…ã€‚è¿™è®©ä½ çš„ç³»ç»Ÿèƒ½å¤ŸéªŒè¯é€šè¿‡ SSL/TLS è¿æ¥ï¼ˆå¦‚ HTTPSï¼‰ä¸‹è½½çš„æ•°æ®çš„æ¥æºæ˜¯å¦å¯ä¿¡ã€‚</li><li><strong>curl</strong>: å®‰è£…ä¸€ä¸ªå¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºé€šè¿‡å„ç§åè®®ï¼ˆåŒ…æ‹¬ HTTPSï¼‰ä¼ è¾“æ•°æ®ã€‚è¿™é‡Œç”¨äºä¸‹è½½ Kubernetes è½¯ä»¶æºçš„ GPG å¯†é’¥ã€‚</li><li><strong>gpg</strong>: å®‰è£… GNU Privacy Guard å·¥å…·ï¼Œç”¨äºå¤„ç†åŠ å¯†ç­¾åã€‚è¿™é‡Œç”¨äºå¤„ç†ä¸‹è½½çš„ GPG å¯†é’¥ï¼Œä»¥ä¾¿ apt èƒ½å¤ŸéªŒè¯è½¯ä»¶åŒ…çš„çœŸå®æ€§ã€‚</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install -y apt-transport-https ca-certificates curl gpg
</span></span></code></pre></div><ol><li>æ·»åŠ GPGç­¾åå¯†é’¥</li></ol><p>ä»é˜¿é‡Œäº‘ä¸‹è½½ç”¨äºéªŒè¯å…¶è½¯ä»¶åŒ…çš„å…¬é’¥ï¼Œå¹¶å°†å…¶å®‰å…¨åœ°å­˜å‚¨åˆ° APT çš„å¯†é’¥ç¯ç›®å½•ä¸­ï¼Œä»¥ä¾¿ apt åœ¨ä¸‹è½½å’Œå®‰è£… Kubernetes è½¯ä»¶åŒ…æ—¶å¯ä»¥éªŒè¯å…¶ç­¾åã€‚</p><p>æ³¨æ„ï¼š è¿™é‡Œçš„ URL ( /v1.28/ ) æŒ‡å®šäº†æ˜¯é’ˆå¯¹ v1.28 ç‰ˆæœ¬çš„å¯†é’¥ï¼Œè¿™è¡¨æ˜ä½ åç»­å®‰è£…çš„è½¯ä»¶åŒ…å°†æ˜¯ v1.28 æˆ–å…¼å®¹ç‰ˆæœ¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</span></span></code></pre></div><ol><li>æ·»åŠ é•œåƒæº</li></ol><p>å°† Kubernetes è½¯ä»¶åŒ…æºçš„é…ç½®ä¿¡æ¯ï¼ˆæŒ‡å‘é˜¿é‡Œäº‘é•œåƒç«™çš„ v1.28 ç‰ˆæœ¬æºï¼Œå¹¶æŒ‡å®šç”¨äºéªŒè¯ç­¾åçš„ GPG å¯†é’¥æ–‡ä»¶ï¼‰å†™å…¥åˆ° /etc/apt/sources.list.d/ ç›®å½•ä¸‹çš„ kubernetes.list æ–‡ä»¶ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/deb/ /&#34;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span></code></pre></div><ol><li>å®‰è£…ä¸‰ä»¶å¥—</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install -y kubelet kubeadm kubectl
</span></span></code></pre></div><p>å®‰è£…å®Œæˆåè¿è¡Œkubelet</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable kubelet
</span></span><span style=display:flex><span>sudo systemctl start kubelet
</span></span></code></pre></div><h3 id=å®‰è£…containerd>å®‰è£…Containerd</h3><p>å®‰è£…<code>containerd</code>ä¸å®‰è£…<code>docker</code>æµç¨‹åŸºæœ¬ä¸€è‡´ï¼Œå·®åˆ«åœ¨äºä¸éœ€è¦å®‰è£…docker-ceã€‚</p><ol><li>å®‰è£…å¿…è¦çš„åŒ…</li></ol><p><code>lsb-release</code>æ˜¾ç¤ºå…³äº Linux Standard Base (LSB) å’Œ Linux å‘è¡Œç‰ˆçš„ä¿¡æ¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt install lsb-release
</span></span></code></pre></div><ol><li>æ·»åŠ GPGç­¾å</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker-apt-keyring.gpg
</span></span></code></pre></div><ol><li>æ·»åŠ é•œåƒä»“åº“</li></ol><p>ä½¿ç”¨ $(lsb_release -cs) å¯ä»¥ç¡®ä¿ APT ä»“åº“çš„é…ç½®æŒ‡å‘é€‚ç”¨äºä½ å½“å‰ Ubuntu ç‰ˆæœ¬çš„ Docker è½¯ä»¶åŒ…ç›®å½•ï¼Œé¿å…å®‰è£…äº†ä¸å…¼å®¹çš„è½¯ä»¶åŒ…ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb [arch=</span><span style=color:#66d9ef>$(</span>dpkg --print-architecture<span style=color:#66d9ef>)</span><span style=color:#e6db74> signed-by=/etc/apt/keyrings/docker-apt-keyring.gpg] https://download.docker.com/linux/ubuntu </span><span style=color:#66d9ef>$(</span>lsb_release -cs<span style=color:#66d9ef>)</span><span style=color:#e6db74> stable&#34;</span> | sudo tee /etc/apt/sources.list.d/docker.list
</span></span></code></pre></div><ol><li>å®‰è£…</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo apt-get update <span style=color:#f92672>&amp;&amp;</span> sudo apt-get install -y containerd.io
</span></span></code></pre></div><p>æŸ¥çœ‹è¿è¡ŒçŠ¶æ€</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable containerd
</span></span><span style=display:flex><span>sudo systemctl start containerd
</span></span><span style=display:flex><span>sudo systemctl status containerd
</span></span></code></pre></div><ol><li>ä¿®æ”¹é…ç½®</li></ol><p>å…ˆç”Ÿæˆcontainerdçš„é»˜è®¤é…ç½®</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo containerd config default | sudo tee /etc/containerd/config.toml
</span></span></code></pre></div><p>å†ä¿®æ”¹CgroupDriverä¸ºsystemdï¼Œk8så®˜æ–¹æ¨èä½¿ç”¨systemdç±»å‹çš„CgroupDriver</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>containerd</span>.<span style=color:#a6e22e>runtimes</span>.<span style=color:#a6e22e>runc</span>]
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>containerd</span>.<span style=color:#a6e22e>runtimes</span>.<span style=color:#a6e22e>runc</span>.<span style=color:#a6e22e>options</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SystemdCgroup</span> = <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>æ¥ä¸‹æ¥ä¿®æ”¹é•œåƒæºï¼Œæ‰¾åˆ°<code>registry.mirrors</code>æ‰€åœ¨ä½ç½®ï¼Œæ·»åŠ å¦‚ä¸‹æ‰€ç¤ºé…ç½®ã€‚</p><ul><li><code>docker.io</code> æ˜¯ Docker Hub çš„å®˜æ–¹åœ°å€ï¼Œç»å¤§å¤šæ•°å…¬å…±é•œåƒéƒ½æ¥æºäºæ­¤ï¼Œé…ç½® <code>docker.io</code> çš„åŠ é€Ÿå™¨æ˜¯æœ€å¸¸è§çš„éœ€æ±‚ã€‚</li><li>å¯¹äº Kubernetes è‡ªå·±çš„æ ¸å¿ƒé•œåƒ (å¦‚ kube-apiserver, kube-controller-manager ç­‰)ï¼Œåœ¨ Kubernetes 1.25 ä¹‹å‰å®ƒä»¬ä¸»è¦æ‰˜ç®¡åœ¨ <code>k8s.gcr.io</code>ï¼Œ1.25 åŠä¹‹åè¿ç§»åˆ°äº† <code>registry.k8s.io</code>ã€‚æˆ‘ä»¬å°†<code>registry.k8s.io</code>åŠ é€Ÿã€‚</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>    [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>]
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>config_path</span> = <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>auths</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>configs</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>headers</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>mirrors</span>]
</span></span><span style=display:flex><span>       [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>mirrors</span>.<span style=color:#e6db74>&#34;docker.io&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endpoint</span>=[<span style=color:#e6db74>&#34;https://docker.m.daocloud.io&#34;</span>]
</span></span><span style=display:flex><span>       [<span style=color:#a6e22e>plugins</span>.<span style=color:#e6db74>&#34;io.containerd.grpc.v1.cri&#34;</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>mirrors</span>.<span style=color:#e6db74>&#34;registry.k8s.io&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endpoint</span>=[<span style=color:#e6db74>&#34;https://k8s.m.daocloud.io&#34;</span>]
</span></span></code></pre></div><p>æœ€åï¼Œé‡å¯containerd</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl restart containerd
</span></span></code></pre></div><p>å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹æ˜¯å¦å°†é•œåƒä¿®æ”¹æˆåŠŸã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo crictl info
</span></span></code></pre></div><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¡¨ç¤ºæˆåŠŸäº†ã€‚</p><p><img src=https://i0.hdslb.com/bfs/openplatform/a0ab7c3dc1c12f60f0a1c391c6ea3dc173523cf4.png alt></p><h2 id=éƒ¨ç½²>éƒ¨ç½²</h2><h3 id=masterèŠ‚ç‚¹åˆå§‹åŒ–>MasterèŠ‚ç‚¹åˆå§‹åŒ–</h3><p>åœ¨<code>bestzy-master</code>ä¸»æœºä¸Šï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>sudo kubeadm init <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --apiserver-advertise-address<span style=color:#f92672>=</span>192.168.154.100 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --image-repository registry.aliyuncs.com/google_containers <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --kubernetes-version v1.28.15 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --service-cidr<span style=color:#f92672>=</span>10.96.0.0/12 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --pod-network-cidr<span style=color:#f92672>=</span>10.244.0.0/16
</span></span></code></pre></div><ul><li><strong>&ndash;apiserver-advertise-address</strong> : å¡«æ§åˆ¶å¹³é¢èŠ‚ç‚¹æœ¬æœºçš„ã€å…¶ä»–èŠ‚ç‚¹å¯ä»¥è®¿é—®åˆ°çš„ IP åœ°å€ã€‚<ul><li>ç”¨ <code>ip a</code> æˆ– <code>ifconfig</code> æŸ¥çœ‹ã€‚åœ¨è¾“å‡ºä¸­æ‰¾åˆ°ä½ è¿æ¥å†…ç½‘çš„é‚£ä¸ªç½‘ç»œæ¥å£ï¼ˆæ¯”å¦‚ eth0 æˆ– ens33 ç­‰ï¼‰ï¼Œæ‰¾åˆ°å®ƒå¯¹åº”çš„ inet åœ°å€ã€‚è¿™ä¸ªåœ°å€å°±æ˜¯ä½ å¯ä»¥å¡«å†™çš„ <code>--apiserver-advertise-address</code>ã€‚</li></ul></li><li><strong>&ndash;image-repository</strong> ï¼šä½¿ç”¨è¿™ä¸ªå‚æ•°æŒ‡å®šå…¶ä»–çš„é•œåƒä»“åº“ï¼Œä¾‹å¦‚é˜¿é‡Œäº‘çš„ <code>registry.aliyuncs.com/google_containers</code>ã€‚è¿™æ · kubeadm å°±ä¼šä»è¿™é‡Œæ‹‰å–æ§åˆ¶å¹³é¢ç»„ä»¶çš„é•œåƒã€‚</li><li><strong>&ndash;kubernetes-version</strong> : æŒ‡å®šè¦å®‰è£…çš„ Kubernetes ç‰ˆæœ¬ï¼Œä¾‹å¦‚ v1.28.15ã€‚å¦‚æœä¸æŒ‡å®šï¼Œä¼šä½¿ç”¨å½“å‰å®‰è£…çš„ kubeadm é€‚é…çš„é»˜è®¤ç‰ˆæœ¬ã€‚</li><li><strong>&ndash;pod-network-cidr</strong> : å¡«ä¸€ä¸ªä¸º Pod å‡†å¤‡çš„ã€æœªè¢«å ç”¨çš„ã€ä¸ä¸ä½ çš„å®¿ä¸»æœºç½‘ç»œå’Œ Service ç½‘ç»œå†²çª çš„ IP åœ°å€æ®µã€‚è¿™ä¸ªå‚æ•°é€šå¸¸å–å†³äºä½ é€‰æ‹©çš„ CNI æ’ä»¶ï¼Œä¾‹å¦‚ Flannel çš„ 10.244.0.0/16 æˆ– Calico çš„ 192.168.0.0/16ã€‚</li><li><strong>&ndash;service-cidr</strong> : å¡«ä¸€ä¸ªä¸º Service å‡†å¤‡çš„ã€æœªè¢«å ç”¨çš„ã€ä¸ä¸ä½ çš„å®¿ä¸»æœºç½‘ç»œå’Œ Pod ç½‘ç»œå†²çª çš„ IP åœ°å€æ®µã€‚å¸¸è§çš„é€‰æ‹©æ˜¯ 10.96.0.0/12ã€‚</li></ul><p>æ˜¾ç¤º successfully è¡¨ç¤ºåˆå§‹åŒ–æˆåŠŸ</p><p><img src=https://i0.hdslb.com/bfs/openplatform/25d7f1d9f024d00f249ff341528dec4626e30393.png alt></p><h3 id=ä¿®æ”¹ç›®å½•æƒé™>ä¿®æ”¹ç›®å½•æƒé™</h3><p>è¦æƒ³ä½¿ç›¸å…³çš„ç»„ä»¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŒ‰æç¤ºå°†ç›®å½•ã€æƒé™è®¾ç½®æˆåŠŸã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span></code></pre></div><h3 id=æ·»åŠ nodeèŠ‚ç‚¹>æ·»åŠ NodeèŠ‚ç‚¹</h3><p>å¦‚æç¤ºæ‰€ç¤ºï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>bestzy-node1</code>ã€<code>bestzy-node2</code>ä¸»æœºä¸Šï¼Œåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubeadm join 192.168.154.100:6443 --token h1wtmw.rr8v9m4ym61wsd6d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        --discovery-token-ca-cert-hash sha256:5b4156b9e5849143330015a8e5912ec7ae345d3783a783a3872aa152a85df0c4
</span></span></code></pre></div><p>ä½†é»˜è®¤çš„tokenæœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œå½“è¿‡æœŸä¹‹åï¼Œè¯¥tokenå°±ä¸èƒ½ç”¨äº†ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤åˆ›å»ºtokenï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubeadm token create --print-join-command
</span></span></code></pre></div><p>æˆåŠŸæ·»åŠ NodeèŠ‚ç‚¹åä¼šæ˜¾ç¤ºå¦‚ä¸‹æ–‡å­—ã€‚</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=OGI1NDY4NzMwYjgxNWQyZjQxMjNhMmFjNjcxNmY2NDhfdGtkaFhMd0Y2NW1RbXJaWFkzdzlmb1N4bm1nRUZnb0JfVG9rZW46WVgwRWIyZEpUb3pRQ054OEN2OWMzRTlSbjhmXzE3NDcwNTQ1Mjc6MTc0NzA1ODEyN19WNA" alt=img></p><h3 id=éƒ¨ç½²cniç½‘ç»œæ’ä»¶>éƒ¨ç½²CNIç½‘ç»œæ’ä»¶</h3><p>æ ¹æ®æç¤ºï¼Œåœ¨MasterèŠ‚ç‚¹ä½¿ç”¨kubectlå·¥å…·æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img src=https://i0.hdslb.com/bfs/openplatform/d66080c573357cbbc97187d3976ab1f27ede090d.png alt></p><p><code>kubeadm init</code> å‘½ä»¤è´Ÿè´£åˆå§‹åŒ– Kubernetes æ§åˆ¶å¹³é¢ã€‚å®ƒä¼šä¸‹è½½å¹¶å¯åŠ¨æ§åˆ¶å¹³é¢æ‰€éœ€çš„ç»„ä»¶ï¼škube-apiserver, kube-controller-manager, kube-scheduler, etcd ç­‰ã€‚</p><p>ä½†<code>kubeadm init</code>å¹¶æ²¡æœ‰éƒ¨ç½²ä¸€ä¸ªå®é™…çš„ Pod ç½‘ç»œ æ¥æ»¡è¶³ä¸Šé¢æåˆ°çš„ Pod ä¹‹é—´ç›´æ¥é€šä¿¡çš„è¦æ±‚ã€‚å®ƒè®¾ç½®äº†ç½‘ç»œç¯å¢ƒçš„åŸºç¡€ï¼Œä½†å®ƒæ²¡æœ‰æä¾›ä¸€ä¸ªå…·ä½“çš„ç½‘ç»œå®ç°æ–¹æ¡ˆæ¥åˆ†é… Pod IP å¹¶å¤„ç†è·¨èŠ‚ç‚¹çš„æ•°æ®åŒ…è½¬å‘ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œ<code>kubeadm init</code> åªæ­å»ºäº†éª¨æ¶ï¼Œå¦‚æœæ²¡æœ‰éƒ¨ç½² CNI æ’ä»¶ï¼Œé‚£ä¹ˆ kubelet åœ¨å°è¯•å¯åŠ¨ Pod æ—¶ï¼Œä¼šå‘ç°æ²¡æœ‰ç»„ä»¶å¯ä»¥ä¸ºå…¶é…ç½®ç½‘ç»œæ¥å£å’Œ IP åœ°å€ï¼ˆè¿™æ˜¯ Pod å¯åŠ¨æµç¨‹ä¸­çš„å…³é”®ä¸€æ­¥ï¼‰ã€‚</p><p>æ­¤å¤„ï¼Œæˆ‘ä»¬é€‰æ‹©https://github.com/flannel-io/flannelï¼Œè¿›è¡Œå¿«é€Ÿéƒ¨ç½²</p><blockquote><p>æ³¨æ„ï¼Œè¯¥å‘½ä»¤ä¸èƒ½ä½¿ç”¨sudoï¼Œå½“ä½ ä½¿ç”¨ sudo æ‰§è¡Œ kubectl å‘½ä»¤æ—¶ï¼Œå‘½ä»¤æ˜¯ä»¥ root ç”¨æˆ·çš„èº«ä»½è¿è¡Œçš„ã€‚ kubectl åœ¨æŸ¥æ‰¾å…¶é…ç½®ï¼ˆkubeconfig æ–‡ä»¶ï¼Œé€šå¸¸æ˜¯ ~/.kube/configï¼‰æ—¶ï¼Œä¼šå» root ç”¨æˆ·çš„homeç›®å½•ï¼Œä¹Ÿå°±æ˜¯ /root/.kube/configã€‚è€Œæˆ‘ä»¬ä¹‹å‰é…ç½® kubectl çš„æ­¥éª¤ï¼ˆå°† /etc/kubernetes/admin.conf å¤åˆ¶åˆ° ~/.kube/config å¹¶ä¿®æ”¹æƒé™ï¼‰è¿™äº›å‘½ä»¤æ˜¯ä¸ºå½“å‰ç™»å½•ç”¨æˆ·é…ç½®çš„ã€‚</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
</span></span></code></pre></div><p><img src=https://i0.hdslb.com/bfs/openplatform/430c39db3967c1c44d3afa2dc7a02872d009d4a0.png alt></p><h3 id=å»é™¤æ±¡ç‚¹>å»é™¤æ±¡ç‚¹</h3><p>æ±¡ç‚¹ï¼ˆTaintï¼‰æ˜¯æ ‡è®°èŠ‚ç‚¹çš„ä¸€ç§æ–¹å¼ï¼Œç”¨æ¥é˜»æ­¢æŸäº› Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚</p><p>åˆå§‹æƒ…å†µä¸‹ï¼Œmasteræ˜¯æ±¡ç‚¹èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ€§çš„ä¸ºå®ƒå»é™¤æ±¡ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl describe node bestzy-master | grep -i taint
</span></span></code></pre></div><p>å‘½ä»¤å°†è¾“å‡ºï¼š</p><p><img src=https://i0.hdslb.com/bfs/openplatform/b1e8dc9cd3014f26f4dc89c9802979d2c445a5de.png alt></p><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆæ³¨æ„æœ«å°¾çš„<code>-</code>ï¼‰å°†ç§»é™¤æ±¡ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl taint node bestzy-master node-role.kubernetes.io/control-plane:NoSchedule-
</span></span></code></pre></div><h2 id=æµ‹è¯•>æµ‹è¯•</h2><h3 id=éƒ¨ç½²nginx>éƒ¨ç½²nginx</h3><p>å°è¯•éƒ¨ç½²ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼ŒéªŒè¯ Pod æ˜¯å¦å¯ä»¥è¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šå¹¶æˆåŠŸè¿è¡Œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl create deployment nginx --image<span style=color:#f92672>=</span>nginx
</span></span></code></pre></div><p><strong>é¢„æœŸè¾“å‡º</strong>ï¼š ä¼šåˆ›å»ºåä¸º nginx çš„ Deploymentã€‚</p><h3 id=æ£€æŸ¥çŠ¶æ€>æ£€æŸ¥çŠ¶æ€</h3><p>æ£€æŸ¥ <code>nginx Deployment</code> çš„çŠ¶æ€ï¼Œä»¥åŠå®ƒåˆ›å»ºçš„ Pod çš„çŠ¶æ€ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>kubectl get deployments
</span></span><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>Pod çš„çŠ¶æ€åº”è¯¥æœ€ç»ˆå˜ä¸º Runningã€‚</p><p><code>kubectl get pods -o wide</code> å¯ä»¥çœ‹åˆ° Pod è¢«è°ƒåº¦åˆ°äº†å“ªä¸ªèŠ‚ç‚¹ä¸Šã€‚</p><p><img src=https://i0.hdslb.com/bfs/openplatform/1f8f0c72f4ec76e1b6094261c93ef13828bc3632.png alt></p><h2 id=å‚è€ƒé“¾æ¥>å‚è€ƒé“¾æ¥</h2><ul><li><a href=https://developer.aliyun.com/mirror/kubernetes/ target=_blank>https://developer.aliyun.com/mirror/kubernetes/</a></li><li><a href=https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/ target=_blank>https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/</a></li></ul></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#å‰æœŸå‡†å¤‡>å‰æœŸå‡†å¤‡</a><ul><li><a href=#æœåŠ¡å™¨é…ç½®>æœåŠ¡å™¨é…ç½®</a></li><li><a href=#æ›´æ¢apté•œåƒæº>æ›´æ¢apté•œåƒæº</a></li><li><a href=#å›ºå®šip>å›ºå®šIP</a></li><li><a href=#ç¦ç”¨swapåˆ†åŒº>ç¦ç”¨swapåˆ†åŒº</a></li><li><a href=#å°†æ¡¥æ¥çš„ipv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾>å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾</a></li></ul></li><li><a href=#å®‰è£…>å®‰è£…</a><ul><li><a href=#kubeä¸‰ä»¶å¥—>Kubeä¸‰ä»¶å¥—</a></li><li><a href=#å®‰è£…containerd>å®‰è£…Containerd</a></li></ul></li><li><a href=#éƒ¨ç½²>éƒ¨ç½²</a><ul><li><a href=#masterèŠ‚ç‚¹åˆå§‹åŒ–>MasterèŠ‚ç‚¹åˆå§‹åŒ–</a></li><li><a href=#ä¿®æ”¹ç›®å½•æƒé™>ä¿®æ”¹ç›®å½•æƒé™</a></li><li><a href=#æ·»åŠ nodeèŠ‚ç‚¹>æ·»åŠ NodeèŠ‚ç‚¹</a></li><li><a href=#éƒ¨ç½²cniç½‘ç»œæ’ä»¶>éƒ¨ç½²CNIç½‘ç»œæ’ä»¶</a></li><li><a href=#å»é™¤æ±¡ç‚¹>å»é™¤æ±¡ç‚¹</a></li></ul></li><li><a href=#æµ‹è¯•>æµ‹è¯•</a><ul><li><a href=#éƒ¨ç½²nginx>éƒ¨ç½²nginx</a></li><li><a href=#æ£€æŸ¥çŠ¶æ€>æ£€æŸ¥çŠ¶æ€</a></li></ul></li><li><a href=#å‚è€ƒé“¾æ¥>å‚è€ƒé“¾æ¥</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>ğŸ‘‹ Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyyå¹´MMæœˆddæ—¥")})}</script><script src=/js/toc.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>