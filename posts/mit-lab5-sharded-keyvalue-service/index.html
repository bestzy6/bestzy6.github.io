<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>【MIT6.5840】Lab5-Sharded Key/Value Service | Bestzy's Blog</title>
<link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/><meta name=author content="bestzy"><meta name=description content="本文将介绍MIT6.5840的Lab5的核心功能实现，完整代码见Github。
"><meta name=keywords content="Shard Key/Value Service"><meta name=generator content="Hugo 0.146.3"><meta property="og:url" content="https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="【MIT6.5840】Lab5-Sharded Key/Value Service"><meta property="og:description" content="本文将介绍MIT6.5840的Lab5的核心功能实现，完整代码见Github。"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-16T22:48:11+08:00"><meta property="article:modified_time" content="2025-03-16T22:48:11+08:00"><meta property="article:tag" content="Shard Key/Value Service"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="【MIT6.5840】Lab5-Sharded Key/Value Service"><meta name=twitter:description content="本文将介绍MIT6.5840的Lab5的核心功能实现，完整代码见Github。"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">🚀先行其事，后臻其善，再求其优！</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=搜索><ion-icon name=search></ion-icon>搜索</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=搜索><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="【MIT6.5840】Lab5-Sharded Key/Value Service"><meta itemprop=description content="本文将介绍MIT6.5840的Lab5的核心功能实现，完整代码见Github。"><meta itemprop=datePublished content="2025-03-16T22:48:11+08:00"><meta itemprop=dateModified content="2025-03-16T22:48:11+08:00"><meta itemprop=wordCount content="6515"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="Shard Key/Value Service"><header><h1 itemprop=headline>【MIT6.5840】Lab5-Sharded Key/Value Service</h1><p class=text-sm><span data-format=luxon>2025-03-16T22:48:11+08:00</span>
| <span>14分钟阅读</span>
| <span>更新于
<span data-format=luxon>2025-03-16T22:48:11+08:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0! src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e3%80%90MIT6.5840%e3%80%91Lab5-Sharded%20Key/Value%20Service&amp;url=https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/mit-lab5-sharded-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://i0.hdslb.com/bfs/article/2ae63f480f1b505eefd034268b52b9a42099359.jpg@1e_1c.webp alt="【MIT6.5840】Lab5-Sharded Key/Value Service"><p>本文将介绍MIT6.5840的Lab5的核心功能实现，完整代码见Github。</p><p><a href=https://github.com/bestzy6/MIT6.5840 target=_blank>https://github.com/bestzy6/MIT6.5840</a></p><p>整个Lab5中，各部分的关系如下图所示。<code>Shardctrler-Cluster</code>存储了配置情况，<code>Client</code>和<code>Server</code>从中获取配置并完成一系列逻辑操作。</p><p><img src=https://i0.hdslb.com/bfs/article/3b504ea45a94c49aae3e51c1bdae02912099359.png@1e_1c.webp alt></p><h2 id=lab5a>Lab5A</h2><h3 id=shardctrler代码实现>ShardCtrler代码实现</h3><p>ShardCtrler几乎可以无脑复制Lab4的代码，Client与Server的主要流程是一致的，同样需要注意去重，RPC请求需要增加<code>ClerkID</code>与<code>ReqID</code>，但<strong>无需考虑快照</strong>。此文只讲解核心实现，具体可参考代码。</p><p>Op结构体如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Op</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Servers</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span> <span style=color:#75715e>//Join</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GIDs</span>    []<span style=color:#66d9ef>int</span>            <span style=color:#75715e>//Leave</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Shard</span>   <span style=color:#66d9ef>int</span>              <span style=color:#75715e>//Move</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GID</span>     <span style=color:#66d9ef>int</span>              <span style=color:#75715e>//Move</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Num</span>     <span style=color:#66d9ef>int</span>              <span style=color:#75715e>//Query</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkId</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>相较于Lab4，<code>handleOperation</code>方法中的数据库操作变更为<code>opExecutor</code>，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>opExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span> <span style=color:#a6e22e>Config</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Join</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>joinExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span> = append(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>, <span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Leave</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>leaveExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span> = append(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>, <span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Move</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>moveExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span> = append(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>, <span style=color:#a6e22e>cfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Query</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>queryExecutor</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Config</span>{}, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>根据任务要求，在进行Join、Leave操作后需要负载均衡处理。以下解释4个操作逻辑。</p><h4 id=joinleave>Join&amp;Leave</h4><blockquote><p>Join RPC 由管理员用于添加新的副本组。其参数是一组从唯一且非零的副本组标识符（GIDs）到服务器名称列表的映射。shardctrler 应通过创建包含新副本组的新配置来响应。新配置应尽可能均匀地在所有组之间分配分片，并且应尽可能少地移动分片以实现该目标。如果 GID 不是当前配置的一部分，shardctrler 应允许重新使用 GID（即，应允许 GID 先加入，然后离开，再重新加入）。</p><p>Leave RPC 的参数是之前加入的组的 GID 列表。shardctrler 应创建一个不包含这些组的新配置，并将这些组的分片分配给剩余的组。新配置应尽可能均匀地在组之间分配分片，并应尽可能少地移动分片以实现该目标。</p></blockquote><p>选取最后的配置并加入或移除Group，操作后的负载均衡后续进行详解。</p><p>需要注意的是，新配置的<code>map</code>必须<strong>深拷贝</strong>，否则当前的变动会影响到之前的配置。以下给出Join的代码，<strong>Leave与Join相似</strong>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>joinExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>servers</span> = <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Servers</span> <span style=color:#75715e>//GID -&gt; 服务名称</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfgNum</span>  = len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastCfg</span> = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>cfgNum</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 深拷贝，创建新的Groups</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] %v Join, Origin Shards:%v&#34;</span>, <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Shards</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newGroups</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span>, len(<span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Groups</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>srvs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Groups</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>newServices</span> = make([]<span style=color:#66d9ef>string</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>srvs</span>))         <span style=color:#75715e>// 服务名称</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ServicesMap</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>struct</span>{}, len(<span style=color:#a6e22e>srvs</span>)) <span style=color:#75715e>// 服务名称Set，用于去重</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>srvs</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>newServices</span> = append(<span style=color:#a6e22e>newServices</span>, <span style=color:#a6e22e>srv</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ServicesMap</span>[<span style=color:#a6e22e>srv</span>] = <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tmpServices</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>gid</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>tmpService</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>tmpServices</span> {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// 判断是否重复</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exist</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ServicesMap</span>[<span style=color:#a6e22e>tmpService</span>]; <span style=color:#a6e22e>exist</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>newServices</span> = append(<span style=color:#a6e22e>newServices</span>, <span style=color:#a6e22e>tmpService</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 删除GID，表示已经添加</span>
</span></span><span style=display:flex><span>          delete(<span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>gid</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newGroups</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>newServices</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果servers中的GID在原组中不存在，则servers长度不为0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>srvs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>servers</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newGroups</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>srvs</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] %v Join newGroups: %v&#34;</span>, <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>newGroups</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewBalancer</span>(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>).<span style=color:#a6e22e>ReBalanceShards</span>(<span style=color:#a6e22e>lastCfg</span>.<span style=color:#a6e22e>Shards</span>, <span style=color:#a6e22e>newGroups</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] %v Join balanced Shards: %v&#34;</span>, <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>shards</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Num</span>:    <span style=color:#a6e22e>cfgNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shards</span>: <span style=color:#a6e22e>shards</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Groups</span>: <span style=color:#a6e22e>newGroups</span>,
</span></span><span style=display:flex><span>    }, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=move>Move</h4><blockquote><p>Move RPC 的参数是一个分片编号和一个 GID。shardctrler 应创建一个新配置，将分片分配给该组。 Move 的目的是让我们能够测试您的软件。在 Move 之后的 Join 或 Leave 可能会撤销 Move ，因为 Join 和 Leave 会重新平衡。</p></blockquote><p>并没有需要特别注意的点，与Join&amp;Leave一样深拷贝Groups字段即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>moveExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>shard</span>  = <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Shard</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>gid</span>    = <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>GID</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfgNum</span> = len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>cfg</span>    = <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>cfgNum</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 深拷贝</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newGroups</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span>, len(<span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Groups</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>srvs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Groups</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newSrvs</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>string</span>, len(<span style=color:#a6e22e>srvs</span>))
</span></span><span style=display:flex><span>       copy(<span style=color:#a6e22e>newSrvs</span>, <span style=color:#a6e22e>srvs</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newGroups</span>[<span style=color:#a6e22e>id</span>] = <span style=color:#a6e22e>newSrvs</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>newShards</span> [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Shards</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>shard</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>newShards</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>gid</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newShards</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Shards</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newConfig</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Num</span>:    <span style=color:#a6e22e>cfgNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shards</span>: <span style=color:#a6e22e>newShards</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Groups</span>: <span style=color:#a6e22e>newGroups</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newConfig</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=query>Query</h4><blockquote><p>Query RPC 的参数是一个配置编号。shardctrler 会回复具有该编号的配置。如果编号为 -1 或大于已知的最大配置编号，shardctrler 应回复最新的配置。 Query(-1) 的结果应反映 shardctrler 在接收 Query(-1) RPC 之前完成处理的每个 Join 、 Leave 或 Move RPC。</p></blockquote><p>用于查询指定编号的配置。根据任务的要求，如果序号传入-1或者大于配置号，则返回最新的配置。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardCtrler</span>) <span style=color:#a6e22e>queryExecutor</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#a6e22e>Config</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>num</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Num</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>num</span> &lt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>num</span> <span style=color:#f92672>&gt;=</span> len(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cfg</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>num</span>], <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=shardctrler负载均衡>ShardCtrler负载均衡</h3><p>Lab5A中的难点是实现负载均衡。假设存在4个Group，以及10个Shard，将Group按照Shard数量倒序排序，此时负载状态如下图所示：</p><p><img src=https://i0.hdslb.com/bfs/article/5e00a2f7924d7a3b5bd44b482aaa1c702099359.png@1e_1c.webp alt></p><p>显然Group的平均Shard数为2（10/4=2）。如果我们将Group中大于Avg的Shard截取，再将截取的Shard分配给Shard数量小于等于Avg的Group中，那么以上负载状态将会多出2个Shard，如下图所示：</p><p><img src=https://i0.hdslb.com/bfs/article/c2f13e7beacc6eadf788e4807ee1bdf72099359.png@1e_1c.webp alt></p><p>我们的目标是使Shard尽可能不移动，因此最佳的负载状态是S3和S4保持原样，而S7和S8移动至G3、G4。此时负载状态为：</p><p><img src=https://i0.hdslb.com/bfs/article/40927383783bd301685f9c6624e9892c2099359.png@1e_1c.webp alt></p><p>要使Group达到如上负载均衡，一种朴素的方法是求出Shard平均值，以及Shard取模，基于模长，动态调整Group的最大Shard值，保证各个Group所分配的最大与最小Shard数量差值为1。具体做法如下：</p><ol><li>求出Avg，上述情况为 <code>10 / 4 = 2</code></li><li>求出Mod，上述情况为 <code>10 % 4 = 2</code></li><li>将Group序列中前<code>Mod</code>个Group的保留长度设置为<code>Avg + 1</code>，其余Group的保留长度为<code>Avg</code>。</li></ol><h4 id=balancer>Balancer</h4><p>为保证单一原则，我们将负载均衡逻辑抽离。Balancer结构体（类）是负载均衡处理器。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Balancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewBalancer</span>(<span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Balancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Balancer</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>me</span>: <span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Balancer实现了<code>ReBalanceShards</code>方法，该方法要求传入最后一个配置的Shard数组<code>oldShards</code>，以及最新的Groups。逻辑步骤如下：</p><ol><li>创建Group-Shard链表结构<code>grpShardMap</code>，表示Group负责的Shard序号，其中Key为GID，而Value为Shard切片，注意<strong>切片按照Shard序号顺序排序</strong>。</li><li>将Group按照Shard数量倒序排序，Shard数量一致时按GID顺序排序，以此<strong>保证排序结果的稳定性</strong>。</li><li>筛选出需要休眠的Group，即排序序号大于等于<code>NShards</code>数量的Group。因为这些Group无法分到Shard。</li><li>将“超出Group容量的Shard”、“休眠Group的所有Shard”放置在<code>freeShards</code>中，<code>freeShards</code>属于自定义Set类型，具体参考代码。</li><li>将<code>freeShards</code>排序，按序列放到未超容量的Group中。</li><li>根据<code>grpShardMap</code>重新生成Shards数组。</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Balancer</span>) <span style=color:#a6e22e>ReBalanceShards</span>(<span style=color:#a6e22e>oldShards</span> [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>groups</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int</span>][]<span style=color:#66d9ef>string</span>) [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>groups</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> [<span style=color:#a6e22e>NShards</span>]<span style=color:#66d9ef>int</span>{}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始情况下，不存在GID的Shard应该归属于0</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// oldShards可能被分配至已经不存在的Group</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grpShardMap</span>, <span style=color:#a6e22e>freeShards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>groupShardMap</span>(<span style=color:#a6e22e>oldShards</span>, <span style=color:#a6e22e>groups</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sortedGid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>sortGroupByShard</span>(<span style=color:#a6e22e>grpShardMap</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sleepGid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>getSleepGid</span>(<span style=color:#a6e22e>sortedGid</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] ReBalanceShards sortedGid:%v ; sleepGid:%v ; freeShards: %v&#34;</span>, <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>sortedGid</span>, <span style=color:#a6e22e>sleepGid</span>, <span style=color:#a6e22e>freeShards</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 计算Shard平均数量，平均值最小为1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>avgShardNum</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NShards</span> <span style=color:#f92672>/</span> (len(<span style=color:#a6e22e>sortedGid</span>) <span style=color:#f92672>-</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Len</span>())
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>modShardNum</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NShards</span> <span style=color:#f92672>%</span> (len(<span style=color:#a6e22e>sortedGid</span>) <span style=color:#f92672>-</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Len</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将超过平均值的Shard放置在freeShards中</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>gid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>sortedGid</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>]
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果GID在sleepGid中，则将Shard放置在freeShards中</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Contain</span>(<span style=color:#a6e22e>gid</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>freeShards</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>shards</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 计算当前GID应该拥有的Shard数量</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pos</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>modShardNum</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果Shard数量大于pos值，则将多余的Shard放置在freeShards中</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>shards</span>) &gt; <span style=color:#a6e22e>pos</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>freeShards</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>shards</span>[<span style=color:#a6e22e>pos</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>shards</span>[:<span style=color:#a6e22e>pos</span>]
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 保证每次分配Shard时取出的Shard是有序的，以此确保副本的一致性</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>unAsgnShards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>freeShards</span>.<span style=color:#a6e22e>SortedSlice</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重新分配Shards</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>gid</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>sortedGid</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sleepGid</span>.<span style=color:#a6e22e>Contain</span>(<span style=color:#a6e22e>gid</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pos</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>modShardNum</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pos</span> = <span style=color:#a6e22e>avgShardNum</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果Shard数量小于平均值，则从unAsgnShards中取出Shard进行分配</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>shards</span>) &lt; <span style=color:#a6e22e>pos</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>unAsgnShards</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>shards</span> = append(<span style=color:#a6e22e>shards</span>, <span style=color:#a6e22e>unAsgnShards</span>[<span style=color:#ae81ff>0</span>])
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>unAsgnShards</span> = <span style=color:#a6e22e>unAsgnShards</span>[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>grpShardMap</span>[<span style=color:#a6e22e>gid</span>] = <span style=color:#a6e22e>shards</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] ReBalanceShards grpShardMap: %v&#34;</span>, <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>grpShardMap</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>shards</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>genNShards</span>(<span style=color:#a6e22e>grpShardMap</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>shards</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=server核心代码实现>Server核心代码实现</h3><p>代码整体上与Lab4相同，具体的可参考<a href=https://github.com/bestzy6/MIT6.5840 target=_blank>代码仓库</a>
。</p><h4 id=更新配置>更新配置</h4><p>Server的Op结构体如下，我们需要添加Config字段，以便将配置传递给Follower。相同的，我们需要增加*<code>OpTypeConfig</code>*<em>类型来表示当前Op结构体是配置类型</em>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Op</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Field names must start with capital letters,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// otherwise RPC will break.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span>     <span style=color:#66d9ef>string</span> <span style=color:#75715e>// OpTypeGet, OpTypePut, OpTypeAppend</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>   <span style=color:#66d9ef>string</span> <span style=color:#75715e>// OpTypeGet, OpTypePut, OpTypeAppend</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Config</span>  <span style=color:#a6e22e>shardctrler</span>.<span style=color:#a6e22e>Config</span> <span style=color:#75715e>// OpTypeConfig</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在<code>handleOperation</code>方法中，也要增加配置类型的处理逻辑，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeGet</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypePut</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeAppend</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeConfig</span>:
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>UpdateConfig</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Config</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>updateConfig</code>方法的实现如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>UpdateConfig</span>(<span style=color:#a6e22e>newCfg</span> <span style=color:#a6e22e>shardctrler</span>.<span style=color:#a6e22e>Config</span>) <span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Config Num[%d] &gt;= New Config Num[%d], Do not need to Update&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span><span style=color:#f92672>-</span><span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ErrWrongConfigNum</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>newCfg</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Config is NIL, Apply Config, Update :[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>newCfg</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span> = <span style=color:#a6e22e>newCfg</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span> = <span style=color:#a6e22e>newCfg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Update Config Success:[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>newCfg</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=监听配置>监听配置</h4><p>对于无需每次都查询ShardCtrler，在Lab5B中，任务期望我们以100ms间隔轮询。因此在实现上，我们开启一个协程，每隔100ms获取一次配置，如需要更新配置，则创建Op结构体并发送至Raft。</p><p>特别需要注意锁的获取和释放。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>PollConfig</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>update</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>nextCfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cfg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mck</span>.<span style=color:#a6e22e>Query</span>(<span style=color:#a6e22e>nextCfg</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cfg</span>.<span style=color:#a6e22e>Num</span> &gt; <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>update</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>update</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Type</span>:    <span style=color:#a6e22e>OpTypeConfig</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ReqId</span>:   <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>nextId</span>(),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Config</span>:  <span style=color:#a6e22e>cfg</span>,
</span></span><span style=display:flex><span>             })
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] Push Config Op Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=易错点>易错点</h3><p>总结一下易错点，如下：</p><ol><li>排序算法的稳定性<ol><li>要保证各副本Shard数组的一致性，使用排序时必须保证结果的稳定性。</li></ol></li><li>map迭代顺序的无序性<ol><li>map本身是无序的，若不考虑这点，可能会导致副本Shard数组不一致。</li></ol></li><li>Group数量与NShard的关系<ol><li>若Group数量大于Nshard，那么必然会存在部分Group无法分配到Shard。</li></ol></li><li>更新Config需要由Leader通过Raft同步至各Follower<ol><li>此举才能保证线性一致性。</li></ol></li><li>必须按配置编号顺序地更新<ol><li>不然会出现配置不一致的bug，所以每次向ShardCtrler拉取的都是当前cfg编号+1的配置。</li></ol></li></ol><h2 id=lab5b>Lab5B</h2><p>这一部分的主要任务是在控制器更改分片时，在<strong>副本组之间移动分片</strong>，并以<strong>提供线性化 k/v 客户端操作</strong>的方式进行。Lab5B 附有两个 challenges，分别要求我们实现</p><ol><li>失效数据的清除（Challenge 1）</li><li>异步变更配置的 shardkv（Challenge 2）。</li></ol><p>我们的目标是实现两个Challenge，因此在设计之初就需要考虑。</p><h3 id=配置更新策略>配置更新策略</h3><p>每个Group的配置必须按照严格的版本号顺序处理（C1→C2→C3），这确保了系统状态的一致性和可预测性。</p><p>而对于Group内部的更新策略，我最初的考虑是这样的：当需要更新的配置与当前配置的差异不与之前的差异冲突时，就允许更新，即“非冲突diff可接受”的原则。这种做法的优点包括：</p><ol><li>提高了并发更新的可能性；</li><li>对于互不影响的配置项变更可以独立进行</li></ol><p>但缺点也很明显，实现该策略的复杂性无比巨大，需要考虑多个Group之间的配置同步，而且可能引入难以调试的竞态条件。</p><p>于是我转换了策略，即<strong>Group必须完全处理完当前配置变更后，才进入下一配置</strong>。这种设计也反映了分布式系统设计中的重要原则：有时候更简单的方法虽然看起来效率较低，但实际上能够显著降低出错风险。</p><p>Challenge要求已经迁移的分片能立即投入服务，无需等待所有分片迁移完毕。为了满足Challenge的要求，我们需要设置一个Shard状态数组来标明状态，包括<code>Serving</code>、<code>Sending</code>和<code>Receiving</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ShardStatus</span> <span style=color:#66d9ef>uint8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ShardStatusServing</span>   <span style=color:#a6e22e>ShardStatus</span> = <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// 正在提供服务</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ShardStatusSending</span>               = <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// 正在发送</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ShardStatusReceiving</span>             = <span style=color:#66d9ef>iota</span> <span style=color:#75715e>// 正在接收</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h3 id=分片迁移策略>分片迁移策略</h3><p>假设根据新的配置，某Shard需要从Server1迁移至Server2，那么我们应该如何进行迁移？</p><p>网上大多数文章都采用Pull模式，即让Server2主动向Server1发起请求，以获取分片数据。但此方法不能很好的让Server1判断Shard是否迁移完毕，因为Server2主动请求，Server1成功返回数据后，Server1无法确定Server2是否收到数据，因此不能更改自身的状态。那么，Server1就需要主动发送RPC请求至Server2，来判断Server2是否获取数据。</p><p>因此，我采用的策略是Push方法，使用Push方法会比较方便的同步Server的Shard状态，发送一次请求即可修改Server1、Server2的Shard状态，时序图如下。</p><p>至于两种方法的难易程度，我个人认为两者的难易程度相当。</p><p><img src=https://i0.hdslb.com/bfs/article/72d94ed4c118d2eeceb51ea98a57008c2099359.png@1e_1c.webp alt></p><p>时序图的场景是正常情况，但我们不应该假设网络都是正常的，因此上述2、4步骤很有可能发生错误。</p><ol><li>步骤2发生错误时，Server1进行重传</li><li>步骤4发生错误时，Server1进行重传，但Server2需要额外的判断来保证不会出错。<ol><li>当Server1 RPC的ConfigNum 小于 Server2的ConfigNum时，Server返回OK，因为默认数据迁移完毕后才能更新ConfigNum；</li><li>当Server1 RPC的ConfigNum 等于 Server2的ConfigNum时，检查Shard状态，如果为Serving，则返回OK。</li><li>当Server1 RPC的ConfigNum 大于 Server2的ConfigNum时，返回Err。</li></ol></li></ol><h3 id=迁移分片后的去重处理>迁移分片后的去重处理</h3><p>我在实现时，遇到了移动分片后无法去重的问题，如下图所示：</p><p><img src=https://i0.hdslb.com/bfs/article/b97272ceb3446e62571e5e32f3cd65d12099359.png@1e_1c.webp alt></p><ol><li>Client发起<code>Append "AB"</code>请求，此时请求由G1处理；</li><li>G1处理完成，但超时。Client将会重新发起请求；</li><li>Client还未发起请求，发生分片迁移，&ldquo;AB"迁移至G2处理；</li><li>Client发起Append请求，此时由G2处理，G2重复处理后返回成功信息给Client。</li></ol><p>对Client而言，只成功提交了一次，但是对于Server而言成功Append了两次，使得结果出错。</p><p><strong>处理方法</strong></p><p>在迁移数据时，<strong>将已经应用的日志信息AppliedLog也进行迁移</strong>，新的Group收到AppliedLog后合并至自身AppliedLog。</p><h3 id=分片迁移数据丢失问题>分片迁移数据丢失问题</h3><p>发生分片迁移之后，似乎原先的数据丢失了？分片迁移时似乎没有把最新的数据迁移过来。</p><p><img src=https://i0.hdslb.com/bfs/article/6c95d7b9052bfac722f90d4e199faba52099359.png@1e_1c.webp alt=img></p><p>问题：G1收到了新的Config，正在发生迁移Shard1至G2，此时Shard1的状态为“sending”，当Shard1由G1发送至G2之后，G1将Shard1的状态改为Serving，当修改Shard1的请求到来时，检查到Shard1的状态为Serving，则修改Shard1了，导致错误！</p><p>引起问题的原因如下：</p><ol><li>G1几乎同时更新<code>Config</code>和<code>Append Shard1</code>消息，<code>Config</code>和<code>Append Shard1</code>都进入Raft等待提交；</li><li>G1收到更新Config命令，将Shard1迁移至G2，此时Shard1的状态修改为Sending；</li><li>G1将Shard1迁移完毕，Shard1状态修改为Serving；</li><li>G1收到Raft提交的Append Shard1命令，执行成功后返回至客户端，<strong>产生线性不一致问题</strong>。</li></ol><p>在步骤4中，G1收到Raft提交的Append Shard1命令后，不应该执行命令，应该返回错误。</p><p><strong>处理方法</strong></p><p>在<code>handleOperation</code>中，除了处理重复值外，还需要判断Shard的分配状态。</p><h3 id=核心代码实现>核心代码实现</h3><h4 id=分片迁移>分片迁移</h4><blockquote><p>分片迁移的引入会改变<code>handleOperation</code>方法的逻辑，可以参考<a href=https://github.com/bestzy6/MIT6.5840 target=_blank>仓库代码</a>
。</p></blockquote><p>迁移的RPC的请求响应结构体如下，在请求中，除去必要的Shard、ConfigNum和KVs以外，ClerkId和ReqId用于去重，Applied用于迁移后的去重。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MigrateShardArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Shard</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConfigNum</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>KVs</span>       []<span style=color:#a6e22e>KV</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Applied</span>   <span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkId</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MigrateShardReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConfigNum</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Err</span>       <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以下是<code>MigrateShard</code>RPC方法实现。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>MigrateShard</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MigrateShardArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MigrateShardReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] not Leader&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>ErrWrongLeader</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>ConfigNum</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Current ConfigNum:[%d] &lt; ConfigNum:[%d]&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>ErrWrongConfigNum</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> &gt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Current ConfigNum:[%d] &gt; ConfigNum:[%d]&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ShardsStatus</span>[<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>] <span style=color:#f92672>==</span> <span style=color:#a6e22e>ShardStatusServing</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Already Serving&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Type</span>:       <span style=color:#a6e22e>OpTypeAddShard</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>:    <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:      <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shard</span>:      <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ShardData</span>:  <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>KVs</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ConfigNum</span>:  <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ConfigNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>AppliedLog</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Applied</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] MigrateShard Shard:[%d] Success&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Shard</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>SendShard</code>有感知到自身Shard发生变化的Leader主动调用，将Shard数据发送至新的Server。只有当RPC响应成功后，才会将数据库中的Shard数据删除。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>SendShard</span>(<span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>configNum</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>applied</span> <span style=color:#a6e22e>AppliedLog</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d not Leader&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>MigrateShardReply</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>MigrateShardArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Shard</span>:     <span style=color:#a6e22e>shard</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ConfigNum</span>: <span style=color:#a6e22e>configNum</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Applied</span>:   <span style=color:#a6e22e>applied</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>KVs</span>:       <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkId</span>:   <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:     <span style=color:#a6e22e>reqId</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>KVs</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>GetByShard</span>(<span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gid</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Shards</span>[<span style=color:#a6e22e>shard</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Groups</span>[<span style=color:#a6e22e>gid</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>servers</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>make_end</span>(<span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d To %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ok</span> = <span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;ShardKV.MigrateShard&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d RPC failed&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OK</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d To %s Success&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>Type</span>:      <span style=color:#a6e22e>OpTypeRemoveShard</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ClerkID</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkId</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ReqId</span>:     <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqId</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>Shard</span>:     <span style=color:#a6e22e>shard</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ConfigNum</span>: <span style=color:#a6e22e>configNum</span>,
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] handle Op failed, Err: %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d Success&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrWrongLeader</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] SendShard %d failed,Err:%s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=分片监听>分片监听</h4><p>同理，我们启动一个协程，每50ms监听一次Shard状态，如果存在需要<code>Sending</code>的Shard，则主动发送RPC请求。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ShardKV</span>) <span style=color:#a6e22e>ShardWatcher</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>isLeader</span>() {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>ShardsStatus</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>ShardStatusSending</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d-%d] ShardWatcher is Preparing to Send Shard&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>gid</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>NextReqId</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>SendShard</span>(<span style=color:#a6e22e>shard</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Num</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Copy</span>(), <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>NextReqId</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=易错点-1>易错点</h3><ol><li>只有所有Shards不存在处于Send的状态时，可以更新Config；</li><li>迁移分片后要保证幂等性；</li><li>旧配置的Server不允许处理新配置的请求。</li></ol></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#lab5a>Lab5A</a><ul><li><a href=#shardctrler代码实现>ShardCtrler代码实现</a></li><li><a href=#shardctrler负载均衡>ShardCtrler负载均衡</a></li><li><a href=#server核心代码实现>Server核心代码实现</a></li><li><a href=#易错点>易错点</a></li></ul></li><li><a href=#lab5b>Lab5B</a><ul><li><a href=#配置更新策略>配置更新策略</a></li><li><a href=#分片迁移策略>分片迁移策略</a></li><li><a href=#迁移分片后的去重处理>迁移分片后的去重处理</a></li><li><a href=#分片迁移数据丢失问题>分片迁移数据丢失问题</a></li><li><a href=#核心代码实现>核心代码实现</a></li><li><a href=#易错点-1>易错点</a></li></ul></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>👋 Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyy年MM月dd日")})}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>