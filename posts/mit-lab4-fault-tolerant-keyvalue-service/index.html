<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ã€MIT6.5840ã€‘Lab4-Fault-tolerant Key/Value Service | Bestzy's Blog</title><link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/><meta name=author content="bestzy"><meta name=description content="åŸºäºRaftå®ç°ä¸€ä¸ªé”®å€¼å­˜å‚¨æœåŠ¡ï¼ˆkvraftï¼‰æ˜¯ç†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒå®è·µã€‚æœ¬æ–‡å°†ç»“åˆMIT 6.5840è¯¾ç¨‹çš„Lab 3Cï¼Œé€æ­¥å®ç°ä¸€ä¸ªé«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚
"><meta name=keywords content="Raft,Tolerant Key/Value Service"><meta name=generator content="Hugo 0.149.0"><meta property="og:url" content="https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="ã€MIT6.5840ã€‘Lab4-Fault-tolerant Key/Value Service"><meta property="og:description" content="åŸºäºRaftå®ç°ä¸€ä¸ªé”®å€¼å­˜å‚¨æœåŠ¡ï¼ˆkvraftï¼‰æ˜¯ç†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒå®è·µã€‚æœ¬æ–‡å°†ç»“åˆMIT 6.5840è¯¾ç¨‹çš„Lab 3Cï¼Œé€æ­¥å®ç°ä¸€ä¸ªé«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T22:48:11+08:00"><meta property="article:modified_time" content="2025-02-15T22:48:11+08:00"><meta property="article:tag" content="Raft"><meta property="article:tag" content="Tolerant Key/Value Service"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="ã€MIT6.5840ã€‘Lab4-Fault-tolerant Key/Value Service"><meta name=twitter:description content="åŸºäºRaftå®ç°ä¸€ä¸ªé”®å€¼å­˜å‚¨æœåŠ¡ï¼ˆkvraftï¼‰æ˜¯ç†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒå®è·µã€‚æœ¬æ–‡å°†ç»“åˆMIT 6.5840è¯¾ç¨‹çš„Lab 3Cï¼Œé€æ­¥å®ç°ä¸€ä¸ªé«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=ç¿»è½¬ä¸€ä¸‹ï¼><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">ğŸš€å…ˆè¡Œå…¶äº‹ï¼Œåè‡»å…¶å–„ï¼Œå†æ±‚å…¶ä¼˜ï¼</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=æœç´¢><ion-icon name=search></ion-icon>æœç´¢</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=æœç´¢><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="ã€MIT6.5840ã€‘Lab4-Fault-tolerant Key/Value Service"><meta itemprop=description content="åŸºäºRaftå®ç°ä¸€ä¸ªé”®å€¼å­˜å‚¨æœåŠ¡ï¼ˆkvraftï¼‰æ˜¯ç†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒå®è·µã€‚æœ¬æ–‡å°†ç»“åˆMIT 6.5840è¯¾ç¨‹çš„Lab 3Cï¼Œé€æ­¥å®ç°ä¸€ä¸ªé«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚"><meta itemprop=datePublished content="2025-02-15T22:48:11+08:00"><meta itemprop=dateModified content="2025-02-15T22:48:11+08:00"><meta itemprop=wordCount content="7713"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="Raft,Tolerant Key/Value Service"><header><h1 itemprop=headline>ã€MIT6.5840ã€‘Lab4-Fault-tolerant Key/Value Service</h1><p class=text-sm><span data-format=luxon>2025-02-15T22:48:11+08:00</span>
| <span>16åˆ†é’Ÿé˜…è¯»</span>
| <span>æ›´æ–°äº
<span data-format=luxon>2025-02-15T22:48:11+08:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0! src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e3%80%90MIT6.5840%e3%80%91Lab4-Fault-tolerant%20Key/Value%20Service&amp;url=https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://i0.hdslb.com/bfs/article/45a4174762f3bcfaf50274ca36e169232099359.jpg@1e_1c.webp alt="ã€MIT6.5840ã€‘Lab4-Fault-tolerant Key/Value Service"><p>åŸºäºRaftå®ç°ä¸€ä¸ªé”®å€¼å­˜å‚¨æœåŠ¡ï¼ˆkvraftï¼‰æ˜¯ç†è§£åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒå®è·µã€‚æœ¬æ–‡å°†ç»“åˆMIT 6.5840è¯¾ç¨‹çš„Lab 3Cï¼Œé€æ­¥å®ç°ä¸€ä¸ªé«˜å¯ç”¨çš„é”®å€¼å­˜å‚¨ç³»ç»Ÿã€‚</p><h2 id=ä»‹ç»>ä»‹ç»</h2><p><a href=http://nil.csail.mit.edu/6.5840/2024/labs/lab-kvraft.html target=_blank>http://nil.csail.mit.edu/6.5840/2024/labs/lab-kvraft.html</a></p><p>åœ¨æœ¬å®éªŒä¸­ï¼Œæ‚¨å°†ä½¿ç”¨ Lab 3 ä¸­çš„ Raft åº“æ„å»ºä¸€ä¸ªå®¹é”™çš„é”®/å€¼å­˜å‚¨æœåŠ¡ã€‚æ‚¨çš„é”®/å€¼æœåŠ¡å°†æ˜¯ä¸€ä¸ªå¤åˆ¶çš„çŠ¶æ€æœºï¼Œç”±å¤šä¸ªé”®/å€¼æœåŠ¡å™¨ç»„æˆï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½ç»´æŠ¤ä¸€ä¸ªé”®/å€¼å¯¹çš„æ•°æ®åº“ï¼Œå¦‚ Lab 2 ä¸­æ‰€ç¤ºï¼Œä½†é¢å¤–ä½¿ç”¨ Raft è¿›è¡Œå¤åˆ¶ã€‚åªè¦å¤§å¤šæ•°æœåŠ¡å™¨å­˜æ´»å¹¶èƒ½é€šä¿¡ï¼Œæ‚¨çš„é”®/å€¼æœåŠ¡åº”ç»§ç»­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå³ä½¿å‘ç”Ÿå…¶ä»–æ•…éšœæˆ–ç½‘ç»œåˆ†åŒºã€‚åœ¨ Lab 4 ä¹‹åï¼Œæ‚¨å°†å®ç°<a href=http://nil.csail.mit.edu/6.5840/2024/notes/raft_diagram.pdf target=_blank> Raft äº¤äº’å›¾</a>
ä¸­æ‰€ç¤ºçš„æ‰€æœ‰éƒ¨åˆ†ï¼ˆClerkã€Service å’Œ Raftï¼‰ã€‚</p><p>å®¢æˆ·ç«¯å°†ä»¥ä¸Lab 2 éå¸¸ç›¸ä¼¼çš„æ–¹å¼ä¸æ‚¨çš„é”®/å€¼æœåŠ¡è¿›è¡Œäº¤äº’ã€‚å…·ä½“æ¥è¯´ï¼Œå®¢æˆ·ç«¯å¯ä»¥å‘é”®/å€¼æœåŠ¡å‘é€ä¸‰ç§ä¸åŒçš„ RPC è°ƒç”¨ï¼š</p><ul><li>Put(key, value) : æ›¿æ¢æ•°æ®åº“ä¸­ç‰¹å®šé”®çš„å€¼</li><li>Append(key, arg) : å°†å‚æ•°é™„åŠ åˆ°é”®çš„å€¼ï¼ˆå¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™å°†ç°æœ‰å€¼è§†ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰</li><li>Get(key) : è·å–é”®çš„å½“å‰å€¼ï¼ˆå¯¹äºä¸å­˜åœ¨çš„é”®è¿”å›ç©ºå­—ç¬¦ä¸²ï¼‰</li></ul><p>é”®å’Œå€¼éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚è¯·æ³¨æ„ï¼Œ<strong>ä¸å®éªŒ 2 ä¸åŒï¼Œ Put å’Œ Append éƒ½ä¸åº”å‘å®¢æˆ·ç«¯è¿”å›å€¼</strong>ã€‚æ¯ä¸ªå®¢æˆ·ç«¯é€šè¿‡ä¸€ä¸ªå¸¦æœ‰ Put/Append/Get æ–¹æ³•çš„ Clerk ä¸Server è¿›è¡Œé€šä¿¡ã€‚</p><p>æ‚¨çš„æœåŠ¡å¿…é¡»ç¡®ä¿å¯¹ Clerk çš„ Get/Put/Append æ–¹æ³•çš„è°ƒç”¨æ˜¯çº¿æ€§åŒ–çš„ã€‚å¦‚æœé€ä¸ªè°ƒç”¨ï¼ŒGet/Put/Append æ–¹æ³•çš„è¡Œä¸ºåº”å¦‚åŒç³»ç»Ÿä»…æœ‰ä¸€ä»½çŠ¶æ€å‰¯æœ¬ï¼Œä¸”æ¯æ¬¡è°ƒç”¨éƒ½åº”è§‚å¯Ÿåˆ°å‰åºè°ƒç”¨åºåˆ—æ‰€éšå«çš„çŠ¶æ€ä¿®æ”¹ã€‚å¯¹äºå¹¶å‘è°ƒç”¨ï¼Œè¿”å›å€¼å’Œæœ€ç»ˆçŠ¶æ€å¿…é¡»ä¸è¿™äº›æ“ä½œæŒ‰æŸç§é¡ºåºé€ä¸ªæ‰§è¡Œæ—¶ç›¸åŒã€‚å¦‚æœè°ƒç”¨åœ¨æ—¶é—´ä¸Šé‡å ï¼Œåˆ™å®ƒä»¬æ˜¯å¹¶å‘çš„ï¼šä¾‹å¦‚ï¼Œå¦‚æœå®¢æˆ·ç«¯ X è°ƒç”¨ Clerk.Put() ï¼Œå®¢æˆ·ç«¯ Y è°ƒç”¨ Clerk.Append() ï¼Œç„¶åå®¢æˆ·ç«¯ X çš„è°ƒç”¨è¿”å›ã€‚ä¸€ä¸ªè°ƒç”¨å¿…é¡»è§‚å¯Ÿåˆ°åœ¨å®ƒå¼€å§‹ä¹‹å‰æ‰€æœ‰å·²å®Œæˆè°ƒç”¨çš„æ•ˆæœã€‚</p><p>ä¸ºå•å°æœåŠ¡å™¨æä¾›çº¿æ€§ä¸€è‡´æ€§ç›¸å¯¹å®¹æ˜“ã€‚å¦‚æœæœåŠ¡è¢«å¤åˆ¶ï¼Œåˆ™éš¾åº¦æ›´å¤§ï¼Œå› ä¸ºæ‰€æœ‰æœåŠ¡å™¨å¿…é¡»ä¸ºå¹¶å‘è¯·æ±‚é€‰æ‹©ç›¸åŒçš„æ‰§è¡Œé¡ºåºï¼Œ<strong>å¿…é¡»é¿å…ä½¿ç”¨æœªæ›´æ–°çš„çŠ¶æ€å›å¤å®¢æˆ·ç«¯</strong>ï¼Œå¹¶ä¸”å¿…é¡»åœ¨æ•…éšœåä»¥ä¿ç•™æ‰€æœ‰å·²ç¡®è®¤å®¢æˆ·ç«¯æ›´æ–°çš„æ–¹å¼æ¢å¤å…¶çŠ¶æ€ã€‚</p><p>æœ¬å®éªŒåˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚åœ¨ A éƒ¨åˆ†ä¸­ï¼Œä½ å°†ä½¿ç”¨ä½ çš„ Raft å®ç°æ¥æ„å»ºä¸€ä¸ªå¤åˆ¶çš„é”®/å€¼æœåŠ¡ï¼Œä½†ä¸ä½¿ç”¨å¿«ç…§ã€‚åœ¨ B éƒ¨åˆ†ä¸­ï¼Œä½ å°†ä½¿ç”¨æ¥è‡ªå®éªŒ 3D çš„å¿«ç…§å®ç°ï¼Œè¿™å°†ä½¿ Raft èƒ½å¤Ÿä¸¢å¼ƒæ—§çš„æ—¥å¿—æ¡ç›®ã€‚</p><h2 id=part-a---æ— å¿«ç…§çš„é”®å€¼æœåŠ¡>Part A - æ— å¿«ç…§çš„é”®/å€¼æœåŠ¡</h2><h3 id=ä»»åŠ¡è¦æ±‚>ä»»åŠ¡è¦æ±‚</h3><p><img src=https://i0.hdslb.com/bfs/article/c1982e09768283ee86831c97bbade9662099359.png@1e_1c.webp alt=ç¨‹åºæ¶æ„å›¾></p><p>æ¯ä¸ªé”®/å€¼æœåŠ¡å™¨ï¼ˆâ€œkvserverâ€ï¼‰éƒ½å°†æœ‰ä¸€ä¸ªå…³è”çš„ Raft å¯¹ç­‰ä½“ã€‚<strong>Clerks å‘å…³è” Raft ä¸ºé¢†å¯¼è€…çš„ kvserver å‘é€æ“ä½œ<strong><strong>RPC</strong></strong>è¯·æ±‚ã€‚kvserver ä»£ç å°†æ“ä½œæäº¤ç»™ Raftï¼Œä»¥ä¾¿ Raft æ—¥å¿—ä¸­ä¿å­˜ä¸€ç³»åˆ—æ“ä½œ</strong>ã€‚æ‰€æœ‰ kvserver æŒ‰é¡ºåºæ‰§è¡Œ Raft æ—¥å¿—ä¸­çš„æ“ä½œï¼Œå°†è¿™äº›æ“ä½œåº”ç”¨åˆ°å®ƒä»¬çš„é”®/å€¼æ•°æ®åº“ä¸­ï¼›ç›®çš„æ˜¯è®©æœåŠ¡å™¨ç»´æŠ¤é”®/å€¼æ•°æ®åº“çš„ç›¸åŒå‰¯æœ¬ã€‚</p><p>Clerk æœ‰æ—¶ä¸çŸ¥é“å“ªä¸ª kvserver æ˜¯ Raft é¢†å¯¼è€…ã€‚å¦‚æœ Clerk å‘é”™è¯¯çš„ kvserver å‘é€ RPCï¼Œæˆ–è€…æ— æ³•è”ç³»åˆ°è¯¥ kvserverï¼Œ <strong>Clerk åº”é€šè¿‡å‘ä¸åŒçš„ kvserver å‘é€è¯·æ±‚æ¥é‡è¯•</strong>ã€‚å¦‚æœé”®/å€¼æœåŠ¡å°†æ“ä½œæäº¤åˆ°å…¶ Raft æ—¥å¿—ï¼ˆä»è€Œå°†æ“ä½œåº”ç”¨åˆ°é”®/å€¼çŠ¶æ€æœºï¼‰ï¼Œé¢†å¯¼è€…é€šè¿‡å“åº”å…¶ RPC å‘ Clerk æŠ¥å‘Šç»“æœã€‚å¦‚æœæ“ä½œæœªèƒ½æäº¤ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœé¢†å¯¼è€…è¢«æ›¿æ¢ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šæŠ¥å‘Šé”™è¯¯ï¼Œ Clerk åˆ™ä¼šå°è¯•ä½¿ç”¨ä¸åŒçš„æœåŠ¡å™¨é‡è¯•ã€‚</p><p>åœ¨ç½‘ç»œå’ŒæœåŠ¡å™¨æ•…éšœçš„æƒ…å†µä¸‹ï¼Œä½ å°†é¢ä¸´çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œ Clerk å¯èƒ½ä¸å¾—ä¸å¤šæ¬¡å‘é€ RPCï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå›å¤ç§¯æçš„ kvserverã€‚å¦‚æœé¢†å¯¼è€…åœ¨å°†æ¡ç›®æäº¤åˆ° Raft æ—¥å¿—åç«‹å³å¤±è´¥ï¼Œ <strong>Clerk å¯èƒ½ä¸ä¼šæ”¶åˆ°å›å¤ï¼Œå› æ­¤å¯èƒ½ä¼šå°†è¯·æ±‚é‡æ–°å‘é€ç»™å¦ä¸€ä¸ªé¢†å¯¼è€…</strong>ã€‚æ¯æ¬¡è°ƒç”¨ Clerk.Put() æˆ– Clerk.Append() åº”è¯¥åªå¯¼è‡´ä¸€æ¬¡æ‰§è¡Œï¼Œå› æ­¤ä½ <strong>å¿…é¡»ç¡®ä¿é‡æ–°å‘é€ä¸ä¼šå¯¼è‡´æœåŠ¡å™¨æ‰§è¡Œè¯·æ±‚ä¸¤æ¬¡</strong>ã€‚</p><p><strong>ä»»åŠ¡</strong>ï¼š</p><ul><li>ä½ éœ€è¦åœ¨ server.go ä¸­å®ç° Put() ã€ Append() å’Œ Get() RPC å¤„ç†ç¨‹åºã€‚<strong>è¿™äº›å¤„ç†ç¨‹åºåº”ä½¿ç”¨ Start() åœ¨ Raft æ—¥å¿—ä¸­è¾“å…¥ä¸€ä¸ª</strong> <strong>Op</strong> ï¼›ä½ åº”åœ¨ server.go ä¸­å¡«å†™ Op ç»“æ„ä½“å®šä¹‰ï¼Œä»¥ä¾¿æè¿° Put/Append/Get æ“ä½œã€‚æ¯ä¸ªæœåŠ¡å™¨åº”åœ¨ Raft æäº¤ Op å‘½ä»¤æ—¶æ‰§è¡Œå®ƒä»¬ï¼Œå³å½“å®ƒä»¬å‡ºç°åœ¨ applyCh ä¸Šæ—¶ã€‚RPC å¤„ç†ç¨‹åºåº”æ³¨æ„åˆ° Raft æäº¤å…¶ Op æ—¶ï¼Œç„¶åå›å¤ RPCã€‚</li><li>æ·»åŠ ä»£ç ä»¥å¤„ç†æ•…éšœï¼Œå¹¶<strong>åº”å¯¹é‡å¤çš„ Clerk è¯·æ±‚</strong>ï¼ŒåŒ…æ‹¬ Clerk åœ¨ä¸€ä¸ªä»»æœŸå†…å‘ kvserver é¢†å¯¼è€…å‘é€è¯·æ±‚ã€ç­‰å¾…å›å¤è¶…æ—¶å¹¶åœ¨å¦ä¸€ä¸ªä»»æœŸå†…å‘æ–°é¢†å¯¼è€…é‡æ–°å‘é€è¯·æ±‚çš„æƒ…å†µã€‚è¯·æ±‚åº”ä»…æ‰§è¡Œä¸€æ¬¡ã€‚è¿™äº›æ³¨é‡ŠåŒ…æ‹¬é‡å¤æ£€æµ‹çš„æŒ‡å¯¼ã€‚</li></ul><p><strong>æç¤º</strong>ï¼š</p><ul><li>è°ƒç”¨ Start() åï¼Œ<strong>æ‚¨çš„ kvservers éœ€è¦ç­‰å¾… Raft å®Œæˆä¸€è‡´æ€§åè®®</strong>ã€‚å·²è¾¾æˆä¸€è‡´çš„å‘½ä»¤ä¼šåˆ°è¾¾ applyCh ã€‚æ‚¨çš„ä»£ç éœ€è¦åœ¨ Put() ã€ Append() å’Œ Get() å¤„ç†ç¨‹åºä½¿ç”¨ Start() å‘ Raft æ—¥å¿—æäº¤å‘½ä»¤æ—¶ï¼ŒæŒç»­è¯»å– applyCh ã€‚æ³¨æ„ kvserver ä¸å…¶ Raft åº“ä¹‹é—´çš„æ­»é”é—®é¢˜ã€‚</li><li>å¦‚æœ kvserver ä¸æ˜¯å¤šæ•°æ´¾çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä¸åº”å®Œæˆ Get() RPCï¼ˆä»¥å…æä¾›è¿‡æ—¶æ•°æ®ï¼‰ã€‚ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†æ¯ä¸ª Get() ï¼ˆä»¥åŠæ¯ä¸ª Put() å’Œ Append() ï¼‰è®°å½•åˆ° Raft æ—¥å¿—ä¸­ã€‚ä½ <strong>æ— éœ€å®ç°</strong>ç¬¬ 8 èŠ‚ä¸­æè¿°çš„åªè¯»æ“ä½œä¼˜åŒ–ã€‚</li><li>æ‚¨ä¸éœ€è¦å‘ Raft ApplyMsg æˆ– Raft RPCï¼ˆå¦‚ AppendEntries ï¼‰æ·»åŠ ä»»ä½•å­—æ®µï¼Œä½†æ‚¨è¢«å…è®¸è¿™æ ·åšã€‚</li><li>æœ€å¥½ä»ä¸€å¼€å§‹å°±æ·»åŠ é”å®šï¼Œå› ä¸ºé¿å…æ­»é”çš„éœ€æ±‚æœ‰æ—¶ä¼šå½±å“æ•´ä½“ä»£ç è®¾è®¡ã€‚ä½¿ç”¨ go test -race æ£€æŸ¥ä½ çš„ä»£ç æ˜¯å¦æ— ç«äº‰ã€‚</li><li>æ‚¨çš„è§£å†³æ–¹æ¡ˆéœ€è¦å¤„ç†è¿™æ ·ä¸€ç§æƒ…å†µï¼šé¢†å¯¼è€…å·²ä¸º Clerk çš„ RPC è°ƒç”¨äº† Start()ï¼Œä½†åœ¨è¯·æ±‚è¢«æäº¤åˆ°æ—¥å¿—ä¹‹å‰å¤±å»äº†é¢†å¯¼æƒã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨åº”å®‰æ’ Clerk å°†è¯·æ±‚é‡æ–°å‘é€åˆ°å…¶ä»–æœåŠ¡å™¨ï¼Œç›´åˆ°æ‰¾åˆ°æ–°çš„é¢†å¯¼è€…ã€‚ä¸€ç§å®ç°æ–¹å¼æ˜¯ï¼ŒæœåŠ¡å™¨é€šè¿‡æ³¨æ„åˆ° Raft çš„ä»»æœŸå·²æ›´æ”¹æˆ– Start()è¿”å›çš„ç´¢å¼•å¤„å‡ºç°äº†ä¸åŒçš„è¯·æ±‚ï¼Œæ¥æ£€æµ‹è‡ªå·±æ˜¯å¦å·²å¤±å»é¢†å¯¼æƒã€‚å¦‚æœå‰ä»»é¢†å¯¼è€…è‡ªèº«è¢«åˆ†åŒºéš”ç¦»ï¼Œå®ƒå°†æ— æ³•çŸ¥æ™“æ–°é¢†å¯¼è€…çš„å­˜åœ¨ï¼›ä½†åŒä¸€åˆ†åŒºå†…çš„ä»»ä½•å®¢æˆ·ç«¯ä¹Ÿæ— æ³•ä¸æ–°é¢†å¯¼è€…é€šä¿¡ï¼Œå› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ— é™æœŸç­‰å¾…ç›´åˆ°åˆ†åŒºæ¢å¤æ˜¯å¯è¡Œçš„ã€‚</li><li>ä½ å¯èƒ½éœ€è¦ä¿®æ”¹ä½ çš„ Clerkï¼Œä½¿å…¶è®°ä½ä¸Šä¸€æ¬¡ RPC ä¸­å“ªä¸ªæœåŠ¡å™¨æˆä¸ºäº†é¢†å¯¼è€…ï¼Œå¹¶é¦–å…ˆå°†ä¸‹ä¸€ä¸ª RPC å‘é€åˆ°è¯¥æœåŠ¡å™¨ã€‚è¿™å°†é¿å…åœ¨æ¯æ¬¡ RPC æ—¶æµªè´¹æ—¶é—´å¯»æ‰¾é¢†å¯¼è€…ï¼Œä»è€Œå¯èƒ½å¸®åŠ©ä½ æ›´å¿«åœ°é€šè¿‡æŸäº›æµ‹è¯•ã€‚</li><li>æ‚¨åº”é‡‡ç”¨ç±»ä¼¼äºå®éªŒ 2 ä¸­çš„é‡å¤æ£€æµ‹æœºåˆ¶ã€‚è¯¥æœºåˆ¶åº”èƒ½è¿…é€Ÿé‡Šæ”¾æœåŠ¡å™¨å†…å­˜ï¼Œä¾‹å¦‚é€šè¿‡è®©æ¯ä¸ª RPC æš—ç¤ºå®¢æˆ·ç«¯å·²æ”¶åˆ°å…¶å‰ä¸€ä¸ª RPC çš„å›å¤ã€‚å¯ä»¥å‡è®¾å®¢æˆ·ç«¯ä¸€æ¬¡åªä¼šå‘ Clerk å‘èµ·ä¸€ä¸ªè°ƒç”¨ã€‚æ‚¨å¯èƒ½ä¼šå‘ç°ï¼Œéœ€è¦æ ¹æ®å®éªŒ 2 çš„æƒ…å†µè°ƒæ•´å­˜å‚¨åœ¨é‡å¤æ£€æµ‹è¡¨ä¸­çš„ä¿¡æ¯ã€‚</li></ul><h3 id=å®ç°>å®ç°</h3><p>æ ¹æ®ä»»åŠ¡çš„è¦æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªæ— å¿«ç…§çš„é”®/å€¼æœåŠ¡å™¨ã€‚ä»‹ç»ä¸­å·²ç»ç»™äº†è®¸å¤šæç¤ºï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹åŒ…æ‹¬ï¼š</p><ol><li>å¿…é¡»ä¿è¯è¯·æ±‚çš„å¹‚ç­‰æ€§</li><li>Clientéœ€è¦å¯»æ‰¾LeaderæœåŠ¡</li></ol><p>åœ¨Lab2ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªç®€å•çš„é”®/å€¼æœåŠ¡å™¨ï¼Œåªä¸è¿‡æ²¡æœ‰æ¥å…¥Raftï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å€Ÿé‰´Lab2ä¸­çš„ä»£ç ï¼Œå¿«é€Ÿå®šä¹‰å‡ºClientã€‚</p><h4 id=clientåˆå§‹åŒ–>Clientåˆå§‹åŒ–</h4><p>ä¸ºäº†ä¿è¯å¹‚ç­‰æ€§ï¼Œæˆ‘ä»¬ä¸ºClientç»“æ„ä½“æ·»åŠ <code>clerkId</code>å’Œ<code>nextReqId</code>å­—æ®µå€¼ï¼ŒæœåŠ¡ç«¯èƒ½å¤Ÿæ ¹æ®è¿™äº›å­—æ®µåˆ¤æ–­æ˜¯å¦ä¸ºé‡å¤è¯·æ±‚ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦å¾ªç¯å¯»æ‰¾Leaderï¼Œä¸ºäº†èƒ½å¤ŸåŠ é€Ÿæ‰¾åˆ°Leaderï¼Œæˆ‘ä»¬å¯ä»¥å¢åŠ ä¸€ä¸ªå­—æ®µ<code>lastLeader</code>ï¼Œè®°å½•ä¸Šä¸€æ¬¡æˆåŠŸè¯·æ±‚çš„Serveråºå·ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Clerk</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You will have to modify this struct.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>clerkId</span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextReqId</span>  <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastLeader</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»£ç æ¡†æ¶ä¸­æä¾›äº†<code>nrand()</code>å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–Clientæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°ç”Ÿæˆ<code>clerkId</code>ã€‚è€Œå¯¹äº<code>nextReqId</code>ï¼Œæˆ‘ä»¬å®ç°å¦‚ä¸‹æ–¹æ³•æ¥ç”Ÿæˆã€‚<code>nextId()</code>æ–¹æ³•å¯ä»¥è¿”å›1,2,&mldr;nåºå·ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ck</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span>) <span style=color:#a6e22e>nextId</span>() <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>nextReqId</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Clientçš„åˆå§‹åŒ–å‡½æ•°å¦‚ä¸‹ï¼Œæˆ‘ä»¬ä»…éœ€ä¸º<code>clerkId</code>èµ‹å€¼å³å¯ï¼Œå…¶ä½™å­—æ®µä½¿ç”¨é›¶å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MakeClerk</span>(<span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ck</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>Clerk</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span> = <span style=color:#a6e22e>servers</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You&#39;ll have to add code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>clerkId</span> = <span style=color:#a6e22e>nrand</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ck</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=commonéƒ¨åˆ†>Commonéƒ¨åˆ†</h4><p>ä»£ç æ¡†æ¶ç»™å‡ºäº†Errå®šä¹‰ï¼Œä»¥åŠå¯é€‰çš„å¸¸é‡ã€‚æˆ‘ä»¬å†æ·»åŠ â€œè¶…æ—¶â€å¸¸é‡ï¼Œä¾¿äºClientå¤„ç†RPCè¯·æ±‚ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OK</span>             = <span style=color:#e6db74>&#34;OK&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrNoKey</span>       = <span style=color:#e6db74>&#34;ErrNoKey&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrWrongLeader</span> = <span style=color:#e6db74>&#34;ErrWrongLeader&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrTimeout</span> = <span style=color:#e6db74>&#34;ErrTimeout&#34;</span> <span style=color:#75715e>// æ–°å¢</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Err</span> <span style=color:#66d9ef>string</span>
</span></span></code></pre></div><p>æˆ‘ä»¬éœ€è¦ä¸ºGetã€Putã€Append RPCçš„<strong>è¯·æ±‚å‚æ•°</strong>éƒ½åŠ ä¸Š<code>clerkId</code>å’Œ<code>nextReqId</code>ï¼Œè®©Serveråˆ¤æ–­é‡å¤ï¼Œå“åº”å‚æ•°ä¿æŒåŸæ ·å³å¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PutAppendArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You&#39;ll have to add definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Field names must start with capital letters,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// otherwise RPC will break.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqID</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GetArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You&#39;ll have to add definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqID</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥è¡¥å……å¸¸é‡ï¼Œæ ‡è®°æ“ä½œç±»å‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OpTypeGet</span>    = <span style=color:#e6db74>&#34;GET&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OpTypePut</span>    = <span style=color:#e6db74>&#34;PUT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OpTypeAppend</span> = <span style=color:#e6db74>&#34;APPEND&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=rpcæ–¹æ³•å®ç°>RPCæ–¹æ³•å®ç°</h4><p><code>Put</code>æ–¹æ³•ä¸<code>Append</code>æ–¹æ³•éå¸¸ç±»ä¼¼ï¼Œå…±ç”¨ä¸€ä¸ªå®ç°å³å¯ï¼Œä»£ç æ¡†æ¶å·²ç»å®šä¹‰äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä»…éœ€å®ç°<code>Get</code>å’Œ<code>PutAppend</code>æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRPCè¯·æ±‚å¤±è´¥çš„æƒ…å†µåˆ†ä¸ºä¸¤ç§ï¼š</p><ol><li>RPCé€šä¿¡æˆåŠŸï¼ŒServerè¿”å›å“åº”å€¼ã€‚</li><li>RPCé€šä¿¡å¤±è´¥ï¼ŒCallæ–¹æ³•è¿”å›falseå€¼ã€‚</li></ol><p>æ— è®ºå“ªç§æƒ…å†µï¼Œè¯·æ±‚å¤±è´¥éƒ½åº”è¯¥æ›´æ¢Serverï¼Œä¸èƒ½æ­»ç£•åŒä¸€ä¸ªServerï¼Œå¦åˆ™æµ‹è¯•ç”¨ä¾‹ä¼šæ— æ³•é€šè¿‡ã€‚</p><p>å½“RPCè¯·æ±‚æˆåŠŸåï¼Œéœ€è¦æ›´æ–°<code>lastLeader</code>å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ck</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span>) <span style=color:#a6e22e>PutAppend</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>op</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You will have to modify this function.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>PutAppendArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Value</span>:   <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>clerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqID</span>:   <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>nextId</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>PutAppendReply</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serverId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Ready to %s key:[%s] value:[%s] to S%d&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>serverId</span>].<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;KVServer.&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>op</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// è¯¥Serverå¯èƒ½å·²ç»å®•æœºï¼Œå°è¯•ä¸‹ä¸€ä¸ª</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OK</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] %s key:[%s] To S%d success&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>SwapInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>, int64(<span style=color:#a6e22e>serverId</span>))
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrWrongLeader</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] %s ,But Server %d is not Leader&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrTimeout</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] %s ,Server %d is Timeout&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Get</code>æ–¹æ³•å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œå¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ck</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You will have to modify this function.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>clerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqID</span>:   <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>nextId</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>GetReply</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serverId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>serverId</span>].<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;KVServer.Get&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// è¯¥Serverå¯èƒ½å·²ç»å®•æœºï¼Œå°è¯•ä¸‹ä¸€ä¸ª</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OK</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Get key From Server%d:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>serverId</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>SwapInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>, int64(<span style=color:#a6e22e>serverId</span>))
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Value</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrNoKey</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrWrongLeader</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Server %d is not Leader&#34;</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrTimeout</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Server %d is Timeout&#34;</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=databaseå®ç°>Databaseå®ç°</h4><p>åœ¨å®ç°Serverä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆéœ€è¦å®ç°ä¸€ä¸ªç®€æ˜“çš„æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹ã€‚</p><p>æ•°æ®å¯ä»¥ä½¿ç”¨mapç±»å‹å­˜å‚¨ï¼Œæ“ä½œmapæ—¶è¦æ³¨æ„å¹¶å‘é—®é¢˜ï¼Œå› æ­¤éœ€è¦åŠ é”ã€‚ç”±äºæ•°æ®åº“ä»…èƒ½ç”±Serverè¿›è¡Œæ“ä½œï¼Œæ‰€ä»¥åŠ é”ä»£ç åœ¨å®ç°Serveræ—¶æ·»åŠ ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Database</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Me</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DB</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDatabase</span>(<span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Database</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Me</span>: <span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DB</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Database%d] Get key:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Me</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>ErrNoKey</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>) <span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Database%d] Put key:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Me</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>) <span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>val</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Database%d] Append key:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Me</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>], <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=serverå®ç°>Serverå®ç°</h4><p><img src=https://i0.hdslb.com/bfs/article/0f579caf92c934cd75fb06317bca3a0a2099359.png@1e_1c.webp alt=Serveræµç¨‹ç¤ºæ„å›¾></p><p>Serverçš„å®ç°å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚æ¥æ”¶åˆ°RPCè¯·æ±‚æ—¶ï¼Œéœ€è¦å°†è¯·æ±‚å‘é€ç»™<code>OpHandler</code>è¿›è¡Œç»Ÿä¸€å¤„ç†ï¼Œ<code>OpHandler</code>ä¼šå°†æ—¥å¿—å‘é€ç»™Raftï¼ŒRaftåŒæ­¥æ—¥å¿—ä¹‹åï¼Œä¼šå°†â€œæäº¤æ—¥å¿—ä¿¡æ¯â€è¿”å›ç»™Serverï¼Œ<code>handleOperation</code>ä¼šå¤„ç†â€œæäº¤æ—¥å¿—ä¿¡æ¯â€ï¼Œæ‰§è¡Œæ—¥å¿—çš„æ“ä½œä¹‹åä¼šé€šçŸ¥<code>OpHandler</code>ï¼Œ<code>OpHandler</code>æœ€åå°†å“åº”ä¿¡æ¯è¿”å›ç»™RPCå‡½æ•°ï¼ŒClientæœ€ç»ˆæ”¶åˆ°å“åº”ï¼Œå‘é€ä¸‹ä¸€æ¡RPCè¯·æ±‚ã€‚</p><p>æ•´ä½“æµç¨‹å¦‚ä¸Šï¼Œä½†åœ¨ç»†èŠ‚éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°â€œ<strong>ç¼“å­˜</strong>â€ä»¥åŠâ€œ<strong>ç›‘å¬é€šé“</strong>â€ã€‚â€œç¼“å­˜â€ç”¨äºå¯¹è¯·æ±‚å»é‡ã€‚</p><p><strong>Opç»“æ„ä½“</strong></p><p><code>Op</code>æ˜¯Serverå‘é€ç»™Raftçš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒæ ·ä¹Ÿæ˜¯<code>OpHandler</code>æ–¹æ³•çš„å…¥å‚ã€‚åœ¨é”®å€¼æœåŠ¡ä¸­ï¼Œè€ƒè™‘åˆ°é‡å¤æ€§é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å®šä¹‰ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Op</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Field names must start with capital letters,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// otherwise RPC will break.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>ç¼“å­˜AppliedMsg</strong></p><p>ç¼“å­˜ä¸­è®°å½•äº†å·²ç»æäº¤çš„Msgï¼Œå®ç°ç¼“å­˜æ—¶éœ€è¦æ³¨æ„ä¸èƒ½å ç”¨å¤ªå¤šå†…å­˜ï¼Œå¦åˆ™å°†æ— æ³•é€šè¿‡æµ‹è¯•ã€‚</p><p>å¯¹äºåŒä¸€ä¸ªClientï¼ŒRPCè¯·æ±‚çš„<code>ReqId</code>æ˜¯é€’å¢çš„ï¼Œè¿™æ„å‘³åªæœ‰ClientæˆåŠŸè¯·æ±‚ä¸€æ¬¡RPCåæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡è¯·æ±‚ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨è®¾è®¡AppliedMsgæ—¶ï¼Œä»…éœ€ä¿å­˜æ¯ä¸ªClientçš„æœ€æ–°è¯·æ±‚ç»“æœï¼Œèƒ½æå¤§å‡å°‘å†…å­˜å ç”¨ã€‚å½“è¯·æ±‚çš„<code>ReqId</code>å°äºæœ€æ–°çš„<code>ReqId</code>ï¼Œåˆ™è¿”å›falseã€‚</p><p>åŒæ ·çš„ï¼Œå¯¹<code>AppliedLog</code>æ“ä½œéœ€è¦åŠ é”ï¼Œç”±Serverå¤„ç†ã€‚</p><p>å®ç°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppliedMsg</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Val</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppliedLog</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Applied</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#a6e22e>AppliedMsg</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>) <span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#a6e22e>AppliedMsg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span>[<span style=color:#a6e22e>clerkId</span>].<span style=color:#a6e22e>ReqId</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>reqId</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span>[<span style=color:#a6e22e>clerkId</span>] = <span style=color:#a6e22e>AppliedMsg</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>: <span style=color:#a6e22e>reqId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Val</span>:   <span style=color:#a6e22e>val</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span>[<span style=color:#a6e22e>clerkId</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>ReqId</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>reqId</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>Val</span>, <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>ç›‘å¬é€šé“NotfiyCh</strong></p><p><code>handleOperation</code>åœ¨æ”¶åˆ°Raftæäº¤çš„æ—¥å¿—ä¹‹åï¼Œå°†ä¼šå¾€<code>NotifyCh</code>ä¸­æ·»åŠ æ¶ˆæ¯ï¼Œ<code>OpHandler</code>æ¥å—æ¶ˆæ¯å¹¶è¿”å›ç»™Clientã€‚é€šé“åº”è¯¥ç”±<code>OpHandler</code>åˆ›å»ºå¹¶åˆ é™¤ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NotifyMsg</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Val</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NotifyCh</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span> <span style=color:#75715e>// map[clerkId][reqId] -&gt; chan</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>][<span style=color:#a6e22e>reqId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>) <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>]; !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>] = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>][<span style=color:#a6e22e>reqId</span>] = <span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>) <span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>][<span style=color:#a6e22e>reqId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          delete(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>], <span style=color:#a6e22e>reqId</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Serveråˆå§‹åŒ–</strong></p><p>æˆ‘ä»¬éœ€è¦å®ç°<code>StartKVServer</code>å‡½æ•°ï¼Œç”¨æˆ·Serverçš„åˆå§‹åŒ–ã€‚<code>handleOperation()</code>æ–¹æ³•åº”è¯¥ç”±ä¸€ä¸ªåç¨‹å•ç‹¬æ‰§è¡Œï¼Œåç»­è¯¦ç»†è®²è¿°è¯¥æ–¹æ³•çš„å®ç°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>KVServer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Raft</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>    <span style=color:#66d9ef>int32</span> <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// snapshot if log grows this big</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>          <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>notifyCh</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applied</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>StartKVServer</span>(<span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// call labgob.Register on structures you want</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Go&#39;s RPC library to marshall/unmarshall.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>Op</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>KVServer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span> = <span style=color:#a6e22e>maxraftstate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span> = <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>persister</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span> = <span style=color:#a6e22e>NewDatabase</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>NotifyCh</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AppliedLog</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>handleOperation</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>kv</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>OpHandler</strong></p><p>åœ¨å°†æ“ä½œæ—¥å¿—å‘é€ç»™Raftæ—¶ï¼Œé¦–å…ˆåº”è¯¥æ£€æµ‹ç¼“å­˜ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºæ¶ˆæ¯é€šé“ã€‚æ­¤å¤„ï¼Œæˆ‘è®¾ç½®äº†1sçš„ç­‰å¾…çš„æ—¶é—´ï¼Œ1sä¹‹å†…å¦‚æœæ— æ¶ˆæ¯è¿”å›ï¼Œåˆ™åˆ é™¤é€šé“å¹¶å‘å®¢æˆ·ç«¯å“åº”é”™è¯¯ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆæ­¥å»é‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æäº¤åˆ°Raft</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>isLeader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>ErrWrongLeader</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Start handle [%s],  key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] handle [%s] Timeout, key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>ErrTimeout</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>:
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] handle [%s] Success, key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Val</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>RPCæ–¹æ³•</strong></p><p>ä¸Clientä¸­çš„Putå’ŒAppendä¸€æ ·ï¼Œæˆ‘ä»¬å°†ä¸¤ç§æ“ä½œç±»å‹åˆå¹¶ä¸º<code>putAppend</code>ï¼Œç®€åŒ–ä»£ç ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GetArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GetReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Type</span>:    <span style=color:#a6e22e>OpTypeGet</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Value</span>:   <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkID</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqID</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate Get [%s] Failed,Err: %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate Get [%s] Success, current Val: [%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>val</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>putAppend</span>(<span style=color:#a6e22e>opType</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Type</span>:    <span style=color:#a6e22e>opType</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Value</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Value</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkID</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqID</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate %s [%s] Failed,Err: %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>opType</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate %s [%s] Success, current val:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>opType</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>putAppend</span>(<span style=color:#a6e22e>OpTypePut</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>putAppend</span>(<span style=color:#a6e22e>OpTypeAppend</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>handleOperation</strong></p><p>è¯¥å‡½æ•°æ¥æ”¶åˆ°æ—¥å¿—ä¿¡æ¯åï¼Œé¦–å…ˆéœ€è¦è¿›è¡Œå»é‡ï¼Œå¦‚æœä¸å»é‡å°†ä¼šå¯¼è‡´é”™è¯¯ï¼Œä¾‹å¦‚ï¼Œå½“Clientçš„æ‰§è¡Œå‘½ä»¤åˆ°è¾¾Serveræ—¶ï¼ŒServerå¤„ç†æ—¶é—´è¾ƒé•¿ï¼ŒClientè¶…æ—¶ï¼Œå› æ­¤æ²¡æœ‰å°†å‘½ä»¤ç»“æœç¼“å­˜ï¼ŒClienté‡æ–°è¯·æ±‚ï¼ŒServerä¼šå¤„ç†ä¸¤æ¡ä¸€æ¨¡ä¸€æ ·çš„å‘½ä»¤ï¼Œè€ŒhandleOperationå¤„ç†å®Œæˆä¸€æ¡å‘½ä»¤ä¹‹åï¼Œä¾¿ä¼šå…³é—­é€šé“ï¼Œç”±äºhandleOperationæ²¡æœ‰è¿›è¡Œå»é‡ï¼Œé€šé“ä¼šè¢«å…³é—­2éï¼Œå¯¼è‡´å‡ºé”™ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶éæ¯æ¬¡å¤„ç†çš„msgéƒ½å­˜åœ¨æ¶ˆæ¯é€šé“ï¼Œ<strong>åªæœ‰<strong><strong>Leader</strong></strong>æ”¶åˆ°Clientè¯·æ±‚ä¹‹åï¼Œæ‰ä¼šåˆ›å»ºæ¶ˆæ¯é€šé“</strong>ï¼Œè€Œå¯¹äºFollowerè€Œè¨€ï¼Œåªä¼šæ¥æ”¶åˆ°msgä¿¡æ¯ï¼Œæ— éœ€å‘é€šé“å“åº”ã€‚</p><p>æ­¤å¤–ï¼Œå½“æ•°æ®åº“æ“ä½œæˆåŠŸä¹‹åï¼Œå°±å¿…é¡»å°†ç»“æœä¿å­˜åœ¨ç¼“å­˜ä¸­ï¼Œå³è¦ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚ä¹‹å‰æˆ‘å°†â€œæ·»åŠ ç¼“å­˜â€é€»è¾‘æ”¾åœ¨OpHandlerä¸­ï¼Œä¾¿å‡ºç°äº†é”™è¯¯ï¼Œå› ä¸ºè¶…æ—¶åï¼Œå·²ä¿å­˜è‡³æ•°æ®åº“çš„æ•°æ®æ²¡æœ‰ä¿å­˜åœ¨ç¼“å­˜ä¸­ï¼Œå¯¼è‡´é‡è¯•æ—¶ä¼šå†æ¬¡æ›´æ–°æ•°æ®åº“ï¼Œç ´åäº†å¹‚ç­‰æ€§ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>handleOperation</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandValid</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Command</span>.(<span style=color:#a6e22e>Op</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Apply [%s], key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>          )
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#75715e>// å»é‡</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Already Applied [%s], key:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeGet</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypePut</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeAppend</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Get NotifyCh Done ,Op:[%s], key:[%s], ChIsNil:[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>NotifyMsg</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Val</span>: <span style=color:#a6e22e>val</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Err</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Notify Clerk [%d] Req [%d] Done,Op:[%s], key:[%s] value:[%s]&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>             close(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       } 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è¿è¡Œç»“æœ>è¿è¡Œç»“æœ</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>client</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>15.1</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3341</span>  <span style=color:#ae81ff>659</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>ops</span> <span style=color:#a6e22e>complete</span> <span style=color:#a6e22e>fast</span> <span style=color:#a6e22e>enough</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>22.5</span>  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>3042</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>15.8</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7385</span> <span style=color:#ae81ff>1447</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>16.0</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>5270</span>  <span style=color:#ae81ff>930</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>concurrent</span> <span style=color:#a6e22e>append</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>same</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>unreliable</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>2.2</span>  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>208</span>   <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>progress</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>majority</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>1.3</span>  <span style=color:#ae81ff>5</span>    <span style=color:#ae81ff>69</span>    <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>no</span> <span style=color:#a6e22e>progress</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>minority</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>1.1</span>  <span style=color:#ae81ff>5</span>    <span style=color:#ae81ff>97</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>completion</span> <span style=color:#a6e22e>after</span> <span style=color:#a6e22e>heal</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>1.1</span>  <span style=color:#ae81ff>5</span>    <span style=color:#ae81ff>45</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>client</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>23.1</span>  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>12402</span>  <span style=color:#ae81ff>453</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>23.6</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7438</span> <span style=color:#ae81ff>1376</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>client</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>22.4</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3514</span>  <span style=color:#ae81ff>661</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>22.4</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7952</span> <span style=color:#ae81ff>1430</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>23.8</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>5546</span>  <span style=color:#ae81ff>832</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>29.9</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7142</span> <span style=color:#ae81ff>1237</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>30.4</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3480</span>  <span style=color:#ae81ff>440</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>random</span> <span style=color:#a6e22e>keys</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>33.4</span>  <span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>9368</span>  <span style=color:#ae81ff>837</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PASS</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ok</span>      <span style=color:#ae81ff>6.5840</span><span style=color:#f92672>/</span><span style=color:#a6e22e>kvraft</span>   <span style=color:#ae81ff>286.255</span><span style=color:#a6e22e>s</span>
</span></span></code></pre></div><h2 id=part-b---å¸¦å¿«ç…§çš„é”®å€¼æœåŠ¡>Part B - å¸¦å¿«ç…§çš„é”®/å€¼æœåŠ¡</h2><h3 id=ä»»åŠ¡è¦æ±‚-1>ä»»åŠ¡è¦æ±‚</h3><p>å°±ç›®å‰æƒ…å†µè€Œè¨€ï¼Œé”®/å€¼æœåŠ¡å™¨å¹¶æœªè°ƒç”¨ Raft åº“çš„ Snapshot() æ–¹æ³•ï¼Œ<strong>é‡å¯çš„æœåŠ¡å™¨å¿…é¡»é‡æ”¾å®Œæ•´çš„æŒä¹…åŒ– Raft æ—¥å¿—ä»¥æ¢å¤å…¶çŠ¶æ€</strong>ã€‚ç°åœ¨ï¼Œæ‚¨å°†ä¿®æ”¹ kvserverï¼Œä½¿å…¶ä¸ Raft åä½œï¼Œåˆ©ç”¨ Lab 3D ä¸­çš„ Raft Snapshot() æ¥èŠ‚çœæ—¥å¿—ç©ºé—´ï¼Œå¹¶å‡å°‘é‡å¯æ—¶é—´ã€‚</p><p>æµ‹è¯•è€…å°† <code>maxraftstate</code> ä¼ é€’ç»™ä½ çš„ <code>StartKVServer()</code> ã€‚ <code>maxraftstate</code> è¡¨ç¤ºä½ çš„æŒä¹…åŒ– Raft çŠ¶æ€çš„æœ€å¤§å…è®¸å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼ŒåŒ…æ‹¬æ—¥å¿—ï¼Œä½†ä¸åŒ…æ‹¬å¿«ç…§ï¼‰ã€‚ä½ åº”è¯¥<strong>å°† maxraftstate ä¸ persister.RaftStateSize() è¿›è¡Œæ¯”è¾ƒ</strong>ã€‚æ¯å½“ä½ çš„é”®/å€¼æœåŠ¡å™¨æ£€æµ‹åˆ° Raft çŠ¶æ€å¤§å°æ¥è¿‘æ­¤é˜ˆå€¼æ—¶ï¼Œåº”é€šè¿‡è°ƒç”¨ Raft çš„ Snapshot æ¥ä¿å­˜å¿«ç…§ã€‚<strong>å¦‚æœ maxraftstate ä¸º-1ï¼Œåˆ™æ— éœ€è¿›è¡Œå¿«ç…§ã€‚</strong> maxraftstate é€‚ç”¨äºä½ çš„ Raft ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™ persister.Save() çš„ GOB ç¼–ç å­—èŠ‚ã€‚</p><p><strong>ä»»åŠ¡</strong>ï¼š</p><p>ä¿®æ”¹ä½ çš„ kvserverï¼Œä½¿å…¶èƒ½å¤Ÿæ£€æµ‹åˆ°æŒä¹…åŒ–çš„ Raft çŠ¶æ€å˜å¾—è¿‡å¤§æ—¶ï¼Œå‘ Raft ä¼ é€’ä¸€ä¸ªå¿«ç…§ã€‚å½“ kvserver æœåŠ¡å™¨é‡å¯æ—¶ï¼Œå®ƒåº”ä» persister è¯»å–å¿«ç…§å¹¶ä»å¿«ç…§ä¸­æ¢å¤å…¶çŠ¶æ€ã€‚</p><p><strong>æç¤º</strong>ï¼š</p><ul><li>è€ƒè™‘ä¸€ä¸‹ kvserver åº”è¯¥åœ¨ä½•æ—¶å¯¹å…¶çŠ¶æ€è¿›è¡Œå¿«ç…§ï¼Œä»¥åŠå¿«ç…§ä¸­åº”åŒ…å«å“ªäº›å†…å®¹ã€‚Raft ä½¿ç”¨ Save() å°†æ¯ä¸ªå¿«ç…§å­˜å‚¨åœ¨ persister å¯¹è±¡ä¸­ï¼ŒåŒæ—¶ä¿å­˜ç›¸åº”çš„ Raft çŠ¶æ€ã€‚ä½ å¯ä»¥ä½¿ç”¨ ReadSnapshot() è¯»å–æœ€æ–°å­˜å‚¨çš„å¿«ç…§ã€‚</li><li>æ‚¨çš„ kvserver å¿…é¡»èƒ½å¤Ÿæ£€æµ‹è·¨æ£€æŸ¥ç‚¹çš„æ—¥å¿—ä¸­çš„é‡å¤æ“ä½œï¼Œå› æ­¤ç”¨äºæ£€æµ‹å®ƒä»¬çš„ä»»ä½•çŠ¶æ€éƒ½å¿…é¡»åŒ…å«åœ¨å¿«ç…§ä¸­ã€‚</li><li>å°†å¿«ç…§ä¸­å­˜å‚¨çš„ç»“æ„çš„æ‰€æœ‰å­—æ®µå¤§å†™ã€‚</li><li>ä½ çš„ Raft åº“å¯èƒ½å­˜åœ¨æœ¬å®éªŒæš´éœ²çš„ bugã€‚å¦‚æœå¯¹ Raft å®ç°è¿›è¡Œäº†ä¿®æ”¹ï¼Œè¯·ç¡®ä¿å®ƒä»èƒ½é€šè¿‡æ‰€æœ‰ Lab 3 æµ‹è¯•ã€‚</li><li>è¿›è¡Œå®éªŒ 4 æµ‹è¯•çš„åˆç†æ—¶é—´åº”ä¸º 400 ç§’çš„å®é™…æ—¶é—´å’Œ 700 ç§’çš„ CPU æ—¶é—´ã€‚æ­¤å¤–ï¼Œ go test -run TestSnapshotSize åº”å°‘äº 20 ç§’çš„å®é™…æ—¶é—´ã€‚</li></ul><h3 id=å®ç°-1>å®ç°</h3><p>æˆ‘ä»¬éœ€è¦è®°å½•æœ€åä¸€æ¬¡å¿«ç…§çš„CommandIndexï¼Œç”¨æ¥åˆ¤æ–­å¿«ç…§è¯·æ±‚æ˜¯å¦è¿‡æœŸï¼Œé¿å…åŠ è½½äº†è¿‡æœŸçš„å¿«ç…§ä¿¡æ¯ï¼Œå› æ­¤Serverç»“æ„ä½“éœ€è¦æ–°å¢<code>lastApplied</code>å±æ€§å€¼ã€‚Serveråº”è¯¥æŒä¹…åŒ–<code>Database</code>ã€<code>Applied</code>å’Œ<code>LastApplied</code>çŠ¶æ€ä¿¡æ¯ï¼Œä¾¿äºå®•æœºé‡å¯åèƒ½æ¢å¤ä¹‹å‰çš„çŠ¶æ€ã€‚</p><h4 id=serveråˆå§‹åŒ–>Serveråˆå§‹åŒ–</h4><p>åœ¨ç»“æ„ä½“ä¸­æ–°å¢<code>lastApplied</code>ã€<code>persister</code>ã€‚æ­£å¦‚ä»»åŠ¡è¦æ±‚ï¼Œéœ€è¦ä½¿ç”¨<code>persister.RaftStateSize()</code>å€¼ä¸<code>maxraftstate</code>è¿›è¡Œæ¯”è¾ƒã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>KVServer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Raft</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>    <span style=color:#66d9ef>int32</span> <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// snapshot if log grows this big</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>          <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>notifyCh</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applied</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Persister</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åˆå§‹åŒ–æ–¹æ³•æ–°å¢åŠ è½½å¿«ç…§ï¼Œå…·ä½“å®ç°è§åç»­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>StartKVServer</span>(<span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// call labgob.Register on structures you want</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Go&#39;s RPC library to marshall/unmarshall.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>Op</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>KVServer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span> = <span style=color:#a6e22e>maxraftstate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span> = <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>persister</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span> = <span style=color:#a6e22e>NewDatabase</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>NotifyCh</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AppliedLog</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>persister</span> = <span style=color:#a6e22e>persister</span> <span style=color:#75715e>// 4B</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>LoadSnapShot</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadSnapshot</span>()) <span style=color:#75715e>//4B</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>handleOperation</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>kv</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=snapshot>SnapShot</h4><p>â€œç”Ÿæˆå¿«ç…§â€å’Œâ€œåŠ è½½å¿«ç…§â€çš„æ–¹æ³•å°†çŠ¶æ€ä¿¡æ¯ä¸å¿«ç…§äº’è½¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>GenSnapShot</span>() []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] GenSnapShot Encode DB Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] GenSnapShot Encode Applied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] GenSnapShot Encode LastApplied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Bytes</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åŒç†ï¼Œå°†ä¸‰ä¸ªçŠ¶æ€ä¿¡æ¯ååºåˆ—åŒ–ä¹‹åï¼Œæ›¿ä»£Serverçš„å±æ€§å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>LoadSnapShot</span>(<span style=color:#a6e22e>snapShot</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>snapShot</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>snapShot</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>          <span style=color:#a6e22e>Database</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>applied</span>     <span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>db</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] LoadSnapShot Decode DB Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>applied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] LoadSnapShot Decode Applied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>lastApplied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] LoadSnapShot Decode LastApplied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>db</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>applied</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#a6e22e>lastApplied</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=handleoperation>handleOperation</h4><p>æ·»åŠ å¤„ç†å¿«ç…§çš„é€»è¾‘ã€‚å½“ä»Raftä¸­æ”¶åˆ°çš„msgä¸ºSnapShotç±»å‹æ—¶ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºè¿‡æœŸä¿¡æ¯ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™æ›´æ–°è‡ªèº«çŠ¶æ€ä¸ºå¿«ç…§ä¿¡æ¯ã€‚å¯¹äºCommandæ¶ˆæ¯ï¼Œæ¯æ¬¡æˆåŠŸå¤„ç†ä¹‹åéƒ½éœ€è¦æ›´æ–°<code>lastApplied</code>å€¼ã€‚</p><p>ä»»åŠ¡è¦æ±‚æˆ‘ä»¬<code>RaftStateSize()</code>æ¥è¿‘<code>maxraftstate</code>è¿›è¡Œå¿«ç…§ï¼Œæˆ‘å°†æ‰§è¡Œå¿«ç…§çš„é˜ˆå€¼è®¾ç½®ä¸º<code>0.9* maxraftstate</code>ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>handleOperation</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandValid</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Command</span>.(<span style=color:#a6e22e>Op</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Apply [%s], key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>          )
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#75715e>// å»é‡</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Already Applied [%s], key:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeGet</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypePut</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeAppend</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandIndex</span> <span style=color:#75715e>//4B</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Get NotifyCh Done ,Op:[%s], key:[%s], ChIsNil:[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>NotifyMsg</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Val</span>: <span style=color:#a6e22e>val</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Err</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Notify Clerk [%d] Req [%d] Done,Op:[%s], key:[%s] value:[%s]&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>             close(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// åˆ¤æ–­æ˜¯å¦éœ€è¦ç”Ÿæˆå¿«ç…§</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>size</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>RaftStateSize</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>&gt;=</span> int(float64(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>0.9</span>) {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] RaftStateSize:[%d] &gt;= MaxRaftState:[%d], Start GenSnapShot&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>GenSnapShot</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>Snapshot</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandIndex</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotValid</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Apply Snapshot, Index:[%d]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>LoadSnapShot</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Snapshot</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è¿è¡Œç»“æœ-1>è¿è¡Œç»“æœ</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test: InstallSnapshot RPC <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>labgob warning: Decoding into a non-default variable/field Err may not work
</span></span><span style=display:flex><span>  ... Passed --   5.3  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>258</span>   <span style=color:#ae81ff>63</span>
</span></span><span style=display:flex><span>Test: snapshot size is reasonable <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  17.9  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>2430</span>  <span style=color:#ae81ff>800</span>
</span></span><span style=display:flex><span>Test: ops complete fast enough <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  21.9  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>3034</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Test: restarts, snapshots, one client <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  22.5  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3578</span>  <span style=color:#ae81ff>672</span>
</span></span><span style=display:flex><span>Test: restarts, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  23.9  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>55081</span> <span style=color:#ae81ff>10494</span>
</span></span><span style=display:flex><span>Test: unreliable net, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  16.3  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>4925</span>  <span style=color:#ae81ff>815</span>
</span></span><span style=display:flex><span>Test: unreliable net, restarts, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  24.2  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>6327</span>  <span style=color:#ae81ff>988</span>
</span></span><span style=display:flex><span>Test: unreliable net, restarts, partitions, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  30.4  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>4888</span>  <span style=color:#ae81ff>723</span>
</span></span><span style=display:flex><span>Test: unreliable net, restarts, partitions, snapshots, random keys, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  31.5  <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>12197</span> <span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/kvraft   193.948s
</span></span></code></pre></div></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#ä»‹ç»>ä»‹ç»</a></li><li><a href=#part-a---æ— å¿«ç…§çš„é”®å€¼æœåŠ¡>Part A - æ— å¿«ç…§çš„é”®/å€¼æœåŠ¡</a><ul><li><a href=#ä»»åŠ¡è¦æ±‚>ä»»åŠ¡è¦æ±‚</a></li><li><a href=#å®ç°>å®ç°</a></li><li><a href=#è¿è¡Œç»“æœ>è¿è¡Œç»“æœ</a></li></ul></li><li><a href=#part-b---å¸¦å¿«ç…§çš„é”®å€¼æœåŠ¡>Part B - å¸¦å¿«ç…§çš„é”®/å€¼æœåŠ¡</a><ul><li><a href=#ä»»åŠ¡è¦æ±‚-1>ä»»åŠ¡è¦æ±‚</a></li><li><a href=#å®ç°-1>å®ç°</a></li><li><a href=#è¿è¡Œç»“æœ-1>è¿è¡Œç»“æœ</a></li></ul></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>ğŸ‘‹ Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyyå¹´MMæœˆddæ—¥")})}</script><script src=/js/toc.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>