<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>【MIT6.5840】Lab4-Fault-tolerant Key/Value Service | Bestzy's Blog</title><link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/><meta name=author content="bestzy"><meta name=description content="基于Raft实现一个键值存储服务（kvraft）是理解分布式存储系统设计的核心实践。本文将结合MIT 6.5840课程的Lab 3C，逐步实现一个高可用的键值存储系统。
"><meta name=keywords content="Raft,Tolerant Key/Value Service"><meta name=generator content="Hugo 0.149.0"><meta property="og:url" content="https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="【MIT6.5840】Lab4-Fault-tolerant Key/Value Service"><meta property="og:description" content="基于Raft实现一个键值存储服务（kvraft）是理解分布式存储系统设计的核心实践。本文将结合MIT 6.5840课程的Lab 3C，逐步实现一个高可用的键值存储系统。"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T22:48:11+08:00"><meta property="article:modified_time" content="2025-02-15T22:48:11+08:00"><meta property="article:tag" content="Raft"><meta property="article:tag" content="Tolerant Key/Value Service"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="【MIT6.5840】Lab4-Fault-tolerant Key/Value Service"><meta name=twitter:description content="基于Raft实现一个键值存储服务（kvraft）是理解分布式存储系统设计的核心实践。本文将结合MIT 6.5840课程的Lab 3C，逐步实现一个高可用的键值存储系统。"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">🚀先行其事，后臻其善，再求其优！</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=搜索><ion-icon name=search></ion-icon>搜索</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=搜索><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="【MIT6.5840】Lab4-Fault-tolerant Key/Value Service"><meta itemprop=description content="基于Raft实现一个键值存储服务（kvraft）是理解分布式存储系统设计的核心实践。本文将结合MIT 6.5840课程的Lab 3C，逐步实现一个高可用的键值存储系统。"><meta itemprop=datePublished content="2025-02-15T22:48:11+08:00"><meta itemprop=dateModified content="2025-02-15T22:48:11+08:00"><meta itemprop=wordCount content="7713"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="Raft,Tolerant Key/Value Service"><header><h1 itemprop=headline>【MIT6.5840】Lab4-Fault-tolerant Key/Value Service</h1><p class=text-sm><span data-format=luxon>2025-02-15T22:48:11+08:00</span>
| <span>16分钟阅读</span>
| <span>更新于
<span data-format=luxon>2025-02-15T22:48:11+08:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0! src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e3%80%90MIT6.5840%e3%80%91Lab4-Fault-tolerant%20Key/Value%20Service&amp;url=https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/mit-lab4-fault-tolerant-keyvalue-service/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img class="w-full z-30" src=https://i0.hdslb.com/bfs/article/45a4174762f3bcfaf50274ca36e169232099359.jpg@1e_1c.webp alt="【MIT6.5840】Lab4-Fault-tolerant Key/Value Service"><p>基于Raft实现一个键值存储服务（kvraft）是理解分布式存储系统设计的核心实践。本文将结合MIT 6.5840课程的Lab 3C，逐步实现一个高可用的键值存储系统。</p><h2 id=介绍>介绍</h2><p><a href=http://nil.csail.mit.edu/6.5840/2024/labs/lab-kvraft.html target=_blank>http://nil.csail.mit.edu/6.5840/2024/labs/lab-kvraft.html</a></p><p>在本实验中，您将使用 Lab 3 中的 Raft 库构建一个容错的键/值存储服务。您的键/值服务将是一个复制的状态机，由多个键/值服务器组成，每个服务器都维护一个键/值对的数据库，如 Lab 2 中所示，但额外使用 Raft 进行复制。只要大多数服务器存活并能通信，您的键/值服务应继续处理客户端请求，即使发生其他故障或网络分区。在 Lab 4 之后，您将实现<a href=http://nil.csail.mit.edu/6.5840/2024/notes/raft_diagram.pdf target=_blank> Raft 交互图</a>
中所示的所有部分（Clerk、Service 和 Raft）。</p><p>客户端将以与Lab 2 非常相似的方式与您的键/值服务进行交互。具体来说，客户端可以向键/值服务发送三种不同的 RPC 调用：</p><ul><li>Put(key, value) : 替换数据库中特定键的值</li><li>Append(key, arg) : 将参数附加到键的值（如果键不存在，则将现有值视为空字符串）</li><li>Get(key) : 获取键的当前值（对于不存在的键返回空字符串）</li></ul><p>键和值都是字符串。请注意，<strong>与实验 2 不同， Put 和 Append 都不应向客户端返回值</strong>。每个客户端通过一个带有 Put/Append/Get 方法的 Clerk 与Server 进行通信。</p><p>您的服务必须确保对 Clerk 的 Get/Put/Append 方法的调用是线性化的。如果逐个调用，Get/Put/Append 方法的行为应如同系统仅有一份状态副本，且每次调用都应观察到前序调用序列所隐含的状态修改。对于并发调用，返回值和最终状态必须与这些操作按某种顺序逐个执行时相同。如果调用在时间上重叠，则它们是并发的：例如，如果客户端 X 调用 Clerk.Put() ，客户端 Y 调用 Clerk.Append() ，然后客户端 X 的调用返回。一个调用必须观察到在它开始之前所有已完成调用的效果。</p><p>为单台服务器提供线性一致性相对容易。如果服务被复制，则难度更大，因为所有服务器必须为并发请求选择相同的执行顺序，<strong>必须避免使用未更新的状态回复客户端</strong>，并且必须在故障后以保留所有已确认客户端更新的方式恢复其状态。</p><p>本实验分为两部分。在 A 部分中，你将使用你的 Raft 实现来构建一个复制的键/值服务，但不使用快照。在 B 部分中，你将使用来自实验 3D 的快照实现，这将使 Raft 能够丢弃旧的日志条目。</p><h2 id=part-a---无快照的键值服务>Part A - 无快照的键/值服务</h2><h3 id=任务要求>任务要求</h3><p><img src=https://i0.hdslb.com/bfs/article/c1982e09768283ee86831c97bbade9662099359.png@1e_1c.webp alt=程序架构图></p><p>每个键/值服务器（“kvserver”）都将有一个关联的 Raft 对等体。<strong>Clerks 向关联 Raft 为领导者的 kvserver 发送操作<strong><strong>RPC</strong></strong>请求。kvserver 代码将操作提交给 Raft，以便 Raft 日志中保存一系列操作</strong>。所有 kvserver 按顺序执行 Raft 日志中的操作，将这些操作应用到它们的键/值数据库中；目的是让服务器维护键/值数据库的相同副本。</p><p>Clerk 有时不知道哪个 kvserver 是 Raft 领导者。如果 Clerk 向错误的 kvserver 发送 RPC，或者无法联系到该 kvserver， <strong>Clerk 应通过向不同的 kvserver 发送请求来重试</strong>。如果键/值服务将操作提交到其 Raft 日志（从而将操作应用到键/值状态机），领导者通过响应其 RPC 向 Clerk 报告结果。如果操作未能提交（例如，如果领导者被替换），服务器会报告错误， Clerk 则会尝试使用不同的服务器重试。</p><p>在网络和服务器故障的情况下，你将面临的一个问题是， Clerk 可能不得不多次发送 RPC，直到找到一个回复积极的 kvserver。如果领导者在将条目提交到 Raft 日志后立即失败， <strong>Clerk 可能不会收到回复，因此可能会将请求重新发送给另一个领导者</strong>。每次调用 Clerk.Put() 或 Clerk.Append() 应该只导致一次执行，因此你<strong>必须确保重新发送不会导致服务器执行请求两次</strong>。</p><p><strong>任务</strong>：</p><ul><li>你需要在 server.go 中实现 Put() 、 Append() 和 Get() RPC 处理程序。<strong>这些处理程序应使用 Start() 在 Raft 日志中输入一个</strong> <strong>Op</strong> ；你应在 server.go 中填写 Op 结构体定义，以便描述 Put/Append/Get 操作。每个服务器应在 Raft 提交 Op 命令时执行它们，即当它们出现在 applyCh 上时。RPC 处理程序应注意到 Raft 提交其 Op 时，然后回复 RPC。</li><li>添加代码以处理故障，并<strong>应对重复的 Clerk 请求</strong>，包括 Clerk 在一个任期内向 kvserver 领导者发送请求、等待回复超时并在另一个任期内向新领导者重新发送请求的情况。请求应仅执行一次。这些注释包括重复检测的指导。</li></ul><p><strong>提示</strong>：</p><ul><li>调用 Start() 后，<strong>您的 kvservers 需要等待 Raft 完成一致性协议</strong>。已达成一致的命令会到达 applyCh 。您的代码需要在 Put() 、 Append() 和 Get() 处理程序使用 Start() 向 Raft 日志提交命令时，持续读取 applyCh 。注意 kvserver 与其 Raft 库之间的死锁问题。</li><li>如果 kvserver 不是多数派的一部分，它不应完成 Get() RPC（以免提供过时数据）。一个简单的解决方案是将每个 Get() （以及每个 Put() 和 Append() ）记录到 Raft 日志中。你<strong>无需实现</strong>第 8 节中描述的只读操作优化。</li><li>您不需要向 Raft ApplyMsg 或 Raft RPC（如 AppendEntries ）添加任何字段，但您被允许这样做。</li><li>最好从一开始就添加锁定，因为避免死锁的需求有时会影响整体代码设计。使用 go test -race 检查你的代码是否无竞争。</li><li>您的解决方案需要处理这样一种情况：领导者已为 Clerk 的 RPC 调用了 Start()，但在请求被提交到日志之前失去了领导权。在这种情况下，您应安排 Clerk 将请求重新发送到其他服务器，直到找到新的领导者。一种实现方式是，服务器通过注意到 Raft 的任期已更改或 Start()返回的索引处出现了不同的请求，来检测自己是否已失去领导权。如果前任领导者自身被分区隔离，它将无法知晓新领导者的存在；但同一分区内的任何客户端也无法与新领导者通信，因此在这种情况下，服务器和客户端无限期等待直到分区恢复是可行的。</li><li>你可能需要修改你的 Clerk，使其记住上一次 RPC 中哪个服务器成为了领导者，并首先将下一个 RPC 发送到该服务器。这将避免在每次 RPC 时浪费时间寻找领导者，从而可能帮助你更快地通过某些测试。</li><li>您应采用类似于实验 2 中的重复检测机制。该机制应能迅速释放服务器内存，例如通过让每个 RPC 暗示客户端已收到其前一个 RPC 的回复。可以假设客户端一次只会向 Clerk 发起一个调用。您可能会发现，需要根据实验 2 的情况调整存储在重复检测表中的信息。</li></ul><h3 id=实现>实现</h3><p>根据任务的要求，我们需要实现一个无快照的键/值服务器。介绍中已经给了许多提示，总结一下，需要注意的点包括：</p><ol><li>必须保证请求的幂等性</li><li>Client需要寻找Leader服务</li></ol><p>在Lab2中，我们已经实现了一个简单的键/值服务器，只不过没有接入Raft，因此我们可以借鉴Lab2中的代码，快速定义出Client。</p><h4 id=client初始化>Client初始化</h4><p>为了保证幂等性，我们为Client结构体添加<code>clerkId</code>和<code>nextReqId</code>字段值，服务端能够根据这些字段判断是否为重复请求。此外，我们需要循环寻找Leader，为了能够加速找到Leader，我们可以增加一个字段<code>lastLeader</code>，记录上一次成功请求的Server序号。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Clerk</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You will have to modify this struct.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>clerkId</span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextReqId</span>  <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastLeader</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码框架中提供了<code>nrand()</code>函数，在初始化Client时，我们可以使用该函数生成<code>clerkId</code>。而对于<code>nextReqId</code>，我们实现如下方法来生成。<code>nextId()</code>方法可以返回1,2,&mldr;n序号。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ck</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span>) <span style=color:#a6e22e>nextId</span>() <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>AddInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>nextReqId</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Client的初始化函数如下，我们仅需为<code>clerkId</code>赋值即可，其余字段使用零值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MakeClerk</span>(<span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ck</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>Clerk</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span> = <span style=color:#a6e22e>servers</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You&#39;ll have to add code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>clerkId</span> = <span style=color:#a6e22e>nrand</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ck</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=common部分>Common部分</h4><p>代码框架给出了Err定义，以及可选的常量。我们再添加“超时”常量，便于Client处理RPC请求。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OK</span>             = <span style=color:#e6db74>&#34;OK&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrNoKey</span>       = <span style=color:#e6db74>&#34;ErrNoKey&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrWrongLeader</span> = <span style=color:#e6db74>&#34;ErrWrongLeader&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrTimeout</span> = <span style=color:#e6db74>&#34;ErrTimeout&#34;</span> <span style=color:#75715e>// 新增</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Err</span> <span style=color:#66d9ef>string</span>
</span></span></code></pre></div><p>我们需要为Get、Put、Append RPC的<strong>请求参数</strong>都加上<code>clerkId</code>和<code>nextReqId</code>，让Server判断重复，响应参数保持原样即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PutAppendArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You&#39;ll have to add definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Field names must start with capital letters,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// otherwise RPC will break.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqID</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GetArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You&#39;ll have to add definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqID</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>此外，我们可以补充常量，标记操作类型。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OpTypeGet</span>    = <span style=color:#e6db74>&#34;GET&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OpTypePut</span>    = <span style=color:#e6db74>&#34;PUT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>OpTypeAppend</span> = <span style=color:#e6db74>&#34;APPEND&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=rpc方法实现>RPC方法实现</h4><p><code>Put</code>方法与<code>Append</code>方法非常类似，共用一个实现即可，代码框架已经定义了。所以，我们仅需实现<code>Get</code>和<code>PutAppend</code>方法。需要注意的是，RPC请求失败的情况分为两种：</p><ol><li>RPC通信成功，Server返回响应值。</li><li>RPC通信失败，Call方法返回false值。</li></ol><p>无论哪种情况，请求失败都应该更换Server，不能死磕同一个Server，否则测试用例会无法通过。</p><p>当RPC请求成功后，需要更新<code>lastLeader</code>值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ck</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span>) <span style=color:#a6e22e>PutAppend</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>op</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You will have to modify this function.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>PutAppendArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Value</span>:   <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>clerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqID</span>:   <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>nextId</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>PutAppendReply</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serverId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Ready to %s key:[%s] value:[%s] to S%d&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>serverId</span>].<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;KVServer.&#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>op</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 该Server可能已经宕机，尝试下一个</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OK</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] %s key:[%s] To S%d success&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>SwapInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>, int64(<span style=color:#a6e22e>serverId</span>))
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrWrongLeader</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] %s ,But Server %d is not Leader&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrTimeout</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] %s ,Server %d is Timeout&#34;</span>, <span style=color:#a6e22e>op</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>Get</code>方法几乎一模一样，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ck</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Clerk</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You will have to modify this function.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>GetArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>clerkId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqID</span>:   <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>nextId</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>GetReply</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serverId</span> <span style=color:#f92672>:=</span> int(<span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>LoadInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>[<span style=color:#a6e22e>serverId</span>].<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;KVServer.Get&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 该Server可能已经宕机，尝试下一个</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OK</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Get key From Server%d:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>serverId</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>SwapInt64</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>lastLeader</span>, int64(<span style=color:#a6e22e>serverId</span>))
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Value</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrNoKey</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrWrongLeader</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Server %d is not Leader&#34;</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serverId</span> = (<span style=color:#a6e22e>serverId</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>ck</span>.<span style=color:#a6e22e>servers</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ErrTimeout</span>:
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Client] Server %d is Timeout&#34;</span>, <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>50</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=database实现>Database实现</h4><p>在实现Server之前，我们先需要实现一个简易的数据库，用于存储键值对。</p><p>数据可以使用map类型存储，操作map时要注意并发问题，因此需要加锁。由于数据库仅能由Server进行操作，所以加锁代码在实现Server时添加。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Database</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Me</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DB</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDatabase</span>(<span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Database</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Me</span>: <span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DB</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Database%d] Get key:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Me</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>ErrNoKey</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>) <span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Database%d] Put key:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Me</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>) <span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>val</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Database%d] Append key:[%s] success, val:[%s]&#34;</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Me</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>DB</span>[<span style=color:#a6e22e>key</span>], <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=server实现>Server实现</h4><p><img src=https://i0.hdslb.com/bfs/article/0f579caf92c934cd75fb06317bca3a0a2099359.png@1e_1c.webp alt=Server流程示意图></p><p>Server的实现如上图所示。接收到RPC请求时，需要将请求发送给<code>OpHandler</code>进行统一处理，<code>OpHandler</code>会将日志发送给Raft，Raft同步日志之后，会将“提交日志信息”返回给Server，<code>handleOperation</code>会处理“提交日志信息”，执行日志的操作之后会通知<code>OpHandler</code>，<code>OpHandler</code>最后将响应信息返回给RPC函数，Client最终收到响应，发送下一条RPC请求。</p><p>整体流程如上，但在细节部分，我们还需要实现“<strong>缓存</strong>”以及“<strong>监听通道</strong>”。“缓存”用于对请求去重。</p><p><strong>Op结构体</strong></p><p><code>Op</code>是Server发送给Raft的日志信息，同样也是<code>OpHandler</code>方法的入参。在键值服务中，考虑到重复性问题，我们可以使用以下定义：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Op</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Field names must start with capital letters,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// otherwise RPC will break.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Type</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Key</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ClerkID</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>缓存AppliedMsg</strong></p><p>缓存中记录了已经提交的Msg，实现缓存时需要注意不能占用太多内存，否则将无法通过测试。</p><p>对于同一个Client，RPC请求的<code>ReqId</code>是递增的，这意味只有Client成功请求一次RPC后才会进行下一次请求。所以我们在设计AppliedMsg时，仅需保存每个Client的最新请求结果，能极大减少内存占用。当请求的<code>ReqId</code>小于最新的<code>ReqId</code>，则返回false。</p><p>同样的，对<code>AppliedLog</code>操作需要加锁，由Server处理。</p><p>实现如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppliedMsg</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ReqId</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Val</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppliedLog</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Applied</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#a6e22e>AppliedMsg</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>) <span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>, <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#a6e22e>AppliedMsg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span>[<span style=color:#a6e22e>clerkId</span>].<span style=color:#a6e22e>ReqId</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>reqId</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span>[<span style=color:#a6e22e>clerkId</span>] = <span style=color:#a6e22e>AppliedMsg</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>: <span style=color:#a6e22e>reqId</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Val</span>:   <span style=color:#a6e22e>val</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>a</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>Applied</span>[<span style=color:#a6e22e>clerkId</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>ReqId</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>reqId</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>.<span style=color:#a6e22e>Val</span>, <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>监听通道NotfiyCh</strong></p><p><code>handleOperation</code>在收到Raft提交的日志之后，将会往<code>NotifyCh</code>中添加消息，<code>OpHandler</code>接受消息并返回给Client。通道应该由<code>OpHandler</code>创建并删除。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NotifyMsg</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Val</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NotifyCh</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>m</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span> <span style=color:#75715e>// map[clerkId][reqId] -&gt; chan</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ch</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>][<span style=color:#a6e22e>reqId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>) <span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>]; !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>] = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int64</span>]<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>NotifyMsg</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>][<span style=color:#a6e22e>reqId</span>] = <span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ch</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>) <span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>clerkId</span>, <span style=color:#a6e22e>reqId</span> <span style=color:#66d9ef>int64</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>][<span style=color:#a6e22e>reqId</span>]; <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>          delete(<span style=color:#a6e22e>n</span>.<span style=color:#a6e22e>m</span>[<span style=color:#a6e22e>clerkId</span>], <span style=color:#a6e22e>reqId</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Server初始化</strong></p><p>我们需要实现<code>StartKVServer</code>函数，用户Server的初始化。<code>handleOperation()</code>方法应该由一个协程单独执行，后续详细讲述该方法的实现。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>KVServer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Raft</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>    <span style=color:#66d9ef>int32</span> <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// snapshot if log grows this big</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>          <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>notifyCh</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applied</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>StartKVServer</span>(<span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// call labgob.Register on structures you want</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Go&#39;s RPC library to marshall/unmarshall.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>Op</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>KVServer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span> = <span style=color:#a6e22e>maxraftstate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span> = <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>persister</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span> = <span style=color:#a6e22e>NewDatabase</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>NotifyCh</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AppliedLog</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>handleOperation</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>kv</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>OpHandler</strong></p><p>在将操作日志发送给Raft时，首先应该检测缓存中是否已经存在。如果不存在，则新建消息通道。此处，我设置了1s的等待的时间，1s之内如果无消息返回，则删除通道并向客户端响应错误。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span> <span style=color:#a6e22e>Op</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>Err</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初步去重</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Delete</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提交到Raft</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>isLeader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>ErrWrongLeader</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Start handle [%s],  key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timer</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] handle [%s] Timeout, key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>ErrTimeout</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ch</span>:
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] handle [%s] Success, key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Val</span>, <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>RPC方法</strong></p><p>与Client中的Put和Append一样，我们将两种操作类型合并为<code>putAppend</code>，简化代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GetArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GetReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Type</span>:    <span style=color:#a6e22e>OpTypeGet</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Value</span>:   <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkID</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqID</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate Get [%s] Failed,Err: %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate Get [%s] Success, current Val: [%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Value</span> = <span style=color:#a6e22e>val</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>putAppend</span>(<span style=color:#a6e22e>opType</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Op</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Type</span>:    <span style=color:#a6e22e>opType</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Key</span>:     <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Value</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Value</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ClerkID</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ClerkID</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ReqId</span>:   <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>ReqID</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>opHandler</span>(<span style=color:#a6e22e>op</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate %s [%s] Failed,Err: %s&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>opType</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Operate %s [%s] Success, current val:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>opType</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Err</span> = <span style=color:#a6e22e>OK</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>putAppend</span>(<span style=color:#a6e22e>OpTypePut</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PutAppendReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>putAppend</span>(<span style=color:#a6e22e>OpTypeAppend</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>handleOperation</strong></p><p>该函数接收到日志信息后，首先需要进行去重，如果不去重将会导致错误，例如，当Client的执行命令到达Server时，Server处理时间较长，Client超时，因此没有将命令结果缓存，Client重新请求，Server会处理两条一模一样的命令，而handleOperation处理完成一条命令之后，便会关闭通道，由于handleOperation没有进行去重，通道会被关闭2遍，导致出错。</p><p>需要注意的是，并非每次处理的msg都存在消息通道，<strong>只有<strong><strong>Leader</strong></strong>收到Client请求之后，才会创建消息通道</strong>，而对于Follower而言，只会接收到msg信息，无需向通道响应。</p><p>此外，当数据库操作成功之后，就必须将结果保存在缓存中，即要保证操作的原子性。之前我将“添加缓存”逻辑放在OpHandler中，便出现了错误，因为超时后，已保存至数据库的数据没有保存在缓存中，导致重试时会再次更新数据库，破坏了幂等性。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>handleOperation</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandValid</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Command</span>.(<span style=color:#a6e22e>Op</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Apply [%s], key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>          )
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 去重</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Already Applied [%s], key:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeGet</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypePut</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeAppend</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Get NotifyCh Done ,Op:[%s], key:[%s], ChIsNil:[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>NotifyMsg</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Val</span>: <span style=color:#a6e22e>val</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Err</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Notify Clerk [%d] Req [%d] Done,Op:[%s], key:[%s] value:[%s]&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>             close(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       } 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=运行结果>运行结果</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>client</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>15.1</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3341</span>  <span style=color:#ae81ff>659</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>ops</span> <span style=color:#a6e22e>complete</span> <span style=color:#a6e22e>fast</span> <span style=color:#a6e22e>enough</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>22.5</span>  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>3042</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>15.8</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7385</span> <span style=color:#ae81ff>1447</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>16.0</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>5270</span>  <span style=color:#ae81ff>930</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>concurrent</span> <span style=color:#a6e22e>append</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>same</span> <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>unreliable</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>2.2</span>  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>208</span>   <span style=color:#ae81ff>52</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>progress</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>majority</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>1.3</span>  <span style=color:#ae81ff>5</span>    <span style=color:#ae81ff>69</span>    <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>no</span> <span style=color:#a6e22e>progress</span> <span style=color:#a6e22e>in</span> <span style=color:#a6e22e>minority</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>1.1</span>  <span style=color:#ae81ff>5</span>    <span style=color:#ae81ff>97</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>completion</span> <span style=color:#a6e22e>after</span> <span style=color:#a6e22e>heal</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>   <span style=color:#ae81ff>1.1</span>  <span style=color:#ae81ff>5</span>    <span style=color:#ae81ff>45</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>client</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>23.1</span>  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>12402</span>  <span style=color:#ae81ff>453</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>23.6</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7438</span> <span style=color:#ae81ff>1376</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>one</span> <span style=color:#a6e22e>client</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>22.4</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3514</span>  <span style=color:#ae81ff>661</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>22.4</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7952</span> <span style=color:#ae81ff>1430</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>23.8</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>5546</span>  <span style=color:#ae81ff>832</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>29.9</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>7142</span> <span style=color:#ae81ff>1237</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>30.4</span>  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3480</span>  <span style=color:#ae81ff>440</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Test</span>: <span style=color:#a6e22e>unreliable</span> <span style=color:#a6e22e>net</span>, <span style=color:#a6e22e>restarts</span>, <span style=color:#a6e22e>partitions</span>, <span style=color:#a6e22e>random</span> <span style=color:#a6e22e>keys</span>, <span style=color:#a6e22e>many</span> <span style=color:#a6e22e>clients</span> (<span style=color:#ae81ff>4</span><span style=color:#a6e22e>A</span>) <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>...</span> <span style=color:#a6e22e>Passed</span> <span style=color:#f92672>--</span>  <span style=color:#ae81ff>33.4</span>  <span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>9368</span>  <span style=color:#ae81ff>837</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PASS</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ok</span>      <span style=color:#ae81ff>6.5840</span><span style=color:#f92672>/</span><span style=color:#a6e22e>kvraft</span>   <span style=color:#ae81ff>286.255</span><span style=color:#a6e22e>s</span>
</span></span></code></pre></div><h2 id=part-b---带快照的键值服务>Part B - 带快照的键/值服务</h2><h3 id=任务要求-1>任务要求</h3><p>就目前情况而言，键/值服务器并未调用 Raft 库的 Snapshot() 方法，<strong>重启的服务器必须重放完整的持久化 Raft 日志以恢复其状态</strong>。现在，您将修改 kvserver，使其与 Raft 协作，利用 Lab 3D 中的 Raft Snapshot() 来节省日志空间，并减少重启时间。</p><p>测试者将 <code>maxraftstate</code> 传递给你的 <code>StartKVServer()</code> 。 <code>maxraftstate</code> 表示你的持久化 Raft 状态的最大允许大小（以字节为单位，包括日志，但不包括快照）。你应该<strong>将 maxraftstate 与 persister.RaftStateSize() 进行比较</strong>。每当你的键/值服务器检测到 Raft 状态大小接近此阈值时，应通过调用 Raft 的 Snapshot 来保存快照。<strong>如果 maxraftstate 为-1，则无需进行快照。</strong> maxraftstate 适用于你的 Raft 作为第一个参数传递给 persister.Save() 的 GOB 编码字节。</p><p><strong>任务</strong>：</p><p>修改你的 kvserver，使其能够检测到持久化的 Raft 状态变得过大时，向 Raft 传递一个快照。当 kvserver 服务器重启时，它应从 persister 读取快照并从快照中恢复其状态。</p><p><strong>提示</strong>：</p><ul><li>考虑一下 kvserver 应该在何时对其状态进行快照，以及快照中应包含哪些内容。Raft 使用 Save() 将每个快照存储在 persister 对象中，同时保存相应的 Raft 状态。你可以使用 ReadSnapshot() 读取最新存储的快照。</li><li>您的 kvserver 必须能够检测跨检查点的日志中的重复操作，因此用于检测它们的任何状态都必须包含在快照中。</li><li>将快照中存储的结构的所有字段大写。</li><li>你的 Raft 库可能存在本实验暴露的 bug。如果对 Raft 实现进行了修改，请确保它仍能通过所有 Lab 3 测试。</li><li>进行实验 4 测试的合理时间应为 400 秒的实际时间和 700 秒的 CPU 时间。此外， go test -run TestSnapshotSize 应少于 20 秒的实际时间。</li></ul><h3 id=实现-1>实现</h3><p>我们需要记录最后一次快照的CommandIndex，用来判断快照请求是否过期，避免加载了过期的快照信息，因此Server结构体需要新增<code>lastApplied</code>属性值。Server应该持久化<code>Database</code>、<code>Applied</code>和<code>LastApplied</code>状态信息，便于宕机重启后能恢复之前的状态。</p><h4 id=server初始化>Server初始化</h4><p>在结构体中新增<code>lastApplied</code>、<code>persister</code>。正如任务要求，需要使用<code>persister.RaftStateSize()</code>值与<code>maxraftstate</code>进行比较。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>KVServer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Raft</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>    <span style=color:#66d9ef>int32</span> <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// snapshot if log grows this big</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your definitions here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>db</span>          <span style=color:#f92672>*</span><span style=color:#a6e22e>Database</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>notifyCh</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>NotifyCh</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applied</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Persister</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>初始化方法新增加载快照，具体实现见后续。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>StartKVServer</span>(<span style=color:#a6e22e>servers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>maxraftstate</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// call labgob.Register on structures you want</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Go&#39;s RPC library to marshall/unmarshall.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>Op</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>KVServer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span> = <span style=color:#a6e22e>maxraftstate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span> = make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>ApplyMsg</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span> = <span style=color:#a6e22e>raft</span>.<span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>servers</span>, <span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>persister</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// You may need initialization code here.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span> = <span style=color:#a6e22e>NewDatabase</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>NotifyCh</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AppliedLog</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>persister</span> = <span style=color:#a6e22e>persister</span> <span style=color:#75715e>// 4B</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>LoadSnapShot</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadSnapshot</span>()) <span style=color:#75715e>//4B</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>handleOperation</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>kv</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=snapshot>SnapShot</h4><p>“生成快照”和“加载快照”的方法将状态信息与快照互转。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>GenSnapShot</span>() []<span style=color:#66d9ef>byte</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] GenSnapShot Encode DB Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] GenSnapShot Encode Applied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] GenSnapShot Encode LastApplied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Bytes</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>同理，将三个状态信息反序列化之后，替代Server的属性值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>LoadSnapShot</span>(<span style=color:#a6e22e>snapShot</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>snapShot</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>snapShot</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>db</span>          <span style=color:#a6e22e>Database</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>applied</span>     <span style=color:#a6e22e>AppliedLog</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>db</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] LoadSnapShot Decode DB Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>applied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] LoadSnapShot Decode Applied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>lastApplied</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] LoadSnapShot Decode LastApplied Failed, Err: %v&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>db</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>applied</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#a6e22e>lastApplied</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=handleoperation>handleOperation</h4><p>添加处理快照的逻辑。当从Raft中收到的msg为SnapShot类型时，判断是否为过期信息，如果不是，则更新自身状态为快照信息。对于Command消息，每次成功处理之后都需要更新<code>lastApplied</code>值。</p><p>任务要求我们<code>RaftStateSize()</code>接近<code>maxraftstate</code>进行快照，我将执行快照的阈值设置为<code>0.9* maxraftstate</code>。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>kv</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>KVServer</span>) <span style=color:#a6e22e>handleOperation</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applyCh</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandValid</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>op</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Command</span>.(<span style=color:#a6e22e>Op</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Apply [%s], key:[%s] value:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>err</span> <span style=color:#a6e22e>Err</span>
</span></span><span style=display:flex><span>          )
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 去重</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>); <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Already Applied [%s], key:[%s]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeGet</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypePut</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>OpTypeAppend</span>:
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Append</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>ch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>notifyCh</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandIndex</span> <span style=color:#75715e>//4B</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>applied</span>.<span style=color:#a6e22e>Put</span>(<span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Get NotifyCh Done ,Op:[%s], key:[%s], ChIsNil:[%v]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>ch</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ch</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ch</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>NotifyMsg</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Val</span>: <span style=color:#a6e22e>val</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Err</span>: <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Notify Clerk [%d] Req [%d] Done,Op:[%s], key:[%s] value:[%s]&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ClerkID</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>ReqId</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Type</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Key</span>, <span style=color:#a6e22e>op</span>.<span style=color:#a6e22e>Value</span>)
</span></span><span style=display:flex><span>             close(<span style=color:#a6e22e>ch</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 判断是否需要生成快照</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>size</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>RaftStateSize</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span> <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>size</span> <span style=color:#f92672>&gt;=</span> int(float64(<span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>0.9</span>) {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] RaftStateSize:[%d] &gt;= MaxRaftState:[%d], Start GenSnapShot&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>size</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>maxraftstate</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>data</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>GenSnapShot</span>()
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>Snapshot</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>CommandIndex</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotValid</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DPrintf</span>(<span style=color:#e6db74>&#34;[Server%d] Raft Apply Snapshot, Index:[%d]&#34;</span>, <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>LoadSnapShot</span>(<span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>Snapshot</span>)
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>kv</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=运行结果-1>运行结果</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test: InstallSnapshot RPC <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>labgob warning: Decoding into a non-default variable/field Err may not work
</span></span><span style=display:flex><span>  ... Passed --   5.3  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>258</span>   <span style=color:#ae81ff>63</span>
</span></span><span style=display:flex><span>Test: snapshot size is reasonable <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  17.9  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>2430</span>  <span style=color:#ae81ff>800</span>
</span></span><span style=display:flex><span>Test: ops complete fast enough <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  21.9  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>3034</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>Test: restarts, snapshots, one client <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  22.5  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>3578</span>  <span style=color:#ae81ff>672</span>
</span></span><span style=display:flex><span>Test: restarts, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  23.9  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>55081</span> <span style=color:#ae81ff>10494</span>
</span></span><span style=display:flex><span>Test: unreliable net, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  16.3  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>4925</span>  <span style=color:#ae81ff>815</span>
</span></span><span style=display:flex><span>Test: unreliable net, restarts, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  24.2  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>6327</span>  <span style=color:#ae81ff>988</span>
</span></span><span style=display:flex><span>Test: unreliable net, restarts, partitions, snapshots, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  30.4  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>4888</span>  <span style=color:#ae81ff>723</span>
</span></span><span style=display:flex><span>Test: unreliable net, restarts, partitions, snapshots, random keys, many clients <span style=color:#f92672>(</span>4B<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  31.5  <span style=color:#ae81ff>7</span> <span style=color:#ae81ff>12197</span> <span style=color:#ae81ff>1167</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/kvraft   193.948s
</span></span></code></pre></div></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#介绍>介绍</a></li><li><a href=#part-a---无快照的键值服务>Part A - 无快照的键/值服务</a><ul><li><a href=#任务要求>任务要求</a></li><li><a href=#实现>实现</a></li><li><a href=#运行结果>运行结果</a></li></ul></li><li><a href=#part-b---带快照的键值服务>Part B - 带快照的键/值服务</a><ul><li><a href=#任务要求-1>任务要求</a></li><li><a href=#实现-1>实现</a></li><li><a href=#运行结果-1>运行结果</a></li></ul></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>👋 Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyy年MM月dd日")})}</script><script src=/js/toc.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>