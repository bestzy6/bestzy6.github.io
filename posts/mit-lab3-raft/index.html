<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>【MIT6.5840】Lab3-Raft | Bestzy's Blog</title>
<link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/mit-lab3-raft/><meta name=author content="bestzy"><meta name=description content="在这篇博客中，我将详细介绍如何实现Raft分布式共识算法的核心功能，包括领导人选举、日志复制和提交等等。
"><meta name=keywords content="Raft"><meta name=generator content="Hugo 0.143.1"><meta property="og:url" content="https://bestzy6.github.io/posts/mit-lab3-raft/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="【MIT6.5840】Lab3-Raft"><meta property="og:description" content="在这篇博客中，我将详细介绍如何实现Raft分布式共识算法的核心功能，包括领导人选举、日志复制和提交等等。"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T22:07:11+08:00"><meta property="article:modified_time" content="2025-02-15T22:07:11+08:00"><meta property="article:tag" content="Raft"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="【MIT6.5840】Lab3-Raft"><meta name=twitter:description content="在这篇博客中，我将详细介绍如何实现Raft分布式共识算法的核心功能，包括领导人选举、日志复制和提交等等。"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:online" @click="flip = !flip" title=翻转一下！><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">🚀先行其事，后臻其善，再求其优！</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=关于><ion-icon name=information-circle></ion-icon>关于</div></li><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=搜索><ion-icon name=search></ion-icon>搜索</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=关于>关于</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=搜索><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=归档><ion-icon name=archive></ion-icon>归档</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=所有分类><ion-icon name=grid></ion-icon>所有分类</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=所有标签><ion-icon name=pricetags></ion-icon>所有标签</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="【MIT6.5840】Lab3-Raft"><meta itemprop=description content="在这篇博客中，我将详细介绍如何实现Raft分布式共识算法的核心功能，包括领导人选举、日志复制和提交等等。"><meta itemprop=datePublished content="2025-02-15T22:07:11+08:00"><meta itemprop=dateModified content="2025-02-15T22:07:11+08:00"><meta itemprop=wordCount content="22994"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="Raft"><header><h1 itemprop=headline>【MIT6.5840】Lab3-Raft</h1><p class=text-sm><span data-format=luxon>2025-02-15T22:07:11+08:00</span>
| <span>46分钟阅读</span>
| <span>更新于
<span data-format=luxon>2025-02-15T22:07:11+08:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0 src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e3%80%90MIT6.5840%e3%80%91Lab3-Raft&amp;url=https://bestzy6.github.io/posts/mit-lab3-raft/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/mit-lab3-raft/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img src=https://i0.hdslb.com/bfs/article/ad2a64facdd40d2920a2a4714a1e4a4c2099359.jpg@1e_1c.webp alt=【MIT6.5840】Lab3-Raft><p>在这篇博客中，我将详细介绍如何实现Raft分布式共识算法的核心功能，包括领导人选举、日志复制和提交等等。</p><h2 id=实验准备>实验准备</h2><p><a href=http://nil.csail.mit.edu/6.5840/2024/labs/lab-raft.html target=_blank>http://nil.csail.mit.edu/6.5840/2024/labs/lab-raft.html</a></p><h3 id=debug日志>Debug日志</h3><h4 id=前言>前言</h4><p>尽管Raft是一个相对好理解的分布式共识算法，但Raft仍然是一个复杂的分布式系统。而调试一个分布式系统是一项非常难的任务。</p><p>我们可以在代码中加入调试日志代码，但密密麻麻日志非常容易使我们头脑混乱，严重影响调试效率，而在完成Lab3的过程中，我们大部分时间都将花费在Debug中（至少我花费了大量时间）。</p><p>参考<a href=https://blog.josejg.com/debugging-pretty/ target=_blank>《Debugging by Pretty Printing》</a>
，我们可以将日志更直观地输出在终端，方便我们快速定位问题，如下图所示。</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2Y3MzU0OTYyMjUxM2FmNmRhZGE3ZDQyNGE0ODNlNzVfblpLN3dSQjNiTkNOWTNWZTV1NXFoN3FSNTNYU0JsMVBfVG9rZW46Q1RrNWJ3bnZhbzg0QXB4RjhHTmNaZGN2bkhjXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><h4 id=实现>实现</h4><p>在src/raft/utils.go中，添加如下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugStart</span>     <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugVerbosity</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugStart</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugVerbosity</span> = <span style=color:#a6e22e>getVerbosity</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将日志的输出格式修改为不包含日期和时间戳。</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Flags</span>() <span style=color:#f92672>&amp;^</span> (<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Ldate</span> | <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Ltime</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>logTopic</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dClient</span>  <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;CLNT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dCommit</span>  <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;CMIT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dDrop</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;DROP&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dError</span>   <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;ERRO&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dInfo</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;INFO&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dLeader</span>  <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;LEAD&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dLog</span>     <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;LOG1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dLog2</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;LOG2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dPersist</span> <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;PERS&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dSnap</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;SNAP&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTerm</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TERM&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTest</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TEST&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTimer</span>   <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TIMR&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTrace</span>   <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TRCE&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dVote</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;VOTE&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dWarn</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;WARN&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>topic</span> <span style=color:#a6e22e>logTopic</span>, <span style=color:#a6e22e>serverId</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugVerbosity</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>debugStart</span>).<span style=color:#a6e22e>Microseconds</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>t</span> <span style=color:#f92672>/=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>prefix</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%06d %v S%d &#34;</span>, <span style=color:#a6e22e>t</span>, string(<span style=color:#a6e22e>topic</span>), <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>format</span> = <span style=color:#a6e22e>prefix</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>format</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getVerbosity</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;VERBOSE&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>level</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Invalid verbosity %v&#34;</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>level</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然后，我们就可以在代码中编写Debug代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;重置选举时刻&#34;</span>)
</span></span></code></pre></div><h4 id=查看>查看</h4><p>我们需要实现一个Python脚本美化日志。首先安装rich与typer库。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>pip</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>rich</span> <span style=color:#a6e22e>typer</span>
</span></span></code></pre></div><p>编写以下脚本，与博客中相同，我将脚本命名为dslogs.py，同样放置在src/raft目录下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> shutil
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Optional, List, Tuple, Dict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> typer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich <span style=color:#f92672>import</span> print
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich.columns <span style=color:#f92672>import</span> Columns
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich.console <span style=color:#f92672>import</span> Console
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich.traceback <span style=color:#f92672>import</span> install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># fmt: off</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Mapping from topics to colors</span>
</span></span><span style=display:flex><span>TOPICS <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TIMR&#34;</span>: <span style=color:#e6db74>&#34;#9a9a99&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;VOTE&#34;</span>: <span style=color:#e6db74>&#34;#67a0b2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;LEAD&#34;</span>: <span style=color:#e6db74>&#34;#d0b343&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TERM&#34;</span>: <span style=color:#e6db74>&#34;#70c43f&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;LOG1&#34;</span>: <span style=color:#e6db74>&#34;#4878bc&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;LOG2&#34;</span>: <span style=color:#e6db74>&#34;#398280&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;CMIT&#34;</span>: <span style=color:#e6db74>&#34;#98719f&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;PERS&#34;</span>: <span style=color:#e6db74>&#34;#d08341&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SNAP&#34;</span>: <span style=color:#e6db74>&#34;#FD971F&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;DROP&#34;</span>: <span style=color:#e6db74>&#34;#ff615c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;CLNT&#34;</span>: <span style=color:#e6db74>&#34;#00813c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TEST&#34;</span>: <span style=color:#e6db74>&#34;#fe2c79&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;INFO&#34;</span>: <span style=color:#e6db74>&#34;#ffffff&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;WARN&#34;</span>: <span style=color:#e6db74>&#34;#d08341&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ERRO&#34;</span>: <span style=color:#e6db74>&#34;#fe2626&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TRCE&#34;</span>: <span style=color:#e6db74>&#34;#fe2626&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e># fmt: on</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>list_topics</span>(value: Optional[str]):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> value <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>    topics <span style=color:#f92672>=</span> value<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;,&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> topic <span style=color:#f92672>in</span> topics:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> topic <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> TOPICS:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> typer<span style=color:#f92672>.</span>BadParameter(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;topic </span><span style=color:#e6db74>{</span>topic<span style=color:#e6db74>}</span><span style=color:#e6db74> not recognized&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> topics
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>(
</span></span><span style=display:flex><span>    file: typer<span style=color:#f92672>.</span>FileText <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Argument(<span style=color:#66d9ef>None</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;File to read, stdin otherwise&#34;</span>),
</span></span><span style=display:flex><span>    colorize: bool <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>True</span>, <span style=color:#e6db74>&#34;--no-color&#34;</span>),
</span></span><span style=display:flex><span>    n_columns: Optional[int] <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>None</span>, <span style=color:#e6db74>&#34;--columns&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>),
</span></span><span style=display:flex><span>    ignore: Optional[str] <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>None</span>, <span style=color:#e6db74>&#34;--ignore&#34;</span>, <span style=color:#e6db74>&#34;-i&#34;</span>, callback<span style=color:#f92672>=</span>list_topics),
</span></span><span style=display:flex><span>    just: Optional[str] <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>None</span>, <span style=color:#e6db74>&#34;--just&#34;</span>, <span style=color:#e6db74>&#34;-j&#34;</span>, callback<span style=color:#f92672>=</span>list_topics),
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    topics <span style=color:#f92672>=</span> list(TOPICS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># We can take input from a stdin (pipes) or from a file</span>
</span></span><span style=display:flex><span>    input_ <span style=color:#f92672>=</span> file <span style=color:#66d9ef>if</span> file <span style=color:#66d9ef>else</span> sys<span style=color:#f92672>.</span>stdin
</span></span><span style=display:flex><span>    <span style=color:#75715e># Print just some topics or exclude some topics (good for avoiding verbose ones)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> just:
</span></span><span style=display:flex><span>        topics <span style=color:#f92672>=</span> just
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ignore:
</span></span><span style=display:flex><span>        topics <span style=color:#f92672>=</span> [lvl <span style=color:#66d9ef>for</span> lvl <span style=color:#f92672>in</span> topics <span style=color:#66d9ef>if</span> lvl <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> set(ignore)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    topics <span style=color:#f92672>=</span> set(topics)
</span></span><span style=display:flex><span>    console <span style=color:#f92672>=</span> Console()
</span></span><span style=display:flex><span>    width <span style=color:#f92672>=</span> console<span style=color:#f92672>.</span>size<span style=color:#f92672>.</span>width
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    panic <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> input_:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            time, topic, <span style=color:#f92672>*</span>msg <span style=color:#f92672>=</span> line<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34; &#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e># To ignore some topics</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> topic <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> topics:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>.</span>join(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Debug calls from the test suite aren&#39;t associated with</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># any particular peer. Otherwise we can treat second column</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># as peer id</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> topic <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;TEST&#34;</span>:
</span></span><span style=display:flex><span>                i <span style=color:#f92672>=</span> int(msg[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Colorize output by using rich syntax when needed</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> colorize <span style=color:#f92672>and</span> topic <span style=color:#f92672>in</span> TOPICS:
</span></span><span style=display:flex><span>                color <span style=color:#f92672>=</span> TOPICS[topic]
</span></span><span style=display:flex><span>                msg <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[</span><span style=color:#e6db74>{</span>color<span style=color:#e6db74>}</span><span style=color:#e6db74>]</span><span style=color:#e6db74>{</span>msg<span style=color:#e6db74>}</span><span style=color:#e6db74>[/</span><span style=color:#e6db74>{</span>color<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Single column printing. Always the case for debug stmts in tests</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> n_columns <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>or</span> topic <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;TEST&#34;</span>:
</span></span><span style=display:flex><span>                print(time, msg)
</span></span><span style=display:flex><span>            <span style=color:#75715e># Multi column printing, timing is dropped to maximize horizontal</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># space. Heavylifting is done through rich.column.Columns object</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                cols <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;&#34;</span> <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(n_columns)]
</span></span><span style=display:flex><span>                msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>+</span> msg
</span></span><span style=display:flex><span>                cols[i] <span style=color:#f92672>=</span> msg
</span></span><span style=display:flex><span>                col_width <span style=color:#f92672>=</span> int(width <span style=color:#f92672>/</span> n_columns)
</span></span><span style=display:flex><span>                cols <span style=color:#f92672>=</span> Columns(cols, width<span style=color:#f92672>=</span>col_width <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, equal<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, expand<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>                print(cols)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Code from tests or panics does not follow format</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># so we print it as is</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> line<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;panic&#34;</span>):
</span></span><span style=display:flex><span>                panic <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Output from tests is usually important so add a</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># horizontal line with hashes to make it more obvious</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> panic:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;#&#34;</span> <span style=color:#f92672>*</span> console<span style=color:#f92672>.</span>width)
</span></span><span style=display:flex><span>            print(line, end<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    typer<span style=color:#f92672>.</span>run(main)
</span></span></code></pre></div><p>当我们需要调试测试代码时，可以使用如下命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>VERBOSE<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> go test -run InitialElection | python dslogs.py -c <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><h2 id=lab-3a---领导人选举>Lab-3A - 领导人选举</h2><h3 id=任务要求>任务要求</h3><p>3A要求我们实现Raft的Leader选举以及心跳检测功能（无需考虑日志）。3A实验的目标是选举出一个单一的Leader，如果没有故障，Leader将保持领导地位，并且如果旧Leader失败或与旧Leader来往的数据包丢失，则新领导者将接管。运行 go test -run 3A 来测试您的 3A 代码。任务要求给出的提示较多，以下是我抽取的几个比较重要的提示。</p><p>提示：</p><ol><li>按照论文中的图 2。在这一点上，您关心发送和接收 RequestVote RPC，与选举相关的服务器规则以及与领导者选举相关的状态。</li><li>在 raft.go 中的 Raft 结构体中添加用于领导者选举的图2 状态。您还需要定义一个结构体来保存每个日志条目的信息。</li></ol><p>测试器要求：</p><ol><li>测试器要求Leader每秒钟发送不超过十次<strong>心跳</strong> RPC。</li><li>测试器要求旧Leader失败后的五秒内选出新领导者（如果大多数Server仍然可以通信）。</li><li>该论文的第 5.2 节提到选举超时范围为 150 至 300 毫秒。只有当领导者发送心跳比每 150 毫秒一次更频繁（例如每 10 毫秒一次）时，这样的范围才有意义。由于测试器每秒只能限制您的心跳数十次，因此您将不得不使用比论文中的 150 至 300 毫秒更长的选举超时时间，但不要太长，否则您可能无法在五秒内选举出领导者。</li><li>不要忘记实现 GetState() 。</li><li>测试器在永久关闭实例时会调用您的 Raft 的 rf.Kill() 。您可以使用 rf.killed() 检查是否已调用 Kill() 。您可能希望在所有循环中执行此操作，以避免死亡 Raft 实例打印混淆的消息。</li></ol><h3 id=实现-1>实现</h3><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=MjZiYTA5YzMxNDU0NzMxNGI2MjhlMWUxNjAwMzY4YjRfTUlXeTJlQTNZYTlMSllicklQRjhwWjJkbU9KTDlOZEdfVG9rZW46RnFIUGJyRFNDb20wUGx4ZzNCRGNHWGVCbkRnXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>以上动图基本涵盖了领导人选举的步骤，首先各个Server等待选举时间，达到选举时间后，Server转变为Candidate，等待其他Server投票，获得半数以上票数的Server当选为Leader，其他Server转变为Follower。</p><p>那么我们需要实现的功能包括“发起选举”、“重置选举时间”、“广播心跳（日志）”、“投票”、“响应Leader”。</p><h4 id=常量定义>常量定义</h4><p>首先，我们先定义Peer的状态，根据论文中的描述，Server存在Follower、Candidate、Leader三种状态。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>State</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>State</span> = <span style=color:#66d9ef>iota</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateCandidate</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateLeader</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>然后再定义最小心跳间隔以及最小选举间隔。只要系统满足下面的时间要求，Raft可以选举并维持一个稳定的 leader：</p><blockquote><p>广播时间（broadcastTime） &#171; 选举超时时间（electionTimeout） &#171; 平均故障间隔时间（MTBF）</p></blockquote><p>广播时间指的是从一个服务器并行的发送 RPCs 给集群中的其他服务器并接收响应的平均时间；选举超时时间就是在前面介绍的选举的超时时间限制；平均故障间隔时间就是对于一台服务器而言，两次故障之间的平均时间。</p><p>测试器要求中已经说明，Leader每秒钟发送不超过10次心跳（或者说广播），因此我将最小心跳间隔定义为100ms，而选举间隔时间应该远大于心跳间隔，但又不宜过长，否则无法在5秒内选举出新的Leader，因此我定义最小选举间隔为500ms。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minHeartBeatInterval</span> = <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minElectionInterval</span>  = <span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=结构体定义>结构体定义</h4><p>首先是定义结构体，根据Raft论文中的定义。注意，完成3A任务无需关注Log。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Raft</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>          <span style=color:#75715e>// Lock to protect shared access to this peer&#39;s state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>peers</span>     []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span> <span style=color:#75715e>// RPC end points of all peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>          <span style=color:#75715e>// Object to hold this peer&#39;s persisted state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>        <span style=color:#66d9ef>int</span>                 <span style=color:#75715e>// this peer&#39;s index into peers[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>      <span style=color:#66d9ef>int32</span>               <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Look at the paper&#39;s Figure 2 for a description of what</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// state a Raft server must maintain.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>         <span style=color:#a6e22e>State</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>heartBeatTime</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>electionTime</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 以下字段论文原文</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentTerm</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 当前任期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votedFor</span>    <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 投票给的候选者ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>         []<span style=color:#a6e22e>LogEntry</span> <span style=color:#75715e>// 日志</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>commitIndex</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 已经提交的最高日志条目索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 已经应用到状态机的最高日志条目索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIndex</span>   []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// 对每个服务器，要发送的下一跳日志条目的索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchIndex</span>  []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// 对每个服务器，已知被复制的最高日志条目的索引</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>测试器还要求我们实现GetState()方法，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetState</span>() (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>term</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>isleader</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3A).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>isleader</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>term</span>, <span style=color:#a6e22e>isleader</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>该方法通过获取 currentTerm 和 state 字段的值来获取当前服务器的状态，返回当前任期号和该服务器是否为 leader。</p><h4 id=选举和心跳时间重置>选举和心跳时间重置</h4><p>如果某一时刻所有Server都发起选举，那么很有可能会发生所有Server都投自己一票，然后拒绝别人的投票，由此将选票瓜分，也称为活锁状态。Raft 算法使用随机选举超时时间（randomized election timeouts）的方法来确保很少会发生选票瓜分的情况，就算发生也能很快的解决：</p><ul><li>每一个 candidate 在开始一次选举的时候会从一个固定的区间（例如 150-300 毫秒）随机选择一个选举超时时间，然后在超时时间内等待投票的结果。</li><li>由于一个任期内不能重复投票，越早超时的 candidate 越先开始拉票，也更容易胜出。</li></ul><p>我们可以将最大选举时间间隔定义为 <strong>最小间隔+（最小间隔 * 0.7）</strong>，然后随机选取**[最小间隔，最大间隔)**中的值为。而心跳时间固定为100ms一次。定义函数如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// 重置选举时间</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>resetElectionTime</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>extra</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(float64(<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Int63</span>()<span style=color:#f92672>%</span>int64(<span style=color:#a6e22e>minElectionInterval</span>)) <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.7</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>electionTime</span> = <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>minElectionInterval</span>).<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>extra</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 重置心跳时间</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>resetHeartBeatTime</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>heartBeatTime</span> = <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>minHeartBeatInterval</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>定义了结构体与重置函数之后，我们就可以给结构体赋初始值，代码框架中要求我们实现Make函数。如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>peers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Raft</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> = <span style=color:#a6e22e>peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span> = <span style=color:#a6e22e>persister</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your initialization code here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// initialize from state persisted before a crash</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadRaftState</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start ticker goroutine to start elections</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>ticker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=rpc函数定义>RPC函数定义</h4><p>完成Lab3A仅需实现两个RPC函数——RequestVote和AppendEntries。</p><p>RequestVote用于候选者请求选举，而AppendEntries用于同步日志以及接收心跳信息。实现3A无需关注日志，因此这里暂且将AppendEntrie视为接收心跳请求。</p><p>根据论文，我们先定义出如下请求响应参数。实验代码已经给出了RequsetVote函数的骨架，而AppendEntries需要自行定义。</p><h5 id=requestvote>RequestVote</h5><p>对于RequesetVote的请求响应。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RequestVoteArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>         <span style=color:#66d9ef>int</span> <span style=color:#75715e>// 候选者的任期号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CandidateId</span>  <span style=color:#66d9ef>int</span> <span style=color:#75715e>// 候选者ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastLogIndex</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// 候选者最新日志的索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastLogTerm</span>  <span style=color:#66d9ef>int</span> <span style=color:#75715e>// 候选者最新日志的任期号</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RequestVoteReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>        <span style=color:#66d9ef>int</span>  <span style=color:#75715e>// 当前任期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VoteGranted</span> <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// 是否投票</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>RequesetVote RPC</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>RequestVote</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3A, 3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到候选人S%d选举请求&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;拒绝候选者S%d，任期小于自身&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;选举候选人 S%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 重置选举时间</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;已选择S%d 拒绝候选人S%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=YTAzOWZiNDU1MWI2MzRlMGFjYTIxYjE4MmJjODczNjdfR0V0eG4ybERYQ1U0b1hmUm9QV2VoTlluSENyUlNvY0xfVG9rZW46QzV4ZWJxc0FGbzhMQjB4NkRabGNuZ2dzbnFnXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>在该代码中，我们要判断rf.votedFor==-1或者<em>rf</em>.votedFor == <em>args</em>.CandidateId为真时，则投票。假如没有rf.votedFor== args.CandidateId，则可能导致一轮选举无法选出Leader，如上图所示，当S3收到S2选举请求并投票时，S3的votedFor值更改为S2，但S3响应的RPC丢失，此时S2再次发送选举请求，如果没有不判断<em>rf</em>.votedFor == <em>args</em>.CandidateId，则将返回False，很明显就发生了错误，致使无法选举出Leader。</p><h5 id=appendentries>AppendEntries</h5><p>而对于AppendEntries的请求响应：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>         <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderId</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Entries</span>      []<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderCommit</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Success</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// AppendEntries RPC 发送心跳或者日志提交</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到 S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果收到的任期小于自身，则拒绝Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的任期号Term%d小于自身任期号Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;当前任期号：%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;由候选者降级为追随者&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 收到的任期大于自身，则追随该Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果是Leader或候选人，则降级为Follower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的新的任期号Term%d，降级为Follower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=广播entries>广播Entries</h4><p>在Lab3A中，广播Entries用来维护Follower的追随状态，并重置Follower的选举发起时间。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastEntries</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;开始广播AppendEntries&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>根据论文，当Leader收到了<strong>大于</strong>自身任期的消息，应该<strong>降级</strong>为Follower；而当Leader收到了<strong>小于</strong>自身的任期的消息，应该将该消息视为<strong>过期消息</strong>而抛弃；当任期相同时，Leader需要将NextIndex值减1，然后再次发送消息给Follower，直到达到一致点。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Term:%d &gt; CurrentTerm%d,降级为Follower&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;非Leader，拒绝响应 S%d:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;响应的任期号%d更小，拒绝接受&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d成功AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d拒绝AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=发起选举>发起选举</h4><p>发起选举函数包括<code>raiseElection</code>和<code>broadcastElection</code>。<code>raiseElection</code> 方法本质上是一个接口，用于启动 Raft 实例的选举过程。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// 开始选举</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>raiseElection</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateCandidate</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;当前任期号：%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;发起选举&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 构建rpc请求与响应</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RequestVoteArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>CandidateId</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 并行发送投票信息</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastElection</span>(<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//重置选举时间</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>broadcastElection</code> 方法向所有其他节点发送投票请求，以及对投票响应进行处理。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span>  <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastElection</span>(<span style=color:#a6e22e>args</span> <span style=color:#a6e22e>RequestVoteArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ticket</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>once</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Once</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>RequestVoteReply</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendRequestVote</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// 发送选取请求失败</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ticket</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>// 如果票数超过半数，则晋升Leader</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ticket</span> &gt; (len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 确保每次晋升Leader只执行一次</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>once</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;升级为Leader&#34;</span>)
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;当前任期号：%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateLeader</span>
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastEntries</span>() <span style=color:#75715e>// 当选之后立马发送Entries</span>
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>注意，当追随者（启动时所有Peer均为追随者）决定发起选举时，应该立即转换状态，将自身的任期值Term加1，并投票给自己。候选者收到超过半数的选票时（包括投给自己的选票），将晋升为Leader。broadcastElection函数中，每次收到Vote RPC的响应时，要判断Peer是否投票以及任期是否与候选者对应。晋升后立即发送一次心跳请求，要求其余Peer成为追随者。</p><h4 id=完成ticker和kill>完成Ticker()和Kill()</h4><p>我们需要监听是否达到心跳时间与选举时间，一种方案是启动对应的协程一直监听，当时间点达到时触发响应的任务。但任务提示中建议我们不要使用 Go 的 time.Timer 或 time.Ticker ，因为这些很难正确使用，而给出了Ticker方法的骨架，那么我们就按照任务提示进行。</p><p>使用Ticker方法无法保证时刻达到时立即触发任务，每轮检测之后都需要进行50~350ms的休眠，但这并不影响Raft的实现。</p><p>注意，在实现Raft过程中会经常使用锁，锁保证peer状态的正确性，要防止出现死锁问题。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>ticker</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>killed</span>() <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Your code here (3A)</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Check if a leader election should be started.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果当前阶段为Leader，并且达到心跳时间</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>heartBeatTime</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendHeartBeat</span>()
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 达到选举时间</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>electionTime</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>raiseElection</span>()
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// pause for a random amount of time between 50 and 350</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// milliseconds.</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ms</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>50</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Int63</span>() <span style=color:#f92672>%</span> <span style=color:#ae81ff>300</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>ms</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Kill函数我们只进行简单的日志打印。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>Kill</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>StoreInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>dead</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here, if desired.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Killed&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=运行结果>运行结果</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestInitialElection3A
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3A<span style=color:#f92672>)</span>: initial election ...
</span></span><span style=display:flex><span>  ... Passed --   3.5  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>26</span>    <span style=color:#ae81ff>5236</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>--- PASS: TestInitialElection3A <span style=color:#f92672>(</span>3.54s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestReElection3A
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3A<span style=color:#f92672>)</span>: election after network failure ...
</span></span><span style=display:flex><span>  ... Passed --   5.1  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>60</span>    <span style=color:#ae81ff>9308</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>--- PASS: TestReElection3A <span style=color:#f92672>(</span>5.10s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestManyElections3A
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3A<span style=color:#f92672>)</span>: multiple elections ...
</span></span><span style=display:flex><span>  ... Passed --   7.1  <span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>300</span>   <span style=color:#ae81ff>46506</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>--- PASS: TestManyElections3A <span style=color:#f92672>(</span>7.13s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     15.783s
</span></span></code></pre></div><h2 id=lab-3b---日志>Lab-3B - 日志</h2><h3 id=任务要求-1>任务要求</h3><p>实现领导者和追随者代码以附加新的日志条目，以便 go test -run 3B 测试通过。</p><p>提示：</p><ol><li>你的第一个目标应该是通过 TestBasicAgree3B() 。首先实现 Start() ，然后编写代码通过 AppendEntries RPC 发送和接收新的日志条目，遵循图 2。在<strong>每个Peer节点</strong>上通过 applyCh 发送每个新提交的条目。</li><li>您需要实现选举限制（论文中的 5.4.1 节）。</li><li>您的代码可能有循环，重复检查某些事件。不要让这些循环连续执行而不暂停，因为这会使您的实现变慢，从而无法通过测试。使用 Go 的条件变量，或在每个循环迭代中插入 time.Sleep(10 * time.Millisecond) 。</li><li>为了未来的实验，请自己做个好事，编写（或重新编写）干净、清晰的代码。有关想法，请重新访问我们的<a href=https://pdos.csail.mit.edu/6.824/labs/guidance.html target=_blank>指南页面</a>
，其中提供了有关如何开发和调试代码的提示。</li></ol><h3 id=实现准备步骤>实现——准备步骤</h3><h4 id=工具函数>工具函数</h4><p>实现max和min工具函数将有助于代码实现，不过Go 1.21.0版本已经内置了max和min。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> max(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> min(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=定义logentry>定义LogEntry</h4><p>该实现需要实现日志同步，那么需要先定义一下LogEntry结构体。max和min方法后续会用到。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LogEntry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>    <span style=color:#66d9ef>int</span>         <span style=color:#75715e>//创建该Log时的任期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Command</span> <span style=color:#66d9ef>interface</span>{} <span style=color:#75715e>//需要执行的命令</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>此外，我们还需要定义一些辅助方法便于我们获取操作Log。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// GetLogSlice [i,j)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>right</span> <span style=color:#66d9ef>int</span>) []<span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &gt; <span style=color:#a6e22e>right</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;left &gt; right&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &lt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>right</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;数组越界&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newLog</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>LogEntry</span>, <span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#a6e22e>left</span>)
</span></span><span style=display:flex><span>    copy(<span style=color:#a6e22e>newLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>left</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:<span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newLog</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>idx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>LastLogTerm</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Panicf</span>(<span style=color:#e6db74>&#34;idx:%d &lt; 0&#34;</span>, <span style=color:#a6e22e>idx</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Command</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>idx</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=补充结构体>补充结构体</h4><p>定义完日志后，我们需要将其补充至Raft结构体中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Raft</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>          <span style=color:#75715e>// Lock to protect shared access to this peer&#39;s state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>peers</span>     []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span> <span style=color:#75715e>// RPC end points of all peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>          <span style=color:#75715e>// Object to hold this peer&#39;s persisted state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>        <span style=color:#66d9ef>int</span>                 <span style=color:#75715e>// this peer&#39;s index into peers[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>      <span style=color:#66d9ef>int32</span>               <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Look at the paper&#39;s Figure 2 for a description of what</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// state a Raft server must maintain.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>         <span style=color:#a6e22e>State</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>heartBeatTime</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>electionTime</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 以下字段论文原文</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>         []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentTerm</span> <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// 当前任期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votedFor</span>    <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// 投票给的候选者ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>commitIndex</span> <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// 已经提交的最高日志条目索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// 已经应用到状态机的最高日志条目索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIndex</span>   []<span style=color:#66d9ef>int</span> <span style=color:#75715e>// 对每个服务器，要发送的下一跳日志条目的索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchIndex</span>  []<span style=color:#66d9ef>int</span> <span style=color:#75715e>// 对每个服务器，已知被复制的最高日志条目的索引</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>此外，我们需要将<code>AppendEntriesArgs</code>结构体中的Entries字段更换为<code>LogEntry</code>切片。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>         <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderId</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Entries</span>      []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderCommit</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=实现start方法>实现Start方法</h4><blockquote><p>Start方法用于Server接收命令。</p></blockquote><p>如果该Server不是 Leader，它将返回false。如果该Server是Leader，则开始共识过程并立即返回。但是需要注意，无法保证此命令将被提交到 Raft 日志中，因为 Leader 可能会失败或失去选举。但即使 Raft 实例已经停止运行，此函数也应该正常返回。</p><p>Start方法第一个返回值是该命令在日志中可能出现的索引。第二个返回值是当前任期号。第三个返回值是true，表示该服务器认为它是 Leader。注意，该方法由Tester执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>command</span> <span style=color:#66d9ef>interface</span>{}) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>term</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isLeader</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到Tester传来的Command: { %v }&#34;</span>, <span style=color:#a6e22e>command</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>, <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Command</span>: <span style=color:#a6e22e>command</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#75715e>// 日志索引从1开始</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isLeader</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送AppendEntry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastEntries</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>term</span>, <span style=color:#a6e22e>isLeader</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=提交日志commitmsg>提交日志commitMsg</h4><p>Raft节点本身是没有状态机实现的，状态机应该由Raft的上层应用来实现。因此，在MIT6.5840-3B实验中，我们无需考虑状态机的实现，只需将日志发送给Make函数的applyCh入参通道来模拟提交。为了方便控制，我们需要实现一个commitMsg方法，将已经commit的数据模拟提交至状态机。</p><p>论文中要求我们根据lastApplied参数与commitIndex参数控制提交，为了防止代码阻塞造成占锁时间过长，可以先将msg添加到数组中，再遍历数组发送给applyCh通道，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>ApplyMsg</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span><span style=color:#f92672>-</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// lastApplied为索引号，从1开始</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>msg</span> = append(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>ApplyMsg</span>{
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>CommandValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>Command</span>:      <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>).<span style=color:#a6e22e>Command</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>CommandIndex</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>,
</span></span><span style=display:flex><span>          })
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msg</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;提交 {Index:%d , Cmd: %v}至ApplyCh&#34;</span>, <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>CommandIndex</span>, <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Command</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>applyCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ms</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>ms</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>该函数无法一直加锁到ApplyMsg都提交至applyCh，会造成死锁现象。</p><p>完成以上工作，接下来需要修改Make函数。我们需要新增一个协程运行commitMsg方法，还需要初始化rf.log参数。注意，索引与论文一致，都默认从1开始。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>peers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Raft</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> = <span style=color:#a6e22e>peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span> = <span style=color:#a6e22e>persister</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your initialization code here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = make([]<span style=color:#a6e22e>LogEntry</span>, <span style=color:#ae81ff>0</span>)  <span style=color:#75715e>// new 初始化log</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span>) <span style=color:#75715e>// new 提交msg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// initialize from state persisted before a crash</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadRaftState</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start ticker goroutine to start elections</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>ticker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=实现核心步骤>实现——核心步骤</h3><p>以下是论文中要求**节点要遵守的规则，**这些规则将会指导我们完成Lab-3B。</p><p>所有节点：</p><ol><li>如果<code>commitIndex > lastApplied</code>，则 lastApplied 递增，并将<code>log[lastApplied]</code>应用到状态机中（<strong>对应Lab3中的上传至applyCh通道</strong>）。</li><li>如果接收到的 RPC 请求或响应中，任期号<code>T > currentTerm</code>，则令 <code>currentTerm = T</code>，并切换为跟随者状态。</li></ol><p>follower：</p><ol><li>响应来自候选人和领导人的请求。</li><li>如果选举时间超时后，没有收到当前领导人的<code>AppendEntries RPC</code>，或者没有给某个候选人投过票，就自己变成候选人。</li></ol><p>candidate：</p><ol><li>在转变成候选人后就立即开始选举过程：自增当前的任期号<code>currentTerm</code>，给自己投票，重置选举超时计时器，发送请求投票的 RPC 给其他所有服务器。</li><li>如果接收到超过半数Server的选票，那么就变成Leader。</li><li>如果接收到来自新的Leader的附加日志<code>AppendEntries RPC</code>，则转变成Follower。</li><li>如果选举过程超时，则再次发起一轮选举。</li></ol><p>leader：</p><ol><li>一旦成为领导人：发送空的 <code>AppendEntries RPC</code> 给其他所有的Server；在一定的空余时间之后不停的重复发送，以防止 follower 超时。</li><li>如果接收到来自客户端的请求：附加Entry到本地日志中，在Entry被应用到状态机后响应客户端。</li><li>对于Follower，如果 leader 最后一项 log entry 的索引值= <code>nextIndex</code>，则发送从 nextIndex 开始的所有 log entry：如果成功，更新相应跟随者的 nextIndex 和 matchIndex；如果因为日志不一致而失败，则 nextIndex 递减并重试。</li><li>假设存在 N 满足<code>N > commitIndex</code>，使得大多数的 <code>matchIndex[i] ≥ N</code>以及<code>log[N].term == currentTerm</code> 成立，则令 <code>commitIndex = N</code>。</li></ol><h4 id=初始选举参数>初始选举参数</h4><p>按照论文，当Follower升级为Candidate之后，需要初始化<code>NextIndex</code>与<code>MatchIndex</code>。</p><p><code>NextIndex</code>表示要发送的<strong>下一个</strong>日志条目的索引（索引由1开始）；<code>MatchIndex</code>表示被<strong>复制</strong>的最高日志条目的索引。初始时，<code>NextIndex</code>的值均为【Leader最长日志索引+1】，而<code>MatchIndex</code>均为0。</p><p>然后，我们需要为<code>LastLogIndex</code>与<code>LastLogTerm</code>赋值，<strong>这些参数将作为其他Server<strong><strong>投票</strong></strong>的依据</strong>。<code>LastLogIndex</code>表示最后一条日志的索引，而<code>LastLogTerm</code>为最后一条日志索引的任期值。当不存在日志时，<code>LastLogIndex</code>将为初始值0，同样的，<code>LastLogTerm</code>也将为初始值0。</p><p>由此，我们需要修改raiseElection()方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>raiseElection</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateCandidate</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 升级为Candidate之后，需要更新MatchIndex、NextIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>//初始时，nextIndex为最后日志索引 + 1，如果索引由1开始，那么log数组的长度即最后日志索引</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//初始时，matchIndex均为0</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;当前任期号：%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;发起选举&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 构建rpc请求与响应</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastLogIndex</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastLogIndex</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogTerm</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RequestVoteArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>CandidateId</span>:  <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastLogIndex</span>: <span style=color:#a6e22e>lastLogIndex</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastLogTerm</span>:  <span style=color:#a6e22e>lastLogTerm</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 并行发送投票信息</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastElection</span>(<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//重置选举时间</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=补充broadcastentries方法>补充broadcastEntries方法</h4><p>在Lab3A中，我们定义了broadcastEntries方法，该方法向各Follower发送心跳信息，底层使用AppendEntries接口，但该接口不仅接受心跳信息，同样负责日志同步问题。因此，我们需要补充<code>broadcastEntries</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastEntries</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;开始广播AppendEntries&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>entries</span>      []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>]<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 剩余log未提交，则附加Entries</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>entries</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;For S%d, Append Entiries: %d, nextIdx:%d&#34;</span>, <span style=color:#a6e22e>i</span>, len(<span style=color:#a6e22e>entries</span>), <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogIndex</span>: <span style=color:#a6e22e>prevLogIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogTerm</span>:  <span style=color:#a6e22e>prevLogTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderCommit</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Entries</span>:      <span style=color:#a6e22e>entries</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>PrevLogIndex</code>表示前一个日志索引，由<code>NextIndex</code>决定，当<code>NextIndex</code>为初始情况0时，PrevLogIndex同样为0。prevLogTerm表示前一个日志的任期值，当PrevLogIndex为0时，该任期值为0。</p><p>如果Leader的最大Log索引大于等于当前Peer的NextIndex，则需要将NextIndex以及之后索引的日志均发送给Peer，让Peer快速复制日志。</p><p>有些Raft实现会逐个将日志发送给Peer，本质上是相同的，但是会增加RPC连接的数量，不过需要注意<code>TestCount3B</code>测试要求RPC数量不能超过<code>（Server数+4）*3</code>，因此逐个发送日志将有很大概率致使RPC数量超过阈值。</p><h4 id=补充sendentry2server>补充sendEntry2Server</h4><p>在<code>sendEntryToServer</code>函数有一点非常重要，即确定CommitIndex。论文中指出</p><blockquote><p>If there exists an N such that N > commitIndex, a majority of matchIndex[i] ≥ N, and log[N].term == currentTerm: set commitIndex = N (§5.3, §5.4).</p><p>翻译：如果存在一个N，使得N>commitIndex，则大多数matchIndex[i]≥N，并且log[N].term==currentTerm：设置commitIndex=N（§5.3，§5.4）。</p></blockquote><p>这意味着Leader每次收到Follower的<code>AppendEntriesReply</code>，应该进行遍历，找出某个值N，使得某个<code>matchIndex</code>值为N的Server数量大于半数。</p><p>再次强调实现Raft时应该注意并发问题，如果简单粗暴地认为<code>reply.Success</code>为true即得到一个Server确认，则为会造成逻辑错误。</p><p><code>extIndex</code>与<code>matchIndex</code>的更新存在旧值问题，为了保证<strong>幂等性</strong>，因此代码应该如此编写：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>//更新peer的nextIdx和matchIdx</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>//计算当前commitIdx，保证幂等性</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span></code></pre></div><p>如果<code>reply.Success</code>为false，也应该先判断Follower任期与Leader任期是否一致，以及是否仍然为Leader，为什么？考虑以下情况：</p><ol><li>如果S1在T1阶段发送了一个AppendEntries给S2，但该AppendEntries消息在网络中迷失；</li><li>之后S3成为了Leader并变更任期为T2，而S1和S2均成为Follower，任期也变更为T2；</li><li>此时，S1在T1时刻的迷失消息传递至S2，S2检查消息的任期为T1后拒绝该消息；</li><li>S1收到拒绝信息后，逻辑中将降低NextIndex，然后再次发送给S2，此时消息是T2。</li></ol><p>显然，S1不应该再处理该消息了。综合以上，sendEntry2Server完整的代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Term:%d &gt; CurrentTerm%d,降级为Follower&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;非Leader，拒绝响应 S%d:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;响应的任期号%d更小，拒绝接受&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d成功AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//更新peer的nextIdx和matchIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//计算当前commitIdx，需要保证幂等性</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d的NextIdx修改为%d，MatchIdx修改为%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#75715e>//寻找commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;LastLogIndex=%d,commitIndex=%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(), <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(); <span style=color:#a6e22e>n</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>n</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>; <span style=color:#a6e22e>n</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cnt</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>peer</span>, <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> {
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>peer</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#75715e>// 如果匹配的索引大于n</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>cnt</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cnt</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>halfPeerNum</span>() {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// n是数组下标，n+1为索引</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;获取半数Peer同意，更新CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d拒绝AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 减少nextIdx，然后重试</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]<span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>entries</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>nextIdx</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;减少S%d nextId，nextId:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newArg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogIndex</span>: <span style=color:#a6e22e>prevLogIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogTerm</span>:  <span style=color:#a6e22e>prevLogTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Entries</span>:      <span style=color:#a6e22e>entries</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderCommit</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>newArg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以上代码中的<code>halfPeerNum</code>实现如下，顾名思义，计算Server数量的半数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>halfPeerNum</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=补充rpc函数>补充RPC函数</h4><h5 id=requestvote-1>RequestVote</h5><p>RequestVote函数需要判断Log，以决定是否投票给该候选者。接受投票的条件为：</p><ol><li>当前Server的Log为初始情况。</li><li>候选者的日志任期必须“领先”当前Server。</li></ol><p>那什么是更领先？Raft通过比较两份日志中<strong>最后一条日志的索引值</strong>和<strong>任期号</strong>定义谁的日志比较领先。</p><ul><li>如果两份日志最后条目的任期号不同，那么任期号大的日志更领先。</li><li>如果两份日志最后的条目任期号相同，那么日志比较长（索引值更大）的那个就更领先。</li></ul><p>但要注意，选举期间如果两个候选者S1、S2拥有相同的任期，但S2拥有更领先的日志，而S1收到S2的投票请求之后，仍然会投拒绝票，如下图所示。这是因为S1已经将票数投给了自己，因此并不会检查日志情况而直接拒绝选举S2。</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=ODQzNTRmOGE5NzFmMzQzM2U0NTA0YTE2MjBlNmRlZjJfdHB5OWQ2VUhZek9vVjNEbW5QZUszWXdZdUJsT2R3VHJfVG9rZW46TFBEaWJxR0N6b3YwMVd4THBOQ2NORVpCblJlXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// example RequestVote RPC handler.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>RequestVote</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3A, 3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到候选人S%d选举请求&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;拒绝候选者S%d，任期小于自身&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>//如果Server存在日志并且最后的日志任期大于候选者，则拒绝。</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//如果Server并不是最后日志任期与候选者相等且日志索引小于等于候选者，则拒绝</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogTerm</span>() <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastLogTerm</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>          !(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogTerm</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastLogTerm</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastLogIndex</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;候选者S%d日志更旧，拒绝选举&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;选举候选人 S%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 重置选举时间</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;已选择S%d 拒绝候选人S%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTVjZjg4ZjliZjNmODNiZGM5M2I2ZjEwZmE1MDNiZTRfaWNLOHFWd3hOOEdHRHlaT2NwTWlRWEF6bFUyS0t5d3VfVG9rZW46U2dkc2JHWldzb0RDUk94YUZKMWNIMVgwbmJkXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>但在实践中我发现上图所示情况下，若Leader后续没有收到新的日志，则S1和S2始终无法提交任期为2的消息。在Lab3B中，类似的情况会导致的测试<code>TestBasicAgree3B</code>失败。借助上图5个Server的情况，我们分析一下为什么<code>TestBasicAgree3B</code>会失败。</p><p><code>TestBasicAgree3B</code>使用3个Server进行测试。</p><ol><li>假设存在3个Server，分别是S1、S2和S3，S1在当选Leader时为T1。</li><li>某时刻，S1收到日志并将其发送给S2和S3。S2和S3收到日志L1并响应，S1收到超过半数的响应，S1将CommitIdx+1，并发送心跳给S2和S3，但心跳消息丢失。</li><li>此时S2触发选举，任期变为T2，并以候选人身份发送投票消息给S1和S3，S1和S3投票并作为追随者。</li><li>这个时候只有S1提交了日志L1，而S2和S3均未提交L1，并且在未收到新的Log之前，S2不会更改Commit，至此永远只有一个Log提交，导致测试失败。</li></ol><p>与之类似的情况是S1将L1提交之后就宕机了，S2和S3没有收到S1发送来的CommitIndex。而S2发起竞选，此时S1成功恢复并投票，S3同样投票，S2当选为Leader，接下来的情况与上述情况一致，同样导致测试失败。</p><p>根据Raft论文，Leader不会直接提交之前任期的日志，这是为了确保安全性，防止已经被覆盖的日志被错误地提交。</p><p>以上情况无法通过测试，但并不意味着L1永远不会被提交，虽然S2不会直接提交T1的日志，但它可以通过提交自己任期（T2）的日志来间接提交之前的日志，S2只要收到了新的日志后便有很大概率使L1提交。</p><p>有一种常见的技巧可以解决这种问题，该技巧是“空日志条目”。如果没有新的命令，S2可以发送一个空的日志条目（称为no-op条目）。no-op在原始的Raft论文中并没有直接详细讨论，但Diego Ongaro（Raft的作者）在他的博士论文中更详细地讨论了这个概念，它是解决这个问题的有效方法。</p><p>Diego Ongaro 在他的博士论文 &ldquo;Consensus: Bridging Theory and Practice&rdquo; 中确实更详细地讨论了no-op，原文如下：</p><blockquote><p>&ldquo;One simple approach is for every leader to commit a blank no-op entry into the log at the start of its term. As soon as this no-op entry is committed, all prior entries in the leader&rsquo;s log are committed indirectly. This approach has the simplest reasoning, but it adds an extra round trip to all leader changes before a new leader can propose new client requests.&rdquo;</p><p>&ldquo;一个简单的方法是让每个领导者在其任期开始时提交一个空白的无操作（no-op）条目到日志中。一旦这个无操作条目被提交，领导者日志中的所有先前条目就会被间接提交。这种方法的推理最为简单，但它在新领导者可以提出新的客户端请求之前，为所有领导者变更增加了一个额外的往返过程。&rdquo;</p></blockquote><p>Ongaro 进一步解释：</p><blockquote><p>&ldquo;Another way to accomplish this is for the leader to treat the election as an implicit no-op entry, which is committed once the leader learns that a majority of the cluster has voted for it. This approach allows the leader to propose client requests without delay.&rdquo;</p><p>&ldquo;实现这一目标的另一种方式是让领导者将选举视为一个隐式的无操作条目，一旦领导者得知集群中的多数已经投票支持它，这个条目就被视为已提交。这种方法允许领导者无延迟地提出客户端请求。&rdquo;</p></blockquote><p>从上面可以得知，Ongaro提出了两种实现方法：</p><ol><li>显式添加一个no-op条目</li><li>将选举本身视为一个隐式的no-op条目</li></ol><p>这两种方法都能解决新领导者需要提交先前任期日志的问题，但第二种方法可能在效率上略胜一筹，因为它避免了额外的往返通信。本次实验我们不实现no-op条目。</p><h5 id=appendentries-1>AppendEntries</h5><p><code>AppendEntries</code>需要增加同步日志的逻辑，具体含义在注释中说明。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到 S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果收到的任期小于自身，则拒绝Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的任期号Term%d小于自身任期号Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;当前任期号：%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;由候选者降级为追随者&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 收到的任期大于自身，则追随该Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果是Leader或候选人，则降级为Follower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的新的任期号Term%d，降级为Follower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查Leader的日志是否与追随者相同</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;日志Index不一致，收到PrevLogIndex:%d,rf.LastLogIndex=%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果日志在PrevLogIndex中不包含Term与PrevLogTerm匹配的Entry，则回复false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;日志Term不一致，收到的PrevLogTerm: %d,MyPrevLogTerm: %d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 第一个判断条件防止并发过程中有旧的数据被重新收到</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 第二个判断条件是截断未提交的过期数据</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>), <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>[<span style=color:#a6e22e>i</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Exist Entries: %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. 如果leaderCommit &gt; commitIndex，则commitIndex设置为min(leaderCommit,最新Entry的索引)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到Leader CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 不能超过Leader的Commit。如果Server的Log比较滞后，args.PrevLogIndex+len(args.Entries)能快速更新commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = min(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span>len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;更新CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=运行结果-1>运行结果</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: basic agreement ...
</span></span><span style=display:flex><span>  ... Passed --   1.5  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>16</span>    <span style=color:#ae81ff>4140</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: RPC byte count ...
</span></span><span style=display:flex><span>  ... Passed --   3.2  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>48</span>  <span style=color:#ae81ff>113016</span>   <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: test progressive failure of followers ...
</span></span><span style=display:flex><span>  ... Passed --   5.5  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>64</span>   <span style=color:#ae81ff>13567</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: test failure of leaders ...
</span></span><span style=display:flex><span>  ... Passed --   5.9  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>98</span>   <span style=color:#ae81ff>21401</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: agreement after follower reconnects ...
</span></span><span style=display:flex><span>  ... Passed --   6.7  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>77</span>   <span style=color:#ae81ff>19701</span>    <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: no agreement <span style=color:#66d9ef>if</span> too many followers disconnect ...
</span></span><span style=display:flex><span>  ... Passed --   4.0  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>112</span>   <span style=color:#ae81ff>24030</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: concurrent Start<span style=color:#f92672>()</span>s ...
</span></span><span style=display:flex><span>  ... Passed --   1.3  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>22</span>    <span style=color:#ae81ff>5971</span>    <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: rejoin of partitioned leader ...
</span></span><span style=display:flex><span>  ... Passed --   7.4  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>101</span>   <span style=color:#ae81ff>24185</span>    <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: leader backs up quickly over incorrect follower logs ...
</span></span><span style=display:flex><span>  ... Passed --  32.4  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>2115</span> <span style=color:#ae81ff>1569372</span>  <span style=color:#ae81ff>103</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: RPC counts aren<span style=color:#960050;background-color:#1e0010>&#39;</span>t too high ...
</span></span><span style=display:flex><span>  ... Passed --   2.8  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>44</span>   <span style=color:#ae81ff>13840</span>   <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     70.757s
</span></span></code></pre></div><h2 id=lab-3c---持久化>Lab-3C - 持久化</h2><h3 id=任务要求-2>任务要求</h3><p>通过添加代码保存和恢复持久状态，完成 raft.go 中的 persist() 和 readPersist() 功能。您需要将状态序列化为字节数组，以便将其传递给 Persister 。使用 labgob 编码器；</p><p>请参见 persist() 和 readPersist() 中的注释。 labgob 类似于 Go 的 gob 编码器，但如果尝试对具有小写字段名称的结构进行编码，则会打印错误消息。</p><p>在<strong>进行3D实验之前</strong>，应该将 nil 作为第二个参数传递给 persister.Save() 。在您的实现更改持久状态的点插入 persist() 调用。完成此操作后，如果您的其余实现正确，则应通过所有 3C 测试。</p><p>您可能需要优化一次备份多个Item的nextIndex。看看从第7页底部和第8页顶部开始的扩展<a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank>Raft论文（用灰色线标记）</a>
。</p><p>这篇论文对细节含糊其辞；你需要填补空白。一种可能是，拒绝消息包括：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>XTerm:  term in the conflicting entry (if any)
</span></span><span style=display:flex><span>XIndex: index of first entry with that term (if any)
</span></span><span style=display:flex><span>XLen:   log length
</span></span></code></pre></div><p>那么，Leader的逻辑可以是这样的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>Case 1: leader doesn&#39;t have XTerm:
</span></span><span style=display:flex><span>    nextIndex = XIndex
</span></span><span style=display:flex><span>Case 2: leader has XTerm:
</span></span><span style=display:flex><span>    nextIndex = leader&#39;s last entry for XTerm
</span></span><span style=display:flex><span>Case 3: follower&#39;s log is too short:
</span></span><span style=display:flex><span>    nextIndex = XLen
</span></span></code></pre></div><h3 id=实验准备-1>实验准备</h3><p>实际上，Lab3C可以分为两部分，一部分是实现持久化，另一部分是优化nextIndex。</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2E1YTcwNjMxZjQ1YmRiMDdjNjMyNGQxMDYxNWRhODBfQmE3UnNER09uMUF5RkgxeHdzeW45ZEFGSENwTmdvSGJfVG9rZW46VzFwTWJubjhvb1RvREV4Sk9GcGNiaWYybndmXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>根据论文图2，所有Peer应该持久化currentTerm，votedFor，log[]。因此，这些参数发生变化的地方都需要<strong>执行一次持久化操作</strong>。</p><p>Lab3C是整个Lab3中难度最低的实验，代码骨架中已经帮我们调用了读取持久化的代码，我们只需要实现<code>Persist</code>方法和<code>readPersist</code>方法即可。</p><h3 id=持久化实现>持久化实现</h3><h4 id=persist方法>persist方法</h4><p>任务要求中已经指出我们应该使用labgob编码器，且persist方法已经给出了示例代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>persist</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;序列化 rf.currentTerm 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// votedFor</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;序列化 rf.votedFor 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// log[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;序列化 rf.log 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>raftState</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Bytes</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>Save</span>(<span style=color:#a6e22e>raftState</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dPersist</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;持久化执行成功&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=readpersist方法>readPersist方法</h4><p>同理，readPersist也给出了示例代码，按照示例代码能快速实现。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>data</span>) &lt; <span style=color:#ae81ff>1</span> { <span style=color:#75715e>// bootstrap without any state?</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;反序列化 rf.currentTerm 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;反序列化 rf.votedFor 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;反序列化 rf.log 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>实现以上函数后，只需要在currentTerm，votedFor，log[]参数发生变化的地方都需要<strong>执行一次持久化操作</strong>即可。</p><p>可以<strong>借助<strong><strong>IDE</strong></strong>的查找功能</strong>来找到currentTerm，votedFor，log[]发生改变的地方，此处不再赘述。</p><h3 id=nextindex优化>nextIndex优化</h3><p>如果不进行nextIndex优化，可能会导致测试用例超时。我们需要使NextId能尽量一次就到达冲突点。</p><p>论文原文描述如下：</p><blockquote><p>If desired, the protocol can be optimized to reduce the number of rejected AppendEntries RPCs. For example, when rejecting an AppendEntries request, the follower can include the term of the conflicting entry and the first index it stores for that term. With this information, the leader can decrement nextIndex to bypass all of the conflicting entries in that term; one AppendEntries RPC will be required for each term with conflicting entries, rather than one RPC per entry. In practice, we doubt this optimization is necessary, since failures happen infrequently and it is unlikely that there will be many inconsistent entries.</p><p>如果需要，可以通过优化协议来减少被拒绝的AppendEntries RPC的数量。例如，当Follower拒绝一个AppendEntries请求时，它可以向领导者提供冲突条目的Term以及存储该任期的第一个索引。有了这些信息，Leader就可以通过减小nextIndex来跳过该冲突任期中的所有冲突条目。这样，每个冲突的任期只需要一个AppendEntries RPC，而不是每个冲突条目都需要一个RPC，从而减少同步日志的成本。但在实践中，我们怀疑这种优化并不是很必要，因为不一致的条目非常少见。</p></blockquote><p>论文并没有详细说明实现方法，但3C任务给了我们提示。一种可能的实现是让<strong>拒绝消息体</strong>中包括</p><table><thead><tr><th>字段名</th><th>说明</th></tr></thead><tbody><tr><td>XTerm</td><td>如果存在的话，表示发生冲突位置日志的Term任期</td></tr><tr><td>XIndex</td><td>如果存在的话，表示该任期的第一个日志索引</td></tr><tr><td>XLen</td><td>已经复制的日志长度</td></tr></tbody></table><p>而Leader接收到消息体后，可以根据不同的情况处理：</p><table><thead><tr><th>情况</th><th>说明</th></tr></thead><tbody><tr><td>Leader不存在XTerm</td><td>nextIndex = XIndex</td></tr><tr><td>Leader存在XTerm</td><td>nextIndex = Leader日志中属于XTerm任期的最大日志索引</td></tr><tr><td>Follower的日志过短</td><td>nextIndex = XLen</td></tr></tbody></table><h4 id=修改appendentries>修改AppendEntries</h4><p>首先，按照上述方法，给<code>AppendEntriesReply</code>新增字段。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Success</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Extend</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>XTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>XIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>XLen</span>   <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>为了方便处理，我们可以实现一个方法来计算某个任期的最大索引与最小索引。当任期不存在时，索引返回0。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>term</span> <span style=color:#66d9ef>int</span>) (<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> = <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>MaxInt</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>minIdx</span> = min(<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>maxIdx</span> = max(<span style=color:#a6e22e>maxIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>minIdx</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 大小值均+1，表示索引（索引从1开始）</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>minIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以上工作完成后，我们需要修改AppendEntries方法，为拓展字段赋值。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// AppendEntries RPC 发送心跳或者日志提交</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到 S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果收到的任期小于自身，则拒绝Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的任期号Term%d小于自身任期号Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;当前任期号：%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>// 不存在</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// 不存在</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;由候选者降级为追随者&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 收到的任期大于自身，则追随该Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果是Leader或候选人，则降级为Follower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的新的任期号Term%d，降级为Follower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查Leader的日志是否与追随者相同</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//Extend: Follower的Log过短，并非发生冲突</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;日志Index不一致，收到PrevLogIndex:%d,rf.LastLogIndex=%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果日志在PrevLogIndex中不包含Term与PrevLogTerm匹配的Entry，则回复false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend: 冲突信息</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;日志Term不一致，收到的PrevLogTerm: %d,MyPrevLogTerm: %d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 第一个判断条件防止并发过程中有旧的数据被重新收到</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 第二个判断条件是截断未提交的过期数据</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>), <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>[<span style=color:#a6e22e>i</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Exist Entries: %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. 如果leaderCommit &gt; commitIndex，则commitIndex设置为min(leaderCommit,最新Entry的索引)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到Leader CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 不能超过Leader的Commit。如果Peer的Log比较滞后，args.PrevLogIndex+len(args.Entries)能快速更新commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = min(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span>len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;更新CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=修改sendentry2server>修改sendEntry2Server</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Term:%d &gt; CurrentTerm%d,降级为Follower&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;非Leader，拒绝响应 S%d:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;响应的任期号%d更小，拒绝接受&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d成功AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//更新peer的nextIdx和matchIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//计算当前commitIdx，需要保证幂等性</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d的NextIdx修改为%d，MatchIdx修改为%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#75715e>//寻找commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;LastLogIndex=%d,commitIndex=%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(), <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(); <span style=color:#a6e22e>n</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>n</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>; <span style=color:#a6e22e>n</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cnt</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>peer</span>, <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> {
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>peer</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#75715e>// 如果匹配的索引大于n</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>cnt</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cnt</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>halfPeerNum</span>() {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// n是数组下标，n+1为索引</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;获取半数Peer同意，更新CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d拒绝AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 减少nextIdx，然后重试</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//if rf.nextIndex[server] &gt; 1 {</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// rf.nextIndex[server]--</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// extend</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d XTerm == -1,nextIdx -&gt; reply.XLen + 1&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader no XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>)
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>maxIdx</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader has XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>maxIdx</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>entries</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>nextIdx</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;减少S%d nextId，nextId:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newArg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogIndex</span>: <span style=color:#a6e22e>prevLogIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogTerm</span>:  <span style=color:#a6e22e>prevLogTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Entries</span>:      <span style=color:#a6e22e>entries</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderCommit</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>newArg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>注意，上面的代码新增了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如果不添加以上代码将会发生错误。考虑这种情况：当S1在T1任期发送了一个AppendEntries请求，但S2并没有收到，之后S1再次当选Leader，向S2发送AppendEntries，S2同步Log之后，收到了T1时的AppendEntries请求，此时会拒绝而响应false，S1会修改nextIndex为Len(S2.Log)+1，如果S1的Log与S2相同，那么S1下一次发送给S2的Entries将会发生数组越界异常。</p><h3 id=运行结果-2>运行结果</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: basic persistence ...
</span></span><span style=display:flex><span>labgob warning: Decoding into a non-default variable/field int may not work
</span></span><span style=display:flex><span>  ... Passed --   5.6  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>54</span>   <span style=color:#ae81ff>13266</span>    <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: more persistence ...
</span></span><span style=display:flex><span>  ... Passed --  20.8  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>610</span>  <span style=color:#ae81ff>128556</span>   <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: partitioned leader and one follower crash, leader restarts ...
</span></span><span style=display:flex><span>  ... Passed --   2.7  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>31</span>    <span style=color:#ae81ff>7528</span>    <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: Figure <span style=color:#ae81ff>8</span> ...
</span></span><span style=display:flex><span>  ... Passed --  31.9  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>556</span>  <span style=color:#ae81ff>118623</span>   <span style=color:#ae81ff>35</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: unreliable agreement ...
</span></span><span style=display:flex><span>  ... Passed --   2.1  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>1000</span>  <span style=color:#ae81ff>315603</span>  <span style=color:#ae81ff>246</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: Figure <span style=color:#ae81ff>8</span> <span style=color:#f92672>(</span>unreliable<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  33.6  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>6382</span> <span style=color:#ae81ff>7293379</span>  <span style=color:#ae81ff>244</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: churn ...
</span></span><span style=display:flex><span>  ... Passed --  16.4  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>4243</span> <span style=color:#ae81ff>7685050</span> <span style=color:#ae81ff>1036</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: unreliable churn ...
</span></span><span style=display:flex><span>  ... Passed --  16.6  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3005</span> <span style=color:#ae81ff>4153099</span>  <span style=color:#ae81ff>723</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     129.596s
</span></span></code></pre></div><h2 id=lab-3d-快照snapshot>Lab-3D-快照Snapshot</h2><p>目前，重启服务器会按顺序重放完整的 Raft 日志以恢复其状态。然而，长时间运行的服务无法永久记住完整的 Raft 日志，这是不切实际的。</p><p>相反，您将修改 Raft 以与持久存储其状态的服务合作，这些服务会不时地存储其状态的“快照”，此时 Raft 会丢弃在快照之前的日志条目。结果是更少的持久数据和更快的重启。</p><p>但是，现在可能会出现追随者落后太远，以至于领导者已经丢弃了它需要追赶的日志条目；然后领导者必须发送一个快照以及从快照时间开始的日志。</p><h3 id=任务要求-3>任务要求</h3><p>在实验室 3D 中，Tester定期调用<code>Snapshot()</code>。在Lab-4中，您将编写一个k-v服务器，调用<code>Snapshot()</code>；快照将包含完整的键/值对表。服务层在每个对等节点上调用 <code>Snapshot()</code> （<strong>而不仅仅是在领导者上</strong>）。</p><p>index 参数表示快照中反映的最高日志条目。Raft 应该在该点之前丢弃其日志条目。您需要修改 Raft 代码，仅在存储日志尾部时运行。</p><p>您需要实现论文中讨论的 InstallSnapshot RPC，以允许 Raft 领导者告诉滞后的 Raft 同行使用快照替换其状态。您可能需要仔细考虑 InstallSnapshot 如何与图 2 中的状态和规则交互。</p><p>当追随者的 Raft 代码接收到 InstallSnapshot RPC 时，它可以使用 applyCh 将快照发送到 ApplyMsg 中的服务。 ApplyMsg 结构定义已经包含了您需要的字段（Tester期望的字段）。请注意，这些快照只会推进服务的状态，而不会使其后退。</p><p>如果服务器崩溃，必须从持久化数据重新启动。<strong>您的 Raft 应该持久化 Raft 状态和相应的快照</strong>。使用第二个参数 persister.Save() 保存快照。如果没有快照，请将 nil 作为第二个参数传递。</p><p>当服务器重新启动时，应用层会读取持久化的快照并恢复其保存的状态。</p><p>提示：</p><ul><li>以单个 InstallSnapshot RPC 发送完整的快照。不要实现<code>Figure 13</code>的 offset 机制来拆分快照。</li></ul><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=MDI2NWI3OWVkMTZiMGE4NDUxOTgzMGY1Mjg4ZDIyYTBfWXhLYUVSakZWMm9EemlETWFJVTBZRFF6VE5MVWJhYlZfVG9rZW46UDdEV2I2QldVb3pIamZ4dTFUamNNV1pXbmhmXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><h3 id=实现准备步骤-1>实现——准备步骤</h3><p>任务要求中，已经明确告诉我们不要按照论文图13的Chunk-Offset机制来拆分快照。所以，我们定义的PRC请求结构体与论文描述会有略微差异。</p><h4 id=raft结构体>Raft结构体</h4><p>Raft结构体新增Snapshot相关字段。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Raft</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>          <span style=color:#75715e>// Lock to protect shared access to this peer&#39;s state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>peers</span>     []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span> <span style=color:#75715e>// RPC end points of all peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>          <span style=color:#75715e>// Object to hold this peer&#39;s persisted state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>        <span style=color:#66d9ef>int</span>                 <span style=color:#75715e>// this peer&#39;s index into peers[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>      <span style=color:#66d9ef>int32</span>               <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Look at the paper&#39;s Figure 2 for a description of what</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// state a Raft server must maintain.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>         <span style=color:#a6e22e>State</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>heartBeatTime</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>electionTime</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 以下字段论文原文</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentTerm</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 当前任期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votedFor</span>    <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 投票给的候选者ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>         []<span style=color:#a6e22e>LogEntry</span> <span style=color:#75715e>// 日志</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>commitIndex</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 已经提交的最高日志条目索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// 已经应用到状态机的最高日志条目索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIndex</span>   []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// 对每个服务器，要发送的下一跳日志条目的索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchIndex</span>  []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// 对每个服务器，已知被复制的最高日志条目的索引</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SnapShot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applyCh</span>           <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SnapShot</span>          []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>结构体中新增了<code>applyCh</code>，用于提交快照，为了方便处理，我们实现<code>commitSnap</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>commitSnap</span>(<span style=color:#a6e22e>msg</span> <span style=color:#a6e22e>ApplyMsg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>applyCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>msg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;commit Snap idx:%d-Term:%d&#34;</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotTerm</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再实现<code>readPersistSnapshot</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>readPersistSnapshot</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span> = <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=persistreadpersist方法>persist&amp;readPersist方法</h4><p>正如任务要求所说，如果服务器崩溃，我们必须从持久化数据重新启动。</p><p>我们应该持久化 Raft 状态和相应的**Snapshot，**首先，我们修改<code>persist()</code>和<code>readPersist()</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// 将 Raft 的持久状态保存到稳定存储中，</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 这样在发生崩溃并重新启动后可以检索到这些状态。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 请参见论文中的图 2，了解哪些内容应该是持久化的。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在实现快照之前，应该将 nil 作为第二个参数传递给 persister.Save()。</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 在实现快照之后，传递当前的快照（如果还没有快照，传递 nil）。</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>persist</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// log[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;序列化 rf.log 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// snapshot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;序列化 rf.LastIncludedIndex 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;序列化 rf.LastIncludedTerm 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>raftState</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Bytes</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>Save</span>(<span style=color:#a6e22e>raftState</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>Save</span>(<span style=color:#a6e22e>raftState</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dPersist</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;持久化执行成功&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>data</span>) &lt; <span style=color:#ae81ff>1</span> { <span style=color:#75715e>// bootstrap without any state?</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;反序列化 rf.log 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// snapshot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;反序列化 rf.LastIncludedIndex 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;反序列化 rf.LastIncludedTerm 失败。err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dPersist</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;读取持久数据成功&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=make方法>Make方法</h4><p>初始化Server的函数增加读取Snapshot持久化数据的代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>peers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span>) <span style=color:#75715e>// 新增</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// initialize from state persisted before a crash</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadRaftState</span>())
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersistSnapshot</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadSnapshot</span>()) <span style=color:#75715e>// 新增</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start ticker goroutine to start elections</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>ticker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=snapshot方法>Snapshot方法</h4><p>仓库代码已经给了Snapshot的骨架代码，我们需要实现它。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>Snapshot</span>(<span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>snapshot</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3D).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>index</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;SnapShot Idx &gt; LogLastIdx&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>index</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;SnapShotIdx &lt; LastIncludedIdx&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Get SnapShot cmd, Idx : %d&#34;</span>, <span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;old Log : %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CutLog</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>index</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;new Log : %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> = <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span> = <span style=color:#a6e22e>CutLog</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;LastIncludedTerm:%d LastIncludedIndex:%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span> = <span style=color:#a6e22e>snapshot</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=实现核心步骤-1>实现——核心步骤</h3><h4 id=installsnapshot-rpc>InstallSnapshot RPC</h4><p>按照论文所述，实现请求和响应结构体。</p><blockquote><p>完成Lab3D并不需要实现offset和done。</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>InstallSnapshotArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>              <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderId</span>          <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Data</span>              []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Offset            int</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Done              bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>InstallSnapshotReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>InstallSnapshot</code>是接收快照信息的RPC函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>InstallSnapshot</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Recv S%d InstallSnapShot&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Recv Snap Term:%d &lt; CurrentTerm:%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;降级为Follower&#34;</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;args.LastIncludedIndex:%d &lt; rf.lastApplied:%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 找到Index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dDrop</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;没有找到索引%d,丢弃所有日志&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = []<span style=color:#a6e22e>LogEntry</span>{}
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dDrop</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;找到索引%d，丢弃部分日志&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更改状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = max(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = max(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitSnap</span>(<span style=color:#a6e22e>ApplyMsg</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>SnapshotValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Snapshot</span>:      <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Data</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>SnapshotTerm</span>:  <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>SnapshotIndex</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=sendinstallsnapshot>sendInstallSnapshot</h4><p>主动调用InstallSnapshot RPC函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>installSnapshot</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotReply</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>[<span style=color:#a6e22e>server</span>].<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;Raft.InstallSnapshot&#34;</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send SnapShot to S%d&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InstallSnapshotArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LeaderId</span>:          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedIndex</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedTerm</span>:  <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Data</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>() <span style=color:#75715e>// 为什么不用 defer rf.mu.Unlock()？见文章后续说明</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>InstallSnapshotReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>installSnapshot</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send Snapshot RPC to S%d failed&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;sendInstallSnapshot Reply.Term &lt; CurrentTerm&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=活锁问题>活锁问题</h5><p>我在实现过程中，发现两个奇怪的现象：</p><ol><li>最后的错误日志会显示某个LogA未达成共识，但查询打印日志发现，并未有任何Server收到了LogA。根据单元测试代码，如果Tester发送了某个日志，这个日志在10s后还没有被Server接收，则报错，可见程序的打印日志是不会有记录的，因为一直没有Server接收。</li><li>最后所有的Server都变为候选人，但没有选出Leader。Server1无法与Server2、Server3通信，一直在更新任期并请求投票，而Server2与Server3能够通信，但是Server2的任期号比Server3更大，Log却比Server3低，Server3永远在追赶Server2的任期号。</li></ol><p>上述两种情况的本质原因是代码中发生了活锁。</p><p>通过排查日志发现是加锁错误导致的。当Server3到达重新选举时间，因为Server3发送SnapShot给Server1获取的锁一直没有释放，使得Server2又重新发起了选举，造成Server3永远追赶Server2，日志无法达成一致。</p><p>正常情况下，Server3不会永远追赶Server2，因为Server3收到新的任期请求时不会重置选举时间，而仅仅是更新任期号。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPro</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send SnapShot to S%d&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// defer rf.mu.Unlock() //原本是在这里释放锁，当rf.installSnapshot卡住时，锁无法释放</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InstallSnapshotArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LeaderId</span>:          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedIndex</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedTerm</span>:  <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Data</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()  <span style=color:#75715e>// 创建了请求结构体之后便可释放锁</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>InstallSnapshotReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>installSnapshot</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPro</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send Snapshot RPC to S%d failed&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>//... 省略</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=发送snapshot判断>发送SnapShot判断</h4><p>当Follower的<code>nextIndex</code>比Leader的<code>LastIncludedIndex</code>小，此时Leader无法将日志发送给该Follower，而是将Snapshot信息传递给它。</p><p>我们需要修改<code>broadcastEntries</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastEntries</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;开始广播AppendEntries&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>entries</span>      []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 【新增】判断是否为压缩日志</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;To S%d nextIndex:%d LastIncludedIndex:%d&#34;</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>]<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ...... 省略</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>同理，我们还需要修改<code>sendEntry2Server</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d拒绝AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 减少nextIdx，然后重试</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//if rf.nextIndex[server] &gt; 1 {</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// rf.nextIndex[server]--</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// extend</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d XTerm == -1,nextIdx -&gt; reply.XLen + 1&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader no XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>)
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>maxIdx</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader has XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>maxIdx</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 【新增】判断是否需要发送快照</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;nextIndex &lt; LastIncludedIndex，发送快照&#34;</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ......省略</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=修改commitmsg>修改commitMsg</h4><p>在提交Msg时，需要将*<code>rf</code><em><code>.lastApplied</code>与</em><code>rf</code><em><code>.LastIncludedIndex</code>进行比较，较大的值才是最终的</em><code>rf</code>*<code>.lastApplied</code>。</p><p>且在初始化ApplyMsg数组时，要注意cap值要确保不能为负数，<em><code>rf</code></em><code>.lastApplied</code>有可能大于*<code>rf</code>*<code>.commitIndex</code>，因此最好将cap去掉。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>ApplyMsg</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 【新增】</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = max(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// lastApplied为索引号，从1开始</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>           <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ...省略</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=修改log相关函数>修改Log相关函数</h4><p>增加Snapshot之后，原本的<code>rf.Log</code>切片并不能表示所有的日志，需要修改Log相关函数，考虑日志因快照被截断的情况。</p><p>修改之后的<code>TermRange</code>方法如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>term</span> <span style=color:#66d9ef>int</span>) (<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>term</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> = <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>MaxInt</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>i</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>minIdx</span> = min(<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>maxIdx</span> = max(<span style=color:#a6e22e>maxIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>minIdx</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 大小值均+1，表示索引（索引从1开始）</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>minIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>修改<code>GetLog</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>index</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Panicf</span>(<span style=color:#e6db74>&#34;idx:%d &lt; 0&#34;</span>, <span style=color:#a6e22e>idx</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>{
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Command</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Command</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>idx</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>修改<code>GetLogSlice</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>right</span> <span style=color:#66d9ef>int</span>) []<span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &gt; <span style=color:#a6e22e>right</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;left &gt; right&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &lt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>right</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;数组越界&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>right</span> = <span style=color:#a6e22e>left</span><span style=color:#f92672>-</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newLog</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>LogEntry</span>, <span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#a6e22e>left</span>)
</span></span><span style=display:flex><span>    copy(<span style=color:#a6e22e>newLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>left</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:<span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newLog</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>修改<code>LastLogIndex</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>idx</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=修改appendentires>修改AppendEntires</h4><p>Follower接收日志时需要判断SnapShot的状态。任务要求已经说明，服务层会对每个Peer调用 Snapshot() ，而不仅仅是在Leader，这可能会造成一种情况：Follower比Leader更先进行快照。</p><p>这种情况导致的结果便是Leader发送的PrevLogIndex比Follower的LastIncludedIndex更小，因此我们添加一条判断语句，如果小于，则返回true，待下一次同步日志恢复一致状态。</p><p>此外，SnapShot会改变日志数组的结构，需要修改调用GetLogSlice方法的代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// AppendEntries RPC 发送心跳或者日志提交</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到 S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果收到的任期小于自身，则拒绝Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的任期号Term%d小于自身任期号Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;当前任期号：%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>// 不存在</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// 不存在</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;由候选者降级为追随者&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 收到的任期大于自身，则追随该Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 如果是Leader或候选人，则降级为Follower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到的新的任期号Term%d，降级为Follower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查Leader的PrevLogIndex是否小于SnapShotIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果小于，则直接返回true，等待下一次同步日志</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查Leader的日志是否与追随者相同</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//Extend: Follower的Log过短，并非发生冲突</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;日志Index不一致，收到PrevLogIndex:%d,rf.LastLogIndex=%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 如果日志在PrevLogIndex中不包含Term与PrevLogTerm匹配的Entry，则回复false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend: 冲突信息</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;日志Term不一致，收到的PrevLogTerm: %d,MyPrevLogTerm: %d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 第一个判断条件防止并发过程中有旧的数据被重新收到</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 第二个判断条件是截断未提交的过期数据</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// 【修改】</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>), <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>[<span style=color:#a6e22e>i</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Exist Entries: %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. 如果leaderCommit &gt; commitIndex，则commitIndex设置为min(leaderCommit,最新Entry的索引)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;收到Leader CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// 不能超过Leader的Commit。如果Peer的Log比较滞后，args.PrevLogIndex+len(args.Entries)能快速更新commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = min(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span>len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;更新CommitIdx为%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=运行结果-3>运行结果</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: snapshots basic ...
</span></span><span style=display:flex><span>  ... Passed --   9.3  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>548</span>  <span style=color:#ae81ff>213483</span>  <span style=color:#ae81ff>240</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>disconnect<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  64.1  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1202</span>  <span style=color:#ae81ff>621766</span>  <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>disconnect+unreliable<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  92.7  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1594</span>  <span style=color:#ae81ff>764054</span>  <span style=color:#ae81ff>336</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>crash<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>labgob warning: Decoding into a non-default variable/field int may not work
</span></span><span style=display:flex><span>  ... Passed --  48.5  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1052</span>  <span style=color:#ae81ff>609275</span>  <span style=color:#ae81ff>338</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>unreliable+crash<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  63.7  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1118</span>  <span style=color:#ae81ff>639339</span>  <span style=color:#ae81ff>317</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: crash and restart all servers ...
</span></span><span style=display:flex><span>  ... Passed --  15.7  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>204</span>   <span style=color:#ae81ff>57418</span>   <span style=color:#ae81ff>45</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: snapshot initialization after crash ...
</span></span><span style=display:flex><span>  ... Passed --   5.4  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>68</span>   <span style=color:#ae81ff>18880</span>   <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     299.426s
</span></span></code></pre></div><h2 id=参考>参考</h2><ul><li><a href=https://raft.github.io/index.html target=_blank>https://raft.github.io/index.html</a></li><li><a href=https://zhuanlan.zhihu.com/p/682153208 target=_blank>https://zhuanlan.zhihu.com/p/682153208</a></li><li><a href=https://zhuanlan.zhihu.com/p/693936991 target=_blank>https://zhuanlan.zhihu.com/p/693936991</a></li><li><a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank>https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</a></li><li><a href=https://blog.josejg.com/debugging-pretty/ target=_blank>https://blog.josejg.com/debugging-pretty/</a></li></ul></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#实验准备>实验准备</a><ul><li><a href=#debug日志>Debug日志</a></li></ul></li><li><a href=#lab-3a---领导人选举>Lab-3A - 领导人选举</a><ul><li><a href=#任务要求>任务要求</a></li><li><a href=#实现-1>实现</a></li><li><a href=#运行结果>运行结果</a></li></ul></li><li><a href=#lab-3b---日志>Lab-3B - 日志</a><ul><li><a href=#任务要求-1>任务要求</a></li><li><a href=#实现准备步骤>实现——准备步骤</a></li><li><a href=#实现核心步骤>实现——核心步骤</a></li><li><a href=#运行结果-1>运行结果</a></li></ul></li><li><a href=#lab-3c---持久化>Lab-3C - 持久化</a><ul><li><a href=#任务要求-2>任务要求</a></li><li><a href=#实验准备-1>实验准备</a></li><li><a href=#持久化实现>持久化实现</a></li><li><a href=#nextindex优化>nextIndex优化</a></li><li><a href=#运行结果-2>运行结果</a></li></ul></li><li><a href=#lab-3d-快照snapshot>Lab-3D-快照Snapshot</a><ul><li><a href=#任务要求-3>任务要求</a></li><li><a href=#实现准备步骤-1>实现——准备步骤</a></li><li><a href=#实现核心步骤-1>实现——核心步骤</a></li><li><a href=#运行结果-3>运行结果</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card card-compact bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>👋 Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2025 Bestzy's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyy年MM月dd日")})}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js></script><script nomodule src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js></script></body></html>