<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>ã€MIT6.5840ã€‘Lab3-Raft | Bestzy's Blog</title>
<link href=/favicon.ico rel=icon type=image/x-icon><link rel=canonical href=https://bestzy6.github.io/posts/mit-lab3-raft/><meta name=author content="bestzy"><meta name=description content="åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°Raftåˆ†å¸ƒå¼å…±è¯†ç®—æ³•çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬é¢†å¯¼äººé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶å’Œæäº¤ç­‰ç­‰ã€‚
"><meta name=keywords content="Raft"><meta name=generator content="Hugo 0.143.1"><meta property="og:url" content="https://bestzy6.github.io/posts/mit-lab3-raft/"><meta property="og:site_name" content="Bestzy's Blog"><meta property="og:title" content="ã€MIT6.5840ã€‘Lab3-Raft"><meta property="og:description" content="åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°Raftåˆ†å¸ƒå¼å…±è¯†ç®—æ³•çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬é¢†å¯¼äººé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶å’Œæäº¤ç­‰ç­‰ã€‚"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T22:07:11+08:00"><meta property="article:modified_time" content="2025-02-15T22:07:11+08:00"><meta property="article:tag" content="Raft"><meta property="og:image" content="https://bestzy6.github.io/me/og.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://bestzy6.github.io/me/og.png"><meta name=twitter:title content="ã€MIT6.5840ã€‘Lab3-Raft"><meta name=twitter:description content="åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°Raftåˆ†å¸ƒå¼å…±è¯†ç®—æ³•çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬é¢†å¯¼äººé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶å’Œæäº¤ç­‰ç­‰ã€‚"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js></script><meta name=referrer content="no-referrer"></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:online" @click="flip = !flip" title=ç¿»è½¬ä¸€ä¸‹ï¼><div class="h-10 rounded-full"><img src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=Bestzy></div></div><div><a href=https://bestzy6.github.io/ class="text-lg font-semibold cursor-pointer">Bestzy</a><div class="text-base-content/60 text-sm">ğŸš€å…ˆè¡Œå…¶äº‹ï¼Œåè‡»å…¶å–„ï¼Œå†æ±‚å…¶ä¼˜ï¼</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=å…³äº><ion-icon name=information-circle></ion-icon>å…³äº</div></li><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=æœç´¢><ion-icon name=search></ion-icon>æœç´¢</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=å…³äº>å…³äº</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=æœç´¢><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/index.xml title=RSS><ion-icon class=group-hover:text-primary-content name=logo-rss></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=å½’æ¡£><ion-icon name=archive></ion-icon>å½’æ¡£</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/categories title=æ‰€æœ‰åˆ†ç±»><ion-icon name=grid></ion-icon>æ‰€æœ‰åˆ†ç±»</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title=æ‰€æœ‰æ ‡ç­¾><ion-icon name=pricetags></ion-icon>æ‰€æœ‰æ ‡ç­¾</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="ã€MIT6.5840ã€‘Lab3-Raft"><meta itemprop=description content="åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°Raftåˆ†å¸ƒå¼å…±è¯†ç®—æ³•çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬é¢†å¯¼äººé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶å’Œæäº¤ç­‰ç­‰ã€‚"><meta itemprop=datePublished content="2025-02-15T22:07:11+08:00"><meta itemprop=dateModified content="2025-02-15T22:07:11+08:00"><meta itemprop=wordCount content="22994"><meta itemprop=image content="https://bestzy6.github.io/me/og.png"><meta itemprop=keywords content="Raft"><header><h1 itemprop=headline>ã€MIT6.5840ã€‘Lab3-Raft</h1><p class=text-sm><span data-format=luxon>2025-02-15T22:07:11+08:00</span>
| <span>46åˆ†é’Ÿé˜…è¯»</span>
| <span>æ›´æ–°äº
<span data-format=luxon>2025-02-15T22:07:11+08:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><div class="avatar mr-1"><div class="w-8 rounded-full"><img class=my-0 src="https://avatars.githubusercontent.com/u/43753176?v=4" alt=bestzy></div></div><span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>bestzy</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=%e3%80%90MIT6.5840%e3%80%91Lab3-Raft&amp;url=https://bestzy6.github.io/posts/mit-lab3-raft/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://bestzy6.github.io/posts/mit-lab3-raft/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><img src=https://i0.hdslb.com/bfs/article/ad2a64facdd40d2920a2a4714a1e4a4c2099359.jpg@1e_1c.webp alt=ã€MIT6.5840ã€‘Lab3-Raft><p>åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°Raftåˆ†å¸ƒå¼å…±è¯†ç®—æ³•çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬é¢†å¯¼äººé€‰ä¸¾ã€æ—¥å¿—å¤åˆ¶å’Œæäº¤ç­‰ç­‰ã€‚</p><h2 id=å®éªŒå‡†å¤‡>å®éªŒå‡†å¤‡</h2><p><a href=http://nil.csail.mit.edu/6.5840/2024/labs/lab-raft.html target=_blank>http://nil.csail.mit.edu/6.5840/2024/labs/lab-raft.html</a></p><h3 id=debugæ—¥å¿—>Debugæ—¥å¿—</h3><h4 id=å‰è¨€>å‰è¨€</h4><p>å°½ç®¡Raftæ˜¯ä¸€ä¸ªç›¸å¯¹å¥½ç†è§£çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œä½†Raftä»ç„¶æ˜¯ä¸€ä¸ªå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚è€Œè°ƒè¯•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæ˜¯ä¸€é¡¹éå¸¸éš¾çš„ä»»åŠ¡ã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­åŠ å…¥è°ƒè¯•æ—¥å¿—ä»£ç ï¼Œä½†å¯†å¯†éº»éº»æ—¥å¿—éå¸¸å®¹æ˜“ä½¿æˆ‘ä»¬å¤´è„‘æ··ä¹±ï¼Œä¸¥é‡å½±å“è°ƒè¯•æ•ˆç‡ï¼Œè€Œåœ¨å®ŒæˆLab3çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†æ—¶é—´éƒ½å°†èŠ±è´¹åœ¨Debugä¸­ï¼ˆè‡³å°‘æˆ‘èŠ±è´¹äº†å¤§é‡æ—¶é—´ï¼‰ã€‚</p><p>å‚è€ƒ<a href=https://blog.josejg.com/debugging-pretty/ target=_blank>ã€ŠDebugging by Pretty Printingã€‹</a>
ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ—¥å¿—æ›´ç›´è§‚åœ°è¾“å‡ºåœ¨ç»ˆç«¯ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¿«é€Ÿå®šä½é—®é¢˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2Y3MzU0OTYyMjUxM2FmNmRhZGE3ZDQyNGE0ODNlNzVfblpLN3dSQjNiTkNOWTNWZTV1NXFoN3FSNTNYU0JsMVBfVG9rZW46Q1RrNWJ3bnZhbzg0QXB4RjhHTmNaZGN2bkhjXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><h4 id=å®ç°>å®ç°</h4><p>åœ¨src/raft/utils.goä¸­ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugStart</span>     <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugVerbosity</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>init</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugStart</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>debugVerbosity</span> = <span style=color:#a6e22e>getVerbosity</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å°†æ—¥å¿—çš„è¾“å‡ºæ ¼å¼ä¿®æ”¹ä¸ºä¸åŒ…å«æ—¥æœŸå’Œæ—¶é—´æˆ³ã€‚</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>SetFlags</span>(<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Flags</span>() <span style=color:#f92672>&amp;^</span> (<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Ldate</span> | <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Ltime</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>logTopic</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dClient</span>  <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;CLNT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dCommit</span>  <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;CMIT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dDrop</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;DROP&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dError</span>   <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;ERRO&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dInfo</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;INFO&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dLeader</span>  <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;LEAD&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dLog</span>     <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;LOG1&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dLog2</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;LOG2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dPersist</span> <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;PERS&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dSnap</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;SNAP&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTerm</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TERM&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTest</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TEST&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTimer</span>   <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TIMR&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dTrace</span>   <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;TRCE&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dVote</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;VOTE&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dWarn</span>    <span style=color:#a6e22e>logTopic</span> = <span style=color:#e6db74>&#34;WARN&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>topic</span> <span style=color:#a6e22e>logTopic</span>, <span style=color:#a6e22e>serverId</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>format</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>a</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>interface</span>{}) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>debugVerbosity</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>t</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>debugStart</span>).<span style=color:#a6e22e>Microseconds</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>t</span> <span style=color:#f92672>/=</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>prefix</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%06d %v S%d &#34;</span>, <span style=color:#a6e22e>t</span>, string(<span style=color:#a6e22e>topic</span>), <span style=color:#a6e22e>serverId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>format</span> = <span style=color:#a6e22e>prefix</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>format</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#a6e22e>format</span>, <span style=color:#a6e22e>a</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getVerbosity</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getenv</span>(<span style=color:#e6db74>&#34;VERBOSE&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>level</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>v</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>level</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;Invalid verbosity %v&#34;</span>, <span style=color:#a6e22e>v</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>level</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç„¶åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä»£ç ä¸­ç¼–å†™Debugä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;é‡ç½®é€‰ä¸¾æ—¶åˆ»&#34;</span>)
</span></span></code></pre></div><h4 id=æŸ¥çœ‹>æŸ¥çœ‹</h4><p>æˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªPythonè„šæœ¬ç¾åŒ–æ—¥å¿—ã€‚é¦–å…ˆå®‰è£…richä¸typeråº“ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#a6e22e>pip</span> <span style=color:#a6e22e>install</span> <span style=color:#a6e22e>rich</span> <span style=color:#a6e22e>typer</span>
</span></span></code></pre></div><p>ç¼–å†™ä»¥ä¸‹è„šæœ¬ï¼Œä¸åšå®¢ä¸­ç›¸åŒï¼Œæˆ‘å°†è„šæœ¬å‘½åä¸ºdslogs.pyï¼ŒåŒæ ·æ”¾ç½®åœ¨src/raftç›®å½•ä¸‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> shutil
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> Optional, List, Tuple, Dict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> typer
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich <span style=color:#f92672>import</span> print
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich.columns <span style=color:#f92672>import</span> Columns
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich.console <span style=color:#f92672>import</span> Console
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> rich.traceback <span style=color:#f92672>import</span> install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># fmt: off</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Mapping from topics to colors</span>
</span></span><span style=display:flex><span>TOPICS <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TIMR&#34;</span>: <span style=color:#e6db74>&#34;#9a9a99&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;VOTE&#34;</span>: <span style=color:#e6db74>&#34;#67a0b2&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;LEAD&#34;</span>: <span style=color:#e6db74>&#34;#d0b343&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TERM&#34;</span>: <span style=color:#e6db74>&#34;#70c43f&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;LOG1&#34;</span>: <span style=color:#e6db74>&#34;#4878bc&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;LOG2&#34;</span>: <span style=color:#e6db74>&#34;#398280&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;CMIT&#34;</span>: <span style=color:#e6db74>&#34;#98719f&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;PERS&#34;</span>: <span style=color:#e6db74>&#34;#d08341&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;SNAP&#34;</span>: <span style=color:#e6db74>&#34;#FD971F&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;DROP&#34;</span>: <span style=color:#e6db74>&#34;#ff615c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;CLNT&#34;</span>: <span style=color:#e6db74>&#34;#00813c&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TEST&#34;</span>: <span style=color:#e6db74>&#34;#fe2c79&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;INFO&#34;</span>: <span style=color:#e6db74>&#34;#ffffff&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;WARN&#34;</span>: <span style=color:#e6db74>&#34;#d08341&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ERRO&#34;</span>: <span style=color:#e6db74>&#34;#fe2626&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;TRCE&#34;</span>: <span style=color:#e6db74>&#34;#fe2626&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e># fmt: on</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>list_topics</span>(value: Optional[str]):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> value <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> value
</span></span><span style=display:flex><span>    topics <span style=color:#f92672>=</span> value<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;,&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> topic <span style=color:#f92672>in</span> topics:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> topic <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> TOPICS:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>raise</span> typer<span style=color:#f92672>.</span>BadParameter(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;topic </span><span style=color:#e6db74>{</span>topic<span style=color:#e6db74>}</span><span style=color:#e6db74> not recognized&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> topics
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>(
</span></span><span style=display:flex><span>    file: typer<span style=color:#f92672>.</span>FileText <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Argument(<span style=color:#66d9ef>None</span>, help<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;File to read, stdin otherwise&#34;</span>),
</span></span><span style=display:flex><span>    colorize: bool <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>True</span>, <span style=color:#e6db74>&#34;--no-color&#34;</span>),
</span></span><span style=display:flex><span>    n_columns: Optional[int] <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>None</span>, <span style=color:#e6db74>&#34;--columns&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>),
</span></span><span style=display:flex><span>    ignore: Optional[str] <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>None</span>, <span style=color:#e6db74>&#34;--ignore&#34;</span>, <span style=color:#e6db74>&#34;-i&#34;</span>, callback<span style=color:#f92672>=</span>list_topics),
</span></span><span style=display:flex><span>    just: Optional[str] <span style=color:#f92672>=</span> typer<span style=color:#f92672>.</span>Option(<span style=color:#66d9ef>None</span>, <span style=color:#e6db74>&#34;--just&#34;</span>, <span style=color:#e6db74>&#34;-j&#34;</span>, callback<span style=color:#f92672>=</span>list_topics),
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    topics <span style=color:#f92672>=</span> list(TOPICS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># We can take input from a stdin (pipes) or from a file</span>
</span></span><span style=display:flex><span>    input_ <span style=color:#f92672>=</span> file <span style=color:#66d9ef>if</span> file <span style=color:#66d9ef>else</span> sys<span style=color:#f92672>.</span>stdin
</span></span><span style=display:flex><span>    <span style=color:#75715e># Print just some topics or exclude some topics (good for avoiding verbose ones)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> just:
</span></span><span style=display:flex><span>        topics <span style=color:#f92672>=</span> just
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ignore:
</span></span><span style=display:flex><span>        topics <span style=color:#f92672>=</span> [lvl <span style=color:#66d9ef>for</span> lvl <span style=color:#f92672>in</span> topics <span style=color:#66d9ef>if</span> lvl <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> set(ignore)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    topics <span style=color:#f92672>=</span> set(topics)
</span></span><span style=display:flex><span>    console <span style=color:#f92672>=</span> Console()
</span></span><span style=display:flex><span>    width <span style=color:#f92672>=</span> console<span style=color:#f92672>.</span>size<span style=color:#f92672>.</span>width
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    panic <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> line <span style=color:#f92672>in</span> input_:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>            time, topic, <span style=color:#f92672>*</span>msg <span style=color:#f92672>=</span> line<span style=color:#f92672>.</span>strip()<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34; &#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#75715e># To ignore some topics</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> topic <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> topics:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34; &#34;</span><span style=color:#f92672>.</span>join(msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Debug calls from the test suite aren&#39;t associated with</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># any particular peer. Otherwise we can treat second column</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># as peer id</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> topic <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;TEST&#34;</span>:
</span></span><span style=display:flex><span>                i <span style=color:#f92672>=</span> int(msg[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Colorize output by using rich syntax when needed</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> colorize <span style=color:#f92672>and</span> topic <span style=color:#f92672>in</span> TOPICS:
</span></span><span style=display:flex><span>                color <span style=color:#f92672>=</span> TOPICS[topic]
</span></span><span style=display:flex><span>                msg <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;[</span><span style=color:#e6db74>{</span>color<span style=color:#e6db74>}</span><span style=color:#e6db74>]</span><span style=color:#e6db74>{</span>msg<span style=color:#e6db74>}</span><span style=color:#e6db74>[/</span><span style=color:#e6db74>{</span>color<span style=color:#e6db74>}</span><span style=color:#e6db74>]&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Single column printing. Always the case for debug stmts in tests</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> n_columns <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span> <span style=color:#f92672>or</span> topic <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;TEST&#34;</span>:
</span></span><span style=display:flex><span>                print(time, msg)
</span></span><span style=display:flex><span>            <span style=color:#75715e># Multi column printing, timing is dropped to maximize horizontal</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># space. Heavylifting is done through rich.column.Columns object</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>                cols <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;&#34;</span> <span style=color:#66d9ef>for</span> _ <span style=color:#f92672>in</span> range(n_columns)]
</span></span><span style=display:flex><span>                msg <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#f92672>+</span> msg
</span></span><span style=display:flex><span>                cols[i] <span style=color:#f92672>=</span> msg
</span></span><span style=display:flex><span>                col_width <span style=color:#f92672>=</span> int(width <span style=color:#f92672>/</span> n_columns)
</span></span><span style=display:flex><span>                cols <span style=color:#f92672>=</span> Columns(cols, width<span style=color:#f92672>=</span>col_width <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, equal<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>, expand<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>                print(cols)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>except</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e># Code from tests or panics does not follow format</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># so we print it as is</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> line<span style=color:#f92672>.</span>startswith(<span style=color:#e6db74>&#34;panic&#34;</span>):
</span></span><span style=display:flex><span>                panic <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Output from tests is usually important so add a</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># horizontal line with hashes to make it more obvious</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> panic:
</span></span><span style=display:flex><span>                print(<span style=color:#e6db74>&#34;#&#34;</span> <span style=color:#f92672>*</span> console<span style=color:#f92672>.</span>width)
</span></span><span style=display:flex><span>            print(line, end<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    typer<span style=color:#f92672>.</span>run(main)
</span></span></code></pre></div><p>å½“æˆ‘ä»¬éœ€è¦è°ƒè¯•æµ‹è¯•ä»£ç æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>VERBOSE<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> go test -run InitialElection | python dslogs.py -c <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><h2 id=lab-3a---é¢†å¯¼äººé€‰ä¸¾>Lab-3A - é¢†å¯¼äººé€‰ä¸¾</h2><h3 id=ä»»åŠ¡è¦æ±‚>ä»»åŠ¡è¦æ±‚</h3><p>3Aè¦æ±‚æˆ‘ä»¬å®ç°Raftçš„Leaderé€‰ä¸¾ä»¥åŠå¿ƒè·³æ£€æµ‹åŠŸèƒ½ï¼ˆæ— éœ€è€ƒè™‘æ—¥å¿—ï¼‰ã€‚3Aå®éªŒçš„ç›®æ ‡æ˜¯é€‰ä¸¾å‡ºä¸€ä¸ªå•ä¸€çš„Leaderï¼Œå¦‚æœæ²¡æœ‰æ•…éšœï¼ŒLeaderå°†ä¿æŒé¢†å¯¼åœ°ä½ï¼Œå¹¶ä¸”å¦‚æœæ—§Leaderå¤±è´¥æˆ–ä¸æ—§Leaderæ¥å¾€çš„æ•°æ®åŒ…ä¸¢å¤±ï¼Œåˆ™æ–°é¢†å¯¼è€…å°†æ¥ç®¡ã€‚è¿è¡Œ go test -run 3A æ¥æµ‹è¯•æ‚¨çš„ 3A ä»£ç ã€‚ä»»åŠ¡è¦æ±‚ç»™å‡ºçš„æç¤ºè¾ƒå¤šï¼Œä»¥ä¸‹æ˜¯æˆ‘æŠ½å–çš„å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æç¤ºã€‚</p><p>æç¤ºï¼š</p><ol><li>æŒ‰ç…§è®ºæ–‡ä¸­çš„å›¾ 2ã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œæ‚¨å…³å¿ƒå‘é€å’Œæ¥æ”¶ RequestVote RPCï¼Œä¸é€‰ä¸¾ç›¸å…³çš„æœåŠ¡å™¨è§„åˆ™ä»¥åŠä¸é¢†å¯¼è€…é€‰ä¸¾ç›¸å…³çš„çŠ¶æ€ã€‚</li><li>åœ¨ raft.go ä¸­çš„ Raft ç»“æ„ä½“ä¸­æ·»åŠ ç”¨äºé¢†å¯¼è€…é€‰ä¸¾çš„å›¾2 çŠ¶æ€ã€‚æ‚¨è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªç»“æ„ä½“æ¥ä¿å­˜æ¯ä¸ªæ—¥å¿—æ¡ç›®çš„ä¿¡æ¯ã€‚</li></ol><p>æµ‹è¯•å™¨è¦æ±‚ï¼š</p><ol><li>æµ‹è¯•å™¨è¦æ±‚Leaderæ¯ç§’é’Ÿå‘é€ä¸è¶…è¿‡åæ¬¡<strong>å¿ƒè·³</strong> RPCã€‚</li><li>æµ‹è¯•å™¨è¦æ±‚æ—§Leaderå¤±è´¥åçš„äº”ç§’å†…é€‰å‡ºæ–°é¢†å¯¼è€…ï¼ˆå¦‚æœå¤§å¤šæ•°Serverä»ç„¶å¯ä»¥é€šä¿¡ï¼‰ã€‚</li><li>è¯¥è®ºæ–‡çš„ç¬¬ 5.2 èŠ‚æåˆ°é€‰ä¸¾è¶…æ—¶èŒƒå›´ä¸º 150 è‡³ 300 æ¯«ç§’ã€‚åªæœ‰å½“é¢†å¯¼è€…å‘é€å¿ƒè·³æ¯”æ¯ 150 æ¯«ç§’ä¸€æ¬¡æ›´é¢‘ç¹ï¼ˆä¾‹å¦‚æ¯ 10 æ¯«ç§’ä¸€æ¬¡ï¼‰æ—¶ï¼Œè¿™æ ·çš„èŒƒå›´æ‰æœ‰æ„ä¹‰ã€‚ç”±äºæµ‹è¯•å™¨æ¯ç§’åªèƒ½é™åˆ¶æ‚¨çš„å¿ƒè·³æ•°åæ¬¡ï¼Œå› æ­¤æ‚¨å°†ä¸å¾—ä¸ä½¿ç”¨æ¯”è®ºæ–‡ä¸­çš„ 150 è‡³ 300 æ¯«ç§’æ›´é•¿çš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œä½†ä¸è¦å¤ªé•¿ï¼Œå¦åˆ™æ‚¨å¯èƒ½æ— æ³•åœ¨äº”ç§’å†…é€‰ä¸¾å‡ºé¢†å¯¼è€…ã€‚</li><li>ä¸è¦å¿˜è®°å®ç° GetState() ã€‚</li><li>æµ‹è¯•å™¨åœ¨æ°¸ä¹…å…³é—­å®ä¾‹æ—¶ä¼šè°ƒç”¨æ‚¨çš„ Raft çš„ rf.Kill() ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ rf.killed() æ£€æŸ¥æ˜¯å¦å·²è°ƒç”¨ Kill() ã€‚æ‚¨å¯èƒ½å¸Œæœ›åœ¨æ‰€æœ‰å¾ªç¯ä¸­æ‰§è¡Œæ­¤æ“ä½œï¼Œä»¥é¿å…æ­»äº¡ Raft å®ä¾‹æ‰“å°æ··æ·†çš„æ¶ˆæ¯ã€‚</li></ol><h3 id=å®ç°-1>å®ç°</h3><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=MjZiYTA5YzMxNDU0NzMxNGI2MjhlMWUxNjAwMzY4YjRfTUlXeTJlQTNZYTlMSllicklQRjhwWjJkbU9KTDlOZEdfVG9rZW46RnFIUGJyRFNDb20wUGx4ZzNCRGNHWGVCbkRnXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>ä»¥ä¸ŠåŠ¨å›¾åŸºæœ¬æ¶µç›–äº†é¢†å¯¼äººé€‰ä¸¾çš„æ­¥éª¤ï¼Œé¦–å…ˆå„ä¸ªServerç­‰å¾…é€‰ä¸¾æ—¶é—´ï¼Œè¾¾åˆ°é€‰ä¸¾æ—¶é—´åï¼ŒServerè½¬å˜ä¸ºCandidateï¼Œç­‰å¾…å…¶ä»–ServeræŠ•ç¥¨ï¼Œè·å¾—åŠæ•°ä»¥ä¸Šç¥¨æ•°çš„Serverå½“é€‰ä¸ºLeaderï¼Œå…¶ä»–Serverè½¬å˜ä¸ºFollowerã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦å®ç°çš„åŠŸèƒ½åŒ…æ‹¬â€œå‘èµ·é€‰ä¸¾â€ã€â€œé‡ç½®é€‰ä¸¾æ—¶é—´â€ã€â€œå¹¿æ’­å¿ƒè·³ï¼ˆæ—¥å¿—ï¼‰â€ã€â€œæŠ•ç¥¨â€ã€â€œå“åº”Leaderâ€ã€‚</p><h4 id=å¸¸é‡å®šä¹‰>å¸¸é‡å®šä¹‰</h4><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå®šä¹‰Peerçš„çŠ¶æ€ï¼Œæ ¹æ®è®ºæ–‡ä¸­çš„æè¿°ï¼ŒServerå­˜åœ¨Followerã€Candidateã€Leaderä¸‰ç§çŠ¶æ€ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>State</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>_</span> <span style=color:#a6e22e>State</span> = <span style=color:#66d9ef>iota</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateCandidate</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateLeader</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>ç„¶åå†å®šä¹‰æœ€å°å¿ƒè·³é—´éš”ä»¥åŠæœ€å°é€‰ä¸¾é—´éš”ã€‚åªè¦ç³»ç»Ÿæ»¡è¶³ä¸‹é¢çš„æ—¶é—´è¦æ±‚ï¼ŒRaftå¯ä»¥é€‰ä¸¾å¹¶ç»´æŒä¸€ä¸ªç¨³å®šçš„ leaderï¼š</p><blockquote><p>å¹¿æ’­æ—¶é—´ï¼ˆbroadcastTimeï¼‰ &#171; é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆelectionTimeoutï¼‰ &#171; å¹³å‡æ•…éšœé—´éš”æ—¶é—´ï¼ˆMTBFï¼‰</p></blockquote><p>å¹¿æ’­æ—¶é—´æŒ‡çš„æ˜¯ä»ä¸€ä¸ªæœåŠ¡å™¨å¹¶è¡Œçš„å‘é€ RPCs ç»™é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨å¹¶æ¥æ”¶å“åº”çš„å¹³å‡æ—¶é—´ï¼›é€‰ä¸¾è¶…æ—¶æ—¶é—´å°±æ˜¯åœ¨å‰é¢ä»‹ç»çš„é€‰ä¸¾çš„è¶…æ—¶æ—¶é—´é™åˆ¶ï¼›å¹³å‡æ•…éšœé—´éš”æ—¶é—´å°±æ˜¯å¯¹äºä¸€å°æœåŠ¡å™¨è€Œè¨€ï¼Œä¸¤æ¬¡æ•…éšœä¹‹é—´çš„å¹³å‡æ—¶é—´ã€‚</p><p>æµ‹è¯•å™¨è¦æ±‚ä¸­å·²ç»è¯´æ˜ï¼ŒLeaderæ¯ç§’é’Ÿå‘é€ä¸è¶…è¿‡10æ¬¡å¿ƒè·³ï¼ˆæˆ–è€…è¯´å¹¿æ’­ï¼‰ï¼Œå› æ­¤æˆ‘å°†æœ€å°å¿ƒè·³é—´éš”å®šä¹‰ä¸º100msï¼Œè€Œé€‰ä¸¾é—´éš”æ—¶é—´åº”è¯¥è¿œå¤§äºå¿ƒè·³é—´éš”ï¼Œä½†åˆä¸å®œè¿‡é•¿ï¼Œå¦åˆ™æ— æ³•åœ¨5ç§’å†…é€‰ä¸¾å‡ºæ–°çš„Leaderï¼Œå› æ­¤æˆ‘å®šä¹‰æœ€å°é€‰ä¸¾é—´éš”ä¸º500msã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minHeartBeatInterval</span> = <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minElectionInterval</span>  = <span style=color:#ae81ff>500</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><h4 id=ç»“æ„ä½“å®šä¹‰>ç»“æ„ä½“å®šä¹‰</h4><p>é¦–å…ˆæ˜¯å®šä¹‰ç»“æ„ä½“ï¼Œæ ¹æ®Raftè®ºæ–‡ä¸­çš„å®šä¹‰ã€‚æ³¨æ„ï¼Œå®Œæˆ3Aä»»åŠ¡æ— éœ€å…³æ³¨Logã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Raft</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>          <span style=color:#75715e>// Lock to protect shared access to this peer&#39;s state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>peers</span>     []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span> <span style=color:#75715e>// RPC end points of all peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>          <span style=color:#75715e>// Object to hold this peer&#39;s persisted state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>        <span style=color:#66d9ef>int</span>                 <span style=color:#75715e>// this peer&#39;s index into peers[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>      <span style=color:#66d9ef>int32</span>               <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Look at the paper&#39;s Figure 2 for a description of what</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// state a Raft server must maintain.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>         <span style=color:#a6e22e>State</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>heartBeatTime</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>electionTime</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»¥ä¸‹å­—æ®µè®ºæ–‡åŸæ–‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentTerm</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// å½“å‰ä»»æœŸ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votedFor</span>    <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// æŠ•ç¥¨ç»™çš„å€™é€‰è€…ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>         []<span style=color:#a6e22e>LogEntry</span> <span style=color:#75715e>// æ—¥å¿—</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>commitIndex</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// å·²ç»æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// å·²ç»åº”ç”¨åˆ°çŠ¶æ€æœºçš„æœ€é«˜æ—¥å¿—æ¡ç›®ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIndex</span>   []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// å¯¹æ¯ä¸ªæœåŠ¡å™¨ï¼Œè¦å‘é€çš„ä¸‹ä¸€è·³æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchIndex</span>  []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// å¯¹æ¯ä¸ªæœåŠ¡å™¨ï¼Œå·²çŸ¥è¢«å¤åˆ¶çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æµ‹è¯•å™¨è¿˜è¦æ±‚æˆ‘ä»¬å®ç°GetState()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetState</span>() (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>term</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>isleader</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3A).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>isleader</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>term</span>, <span style=color:#a6e22e>isleader</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¯¥æ–¹æ³•é€šè¿‡è·å– currentTerm å’Œ state å­—æ®µçš„å€¼æ¥è·å–å½“å‰æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œè¿”å›å½“å‰ä»»æœŸå·å’Œè¯¥æœåŠ¡å™¨æ˜¯å¦ä¸º leaderã€‚</p><h4 id=é€‰ä¸¾å’Œå¿ƒè·³æ—¶é—´é‡ç½®>é€‰ä¸¾å’Œå¿ƒè·³æ—¶é—´é‡ç½®</h4><p>å¦‚æœæŸä¸€æ—¶åˆ»æ‰€æœ‰Serveréƒ½å‘èµ·é€‰ä¸¾ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ä¼šå‘ç”Ÿæ‰€æœ‰Serveréƒ½æŠ•è‡ªå·±ä¸€ç¥¨ï¼Œç„¶åæ‹’ç»åˆ«äººçš„æŠ•ç¥¨ï¼Œç”±æ­¤å°†é€‰ç¥¨ç“œåˆ†ï¼Œä¹Ÿç§°ä¸ºæ´»é”çŠ¶æ€ã€‚Raft ç®—æ³•ä½¿ç”¨éšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆrandomized election timeoutsï¼‰çš„æ–¹æ³•æ¥ç¡®ä¿å¾ˆå°‘ä¼šå‘ç”Ÿé€‰ç¥¨ç“œåˆ†çš„æƒ…å†µï¼Œå°±ç®—å‘ç”Ÿä¹Ÿèƒ½å¾ˆå¿«çš„è§£å†³ï¼š</p><ul><li>æ¯ä¸€ä¸ª candidate åœ¨å¼€å§‹ä¸€æ¬¡é€‰ä¸¾çš„æ—¶å€™ä¼šä»ä¸€ä¸ªå›ºå®šçš„åŒºé—´ï¼ˆä¾‹å¦‚ 150-300 æ¯«ç§’ï¼‰éšæœºé€‰æ‹©ä¸€ä¸ªé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œç„¶ååœ¨è¶…æ—¶æ—¶é—´å†…ç­‰å¾…æŠ•ç¥¨çš„ç»“æœã€‚</li><li>ç”±äºä¸€ä¸ªä»»æœŸå†…ä¸èƒ½é‡å¤æŠ•ç¥¨ï¼Œè¶Šæ—©è¶…æ—¶çš„ candidate è¶Šå…ˆå¼€å§‹æ‹‰ç¥¨ï¼Œä¹Ÿæ›´å®¹æ˜“èƒœå‡ºã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å°†æœ€å¤§é€‰ä¸¾æ—¶é—´é—´éš”å®šä¹‰ä¸º <strong>æœ€å°é—´éš”+ï¼ˆæœ€å°é—´éš” * 0.7ï¼‰</strong>ï¼Œç„¶åéšæœºé€‰å–**[æœ€å°é—´éš”ï¼Œæœ€å¤§é—´éš”)**ä¸­çš„å€¼ä¸ºã€‚è€Œå¿ƒè·³æ—¶é—´å›ºå®šä¸º100msä¸€æ¬¡ã€‚å®šä¹‰å‡½æ•°å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// é‡ç½®é€‰ä¸¾æ—¶é—´</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>resetElectionTime</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>extra</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(float64(<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Int63</span>()<span style=color:#f92672>%</span>int64(<span style=color:#a6e22e>minElectionInterval</span>)) <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.7</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>electionTime</span> = <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>minElectionInterval</span>).<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>extra</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡ç½®å¿ƒè·³æ—¶é—´</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>resetHeartBeatTime</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>heartBeatTime</span> = <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#a6e22e>minHeartBeatInterval</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å®šä¹‰äº†ç»“æ„ä½“ä¸é‡ç½®å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™ç»“æ„ä½“èµ‹åˆå§‹å€¼ï¼Œä»£ç æ¡†æ¶ä¸­è¦æ±‚æˆ‘ä»¬å®ç°Makeå‡½æ•°ã€‚å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>peers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Raft</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> = <span style=color:#a6e22e>peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span> = <span style=color:#a6e22e>persister</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your initialization code here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// initialize from state persisted before a crash</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadRaftState</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start ticker goroutine to start elections</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>ticker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=rpcå‡½æ•°å®šä¹‰>RPCå‡½æ•°å®šä¹‰</h4><p>å®ŒæˆLab3Aä»…éœ€å®ç°ä¸¤ä¸ªRPCå‡½æ•°â€”â€”RequestVoteå’ŒAppendEntriesã€‚</p><p>RequestVoteç”¨äºå€™é€‰è€…è¯·æ±‚é€‰ä¸¾ï¼Œè€ŒAppendEntriesç”¨äºåŒæ­¥æ—¥å¿—ä»¥åŠæ¥æ”¶å¿ƒè·³ä¿¡æ¯ã€‚å®ç°3Aæ— éœ€å…³æ³¨æ—¥å¿—ï¼Œå› æ­¤è¿™é‡Œæš‚ä¸”å°†AppendEntrieè§†ä¸ºæ¥æ”¶å¿ƒè·³è¯·æ±‚ã€‚</p><p>æ ¹æ®è®ºæ–‡ï¼Œæˆ‘ä»¬å…ˆå®šä¹‰å‡ºå¦‚ä¸‹è¯·æ±‚å“åº”å‚æ•°ã€‚å®éªŒä»£ç å·²ç»ç»™å‡ºäº†RequsetVoteå‡½æ•°çš„éª¨æ¶ï¼Œè€ŒAppendEntrieséœ€è¦è‡ªè¡Œå®šä¹‰ã€‚</p><h5 id=requestvote>RequestVote</h5><p>å¯¹äºRequesetVoteçš„è¯·æ±‚å“åº”ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RequestVoteArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>         <span style=color:#66d9ef>int</span> <span style=color:#75715e>// å€™é€‰è€…çš„ä»»æœŸå·</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CandidateId</span>  <span style=color:#66d9ef>int</span> <span style=color:#75715e>// å€™é€‰è€…ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastLogIndex</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>// å€™é€‰è€…æœ€æ–°æ—¥å¿—çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastLogTerm</span>  <span style=color:#66d9ef>int</span> <span style=color:#75715e>// å€™é€‰è€…æœ€æ–°æ—¥å¿—çš„ä»»æœŸå·</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RequestVoteReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>        <span style=color:#66d9ef>int</span>  <span style=color:#75715e>// å½“å‰ä»»æœŸ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>VoteGranted</span> <span style=color:#66d9ef>bool</span> <span style=color:#75715e>// æ˜¯å¦æŠ•ç¥¨</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>RequesetVote RPC</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>RequestVote</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3A, 3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°å€™é€‰äººS%dé€‰ä¸¾è¯·æ±‚&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ‹’ç»å€™é€‰è€…S%dï¼Œä»»æœŸå°äºè‡ªèº«&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;é€‰ä¸¾å€™é€‰äºº S%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// é‡ç½®é€‰ä¸¾æ—¶é—´</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å·²é€‰æ‹©S%d æ‹’ç»å€™é€‰äººS%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=YTAzOWZiNDU1MWI2MzRlMGFjYTIxYjE4MmJjODczNjdfR0V0eG4ybERYQ1U0b1hmUm9QV2VoTlluSENyUlNvY0xfVG9rZW46QzV4ZWJxc0FGbzhMQjB4NkRabGNuZ2dzbnFnXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>åœ¨è¯¥ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¦åˆ¤æ–­rf.votedFor==-1æˆ–è€…<em>rf</em>.votedFor == <em>args</em>.CandidateIdä¸ºçœŸæ—¶ï¼Œåˆ™æŠ•ç¥¨ã€‚å‡å¦‚æ²¡æœ‰rf.votedFor== args.CandidateIdï¼Œåˆ™å¯èƒ½å¯¼è‡´ä¸€è½®é€‰ä¸¾æ— æ³•é€‰å‡ºLeaderï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“S3æ”¶åˆ°S2é€‰ä¸¾è¯·æ±‚å¹¶æŠ•ç¥¨æ—¶ï¼ŒS3çš„votedForå€¼æ›´æ”¹ä¸ºS2ï¼Œä½†S3å“åº”çš„RPCä¸¢å¤±ï¼Œæ­¤æ—¶S2å†æ¬¡å‘é€é€‰ä¸¾è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰ä¸åˆ¤æ–­<em>rf</em>.votedFor == <em>args</em>.CandidateIdï¼Œåˆ™å°†è¿”å›Falseï¼Œå¾ˆæ˜æ˜¾å°±å‘ç”Ÿäº†é”™è¯¯ï¼Œè‡´ä½¿æ— æ³•é€‰ä¸¾å‡ºLeaderã€‚</p><h5 id=appendentries>AppendEntries</h5><p>è€Œå¯¹äºAppendEntriesçš„è¯·æ±‚å“åº”ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>         <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderId</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Entries</span>      []<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderCommit</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Success</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// AppendEntries RPC å‘é€å¿ƒè·³æˆ–è€…æ—¥å¿—æäº¤</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ° S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœæ”¶åˆ°çš„ä»»æœŸå°äºè‡ªèº«ï¼Œåˆ™æ‹’ç»Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„ä»»æœŸå·Term%då°äºè‡ªèº«ä»»æœŸå·Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å½“å‰ä»»æœŸå·ï¼š%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ç”±å€™é€‰è€…é™çº§ä¸ºè¿½éšè€…&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ”¶åˆ°çš„ä»»æœŸå¤§äºè‡ªèº«ï¼Œåˆ™è¿½éšè¯¥Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœæ˜¯Leaderæˆ–å€™é€‰äººï¼Œåˆ™é™çº§ä¸ºFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„æ–°çš„ä»»æœŸå·Term%dï¼Œé™çº§ä¸ºFollower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=å¹¿æ’­entries>å¹¿æ’­Entries</h4><p>åœ¨Lab3Aä¸­ï¼Œå¹¿æ’­Entriesç”¨æ¥ç»´æŠ¤Followerçš„è¿½éšçŠ¶æ€ï¼Œå¹¶é‡ç½®Followerçš„é€‰ä¸¾å‘èµ·æ—¶é—´ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastEntries</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å¼€å§‹å¹¿æ’­AppendEntries&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ ¹æ®è®ºæ–‡ï¼Œå½“Leaderæ”¶åˆ°äº†<strong>å¤§äº</strong>è‡ªèº«ä»»æœŸçš„æ¶ˆæ¯ï¼Œåº”è¯¥<strong>é™çº§</strong>ä¸ºFollowerï¼›è€Œå½“Leaderæ”¶åˆ°äº†<strong>å°äº</strong>è‡ªèº«çš„ä»»æœŸçš„æ¶ˆæ¯ï¼Œåº”è¯¥å°†è¯¥æ¶ˆæ¯è§†ä¸º<strong>è¿‡æœŸæ¶ˆæ¯</strong>è€ŒæŠ›å¼ƒï¼›å½“ä»»æœŸç›¸åŒæ—¶ï¼ŒLeaderéœ€è¦å°†NextIndexå€¼å‡1ï¼Œç„¶åå†æ¬¡å‘é€æ¶ˆæ¯ç»™Followerï¼Œç›´åˆ°è¾¾åˆ°ä¸€è‡´ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Term:%d &gt; CurrentTerm%d,é™çº§ä¸ºFollower&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;éLeaderï¼Œæ‹’ç»å“åº” S%d:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å“åº”çš„ä»»æœŸå·%dæ›´å°ï¼Œæ‹’ç»æ¥å—&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dæˆåŠŸAppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dæ‹’ç»AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=å‘èµ·é€‰ä¸¾>å‘èµ·é€‰ä¸¾</h4><p>å‘èµ·é€‰ä¸¾å‡½æ•°åŒ…æ‹¬<code>raiseElection</code>å’Œ<code>broadcastElection</code>ã€‚<code>raiseElection</code> æ–¹æ³•æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨äºå¯åŠ¨ Raft å®ä¾‹çš„é€‰ä¸¾è¿‡ç¨‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// å¼€å§‹é€‰ä¸¾</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>raiseElection</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateCandidate</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å½“å‰ä»»æœŸå·ï¼š%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å‘èµ·é€‰ä¸¾&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ„å»ºrpcè¯·æ±‚ä¸å“åº”</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RequestVoteArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>CandidateId</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¹¶è¡Œå‘é€æŠ•ç¥¨ä¿¡æ¯</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastElection</span>(<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//é‡ç½®é€‰ä¸¾æ—¶é—´</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>broadcastElection</code> æ–¹æ³•å‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ï¼Œä»¥åŠå¯¹æŠ•ç¥¨å“åº”è¿›è¡Œå¤„ç†ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span>  <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastElection</span>(<span style=color:#a6e22e>args</span> <span style=color:#a6e22e>RequestVoteArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ticket</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>once</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Once</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>RequestVoteReply</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendRequestVote</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// å‘é€é€‰å–è¯·æ±‚å¤±è´¥</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>ticket</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>// å¦‚æœç¥¨æ•°è¶…è¿‡åŠæ•°ï¼Œåˆ™æ™‹å‡Leader</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ticket</span> &gt; (len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// ç¡®ä¿æ¯æ¬¡æ™‹å‡Leaderåªæ‰§è¡Œä¸€æ¬¡</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>once</span>.<span style=color:#a6e22e>Do</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å‡çº§ä¸ºLeader&#34;</span>)
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å½“å‰ä»»æœŸå·ï¼š%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateLeader</span>
</span></span><span style=display:flex><span>                   <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastEntries</span>() <span style=color:#75715e>// å½“é€‰ä¹‹åç«‹é©¬å‘é€Entries</span>
</span></span><span style=display:flex><span>                })
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„ï¼Œå½“è¿½éšè€…ï¼ˆå¯åŠ¨æ—¶æ‰€æœ‰Peerå‡ä¸ºè¿½éšè€…ï¼‰å†³å®šå‘èµ·é€‰ä¸¾æ—¶ï¼Œåº”è¯¥ç«‹å³è½¬æ¢çŠ¶æ€ï¼Œå°†è‡ªèº«çš„ä»»æœŸå€¼TermåŠ 1ï¼Œå¹¶æŠ•ç¥¨ç»™è‡ªå·±ã€‚å€™é€‰è€…æ”¶åˆ°è¶…è¿‡åŠæ•°çš„é€‰ç¥¨æ—¶ï¼ˆåŒ…æ‹¬æŠ•ç»™è‡ªå·±çš„é€‰ç¥¨ï¼‰ï¼Œå°†æ™‹å‡ä¸ºLeaderã€‚broadcastElectionå‡½æ•°ä¸­ï¼Œæ¯æ¬¡æ”¶åˆ°Vote RPCçš„å“åº”æ—¶ï¼Œè¦åˆ¤æ–­Peeræ˜¯å¦æŠ•ç¥¨ä»¥åŠä»»æœŸæ˜¯å¦ä¸å€™é€‰è€…å¯¹åº”ã€‚æ™‹å‡åç«‹å³å‘é€ä¸€æ¬¡å¿ƒè·³è¯·æ±‚ï¼Œè¦æ±‚å…¶ä½™Peeræˆä¸ºè¿½éšè€…ã€‚</p><h4 id=å®Œæˆtickerå’Œkill>å®ŒæˆTicker()å’ŒKill()</h4><p>æˆ‘ä»¬éœ€è¦ç›‘å¬æ˜¯å¦è¾¾åˆ°å¿ƒè·³æ—¶é—´ä¸é€‰ä¸¾æ—¶é—´ï¼Œä¸€ç§æ–¹æ¡ˆæ˜¯å¯åŠ¨å¯¹åº”çš„åç¨‹ä¸€ç›´ç›‘å¬ï¼Œå½“æ—¶é—´ç‚¹è¾¾åˆ°æ—¶è§¦å‘å“åº”çš„ä»»åŠ¡ã€‚ä½†ä»»åŠ¡æç¤ºä¸­å»ºè®®æˆ‘ä»¬ä¸è¦ä½¿ç”¨ Go çš„ time.Timer æˆ– time.Ticker ï¼Œå› ä¸ºè¿™äº›å¾ˆéš¾æ­£ç¡®ä½¿ç”¨ï¼Œè€Œç»™å‡ºäº†Tickeræ–¹æ³•çš„éª¨æ¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŒ‰ç…§ä»»åŠ¡æç¤ºè¿›è¡Œã€‚</p><p>ä½¿ç”¨Tickeræ–¹æ³•æ— æ³•ä¿è¯æ—¶åˆ»è¾¾åˆ°æ—¶ç«‹å³è§¦å‘ä»»åŠ¡ï¼Œæ¯è½®æ£€æµ‹ä¹‹åéƒ½éœ€è¦è¿›è¡Œ50~350msçš„ä¼‘çœ ï¼Œä½†è¿™å¹¶ä¸å½±å“Raftçš„å®ç°ã€‚</p><p>æ³¨æ„ï¼Œåœ¨å®ç°Raftè¿‡ç¨‹ä¸­ä¼šç»å¸¸ä½¿ç”¨é”ï¼Œé”ä¿è¯peerçŠ¶æ€çš„æ­£ç¡®æ€§ï¼Œè¦é˜²æ­¢å‡ºç°æ­»é”é—®é¢˜ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>ticker</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>killed</span>() <span style=color:#f92672>==</span> <span style=color:#66d9ef>false</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Your code here (3A)</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Check if a leader election should be started.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœå½“å‰é˜¶æ®µä¸ºLeaderï¼Œå¹¶ä¸”è¾¾åˆ°å¿ƒè·³æ—¶é—´</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>heartBeatTime</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendHeartBeat</span>()
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// è¾¾åˆ°é€‰ä¸¾æ—¶é—´</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>electionTime</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>raiseElection</span>()
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// pause for a random amount of time between 50 and 350</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// milliseconds.</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ms</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>50</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Int63</span>() <span style=color:#f92672>%</span> <span style=color:#ae81ff>300</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>ms</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Killå‡½æ•°æˆ‘ä»¬åªè¿›è¡Œç®€å•çš„æ—¥å¿—æ‰“å°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>Kill</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>StoreInt32</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>dead</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here, if desired.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Killed&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è¿è¡Œç»“æœ>è¿è¡Œç»“æœ</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestInitialElection3A
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3A<span style=color:#f92672>)</span>: initial election ...
</span></span><span style=display:flex><span>  ... Passed --   3.5  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>26</span>    <span style=color:#ae81ff>5236</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>--- PASS: TestInitialElection3A <span style=color:#f92672>(</span>3.54s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestReElection3A
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3A<span style=color:#f92672>)</span>: election after network failure ...
</span></span><span style=display:flex><span>  ... Passed --   5.1  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>60</span>    <span style=color:#ae81ff>9308</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>--- PASS: TestReElection3A <span style=color:#f92672>(</span>5.10s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>===</span> RUN   TestManyElections3A
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3A<span style=color:#f92672>)</span>: multiple elections ...
</span></span><span style=display:flex><span>  ... Passed --   7.1  <span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>300</span>   <span style=color:#ae81ff>46506</span>    <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>--- PASS: TestManyElections3A <span style=color:#f92672>(</span>7.13s<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     15.783s
</span></span></code></pre></div><h2 id=lab-3b---æ—¥å¿—>Lab-3B - æ—¥å¿—</h2><h3 id=ä»»åŠ¡è¦æ±‚-1>ä»»åŠ¡è¦æ±‚</h3><p>å®ç°é¢†å¯¼è€…å’Œè¿½éšè€…ä»£ç ä»¥é™„åŠ æ–°çš„æ—¥å¿—æ¡ç›®ï¼Œä»¥ä¾¿ go test -run 3B æµ‹è¯•é€šè¿‡ã€‚</p><p>æç¤ºï¼š</p><ol><li>ä½ çš„ç¬¬ä¸€ä¸ªç›®æ ‡åº”è¯¥æ˜¯é€šè¿‡ TestBasicAgree3B() ã€‚é¦–å…ˆå®ç° Start() ï¼Œç„¶åç¼–å†™ä»£ç é€šè¿‡ AppendEntries RPC å‘é€å’Œæ¥æ”¶æ–°çš„æ—¥å¿—æ¡ç›®ï¼Œéµå¾ªå›¾ 2ã€‚åœ¨<strong>æ¯ä¸ªPeerèŠ‚ç‚¹</strong>ä¸Šé€šè¿‡ applyCh å‘é€æ¯ä¸ªæ–°æäº¤çš„æ¡ç›®ã€‚</li><li>æ‚¨éœ€è¦å®ç°é€‰ä¸¾é™åˆ¶ï¼ˆè®ºæ–‡ä¸­çš„ 5.4.1 èŠ‚ï¼‰ã€‚</li><li>æ‚¨çš„ä»£ç å¯èƒ½æœ‰å¾ªç¯ï¼Œé‡å¤æ£€æŸ¥æŸäº›äº‹ä»¶ã€‚ä¸è¦è®©è¿™äº›å¾ªç¯è¿ç»­æ‰§è¡Œè€Œä¸æš‚åœï¼Œå› ä¸ºè¿™ä¼šä½¿æ‚¨çš„å®ç°å˜æ…¢ï¼Œä»è€Œæ— æ³•é€šè¿‡æµ‹è¯•ã€‚ä½¿ç”¨ Go çš„æ¡ä»¶å˜é‡ï¼Œæˆ–åœ¨æ¯ä¸ªå¾ªç¯è¿­ä»£ä¸­æ’å…¥ time.Sleep(10 * time.Millisecond) ã€‚</li><li>ä¸ºäº†æœªæ¥çš„å®éªŒï¼Œè¯·è‡ªå·±åšä¸ªå¥½äº‹ï¼Œç¼–å†™ï¼ˆæˆ–é‡æ–°ç¼–å†™ï¼‰å¹²å‡€ã€æ¸…æ™°çš„ä»£ç ã€‚æœ‰å…³æƒ³æ³•ï¼Œè¯·é‡æ–°è®¿é—®æˆ‘ä»¬çš„<a href=https://pdos.csail.mit.edu/6.824/labs/guidance.html target=_blank>æŒ‡å—é¡µé¢</a>
ï¼Œå…¶ä¸­æä¾›äº†æœ‰å…³å¦‚ä½•å¼€å‘å’Œè°ƒè¯•ä»£ç çš„æç¤ºã€‚</li></ol><h3 id=å®ç°å‡†å¤‡æ­¥éª¤>å®ç°â€”â€”å‡†å¤‡æ­¥éª¤</h3><h4 id=å·¥å…·å‡½æ•°>å·¥å…·å‡½æ•°</h4><p>å®ç°maxå’Œminå·¥å…·å‡½æ•°å°†æœ‰åŠ©äºä»£ç å®ç°ï¼Œä¸è¿‡Go 1.21.0ç‰ˆæœ¬å·²ç»å†…ç½®äº†maxå’Œminã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> max(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> min(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=å®šä¹‰logentry>å®šä¹‰LogEntry</h4><p>è¯¥å®ç°éœ€è¦å®ç°æ—¥å¿—åŒæ­¥ï¼Œé‚£ä¹ˆéœ€è¦å…ˆå®šä¹‰ä¸€ä¸‹LogEntryç»“æ„ä½“ã€‚maxå’Œminæ–¹æ³•åç»­ä¼šç”¨åˆ°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LogEntry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>    <span style=color:#66d9ef>int</span>         <span style=color:#75715e>//åˆ›å»ºè¯¥Logæ—¶çš„ä»»æœŸ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Command</span> <span style=color:#66d9ef>interface</span>{} <span style=color:#75715e>//éœ€è¦æ‰§è¡Œçš„å‘½ä»¤</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€äº›è¾…åŠ©æ–¹æ³•ä¾¿äºæˆ‘ä»¬è·å–æ“ä½œLogã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// GetLogSlice [i,j)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>right</span> <span style=color:#66d9ef>int</span>) []<span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &gt; <span style=color:#a6e22e>right</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;left &gt; right&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &lt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>right</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;æ•°ç»„è¶Šç•Œ&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newLog</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>LogEntry</span>, <span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#a6e22e>left</span>)
</span></span><span style=display:flex><span>    copy(<span style=color:#a6e22e>newLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>left</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:<span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newLog</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>idx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>LastLogTerm</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Panicf</span>(<span style=color:#e6db74>&#34;idx:%d &lt; 0&#34;</span>, <span style=color:#a6e22e>idx</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Command</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>idx</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=è¡¥å……ç»“æ„ä½“>è¡¥å……ç»“æ„ä½“</h4><p>å®šä¹‰å®Œæ—¥å¿—åï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è¡¥å……è‡³Raftç»“æ„ä½“ä¸­ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Raft</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>          <span style=color:#75715e>// Lock to protect shared access to this peer&#39;s state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>peers</span>     []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span> <span style=color:#75715e>// RPC end points of all peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>          <span style=color:#75715e>// Object to hold this peer&#39;s persisted state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>        <span style=color:#66d9ef>int</span>                 <span style=color:#75715e>// this peer&#39;s index into peers[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>      <span style=color:#66d9ef>int32</span>               <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Look at the paper&#39;s Figure 2 for a description of what</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// state a Raft server must maintain.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>         <span style=color:#a6e22e>State</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>heartBeatTime</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>electionTime</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»¥ä¸‹å­—æ®µè®ºæ–‡åŸæ–‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>         []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentTerm</span> <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// å½“å‰ä»»æœŸ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votedFor</span>    <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// æŠ•ç¥¨ç»™çš„å€™é€‰è€…ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>commitIndex</span> <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// å·²ç»æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>   <span style=color:#75715e>// å·²ç»åº”ç”¨åˆ°çŠ¶æ€æœºçš„æœ€é«˜æ—¥å¿—æ¡ç›®ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIndex</span>   []<span style=color:#66d9ef>int</span> <span style=color:#75715e>// å¯¹æ¯ä¸ªæœåŠ¡å™¨ï¼Œè¦å‘é€çš„ä¸‹ä¸€è·³æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchIndex</span>  []<span style=color:#66d9ef>int</span> <span style=color:#75715e>// å¯¹æ¯ä¸ªæœåŠ¡å™¨ï¼Œå·²çŸ¥è¢«å¤åˆ¶çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ­¤å¤–ï¼Œæˆ‘ä»¬éœ€è¦å°†<code>AppendEntriesArgs</code>ç»“æ„ä½“ä¸­çš„Entrieså­—æ®µæ›´æ¢ä¸º<code>LogEntry</code>åˆ‡ç‰‡ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>         <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderId</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>PrevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Entries</span>      []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderCommit</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=å®ç°startæ–¹æ³•>å®ç°Startæ–¹æ³•</h4><blockquote><p>Startæ–¹æ³•ç”¨äºServeræ¥æ”¶å‘½ä»¤ã€‚</p></blockquote><p>å¦‚æœè¯¥Serverä¸æ˜¯ Leaderï¼Œå®ƒå°†è¿”å›falseã€‚å¦‚æœè¯¥Serveræ˜¯Leaderï¼Œåˆ™å¼€å§‹å…±è¯†è¿‡ç¨‹å¹¶ç«‹å³è¿”å›ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œæ— æ³•ä¿è¯æ­¤å‘½ä»¤å°†è¢«æäº¤åˆ° Raft æ—¥å¿—ä¸­ï¼Œå› ä¸º Leader å¯èƒ½ä¼šå¤±è´¥æˆ–å¤±å»é€‰ä¸¾ã€‚ä½†å³ä½¿ Raft å®ä¾‹å·²ç»åœæ­¢è¿è¡Œï¼Œæ­¤å‡½æ•°ä¹Ÿåº”è¯¥æ­£å¸¸è¿”å›ã€‚</p><p>Startæ–¹æ³•ç¬¬ä¸€ä¸ªè¿”å›å€¼æ˜¯è¯¥å‘½ä»¤åœ¨æ—¥å¿—ä¸­å¯èƒ½å‡ºç°çš„ç´¢å¼•ã€‚ç¬¬äºŒä¸ªè¿”å›å€¼æ˜¯å½“å‰ä»»æœŸå·ã€‚ç¬¬ä¸‰ä¸ªè¿”å›å€¼æ˜¯trueï¼Œè¡¨ç¤ºè¯¥æœåŠ¡å™¨è®¤ä¸ºå®ƒæ˜¯ Leaderã€‚æ³¨æ„ï¼Œè¯¥æ–¹æ³•ç”±Testeræ‰§è¡Œã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>Start</span>(<span style=color:#a6e22e>command</span> <span style=color:#66d9ef>interface</span>{}) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>term</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isLeader</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°Testerä¼ æ¥çš„Command: { %v }&#34;</span>, <span style=color:#a6e22e>command</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>, <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Command</span>: <span style=color:#a6e22e>command</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#75715e>// æ—¥å¿—ç´¢å¼•ä»1å¼€å§‹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isLeader</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘é€AppendEntry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastEntries</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>index</span>, <span style=color:#a6e22e>term</span>, <span style=color:#a6e22e>isLeader</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=æäº¤æ—¥å¿—commitmsg>æäº¤æ—¥å¿—commitMsg</h4><p>RaftèŠ‚ç‚¹æœ¬èº«æ˜¯æ²¡æœ‰çŠ¶æ€æœºå®ç°çš„ï¼ŒçŠ¶æ€æœºåº”è¯¥ç”±Raftçš„ä¸Šå±‚åº”ç”¨æ¥å®ç°ã€‚å› æ­¤ï¼Œåœ¨MIT6.5840-3Bå®éªŒä¸­ï¼Œæˆ‘ä»¬æ— éœ€è€ƒè™‘çŠ¶æ€æœºçš„å®ç°ï¼Œåªéœ€å°†æ—¥å¿—å‘é€ç»™Makeå‡½æ•°çš„applyChå…¥å‚é€šé“æ¥æ¨¡æ‹Ÿæäº¤ã€‚ä¸ºäº†æ–¹ä¾¿æ§åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ªcommitMsgæ–¹æ³•ï¼Œå°†å·²ç»commitçš„æ•°æ®æ¨¡æ‹Ÿæäº¤è‡³çŠ¶æ€æœºã€‚</p><p>è®ºæ–‡ä¸­è¦æ±‚æˆ‘ä»¬æ ¹æ®lastAppliedå‚æ•°ä¸commitIndexå‚æ•°æ§åˆ¶æäº¤ï¼Œä¸ºäº†é˜²æ­¢ä»£ç é˜»å¡é€ æˆå é”æ—¶é—´è¿‡é•¿ï¼Œå¯ä»¥å…ˆå°†msgæ·»åŠ åˆ°æ•°ç»„ä¸­ï¼Œå†éå†æ•°ç»„å‘é€ç»™applyChé€šé“ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>ApplyMsg</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span><span style=color:#f92672>-</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// lastAppliedä¸ºç´¢å¼•å·ï¼Œä»1å¼€å§‹</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>msg</span> = append(<span style=color:#a6e22e>msg</span>, <span style=color:#a6e22e>ApplyMsg</span>{
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>CommandValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>Command</span>:      <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>).<span style=color:#a6e22e>Command</span>,
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>CommandIndex</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>,
</span></span><span style=display:flex><span>          })
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>msg</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æäº¤ {Index:%d , Cmd: %v}è‡³ApplyCh&#34;</span>, <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>CommandIndex</span>, <span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>Command</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>applyCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>ms</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>ms</span>) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¯¥å‡½æ•°æ— æ³•ä¸€ç›´åŠ é”åˆ°ApplyMsgéƒ½æäº¤è‡³applyChï¼Œä¼šé€ æˆæ­»é”ç°è±¡ã€‚</p><p>å®Œæˆä»¥ä¸Šå·¥ä½œï¼Œæ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹Makeå‡½æ•°ã€‚æˆ‘ä»¬éœ€è¦æ–°å¢ä¸€ä¸ªåç¨‹è¿è¡ŒcommitMsgæ–¹æ³•ï¼Œè¿˜éœ€è¦åˆå§‹åŒ–rf.logå‚æ•°ã€‚æ³¨æ„ï¼Œç´¢å¼•ä¸è®ºæ–‡ä¸€è‡´ï¼Œéƒ½é»˜è®¤ä»1å¼€å§‹ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>peers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>, <span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Raft</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> = <span style=color:#a6e22e>peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span> = <span style=color:#a6e22e>persister</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> = <span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your initialization code here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = make([]<span style=color:#a6e22e>LogEntry</span>, <span style=color:#ae81ff>0</span>)  <span style=color:#75715e>// new åˆå§‹åŒ–log</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> = make([]<span style=color:#66d9ef>int</span>, len(<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span>) <span style=color:#75715e>// new æäº¤msg</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// initialize from state persisted before a crash</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadRaftState</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start ticker goroutine to start elections</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>ticker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å®ç°æ ¸å¿ƒæ­¥éª¤>å®ç°â€”â€”æ ¸å¿ƒæ­¥éª¤</h3><p>ä»¥ä¸‹æ˜¯è®ºæ–‡ä¸­è¦æ±‚**èŠ‚ç‚¹è¦éµå®ˆçš„è§„åˆ™ï¼Œ**è¿™äº›è§„åˆ™å°†ä¼šæŒ‡å¯¼æˆ‘ä»¬å®ŒæˆLab-3Bã€‚</p><p>æ‰€æœ‰èŠ‚ç‚¹ï¼š</p><ol><li>å¦‚æœ<code>commitIndex > lastApplied</code>ï¼Œåˆ™ lastApplied é€’å¢ï¼Œå¹¶å°†<code>log[lastApplied]</code>åº”ç”¨åˆ°çŠ¶æ€æœºä¸­ï¼ˆ<strong>å¯¹åº”Lab3ä¸­çš„ä¸Šä¼ è‡³applyChé€šé“</strong>ï¼‰ã€‚</li><li>å¦‚æœæ¥æ”¶åˆ°çš„ RPC è¯·æ±‚æˆ–å“åº”ä¸­ï¼Œä»»æœŸå·<code>T > currentTerm</code>ï¼Œåˆ™ä»¤ <code>currentTerm = T</code>ï¼Œå¹¶åˆ‡æ¢ä¸ºè·Ÿéšè€…çŠ¶æ€ã€‚</li></ol><p>followerï¼š</p><ol><li>å“åº”æ¥è‡ªå€™é€‰äººå’Œé¢†å¯¼äººçš„è¯·æ±‚ã€‚</li><li>å¦‚æœé€‰ä¸¾æ—¶é—´è¶…æ—¶åï¼Œæ²¡æœ‰æ”¶åˆ°å½“å‰é¢†å¯¼äººçš„<code>AppendEntries RPC</code>ï¼Œæˆ–è€…æ²¡æœ‰ç»™æŸä¸ªå€™é€‰äººæŠ•è¿‡ç¥¨ï¼Œå°±è‡ªå·±å˜æˆå€™é€‰äººã€‚</li></ol><p>candidateï¼š</p><ol><li>åœ¨è½¬å˜æˆå€™é€‰äººåå°±ç«‹å³å¼€å§‹é€‰ä¸¾è¿‡ç¨‹ï¼šè‡ªå¢å½“å‰çš„ä»»æœŸå·<code>currentTerm</code>ï¼Œç»™è‡ªå·±æŠ•ç¥¨ï¼Œé‡ç½®é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨ï¼Œå‘é€è¯·æ±‚æŠ•ç¥¨çš„ RPC ç»™å…¶ä»–æ‰€æœ‰æœåŠ¡å™¨ã€‚</li><li>å¦‚æœæ¥æ”¶åˆ°è¶…è¿‡åŠæ•°Serverçš„é€‰ç¥¨ï¼Œé‚£ä¹ˆå°±å˜æˆLeaderã€‚</li><li>å¦‚æœæ¥æ”¶åˆ°æ¥è‡ªæ–°çš„Leaderçš„é™„åŠ æ—¥å¿—<code>AppendEntries RPC</code>ï¼Œåˆ™è½¬å˜æˆFollowerã€‚</li><li>å¦‚æœé€‰ä¸¾è¿‡ç¨‹è¶…æ—¶ï¼Œåˆ™å†æ¬¡å‘èµ·ä¸€è½®é€‰ä¸¾ã€‚</li></ol><p>leaderï¼š</p><ol><li>ä¸€æ—¦æˆä¸ºé¢†å¯¼äººï¼šå‘é€ç©ºçš„ <code>AppendEntries RPC</code> ç»™å…¶ä»–æ‰€æœ‰çš„Serverï¼›åœ¨ä¸€å®šçš„ç©ºä½™æ—¶é—´ä¹‹åä¸åœçš„é‡å¤å‘é€ï¼Œä»¥é˜²æ­¢ follower è¶…æ—¶ã€‚</li><li>å¦‚æœæ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼šé™„åŠ Entryåˆ°æœ¬åœ°æ—¥å¿—ä¸­ï¼Œåœ¨Entryè¢«åº”ç”¨åˆ°çŠ¶æ€æœºåå“åº”å®¢æˆ·ç«¯ã€‚</li><li>å¯¹äºFollowerï¼Œå¦‚æœ leader æœ€åä¸€é¡¹ log entry çš„ç´¢å¼•å€¼= <code>nextIndex</code>ï¼Œåˆ™å‘é€ä» nextIndex å¼€å§‹çš„æ‰€æœ‰ log entryï¼šå¦‚æœæˆåŠŸï¼Œæ›´æ–°ç›¸åº”è·Ÿéšè€…çš„ nextIndex å’Œ matchIndexï¼›å¦‚æœå› ä¸ºæ—¥å¿—ä¸ä¸€è‡´è€Œå¤±è´¥ï¼Œåˆ™ nextIndex é€’å‡å¹¶é‡è¯•ã€‚</li><li>å‡è®¾å­˜åœ¨ N æ»¡è¶³<code>N > commitIndex</code>ï¼Œä½¿å¾—å¤§å¤šæ•°çš„ <code>matchIndex[i] â‰¥ N</code>ä»¥åŠ<code>log[N].term == currentTerm</code> æˆç«‹ï¼Œåˆ™ä»¤ <code>commitIndex = N</code>ã€‚</li></ol><h4 id=åˆå§‹é€‰ä¸¾å‚æ•°>åˆå§‹é€‰ä¸¾å‚æ•°</h4><p>æŒ‰ç…§è®ºæ–‡ï¼Œå½“Followerå‡çº§ä¸ºCandidateä¹‹åï¼Œéœ€è¦åˆå§‹åŒ–<code>NextIndex</code>ä¸<code>MatchIndex</code>ã€‚</p><p><code>NextIndex</code>è¡¨ç¤ºè¦å‘é€çš„<strong>ä¸‹ä¸€ä¸ª</strong>æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆç´¢å¼•ç”±1å¼€å§‹ï¼‰ï¼›<code>MatchIndex</code>è¡¨ç¤ºè¢«<strong>å¤åˆ¶</strong>çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ã€‚åˆå§‹æ—¶ï¼Œ<code>NextIndex</code>çš„å€¼å‡ä¸ºã€Leaderæœ€é•¿æ—¥å¿—ç´¢å¼•+1ã€‘ï¼Œè€Œ<code>MatchIndex</code>å‡ä¸º0ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä¸º<code>LastLogIndex</code>ä¸<code>LastLogTerm</code>èµ‹å€¼ï¼Œ<strong>è¿™äº›å‚æ•°å°†ä½œä¸ºå…¶ä»–Server<strong><strong>æŠ•ç¥¨</strong></strong>çš„ä¾æ®</strong>ã€‚<code>LastLogIndex</code>è¡¨ç¤ºæœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•ï¼Œè€Œ<code>LastLogTerm</code>ä¸ºæœ€åä¸€æ¡æ—¥å¿—ç´¢å¼•çš„ä»»æœŸå€¼ã€‚å½“ä¸å­˜åœ¨æ—¥å¿—æ—¶ï¼Œ<code>LastLogIndex</code>å°†ä¸ºåˆå§‹å€¼0ï¼ŒåŒæ ·çš„ï¼Œ<code>LastLogTerm</code>ä¹Ÿå°†ä¸ºåˆå§‹å€¼0ã€‚</p><p>ç”±æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹raiseElection()æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>raiseElection</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateCandidate</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‡çº§ä¸ºCandidateä¹‹åï¼Œéœ€è¦æ›´æ–°MatchIndexã€NextIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>//åˆå§‹æ—¶ï¼ŒnextIndexä¸ºæœ€åæ—¥å¿—ç´¢å¼• + 1ï¼Œå¦‚æœç´¢å¼•ç”±1å¼€å§‹ï¼Œé‚£ä¹ˆlogæ•°ç»„çš„é•¿åº¦å³æœ€åæ—¥å¿—ç´¢å¼•</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//åˆå§‹æ—¶ï¼ŒmatchIndexå‡ä¸º0</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å½“å‰ä»»æœŸå·ï¼š%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å‘èµ·é€‰ä¸¾&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ„å»ºrpcè¯·æ±‚ä¸å“åº”</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastLogIndex</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastLogIndex</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>lastLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogTerm</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RequestVoteArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>CandidateId</span>:  <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastLogIndex</span>: <span style=color:#a6e22e>lastLogIndex</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastLogTerm</span>:  <span style=color:#a6e22e>lastLogTerm</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¹¶è¡Œå‘é€æŠ•ç¥¨ä¿¡æ¯</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>broadcastElection</span>(<span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//é‡ç½®é€‰ä¸¾æ—¶é—´</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=è¡¥å……broadcastentriesæ–¹æ³•>è¡¥å……broadcastEntriesæ–¹æ³•</h4><p>åœ¨Lab3Aä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†broadcastEntriesæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å‘å„Followerå‘é€å¿ƒè·³ä¿¡æ¯ï¼Œåº•å±‚ä½¿ç”¨AppendEntriesæ¥å£ï¼Œä½†è¯¥æ¥å£ä¸ä»…æ¥å—å¿ƒè·³ä¿¡æ¯ï¼ŒåŒæ ·è´Ÿè´£æ—¥å¿—åŒæ­¥é—®é¢˜ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è¡¥å……<code>broadcastEntries</code>æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastEntries</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å¼€å§‹å¹¿æ’­AppendEntries&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>entries</span>      []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>]<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å‰©ä½™logæœªæäº¤ï¼Œåˆ™é™„åŠ Entries</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>entries</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;For S%d, Append Entiries: %d, nextIdx:%d&#34;</span>, <span style=color:#a6e22e>i</span>, len(<span style=color:#a6e22e>entries</span>), <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogIndex</span>: <span style=color:#a6e22e>prevLogIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogTerm</span>:  <span style=color:#a6e22e>prevLogTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderCommit</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Entries</span>:      <span style=color:#a6e22e>entries</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>args</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetHeartBeatTime</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>PrevLogIndex</code>è¡¨ç¤ºå‰ä¸€ä¸ªæ—¥å¿—ç´¢å¼•ï¼Œç”±<code>NextIndex</code>å†³å®šï¼Œå½“<code>NextIndex</code>ä¸ºåˆå§‹æƒ…å†µ0æ—¶ï¼ŒPrevLogIndexåŒæ ·ä¸º0ã€‚prevLogTermè¡¨ç¤ºå‰ä¸€ä¸ªæ—¥å¿—çš„ä»»æœŸå€¼ï¼Œå½“PrevLogIndexä¸º0æ—¶ï¼Œè¯¥ä»»æœŸå€¼ä¸º0ã€‚</p><p>å¦‚æœLeaderçš„æœ€å¤§Logç´¢å¼•å¤§äºç­‰äºå½“å‰Peerçš„NextIndexï¼Œåˆ™éœ€è¦å°†NextIndexä»¥åŠä¹‹åç´¢å¼•çš„æ—¥å¿—å‡å‘é€ç»™Peerï¼Œè®©Peerå¿«é€Ÿå¤åˆ¶æ—¥å¿—ã€‚</p><p>æœ‰äº›Raftå®ç°ä¼šé€ä¸ªå°†æ—¥å¿—å‘é€ç»™Peerï¼Œæœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯ä¼šå¢åŠ RPCè¿æ¥çš„æ•°é‡ï¼Œä¸è¿‡éœ€è¦æ³¨æ„<code>TestCount3B</code>æµ‹è¯•è¦æ±‚RPCæ•°é‡ä¸èƒ½è¶…è¿‡<code>ï¼ˆServeræ•°+4ï¼‰*3</code>ï¼Œå› æ­¤é€ä¸ªå‘é€æ—¥å¿—å°†æœ‰å¾ˆå¤§æ¦‚ç‡è‡´ä½¿RPCæ•°é‡è¶…è¿‡é˜ˆå€¼ã€‚</p><h4 id=è¡¥å……sendentry2server>è¡¥å……sendEntry2Server</h4><p>åœ¨<code>sendEntryToServer</code>å‡½æ•°æœ‰ä¸€ç‚¹éå¸¸é‡è¦ï¼Œå³ç¡®å®šCommitIndexã€‚è®ºæ–‡ä¸­æŒ‡å‡º</p><blockquote><p>If there exists an N such that N > commitIndex, a majority of matchIndex[i] â‰¥ N, and log[N].term == currentTerm: set commitIndex = N (Â§5.3, Â§5.4).</p><p>ç¿»è¯‘ï¼šå¦‚æœå­˜åœ¨ä¸€ä¸ªNï¼Œä½¿å¾—N>commitIndexï¼Œåˆ™å¤§å¤šæ•°matchIndex[i]â‰¥Nï¼Œå¹¶ä¸”log[N].term==currentTermï¼šè®¾ç½®commitIndex=Nï¼ˆÂ§5.3ï¼ŒÂ§5.4ï¼‰ã€‚</p></blockquote><p>è¿™æ„å‘³ç€Leaderæ¯æ¬¡æ”¶åˆ°Followerçš„<code>AppendEntriesReply</code>ï¼Œåº”è¯¥è¿›è¡Œéå†ï¼Œæ‰¾å‡ºæŸä¸ªå€¼Nï¼Œä½¿å¾—æŸä¸ª<code>matchIndex</code>å€¼ä¸ºNçš„Serveræ•°é‡å¤§äºåŠæ•°ã€‚</p><p>å†æ¬¡å¼ºè°ƒå®ç°Raftæ—¶åº”è¯¥æ³¨æ„å¹¶å‘é—®é¢˜ï¼Œå¦‚æœç®€å•ç²—æš´åœ°è®¤ä¸º<code>reply.Success</code>ä¸ºtrueå³å¾—åˆ°ä¸€ä¸ªServerç¡®è®¤ï¼Œåˆ™ä¸ºä¼šé€ æˆé€»è¾‘é”™è¯¯ã€‚</p><p><code>extIndex</code>ä¸<code>matchIndex</code>çš„æ›´æ–°å­˜åœ¨æ—§å€¼é—®é¢˜ï¼Œä¸ºäº†ä¿è¯<strong>å¹‚ç­‰æ€§</strong>ï¼Œå› æ­¤ä»£ç åº”è¯¥å¦‚æ­¤ç¼–å†™ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>//æ›´æ–°peerçš„nextIdxå’ŒmatchIdx</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>)
</span></span><span style=display:flex><span><span style=color:#75715e>//è®¡ç®—å½“å‰commitIdxï¼Œä¿è¯å¹‚ç­‰æ€§</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span></code></pre></div><p>å¦‚æœ<code>reply.Success</code>ä¸ºfalseï¼Œä¹Ÿåº”è¯¥å…ˆåˆ¤æ–­Followerä»»æœŸä¸Leaderä»»æœŸæ˜¯å¦ä¸€è‡´ï¼Œä»¥åŠæ˜¯å¦ä»ç„¶ä¸ºLeaderï¼Œä¸ºä»€ä¹ˆï¼Ÿè€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼š</p><ol><li>å¦‚æœS1åœ¨T1é˜¶æ®µå‘é€äº†ä¸€ä¸ªAppendEntriesç»™S2ï¼Œä½†è¯¥AppendEntriesæ¶ˆæ¯åœ¨ç½‘ç»œä¸­è¿·å¤±ï¼›</li><li>ä¹‹åS3æˆä¸ºäº†Leaderå¹¶å˜æ›´ä»»æœŸä¸ºT2ï¼Œè€ŒS1å’ŒS2å‡æˆä¸ºFollowerï¼Œä»»æœŸä¹Ÿå˜æ›´ä¸ºT2ï¼›</li><li>æ­¤æ—¶ï¼ŒS1åœ¨T1æ—¶åˆ»çš„è¿·å¤±æ¶ˆæ¯ä¼ é€’è‡³S2ï¼ŒS2æ£€æŸ¥æ¶ˆæ¯çš„ä»»æœŸä¸ºT1åæ‹’ç»è¯¥æ¶ˆæ¯ï¼›</li><li>S1æ”¶åˆ°æ‹’ç»ä¿¡æ¯åï¼Œé€»è¾‘ä¸­å°†é™ä½NextIndexï¼Œç„¶åå†æ¬¡å‘é€ç»™S2ï¼Œæ­¤æ—¶æ¶ˆæ¯æ˜¯T2ã€‚</li></ol><p>æ˜¾ç„¶ï¼ŒS1ä¸åº”è¯¥å†å¤„ç†è¯¥æ¶ˆæ¯äº†ã€‚ç»¼åˆä»¥ä¸Šï¼ŒsendEntry2Serverå®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Term:%d &gt; CurrentTerm%d,é™çº§ä¸ºFollower&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;éLeaderï¼Œæ‹’ç»å“åº” S%d:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å“åº”çš„ä»»æœŸå·%dæ›´å°ï¼Œæ‹’ç»æ¥å—&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dæˆåŠŸAppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//æ›´æ–°peerçš„nextIdxå’ŒmatchIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//è®¡ç®—å½“å‰commitIdxï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dçš„NextIdxä¿®æ”¹ä¸º%dï¼ŒMatchIdxä¿®æ”¹ä¸º%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#75715e>//å¯»æ‰¾commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;LastLogIndex=%d,commitIndex=%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(), <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(); <span style=color:#a6e22e>n</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>n</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>; <span style=color:#a6e22e>n</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cnt</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>peer</span>, <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> {
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>peer</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#75715e>// å¦‚æœåŒ¹é…çš„ç´¢å¼•å¤§äºn</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>cnt</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cnt</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>halfPeerNum</span>() {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// næ˜¯æ•°ç»„ä¸‹æ ‡ï¼Œn+1ä¸ºç´¢å¼•</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;è·å–åŠæ•°PeeråŒæ„ï¼Œæ›´æ–°CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dæ‹’ç»AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å‡å°‘nextIdxï¼Œç„¶åé‡è¯•</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]<span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>entries</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>nextIdx</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å‡å°‘S%d nextIdï¼ŒnextId:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newArg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogIndex</span>: <span style=color:#a6e22e>prevLogIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogTerm</span>:  <span style=color:#a6e22e>prevLogTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Entries</span>:      <span style=color:#a6e22e>entries</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderCommit</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>newArg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»¥ä¸Šä»£ç ä¸­çš„<code>halfPeerNum</code>å®ç°å¦‚ä¸‹ï¼Œé¡¾åæ€ä¹‰ï¼Œè®¡ç®—Serveræ•°é‡çš„åŠæ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>halfPeerNum</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=è¡¥å……rpcå‡½æ•°>è¡¥å……RPCå‡½æ•°</h4><h5 id=requestvote-1>RequestVote</h5><p>RequestVoteå‡½æ•°éœ€è¦åˆ¤æ–­Logï¼Œä»¥å†³å®šæ˜¯å¦æŠ•ç¥¨ç»™è¯¥å€™é€‰è€…ã€‚æ¥å—æŠ•ç¥¨çš„æ¡ä»¶ä¸ºï¼š</p><ol><li>å½“å‰Serverçš„Logä¸ºåˆå§‹æƒ…å†µã€‚</li><li>å€™é€‰è€…çš„æ—¥å¿—ä»»æœŸå¿…é¡»â€œé¢†å…ˆâ€å½“å‰Serverã€‚</li></ol><p>é‚£ä»€ä¹ˆæ˜¯æ›´é¢†å…ˆï¼ŸRafté€šè¿‡æ¯”è¾ƒä¸¤ä»½æ—¥å¿—ä¸­<strong>æœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•å€¼</strong>å’Œ<strong>ä»»æœŸå·</strong>å®šä¹‰è°çš„æ—¥å¿—æ¯”è¾ƒé¢†å…ˆã€‚</p><ul><li>å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åæ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œé‚£ä¹ˆä»»æœŸå·å¤§çš„æ—¥å¿—æ›´é¢†å…ˆã€‚</li><li>å¦‚æœä¸¤ä»½æ—¥å¿—æœ€åçš„æ¡ç›®ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆæ—¥å¿—æ¯”è¾ƒé•¿ï¼ˆç´¢å¼•å€¼æ›´å¤§ï¼‰çš„é‚£ä¸ªå°±æ›´é¢†å…ˆã€‚</li></ul><p>ä½†è¦æ³¨æ„ï¼Œé€‰ä¸¾æœŸé—´å¦‚æœä¸¤ä¸ªå€™é€‰è€…S1ã€S2æ‹¥æœ‰ç›¸åŒçš„ä»»æœŸï¼Œä½†S2æ‹¥æœ‰æ›´é¢†å…ˆçš„æ—¥å¿—ï¼Œè€ŒS1æ”¶åˆ°S2çš„æŠ•ç¥¨è¯·æ±‚ä¹‹åï¼Œä»ç„¶ä¼šæŠ•æ‹’ç»ç¥¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™æ˜¯å› ä¸ºS1å·²ç»å°†ç¥¨æ•°æŠ•ç»™äº†è‡ªå·±ï¼Œå› æ­¤å¹¶ä¸ä¼šæ£€æŸ¥æ—¥å¿—æƒ…å†µè€Œç›´æ¥æ‹’ç»é€‰ä¸¾S2ã€‚</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=ODQzNTRmOGE5NzFmMzQzM2U0NTA0YTE2MjBlNmRlZjJfdHB5OWQ2VUhZek9vVjNEbW5QZUszWXdZdUJsT2R3VHJfVG9rZW46TFBEaWJxR0N6b3YwMVd4THBOQ2NORVpCblJlXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// example RequestVote RPC handler.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>RequestVote</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RequestVoteReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3A, 3B).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°å€™é€‰äººS%dé€‰ä¸¾è¯·æ±‚&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ‹’ç»å€™é€‰è€…S%dï¼Œä»»æœŸå°äºè‡ªèº«&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>//å¦‚æœServerå­˜åœ¨æ—¥å¿—å¹¶ä¸”æœ€åçš„æ—¥å¿—ä»»æœŸå¤§äºå€™é€‰è€…ï¼Œåˆ™æ‹’ç»ã€‚</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//å¦‚æœServerå¹¶ä¸æ˜¯æœ€åæ—¥å¿—ä»»æœŸä¸å€™é€‰è€…ç›¸ç­‰ä¸”æ—¥å¿—ç´¢å¼•å°äºç­‰äºå€™é€‰è€…ï¼Œåˆ™æ‹’ç»</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogTerm</span>() <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastLogTerm</span> <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>          !(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogTerm</span>() <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastLogTerm</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastLogIndex</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å€™é€‰è€…S%dæ—¥å¿—æ›´æ—§ï¼Œæ‹’ç»é€‰ä¸¾&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;é€‰ä¸¾å€™é€‰äºº S%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// é‡ç½®é€‰ä¸¾æ—¶é—´</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dVote</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å·²é€‰æ‹©S%d æ‹’ç»å€™é€‰äººS%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>CandidateId</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTVjZjg4ZjliZjNmODNiZGM5M2I2ZjEwZmE1MDNiZTRfaWNLOHFWd3hOOEdHRHlaT2NwTWlRWEF6bFUyS0t5d3VfVG9rZW46U2dkc2JHWldzb0RDUk94YUZKMWNIMVgwbmJkXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>ä½†åœ¨å®è·µä¸­æˆ‘å‘ç°ä¸Šå›¾æ‰€ç¤ºæƒ…å†µä¸‹ï¼Œè‹¥Leaderåç»­æ²¡æœ‰æ”¶åˆ°æ–°çš„æ—¥å¿—ï¼Œåˆ™S1å’ŒS2å§‹ç»ˆæ— æ³•æäº¤ä»»æœŸä¸º2çš„æ¶ˆæ¯ã€‚åœ¨Lab3Bä¸­ï¼Œç±»ä¼¼çš„æƒ…å†µä¼šå¯¼è‡´çš„æµ‹è¯•<code>TestBasicAgree3B</code>å¤±è´¥ã€‚å€ŸåŠ©ä¸Šå›¾5ä¸ªServerçš„æƒ…å†µï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆ<code>TestBasicAgree3B</code>ä¼šå¤±è´¥ã€‚</p><p><code>TestBasicAgree3B</code>ä½¿ç”¨3ä¸ªServerè¿›è¡Œæµ‹è¯•ã€‚</p><ol><li>å‡è®¾å­˜åœ¨3ä¸ªServerï¼Œåˆ†åˆ«æ˜¯S1ã€S2å’ŒS3ï¼ŒS1åœ¨å½“é€‰Leaderæ—¶ä¸ºT1ã€‚</li><li>æŸæ—¶åˆ»ï¼ŒS1æ”¶åˆ°æ—¥å¿—å¹¶å°†å…¶å‘é€ç»™S2å’ŒS3ã€‚S2å’ŒS3æ”¶åˆ°æ—¥å¿—L1å¹¶å“åº”ï¼ŒS1æ”¶åˆ°è¶…è¿‡åŠæ•°çš„å“åº”ï¼ŒS1å°†CommitIdx+1ï¼Œå¹¶å‘é€å¿ƒè·³ç»™S2å’ŒS3ï¼Œä½†å¿ƒè·³æ¶ˆæ¯ä¸¢å¤±ã€‚</li><li>æ­¤æ—¶S2è§¦å‘é€‰ä¸¾ï¼Œä»»æœŸå˜ä¸ºT2ï¼Œå¹¶ä»¥å€™é€‰äººèº«ä»½å‘é€æŠ•ç¥¨æ¶ˆæ¯ç»™S1å’ŒS3ï¼ŒS1å’ŒS3æŠ•ç¥¨å¹¶ä½œä¸ºè¿½éšè€…ã€‚</li><li>è¿™ä¸ªæ—¶å€™åªæœ‰S1æäº¤äº†æ—¥å¿—L1ï¼Œè€ŒS2å’ŒS3å‡æœªæäº¤L1ï¼Œå¹¶ä¸”åœ¨æœªæ”¶åˆ°æ–°çš„Logä¹‹å‰ï¼ŒS2ä¸ä¼šæ›´æ”¹Commitï¼Œè‡³æ­¤æ°¸è¿œåªæœ‰ä¸€ä¸ªLogæäº¤ï¼Œå¯¼è‡´æµ‹è¯•å¤±è´¥ã€‚</li></ol><p>ä¸ä¹‹ç±»ä¼¼çš„æƒ…å†µæ˜¯S1å°†L1æäº¤ä¹‹åå°±å®•æœºäº†ï¼ŒS2å’ŒS3æ²¡æœ‰æ”¶åˆ°S1å‘é€æ¥çš„CommitIndexã€‚è€ŒS2å‘èµ·ç«é€‰ï¼Œæ­¤æ—¶S1æˆåŠŸæ¢å¤å¹¶æŠ•ç¥¨ï¼ŒS3åŒæ ·æŠ•ç¥¨ï¼ŒS2å½“é€‰ä¸ºLeaderï¼Œæ¥ä¸‹æ¥çš„æƒ…å†µä¸ä¸Šè¿°æƒ…å†µä¸€è‡´ï¼ŒåŒæ ·å¯¼è‡´æµ‹è¯•å¤±è´¥ã€‚</p><p>æ ¹æ®Raftè®ºæ–‡ï¼ŒLeaderä¸ä¼šç›´æ¥æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ï¼Œè¿™æ˜¯ä¸ºäº†ç¡®ä¿å®‰å…¨æ€§ï¼Œé˜²æ­¢å·²ç»è¢«è¦†ç›–çš„æ—¥å¿—è¢«é”™è¯¯åœ°æäº¤ã€‚</p><p>ä»¥ä¸Šæƒ…å†µæ— æ³•é€šè¿‡æµ‹è¯•ï¼Œä½†å¹¶ä¸æ„å‘³ç€L1æ°¸è¿œä¸ä¼šè¢«æäº¤ï¼Œè™½ç„¶S2ä¸ä¼šç›´æ¥æäº¤T1çš„æ—¥å¿—ï¼Œä½†å®ƒå¯ä»¥é€šè¿‡æäº¤è‡ªå·±ä»»æœŸï¼ˆT2ï¼‰çš„æ—¥å¿—æ¥é—´æ¥æäº¤ä¹‹å‰çš„æ—¥å¿—ï¼ŒS2åªè¦æ”¶åˆ°äº†æ–°çš„æ—¥å¿—åä¾¿æœ‰å¾ˆå¤§æ¦‚ç‡ä½¿L1æäº¤ã€‚</p><p>æœ‰ä¸€ç§å¸¸è§çš„æŠ€å·§å¯ä»¥è§£å†³è¿™ç§é—®é¢˜ï¼Œè¯¥æŠ€å·§æ˜¯â€œç©ºæ—¥å¿—æ¡ç›®â€ã€‚å¦‚æœæ²¡æœ‰æ–°çš„å‘½ä»¤ï¼ŒS2å¯ä»¥å‘é€ä¸€ä¸ªç©ºçš„æ—¥å¿—æ¡ç›®ï¼ˆç§°ä¸ºno-opæ¡ç›®ï¼‰ã€‚no-opåœ¨åŸå§‹çš„Raftè®ºæ–‡ä¸­å¹¶æ²¡æœ‰ç›´æ¥è¯¦ç»†è®¨è®ºï¼Œä½†Diego Ongaroï¼ˆRaftçš„ä½œè€…ï¼‰åœ¨ä»–çš„åšå£«è®ºæ–‡ä¸­æ›´è¯¦ç»†åœ°è®¨è®ºäº†è¿™ä¸ªæ¦‚å¿µï¼Œå®ƒæ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•ã€‚</p><p>Diego Ongaro åœ¨ä»–çš„åšå£«è®ºæ–‡ &ldquo;Consensus: Bridging Theory and Practice&rdquo; ä¸­ç¡®å®æ›´è¯¦ç»†åœ°è®¨è®ºäº†no-opï¼ŒåŸæ–‡å¦‚ä¸‹ï¼š</p><blockquote><p>&ldquo;One simple approach is for every leader to commit a blank no-op entry into the log at the start of its term. As soon as this no-op entry is committed, all prior entries in the leader&rsquo;s log are committed indirectly. This approach has the simplest reasoning, but it adds an extra round trip to all leader changes before a new leader can propose new client requests.&rdquo;</p><p>&ldquo;ä¸€ä¸ªç®€å•çš„æ–¹æ³•æ˜¯è®©æ¯ä¸ªé¢†å¯¼è€…åœ¨å…¶ä»»æœŸå¼€å§‹æ—¶æäº¤ä¸€ä¸ªç©ºç™½çš„æ— æ“ä½œï¼ˆno-opï¼‰æ¡ç›®åˆ°æ—¥å¿—ä¸­ã€‚ä¸€æ—¦è¿™ä¸ªæ— æ“ä½œæ¡ç›®è¢«æäº¤ï¼Œé¢†å¯¼è€…æ—¥å¿—ä¸­çš„æ‰€æœ‰å…ˆå‰æ¡ç›®å°±ä¼šè¢«é—´æ¥æäº¤ã€‚è¿™ç§æ–¹æ³•çš„æ¨ç†æœ€ä¸ºç®€å•ï¼Œä½†å®ƒåœ¨æ–°é¢†å¯¼è€…å¯ä»¥æå‡ºæ–°çš„å®¢æˆ·ç«¯è¯·æ±‚ä¹‹å‰ï¼Œä¸ºæ‰€æœ‰é¢†å¯¼è€…å˜æ›´å¢åŠ äº†ä¸€ä¸ªé¢å¤–çš„å¾€è¿”è¿‡ç¨‹ã€‚&rdquo;</p></blockquote><p>Ongaro è¿›ä¸€æ­¥è§£é‡Šï¼š</p><blockquote><p>&ldquo;Another way to accomplish this is for the leader to treat the election as an implicit no-op entry, which is committed once the leader learns that a majority of the cluster has voted for it. This approach allows the leader to propose client requests without delay.&rdquo;</p><p>&ldquo;å®ç°è¿™ä¸€ç›®æ ‡çš„å¦ä¸€ç§æ–¹å¼æ˜¯è®©é¢†å¯¼è€…å°†é€‰ä¸¾è§†ä¸ºä¸€ä¸ªéšå¼çš„æ— æ“ä½œæ¡ç›®ï¼Œä¸€æ—¦é¢†å¯¼è€…å¾—çŸ¥é›†ç¾¤ä¸­çš„å¤šæ•°å·²ç»æŠ•ç¥¨æ”¯æŒå®ƒï¼Œè¿™ä¸ªæ¡ç›®å°±è¢«è§†ä¸ºå·²æäº¤ã€‚è¿™ç§æ–¹æ³•å…è®¸é¢†å¯¼è€…æ— å»¶è¿Ÿåœ°æå‡ºå®¢æˆ·ç«¯è¯·æ±‚ã€‚&rdquo;</p></blockquote><p>ä»ä¸Šé¢å¯ä»¥å¾—çŸ¥ï¼ŒOngaroæå‡ºäº†ä¸¤ç§å®ç°æ–¹æ³•ï¼š</p><ol><li>æ˜¾å¼æ·»åŠ ä¸€ä¸ªno-opæ¡ç›®</li><li>å°†é€‰ä¸¾æœ¬èº«è§†ä¸ºä¸€ä¸ªéšå¼çš„no-opæ¡ç›®</li></ol><p>è¿™ä¸¤ç§æ–¹æ³•éƒ½èƒ½è§£å†³æ–°é¢†å¯¼è€…éœ€è¦æäº¤å…ˆå‰ä»»æœŸæ—¥å¿—çš„é—®é¢˜ï¼Œä½†ç¬¬äºŒç§æ–¹æ³•å¯èƒ½åœ¨æ•ˆç‡ä¸Šç•¥èƒœä¸€ç­¹ï¼Œå› ä¸ºå®ƒé¿å…äº†é¢å¤–çš„å¾€è¿”é€šä¿¡ã€‚æœ¬æ¬¡å®éªŒæˆ‘ä»¬ä¸å®ç°no-opæ¡ç›®ã€‚</p><h5 id=appendentries-1>AppendEntries</h5><p><code>AppendEntries</code>éœ€è¦å¢åŠ åŒæ­¥æ—¥å¿—çš„é€»è¾‘ï¼Œå…·ä½“å«ä¹‰åœ¨æ³¨é‡Šä¸­è¯´æ˜ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ° S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœæ”¶åˆ°çš„ä»»æœŸå°äºè‡ªèº«ï¼Œåˆ™æ‹’ç»Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„ä»»æœŸå·Term%då°äºè‡ªèº«ä»»æœŸå·Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å½“å‰ä»»æœŸå·ï¼š%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ç”±å€™é€‰è€…é™çº§ä¸ºè¿½éšè€…&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ”¶åˆ°çš„ä»»æœŸå¤§äºè‡ªèº«ï¼Œåˆ™è¿½éšè¯¥Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœæ˜¯Leaderæˆ–å€™é€‰äººï¼Œåˆ™é™çº§ä¸ºFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„æ–°çš„ä»»æœŸå·Term%dï¼Œé™çº§ä¸ºFollower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥Leaderçš„æ—¥å¿—æ˜¯å¦ä¸è¿½éšè€…ç›¸åŒ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ—¥å¿—Indexä¸ä¸€è‡´ï¼Œæ”¶åˆ°PrevLogIndex:%d,rf.LastLogIndex=%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœæ—¥å¿—åœ¨PrevLogIndexä¸­ä¸åŒ…å«Termä¸PrevLogTermåŒ¹é…çš„Entryï¼Œåˆ™å›å¤false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ—¥å¿—Termä¸ä¸€è‡´ï¼Œæ”¶åˆ°çš„PrevLogTerm: %d,MyPrevLogTerm: %d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ç¬¬ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶é˜²æ­¢å¹¶å‘è¿‡ç¨‹ä¸­æœ‰æ—§çš„æ•°æ®è¢«é‡æ–°æ”¶åˆ°</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ç¬¬äºŒä¸ªåˆ¤æ–­æ¡ä»¶æ˜¯æˆªæ–­æœªæäº¤çš„è¿‡æœŸæ•°æ®</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>), <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>[<span style=color:#a6e22e>i</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Exist Entries: %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. å¦‚æœleaderCommit &gt; commitIndexï¼Œåˆ™commitIndexè®¾ç½®ä¸ºmin(leaderCommit,æœ€æ–°Entryçš„ç´¢å¼•)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°Leader CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ä¸èƒ½è¶…è¿‡Leaderçš„Commitã€‚å¦‚æœServerçš„Logæ¯”è¾ƒæ»åï¼Œargs.PrevLogIndex+len(args.Entries)èƒ½å¿«é€Ÿæ›´æ–°commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = min(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span>len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ›´æ–°CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è¿è¡Œç»“æœ-1>è¿è¡Œç»“æœ</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: basic agreement ...
</span></span><span style=display:flex><span>  ... Passed --   1.5  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>16</span>    <span style=color:#ae81ff>4140</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: RPC byte count ...
</span></span><span style=display:flex><span>  ... Passed --   3.2  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>48</span>  <span style=color:#ae81ff>113016</span>   <span style=color:#ae81ff>11</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: test progressive failure of followers ...
</span></span><span style=display:flex><span>  ... Passed --   5.5  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>64</span>   <span style=color:#ae81ff>13567</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: test failure of leaders ...
</span></span><span style=display:flex><span>  ... Passed --   5.9  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>98</span>   <span style=color:#ae81ff>21401</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: agreement after follower reconnects ...
</span></span><span style=display:flex><span>  ... Passed --   6.7  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>77</span>   <span style=color:#ae81ff>19701</span>    <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: no agreement <span style=color:#66d9ef>if</span> too many followers disconnect ...
</span></span><span style=display:flex><span>  ... Passed --   4.0  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>112</span>   <span style=color:#ae81ff>24030</span>    <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: concurrent Start<span style=color:#f92672>()</span>s ...
</span></span><span style=display:flex><span>  ... Passed --   1.3  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>22</span>    <span style=color:#ae81ff>5971</span>    <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: rejoin of partitioned leader ...
</span></span><span style=display:flex><span>  ... Passed --   7.4  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>101</span>   <span style=color:#ae81ff>24185</span>    <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: leader backs up quickly over incorrect follower logs ...
</span></span><span style=display:flex><span>  ... Passed --  32.4  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>2115</span> <span style=color:#ae81ff>1569372</span>  <span style=color:#ae81ff>103</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3B<span style=color:#f92672>)</span>: RPC counts aren<span style=color:#960050;background-color:#1e0010>&#39;</span>t too high ...
</span></span><span style=display:flex><span>  ... Passed --   2.8  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>44</span>   <span style=color:#ae81ff>13840</span>   <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     70.757s
</span></span></code></pre></div><h2 id=lab-3c---æŒä¹…åŒ–>Lab-3C - æŒä¹…åŒ–</h2><h3 id=ä»»åŠ¡è¦æ±‚-2>ä»»åŠ¡è¦æ±‚</h3><p>é€šè¿‡æ·»åŠ ä»£ç ä¿å­˜å’Œæ¢å¤æŒä¹…çŠ¶æ€ï¼Œå®Œæˆ raft.go ä¸­çš„ persist() å’Œ readPersist() åŠŸèƒ½ã€‚æ‚¨éœ€è¦å°†çŠ¶æ€åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œä»¥ä¾¿å°†å…¶ä¼ é€’ç»™ Persister ã€‚ä½¿ç”¨ labgob ç¼–ç å™¨ï¼›</p><p>è¯·å‚è§ persist() å’Œ readPersist() ä¸­çš„æ³¨é‡Šã€‚ labgob ç±»ä¼¼äº Go çš„ gob ç¼–ç å™¨ï¼Œä½†å¦‚æœå°è¯•å¯¹å…·æœ‰å°å†™å­—æ®µåç§°çš„ç»“æ„è¿›è¡Œç¼–ç ï¼Œåˆ™ä¼šæ‰“å°é”™è¯¯æ¶ˆæ¯ã€‚</p><p>åœ¨<strong>è¿›è¡Œ3Då®éªŒä¹‹å‰</strong>ï¼Œåº”è¯¥å°† nil ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™ persister.Save() ã€‚åœ¨æ‚¨çš„å®ç°æ›´æ”¹æŒä¹…çŠ¶æ€çš„ç‚¹æ’å…¥ persist() è°ƒç”¨ã€‚å®Œæˆæ­¤æ“ä½œåï¼Œå¦‚æœæ‚¨çš„å…¶ä½™å®ç°æ­£ç¡®ï¼Œåˆ™åº”é€šè¿‡æ‰€æœ‰ 3C æµ‹è¯•ã€‚</p><p>æ‚¨å¯èƒ½éœ€è¦ä¼˜åŒ–ä¸€æ¬¡å¤‡ä»½å¤šä¸ªItemçš„nextIndexã€‚çœ‹çœ‹ä»ç¬¬7é¡µåº•éƒ¨å’Œç¬¬8é¡µé¡¶éƒ¨å¼€å§‹çš„æ‰©å±•<a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank>Raftè®ºæ–‡ï¼ˆç”¨ç°è‰²çº¿æ ‡è®°ï¼‰</a>
ã€‚</p><p>è¿™ç¯‡è®ºæ–‡å¯¹ç»†èŠ‚å«ç³Šå…¶è¾ï¼›ä½ éœ€è¦å¡«è¡¥ç©ºç™½ã€‚ä¸€ç§å¯èƒ½æ˜¯ï¼Œæ‹’ç»æ¶ˆæ¯åŒ…æ‹¬ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>XTerm:  term in the conflicting entry (if any)
</span></span><span style=display:flex><span>XIndex: index of first entry with that term (if any)
</span></span><span style=display:flex><span>XLen:   log length
</span></span></code></pre></div><p>é‚£ä¹ˆï¼ŒLeaderçš„é€»è¾‘å¯ä»¥æ˜¯è¿™æ ·çš„ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Plain data-lang=Plain><span style=display:flex><span>Case 1: leader doesn&#39;t have XTerm:
</span></span><span style=display:flex><span>    nextIndex = XIndex
</span></span><span style=display:flex><span>Case 2: leader has XTerm:
</span></span><span style=display:flex><span>    nextIndex = leader&#39;s last entry for XTerm
</span></span><span style=display:flex><span>Case 3: follower&#39;s log is too short:
</span></span><span style=display:flex><span>    nextIndex = XLen
</span></span></code></pre></div><h3 id=å®éªŒå‡†å¤‡-1>å®éªŒå‡†å¤‡</h3><p>å®é™…ä¸Šï¼ŒLab3Cå¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯å®ç°æŒä¹…åŒ–ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ä¼˜åŒ–nextIndexã€‚</p><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=Y2E1YTcwNjMxZjQ1YmRiMDdjNjMyNGQxMDYxNWRhODBfQmE3UnNER09uMUF5RkgxeHdzeW45ZEFGSENwTmdvSGJfVG9rZW46VzFwTWJubjhvb1RvREV4Sk9GcGNiaWYybndmXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><p>æ ¹æ®è®ºæ–‡å›¾2ï¼Œæ‰€æœ‰Peeråº”è¯¥æŒä¹…åŒ–currentTermï¼ŒvotedForï¼Œlog[]ã€‚å› æ­¤ï¼Œè¿™äº›å‚æ•°å‘ç”Ÿå˜åŒ–çš„åœ°æ–¹éƒ½éœ€è¦<strong>æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–æ“ä½œ</strong>ã€‚</p><p>Lab3Cæ˜¯æ•´ä¸ªLab3ä¸­éš¾åº¦æœ€ä½çš„å®éªŒï¼Œä»£ç éª¨æ¶ä¸­å·²ç»å¸®æˆ‘ä»¬è°ƒç”¨äº†è¯»å–æŒä¹…åŒ–çš„ä»£ç ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°<code>Persist</code>æ–¹æ³•å’Œ<code>readPersist</code>æ–¹æ³•å³å¯ã€‚</p><h3 id=æŒä¹…åŒ–å®ç°>æŒä¹…åŒ–å®ç°</h3><h4 id=persistæ–¹æ³•>persistæ–¹æ³•</h4><p>ä»»åŠ¡è¦æ±‚ä¸­å·²ç»æŒ‡å‡ºæˆ‘ä»¬åº”è¯¥ä½¿ç”¨labgobç¼–ç å™¨ï¼Œä¸”persistæ–¹æ³•å·²ç»ç»™å‡ºäº†ç¤ºä¾‹ä»£ç ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>persist</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>e</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;åºåˆ—åŒ– rf.currentTerm å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// votedFor</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;åºåˆ—åŒ– rf.votedFor å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// log[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;åºåˆ—åŒ– rf.log å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>raftState</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Bytes</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>Save</span>(<span style=color:#a6e22e>raftState</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dPersist</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æŒä¹…åŒ–æ‰§è¡ŒæˆåŠŸ&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=readpersistæ–¹æ³•>readPersistæ–¹æ³•</h4><p>åŒç†ï¼ŒreadPersistä¹Ÿç»™å‡ºäº†ç¤ºä¾‹ä»£ç ï¼ŒæŒ‰ç…§ç¤ºä¾‹ä»£ç èƒ½å¿«é€Ÿå®ç°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>data</span>) &lt; <span style=color:#ae81ff>1</span> { <span style=color:#75715e>// bootstrap without any state?</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>d</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>labgob</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ååºåˆ—åŒ– rf.currentTerm å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ååºåˆ—åŒ– rf.votedFor å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ååºåˆ—åŒ– rf.log å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å®ç°ä»¥ä¸Šå‡½æ•°åï¼Œåªéœ€è¦åœ¨currentTermï¼ŒvotedForï¼Œlog[]å‚æ•°å‘ç”Ÿå˜åŒ–çš„åœ°æ–¹éƒ½éœ€è¦<strong>æ‰§è¡Œä¸€æ¬¡æŒä¹…åŒ–æ“ä½œ</strong>å³å¯ã€‚</p><p>å¯ä»¥<strong>å€ŸåŠ©<strong><strong>IDE</strong></strong>çš„æŸ¥æ‰¾åŠŸèƒ½</strong>æ¥æ‰¾åˆ°currentTermï¼ŒvotedForï¼Œlog[]å‘ç”Ÿæ”¹å˜çš„åœ°æ–¹ï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚</p><h3 id=nextindexä¼˜åŒ–>nextIndexä¼˜åŒ–</h3><p>å¦‚æœä¸è¿›è¡ŒnextIndexä¼˜åŒ–ï¼Œå¯èƒ½ä¼šå¯¼è‡´æµ‹è¯•ç”¨ä¾‹è¶…æ—¶ã€‚æˆ‘ä»¬éœ€è¦ä½¿NextIdèƒ½å°½é‡ä¸€æ¬¡å°±åˆ°è¾¾å†²çªç‚¹ã€‚</p><p>è®ºæ–‡åŸæ–‡æè¿°å¦‚ä¸‹ï¼š</p><blockquote><p>If desired, the protocol can be optimized to reduce the number of rejected AppendEntries RPCs. For example, when rejecting an AppendEntries request, the follower can include the term of the conflicting entry and the first index it stores for that term. With this information, the leader can decrement nextIndex to bypass all of the conflicting entries in that term; one AppendEntries RPC will be required for each term with conflicting entries, rather than one RPC per entry. In practice, we doubt this optimization is necessary, since failures happen infrequently and it is unlikely that there will be many inconsistent entries.</p><p>å¦‚æœéœ€è¦ï¼Œå¯ä»¥é€šè¿‡ä¼˜åŒ–åè®®æ¥å‡å°‘è¢«æ‹’ç»çš„AppendEntries RPCçš„æ•°é‡ã€‚ä¾‹å¦‚ï¼Œå½“Followeræ‹’ç»ä¸€ä¸ªAppendEntriesè¯·æ±‚æ—¶ï¼Œå®ƒå¯ä»¥å‘é¢†å¯¼è€…æä¾›å†²çªæ¡ç›®çš„Termä»¥åŠå­˜å‚¨è¯¥ä»»æœŸçš„ç¬¬ä¸€ä¸ªç´¢å¼•ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼ŒLeaderå°±å¯ä»¥é€šè¿‡å‡å°nextIndexæ¥è·³è¿‡è¯¥å†²çªä»»æœŸä¸­çš„æ‰€æœ‰å†²çªæ¡ç›®ã€‚è¿™æ ·ï¼Œæ¯ä¸ªå†²çªçš„ä»»æœŸåªéœ€è¦ä¸€ä¸ªAppendEntries RPCï¼Œè€Œä¸æ˜¯æ¯ä¸ªå†²çªæ¡ç›®éƒ½éœ€è¦ä¸€ä¸ªRPCï¼Œä»è€Œå‡å°‘åŒæ­¥æ—¥å¿—çš„æˆæœ¬ã€‚ä½†åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬æ€€ç–‘è¿™ç§ä¼˜åŒ–å¹¶ä¸æ˜¯å¾ˆå¿…è¦ï¼Œå› ä¸ºä¸ä¸€è‡´çš„æ¡ç›®éå¸¸å°‘è§ã€‚</p></blockquote><p>è®ºæ–‡å¹¶æ²¡æœ‰è¯¦ç»†è¯´æ˜å®ç°æ–¹æ³•ï¼Œä½†3Cä»»åŠ¡ç»™äº†æˆ‘ä»¬æç¤ºã€‚ä¸€ç§å¯èƒ½çš„å®ç°æ˜¯è®©<strong>æ‹’ç»æ¶ˆæ¯ä½“</strong>ä¸­åŒ…æ‹¬</p><table><thead><tr><th>å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>XTerm</td><td>å¦‚æœå­˜åœ¨çš„è¯ï¼Œè¡¨ç¤ºå‘ç”Ÿå†²çªä½ç½®æ—¥å¿—çš„Termä»»æœŸ</td></tr><tr><td>XIndex</td><td>å¦‚æœå­˜åœ¨çš„è¯ï¼Œè¡¨ç¤ºè¯¥ä»»æœŸçš„ç¬¬ä¸€ä¸ªæ—¥å¿—ç´¢å¼•</td></tr><tr><td>XLen</td><td>å·²ç»å¤åˆ¶çš„æ—¥å¿—é•¿åº¦</td></tr></tbody></table><p>è€ŒLeaderæ¥æ”¶åˆ°æ¶ˆæ¯ä½“åï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„æƒ…å†µå¤„ç†ï¼š</p><table><thead><tr><th>æƒ…å†µ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Leaderä¸å­˜åœ¨XTerm</td><td>nextIndex = XIndex</td></tr><tr><td>Leaderå­˜åœ¨XTerm</td><td>nextIndex = Leaderæ—¥å¿—ä¸­å±äºXTermä»»æœŸçš„æœ€å¤§æ—¥å¿—ç´¢å¼•</td></tr><tr><td>Followerçš„æ—¥å¿—è¿‡çŸ­</td><td>nextIndex = XLen</td></tr></tbody></table><h4 id=ä¿®æ”¹appendentries>ä¿®æ”¹AppendEntries</h4><p>é¦–å…ˆï¼ŒæŒ‰ç…§ä¸Šè¿°æ–¹æ³•ï¼Œç»™<code>AppendEntriesReply</code>æ–°å¢å­—æ®µã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AppendEntriesReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Success</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Extend</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>XTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>XIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>XLen</span>   <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªæ–¹æ³•æ¥è®¡ç®—æŸä¸ªä»»æœŸçš„æœ€å¤§ç´¢å¼•ä¸æœ€å°ç´¢å¼•ã€‚å½“ä»»æœŸä¸å­˜åœ¨æ—¶ï¼Œç´¢å¼•è¿”å›0ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>term</span> <span style=color:#66d9ef>int</span>) (<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> = <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>MaxInt</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>minIdx</span> = min(<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>maxIdx</span> = max(<span style=color:#a6e22e>maxIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>minIdx</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¤§å°å€¼å‡+1ï¼Œè¡¨ç¤ºç´¢å¼•ï¼ˆç´¢å¼•ä»1å¼€å§‹ï¼‰</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>minIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»¥ä¸Šå·¥ä½œå®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹AppendEntriesæ–¹æ³•ï¼Œä¸ºæ‹“å±•å­—æ®µèµ‹å€¼ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// AppendEntries RPC å‘é€å¿ƒè·³æˆ–è€…æ—¥å¿—æäº¤</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ° S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœæ”¶åˆ°çš„ä»»æœŸå°äºè‡ªèº«ï¼Œåˆ™æ‹’ç»Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„ä»»æœŸå·Term%då°äºè‡ªèº«ä»»æœŸå·Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å½“å‰ä»»æœŸå·ï¼š%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>// ä¸å­˜åœ¨</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// ä¸å­˜åœ¨</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ç”±å€™é€‰è€…é™çº§ä¸ºè¿½éšè€…&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ”¶åˆ°çš„ä»»æœŸå¤§äºè‡ªèº«ï¼Œåˆ™è¿½éšè¯¥Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœæ˜¯Leaderæˆ–å€™é€‰äººï¼Œåˆ™é™çº§ä¸ºFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„æ–°çš„ä»»æœŸå·Term%dï¼Œé™çº§ä¸ºFollower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥Leaderçš„æ—¥å¿—æ˜¯å¦ä¸è¿½éšè€…ç›¸åŒ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//Extend: Followerçš„Logè¿‡çŸ­ï¼Œå¹¶éå‘ç”Ÿå†²çª</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ—¥å¿—Indexä¸ä¸€è‡´ï¼Œæ”¶åˆ°PrevLogIndex:%d,rf.LastLogIndex=%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœæ—¥å¿—åœ¨PrevLogIndexä¸­ä¸åŒ…å«Termä¸PrevLogTermåŒ¹é…çš„Entryï¼Œåˆ™å›å¤false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend: å†²çªä¿¡æ¯</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ—¥å¿—Termä¸ä¸€è‡´ï¼Œæ”¶åˆ°çš„PrevLogTerm: %d,MyPrevLogTerm: %d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ç¬¬ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶é˜²æ­¢å¹¶å‘è¿‡ç¨‹ä¸­æœ‰æ—§çš„æ•°æ®è¢«é‡æ–°æ”¶åˆ°</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ç¬¬äºŒä¸ªåˆ¤æ–­æ¡ä»¶æ˜¯æˆªæ–­æœªæäº¤çš„è¿‡æœŸæ•°æ®</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>), <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>[<span style=color:#a6e22e>i</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Exist Entries: %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. å¦‚æœleaderCommit &gt; commitIndexï¼Œåˆ™commitIndexè®¾ç½®ä¸ºmin(leaderCommit,æœ€æ–°Entryçš„ç´¢å¼•)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°Leader CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ä¸èƒ½è¶…è¿‡Leaderçš„Commitã€‚å¦‚æœPeerçš„Logæ¯”è¾ƒæ»åï¼Œargs.PrevLogIndex+len(args.Entries)èƒ½å¿«é€Ÿæ›´æ–°commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = min(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span>len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ›´æ–°CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ä¿®æ”¹sendentry2server>ä¿®æ”¹sendEntry2Server</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Term:%d &gt; CurrentTerm%d,é™çº§ä¸ºFollower&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;éLeaderï¼Œæ‹’ç»å“åº” S%d:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å“åº”çš„ä»»æœŸå·%dæ›´å°ï¼Œæ‹’ç»æ¥å—&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dæˆåŠŸAppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//æ›´æ–°peerçš„nextIdxå’ŒmatchIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>//è®¡ç®—å½“å‰commitIdxï¼Œéœ€è¦ä¿è¯å¹‚ç­‰æ€§</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dçš„NextIdxä¿®æ”¹ä¸º%dï¼ŒMatchIdxä¿®æ”¹ä¸º%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#75715e>//å¯»æ‰¾commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;LastLogIndex=%d,commitIndex=%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(), <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(); <span style=color:#a6e22e>n</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>n</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>; <span style=color:#a6e22e>n</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cnt</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>peer</span>, <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span> {
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>peer</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>             <span style=color:#75715e>// å¦‚æœåŒ¹é…çš„ç´¢å¼•å¤§äºn</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>matchIdx</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>n</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>cnt</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>             }
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cnt</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>halfPeerNum</span>() {
</span></span><span style=display:flex><span>             <span style=color:#75715e>// næ˜¯æ•°ç»„ä¸‹æ ‡ï¼Œn+1ä¸ºç´¢å¼•</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#a6e22e>n</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;è·å–åŠæ•°PeeråŒæ„ï¼Œæ›´æ–°CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>n</span>)
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dæ‹’ç»AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å‡å°‘nextIdxï¼Œç„¶åé‡è¯•</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//if rf.nextIndex[server] &gt; 1 {</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// rf.nextIndex[server]--</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// extend</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d XTerm == -1,nextIdx -&gt; reply.XLen + 1&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader no XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>)
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>maxIdx</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader has XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>maxIdx</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>entries</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>nextIdx</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog2</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å‡å°‘S%d nextIdï¼ŒnextId:%d&#34;</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>newArg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderId</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogIndex</span>: <span style=color:#a6e22e>prevLogIndex</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>PrevLogTerm</span>:  <span style=color:#a6e22e>prevLogTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Entries</span>:      <span style=color:#a6e22e>entries</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>LeaderCommit</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>newArg</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ³¨æ„ï¼Œä¸Šé¢çš„ä»£ç æ–°å¢äº†</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¦‚æœä¸æ·»åŠ ä»¥ä¸Šä»£ç å°†ä¼šå‘ç”Ÿé”™è¯¯ã€‚è€ƒè™‘è¿™ç§æƒ…å†µï¼šå½“S1åœ¨T1ä»»æœŸå‘é€äº†ä¸€ä¸ªAppendEntriesè¯·æ±‚ï¼Œä½†S2å¹¶æ²¡æœ‰æ”¶åˆ°ï¼Œä¹‹åS1å†æ¬¡å½“é€‰Leaderï¼Œå‘S2å‘é€AppendEntriesï¼ŒS2åŒæ­¥Logä¹‹åï¼Œæ”¶åˆ°äº†T1æ—¶çš„AppendEntriesè¯·æ±‚ï¼Œæ­¤æ—¶ä¼šæ‹’ç»è€Œå“åº”falseï¼ŒS1ä¼šä¿®æ”¹nextIndexä¸ºLen(S2.Log)+1ï¼Œå¦‚æœS1çš„Logä¸S2ç›¸åŒï¼Œé‚£ä¹ˆS1ä¸‹ä¸€æ¬¡å‘é€ç»™S2çš„Entrieså°†ä¼šå‘ç”Ÿæ•°ç»„è¶Šç•Œå¼‚å¸¸ã€‚</p><h3 id=è¿è¡Œç»“æœ-2>è¿è¡Œç»“æœ</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: basic persistence ...
</span></span><span style=display:flex><span>labgob warning: Decoding into a non-default variable/field int may not work
</span></span><span style=display:flex><span>  ... Passed --   5.6  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>54</span>   <span style=color:#ae81ff>13266</span>    <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: more persistence ...
</span></span><span style=display:flex><span>  ... Passed --  20.8  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>610</span>  <span style=color:#ae81ff>128556</span>   <span style=color:#ae81ff>16</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: partitioned leader and one follower crash, leader restarts ...
</span></span><span style=display:flex><span>  ... Passed --   2.7  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>31</span>    <span style=color:#ae81ff>7528</span>    <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: Figure <span style=color:#ae81ff>8</span> ...
</span></span><span style=display:flex><span>  ... Passed --  31.9  <span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>556</span>  <span style=color:#ae81ff>118623</span>   <span style=color:#ae81ff>35</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: unreliable agreement ...
</span></span><span style=display:flex><span>  ... Passed --   2.1  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>1000</span>  <span style=color:#ae81ff>315603</span>  <span style=color:#ae81ff>246</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: Figure <span style=color:#ae81ff>8</span> <span style=color:#f92672>(</span>unreliable<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  33.6  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>6382</span> <span style=color:#ae81ff>7293379</span>  <span style=color:#ae81ff>244</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: churn ...
</span></span><span style=display:flex><span>  ... Passed --  16.4  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>4243</span> <span style=color:#ae81ff>7685050</span> <span style=color:#ae81ff>1036</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3C<span style=color:#f92672>)</span>: unreliable churn ...
</span></span><span style=display:flex><span>  ... Passed --  16.6  <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>3005</span> <span style=color:#ae81ff>4153099</span>  <span style=color:#ae81ff>723</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     129.596s
</span></span></code></pre></div><h2 id=lab-3d-å¿«ç…§snapshot>Lab-3D-å¿«ç…§Snapshot</h2><p>ç›®å‰ï¼Œé‡å¯æœåŠ¡å™¨ä¼šæŒ‰é¡ºåºé‡æ”¾å®Œæ•´çš„ Raft æ—¥å¿—ä»¥æ¢å¤å…¶çŠ¶æ€ã€‚ç„¶è€Œï¼Œé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡æ— æ³•æ°¸ä¹…è®°ä½å®Œæ•´çš„ Raft æ—¥å¿—ï¼Œè¿™æ˜¯ä¸åˆ‡å®é™…çš„ã€‚</p><p>ç›¸åï¼Œæ‚¨å°†ä¿®æ”¹ Raft ä»¥ä¸æŒä¹…å­˜å‚¨å…¶çŠ¶æ€çš„æœåŠ¡åˆä½œï¼Œè¿™äº›æœåŠ¡ä¼šä¸æ—¶åœ°å­˜å‚¨å…¶çŠ¶æ€çš„â€œå¿«ç…§â€ï¼Œæ­¤æ—¶ Raft ä¼šä¸¢å¼ƒåœ¨å¿«ç…§ä¹‹å‰çš„æ—¥å¿—æ¡ç›®ã€‚ç»“æœæ˜¯æ›´å°‘çš„æŒä¹…æ•°æ®å’Œæ›´å¿«çš„é‡å¯ã€‚</p><p>ä½†æ˜¯ï¼Œç°åœ¨å¯èƒ½ä¼šå‡ºç°è¿½éšè€…è½åå¤ªè¿œï¼Œä»¥è‡³äºé¢†å¯¼è€…å·²ç»ä¸¢å¼ƒäº†å®ƒéœ€è¦è¿½èµ¶çš„æ—¥å¿—æ¡ç›®ï¼›ç„¶åé¢†å¯¼è€…å¿…é¡»å‘é€ä¸€ä¸ªå¿«ç…§ä»¥åŠä»å¿«ç…§æ—¶é—´å¼€å§‹çš„æ—¥å¿—ã€‚</p><h3 id=ä»»åŠ¡è¦æ±‚-3>ä»»åŠ¡è¦æ±‚</h3><p>åœ¨å®éªŒå®¤ 3D ä¸­ï¼ŒTesterå®šæœŸè°ƒç”¨<code>Snapshot()</code>ã€‚åœ¨Lab-4ä¸­ï¼Œæ‚¨å°†ç¼–å†™ä¸€ä¸ªk-væœåŠ¡å™¨ï¼Œè°ƒç”¨<code>Snapshot()</code>ï¼›å¿«ç…§å°†åŒ…å«å®Œæ•´çš„é”®/å€¼å¯¹è¡¨ã€‚æœåŠ¡å±‚åœ¨æ¯ä¸ªå¯¹ç­‰èŠ‚ç‚¹ä¸Šè°ƒç”¨ <code>Snapshot()</code> ï¼ˆ<strong>è€Œä¸ä»…ä»…æ˜¯åœ¨é¢†å¯¼è€…ä¸Š</strong>ï¼‰ã€‚</p><p>index å‚æ•°è¡¨ç¤ºå¿«ç…§ä¸­åæ˜ çš„æœ€é«˜æ—¥å¿—æ¡ç›®ã€‚Raft åº”è¯¥åœ¨è¯¥ç‚¹ä¹‹å‰ä¸¢å¼ƒå…¶æ—¥å¿—æ¡ç›®ã€‚æ‚¨éœ€è¦ä¿®æ”¹ Raft ä»£ç ï¼Œä»…åœ¨å­˜å‚¨æ—¥å¿—å°¾éƒ¨æ—¶è¿è¡Œã€‚</p><p>æ‚¨éœ€è¦å®ç°è®ºæ–‡ä¸­è®¨è®ºçš„ InstallSnapshot RPCï¼Œä»¥å…è®¸ Raft é¢†å¯¼è€…å‘Šè¯‰æ»åçš„ Raft åŒè¡Œä½¿ç”¨å¿«ç…§æ›¿æ¢å…¶çŠ¶æ€ã€‚æ‚¨å¯èƒ½éœ€è¦ä»”ç»†è€ƒè™‘ InstallSnapshot å¦‚ä½•ä¸å›¾ 2 ä¸­çš„çŠ¶æ€å’Œè§„åˆ™äº¤äº’ã€‚</p><p>å½“è¿½éšè€…çš„ Raft ä»£ç æ¥æ”¶åˆ° InstallSnapshot RPC æ—¶ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ applyCh å°†å¿«ç…§å‘é€åˆ° ApplyMsg ä¸­çš„æœåŠ¡ã€‚ ApplyMsg ç»“æ„å®šä¹‰å·²ç»åŒ…å«äº†æ‚¨éœ€è¦çš„å­—æ®µï¼ˆTesteræœŸæœ›çš„å­—æ®µï¼‰ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›å¿«ç…§åªä¼šæ¨è¿›æœåŠ¡çš„çŠ¶æ€ï¼Œè€Œä¸ä¼šä½¿å…¶åé€€ã€‚</p><p>å¦‚æœæœåŠ¡å™¨å´©æºƒï¼Œå¿…é¡»ä»æŒä¹…åŒ–æ•°æ®é‡æ–°å¯åŠ¨ã€‚<strong>æ‚¨çš„ Raft åº”è¯¥æŒä¹…åŒ– Raft çŠ¶æ€å’Œç›¸åº”çš„å¿«ç…§</strong>ã€‚ä½¿ç”¨ç¬¬äºŒä¸ªå‚æ•° persister.Save() ä¿å­˜å¿«ç…§ã€‚å¦‚æœæ²¡æœ‰å¿«ç…§ï¼Œè¯·å°† nil ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ã€‚</p><p>å½“æœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶ï¼Œåº”ç”¨å±‚ä¼šè¯»å–æŒä¹…åŒ–çš„å¿«ç…§å¹¶æ¢å¤å…¶ä¿å­˜çš„çŠ¶æ€ã€‚</p><p>æç¤ºï¼š</p><ul><li>ä»¥å•ä¸ª InstallSnapshot RPC å‘é€å®Œæ•´çš„å¿«ç…§ã€‚ä¸è¦å®ç°<code>Figure 13</code>çš„ offset æœºåˆ¶æ¥æ‹†åˆ†å¿«ç…§ã€‚</li></ul><p><img src="https://iuodqykkhs.feishu.cn/space/api/box/stream/download/asynccode/?code=MDI2NWI3OWVkMTZiMGE4NDUxOTgzMGY1Mjg4ZDIyYTBfWXhLYUVSakZWMm9EemlETWFJVTBZRFF6VE5MVWJhYlZfVG9rZW46UDdEV2I2QldVb3pIamZ4dTFUamNNV1pXbmhmXzE3Mzk2MjgzNTI6MTczOTYzMTk1Ml9WNA" alt=img></p><h3 id=å®ç°å‡†å¤‡æ­¥éª¤-1>å®ç°â€”â€”å‡†å¤‡æ­¥éª¤</h3><p>ä»»åŠ¡è¦æ±‚ä¸­ï¼Œå·²ç»æ˜ç¡®å‘Šè¯‰æˆ‘ä»¬ä¸è¦æŒ‰ç…§è®ºæ–‡å›¾13çš„Chunk-Offsetæœºåˆ¶æ¥æ‹†åˆ†å¿«ç…§ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å®šä¹‰çš„PRCè¯·æ±‚ç»“æ„ä½“ä¸è®ºæ–‡æè¿°ä¼šæœ‰ç•¥å¾®å·®å¼‚ã€‚</p><h4 id=raftç»“æ„ä½“>Raftç»“æ„ä½“</h4><p>Raftç»“æ„ä½“æ–°å¢Snapshotç›¸å…³å­—æ®µã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Raft</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>          <span style=color:#75715e>// Lock to protect shared access to this peer&#39;s state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>peers</span>     []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span> <span style=color:#75715e>// RPC end points of all peers</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>          <span style=color:#75715e>// Object to hold this peer&#39;s persisted state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>        <span style=color:#66d9ef>int</span>                 <span style=color:#75715e>// this peer&#39;s index into peers[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dead</span>      <span style=color:#66d9ef>int32</span>               <span style=color:#75715e>// set by Kill()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your data here (3A, 3B, 3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Look at the paper&#39;s Figure 2 for a description of what</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// state a Raft server must maintain.</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>         <span style=color:#a6e22e>State</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>heartBeatTime</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>electionTime</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»¥ä¸‹å­—æ®µè®ºæ–‡åŸæ–‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentTerm</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// å½“å‰ä»»æœŸ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votedFor</span>    <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// æŠ•ç¥¨ç»™çš„å€™é€‰è€…ID</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>         []<span style=color:#a6e22e>LogEntry</span> <span style=color:#75715e>// æ—¥å¿—</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>commitIndex</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// å·²ç»æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>        <span style=color:#75715e>// å·²ç»åº”ç”¨åˆ°çŠ¶æ€æœºçš„æœ€é«˜æ—¥å¿—æ¡ç›®ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIndex</span>   []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// å¯¹æ¯ä¸ªæœåŠ¡å™¨ï¼Œè¦å‘é€çš„ä¸‹ä¸€è·³æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchIndex</span>  []<span style=color:#66d9ef>int</span>      <span style=color:#75715e>// å¯¹æ¯ä¸ªæœåŠ¡å™¨ï¼Œå·²çŸ¥è¢«å¤åˆ¶çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SnapShot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applyCh</span>           <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SnapShot</span>          []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç»“æ„ä½“ä¸­æ–°å¢äº†<code>applyCh</code>ï¼Œç”¨äºæäº¤å¿«ç…§ï¼Œä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œæˆ‘ä»¬å®ç°<code>commitSnap</code>æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>commitSnap</span>(<span style=color:#a6e22e>msg</span> <span style=color:#a6e22e>ApplyMsg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>applyCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>msg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;commit Snap idx:%d-Term:%d&#34;</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotIndex</span>, <span style=color:#a6e22e>msg</span>.<span style=color:#a6e22e>SnapshotTerm</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å†å®ç°<code>readPersistSnapshot</code>æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>readPersistSnapshot</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span> = <span style=color:#a6e22e>data</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=persistreadpersistæ–¹æ³•>persist&amp;readPersistæ–¹æ³•</h4><p>æ­£å¦‚ä»»åŠ¡è¦æ±‚æ‰€è¯´ï¼Œå¦‚æœæœåŠ¡å™¨å´©æºƒï¼Œæˆ‘ä»¬å¿…é¡»ä»æŒä¹…åŒ–æ•°æ®é‡æ–°å¯åŠ¨ã€‚</p><p>æˆ‘ä»¬åº”è¯¥æŒä¹…åŒ– Raft çŠ¶æ€å’Œç›¸åº”çš„**Snapshotï¼Œ**é¦–å…ˆï¼Œæˆ‘ä»¬ä¿®æ”¹<code>persist()</code>å’Œ<code>readPersist()</code>æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// å°† Raft çš„æŒä¹…çŠ¶æ€ä¿å­˜åˆ°ç¨³å®šå­˜å‚¨ä¸­ï¼Œ</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è¿™æ ·åœ¨å‘ç”Ÿå´©æºƒå¹¶é‡æ–°å¯åŠ¨åå¯ä»¥æ£€ç´¢åˆ°è¿™äº›çŠ¶æ€ã€‚</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è¯·å‚è§è®ºæ–‡ä¸­çš„å›¾ 2ï¼Œäº†è§£å“ªäº›å†…å®¹åº”è¯¥æ˜¯æŒä¹…åŒ–çš„ã€‚</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åœ¨å®ç°å¿«ç…§ä¹‹å‰ï¼Œåº”è¯¥å°† nil ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™ persister.Save()ã€‚</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åœ¨å®ç°å¿«ç…§ä¹‹åï¼Œä¼ é€’å½“å‰çš„å¿«ç…§ï¼ˆå¦‚æœè¿˜æ²¡æœ‰å¿«ç…§ï¼Œä¼ é€’ nilï¼‰ã€‚</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>persist</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>Buffer</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// log[]</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;åºåˆ—åŒ– rf.log å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// snapshot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;åºåˆ—åŒ– rf.LastIncludedIndex å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;åºåˆ—åŒ– rf.LastIncludedTerm å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>raftState</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Bytes</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>Save</span>(<span style=color:#a6e22e>raftState</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>Save</span>(<span style=color:#a6e22e>raftState</span>, <span style=color:#66d9ef>nil</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dPersist</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æŒä¹…åŒ–æ‰§è¡ŒæˆåŠŸ&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>data</span>) &lt; <span style=color:#ae81ff>1</span> { <span style=color:#75715e>// bootstrap without any state?</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3C).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewBuffer</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ååºåˆ—åŒ– rf.log å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// snapshot</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ååºåˆ—åŒ– rf.LastIncludedIndex å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ååºåˆ—åŒ– rf.LastIncludedTerm å¤±è´¥ã€‚err: %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dPersist</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;è¯»å–æŒä¹…æ•°æ®æˆåŠŸ&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=makeæ–¹æ³•>Makeæ–¹æ³•</h4><p>åˆå§‹åŒ–Serverçš„å‡½æ•°å¢åŠ è¯»å–SnapshotæŒä¹…åŒ–æ•°æ®çš„ä»£ç ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Make</span>(<span style=color:#a6e22e>peers</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>labrpc</span>.<span style=color:#a6e22e>ClientEnd</span>, <span style=color:#a6e22e>me</span> <span style=color:#66d9ef>int</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span>) <span style=color:#75715e>// æ–°å¢</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// initialize from state persisted before a crash</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersist</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadRaftState</span>())
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>readPersistSnapshot</span>(<span style=color:#a6e22e>persister</span>.<span style=color:#a6e22e>ReadSnapshot</span>()) <span style=color:#75715e>// æ–°å¢</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// start ticker goroutine to start elections</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>ticker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=snapshotæ–¹æ³•>Snapshotæ–¹æ³•</h4><p>ä»“åº“ä»£ç å·²ç»ç»™äº†Snapshotçš„éª¨æ¶ä»£ç ï¼Œæˆ‘ä»¬éœ€è¦å®ç°å®ƒã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>Snapshot</span>(<span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>snapshot</span> []<span style=color:#66d9ef>byte</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Your code here (3D).</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>index</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;SnapShot Idx &gt; LogLastIdx&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>index</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dWarn</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;SnapShotIdx &lt; LastIncludedIdx&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Get SnapShot cmd, Idx : %d&#34;</span>, <span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;old Log : %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CutLog</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>index</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>index</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;new Log : %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> = <span style=color:#a6e22e>index</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span> = <span style=color:#a6e22e>CutLog</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;LastIncludedTerm:%d LastIncludedIndex:%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span> = <span style=color:#a6e22e>snapshot</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=å®ç°æ ¸å¿ƒæ­¥éª¤-1>å®ç°â€”â€”æ ¸å¿ƒæ­¥éª¤</h3><h4 id=installsnapshot-rpc>InstallSnapshot RPC</h4><p>æŒ‰ç…§è®ºæ–‡æ‰€è¿°ï¼Œå®ç°è¯·æ±‚å’Œå“åº”ç»“æ„ä½“ã€‚</p><blockquote><p>å®ŒæˆLab3Då¹¶ä¸éœ€è¦å®ç°offsetå’Œdoneã€‚</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>InstallSnapshotArgs</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>              <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LeaderId</span>          <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastIncludedTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Data</span>              []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Offset            int</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Done              bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>InstallSnapshotReply</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>InstallSnapshot</code>æ˜¯æ¥æ”¶å¿«ç…§ä¿¡æ¯çš„RPCå‡½æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>InstallSnapshot</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Recv S%d InstallSnapShot&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Recv Snap Term:%d &lt; CurrentTerm:%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;é™çº§ä¸ºFollower&#34;</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;args.LastIncludedIndex:%d &lt; rf.lastApplied:%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰¾åˆ°Index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dDrop</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ²¡æœ‰æ‰¾åˆ°ç´¢å¼•%d,ä¸¢å¼ƒæ‰€æœ‰æ—¥å¿—&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = []<span style=color:#a6e22e>LogEntry</span>{}
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dDrop</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ‰¾åˆ°ç´¢å¼•%dï¼Œä¸¢å¼ƒéƒ¨åˆ†æ—¥å¿—&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ”¹çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = max(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = max(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitSnap</span>(<span style=color:#a6e22e>ApplyMsg</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>SnapshotValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Snapshot</span>:      <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Data</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>SnapshotTerm</span>:  <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>SnapshotIndex</span>: <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=sendinstallsnapshot>sendInstallSnapshot</h4><p>ä¸»åŠ¨è°ƒç”¨InstallSnapshot RPCå‡½æ•°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>installSnapshot</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>InstallSnapshotReply</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>[<span style=color:#a6e22e>server</span>].<span style=color:#a6e22e>Call</span>(<span style=color:#e6db74>&#34;Raft.InstallSnapshot&#34;</span>, <span style=color:#a6e22e>args</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send SnapShot to S%d&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InstallSnapshotArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LeaderId</span>:          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedIndex</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedTerm</span>:  <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Data</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>() <span style=color:#75715e>// ä¸ºä»€ä¹ˆä¸ç”¨ defer rf.mu.Unlock()ï¼Ÿè§æ–‡ç« åç»­è¯´æ˜</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>InstallSnapshotReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>installSnapshot</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send Snapshot RPC to S%d failed&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;sendInstallSnapshot Reply.Term &lt; CurrentTerm&#34;</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newMatch</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newNext</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newMatch</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = max(<span style=color:#a6e22e>newNext</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>])
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h5 id=æ´»é”é—®é¢˜>æ´»é”é—®é¢˜</h5><p>æˆ‘åœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸¤ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼š</p><ol><li>æœ€åçš„é”™è¯¯æ—¥å¿—ä¼šæ˜¾ç¤ºæŸä¸ªLogAæœªè¾¾æˆå…±è¯†ï¼Œä½†æŸ¥è¯¢æ‰“å°æ—¥å¿—å‘ç°ï¼Œå¹¶æœªæœ‰ä»»ä½•Serveræ”¶åˆ°äº†LogAã€‚æ ¹æ®å•å…ƒæµ‹è¯•ä»£ç ï¼Œå¦‚æœTesterå‘é€äº†æŸä¸ªæ—¥å¿—ï¼Œè¿™ä¸ªæ—¥å¿—åœ¨10såè¿˜æ²¡æœ‰è¢«Serveræ¥æ”¶ï¼Œåˆ™æŠ¥é”™ï¼Œå¯è§ç¨‹åºçš„æ‰“å°æ—¥å¿—æ˜¯ä¸ä¼šæœ‰è®°å½•çš„ï¼Œå› ä¸ºä¸€ç›´æ²¡æœ‰Serveræ¥æ”¶ã€‚</li><li>æœ€åæ‰€æœ‰çš„Serveréƒ½å˜ä¸ºå€™é€‰äººï¼Œä½†æ²¡æœ‰é€‰å‡ºLeaderã€‚Server1æ— æ³•ä¸Server2ã€Server3é€šä¿¡ï¼Œä¸€ç›´åœ¨æ›´æ–°ä»»æœŸå¹¶è¯·æ±‚æŠ•ç¥¨ï¼Œè€ŒServer2ä¸Server3èƒ½å¤Ÿé€šä¿¡ï¼Œä½†æ˜¯Server2çš„ä»»æœŸå·æ¯”Server3æ›´å¤§ï¼ŒLogå´æ¯”Server3ä½ï¼ŒServer3æ°¸è¿œåœ¨è¿½èµ¶Server2çš„ä»»æœŸå·ã€‚</li></ol><p>ä¸Šè¿°ä¸¤ç§æƒ…å†µçš„æœ¬è´¨åŸå› æ˜¯ä»£ç ä¸­å‘ç”Ÿäº†æ´»é”ã€‚</p><p>é€šè¿‡æ’æŸ¥æ—¥å¿—å‘ç°æ˜¯åŠ é”é”™è¯¯å¯¼è‡´çš„ã€‚å½“Server3åˆ°è¾¾é‡æ–°é€‰ä¸¾æ—¶é—´ï¼Œå› ä¸ºServer3å‘é€SnapShotç»™Server1è·å–çš„é”ä¸€ç›´æ²¡æœ‰é‡Šæ”¾ï¼Œä½¿å¾—Server2åˆé‡æ–°å‘èµ·äº†é€‰ä¸¾ï¼Œé€ æˆServer3æ°¸è¿œè¿½èµ¶Server2ï¼Œæ—¥å¿—æ— æ³•è¾¾æˆä¸€è‡´ã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒServer3ä¸ä¼šæ°¸è¿œè¿½èµ¶Server2ï¼Œå› ä¸ºServer3æ”¶åˆ°æ–°çš„ä»»æœŸè¯·æ±‚æ—¶ä¸ä¼šé‡ç½®é€‰ä¸¾æ—¶é—´ï¼Œè€Œä»…ä»…æ˜¯æ›´æ–°ä»»æœŸå·ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPro</span>(<span style=color:#a6e22e>dSnap</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send SnapShot to S%d&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// defer rf.mu.Unlock() //åŸæœ¬æ˜¯åœ¨è¿™é‡Œé‡Šæ”¾é”ï¼Œå½“rf.installSnapshotå¡ä½æ—¶ï¼Œé”æ— æ³•é‡Šæ”¾</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>InstallSnapshotArgs</span>{
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Term</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LeaderId</span>:          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedIndex</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>LastIncludedTerm</span>:  <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>Data</span>:              <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>SnapShot</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()  <span style=color:#75715e>// åˆ›å»ºäº†è¯·æ±‚ç»“æ„ä½“ä¹‹åä¾¿å¯é‡Šæ”¾é”</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>InstallSnapshotReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>installSnapshot</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>); !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPro</span>(<span style=color:#a6e22e>dError</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Send Snapshot RPC to S%d failed&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>//... çœç•¥</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=å‘é€snapshotåˆ¤æ–­>å‘é€SnapShotåˆ¤æ–­</h4><p>å½“Followerçš„<code>nextIndex</code>æ¯”Leaderçš„<code>LastIncludedIndex</code>å°ï¼Œæ­¤æ—¶Leaderæ— æ³•å°†æ—¥å¿—å‘é€ç»™è¯¥Followerï¼Œè€Œæ˜¯å°†Snapshotä¿¡æ¯ä¼ é€’ç»™å®ƒã€‚</p><p>æˆ‘ä»¬éœ€è¦ä¿®æ”¹<code>broadcastEntries</code>æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>broadcastEntries</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å¼€å§‹å¹¿æ’­AppendEntries&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>entries</span>      []<span style=color:#a6e22e>LogEntry</span>
</span></span><span style=display:flex><span>       )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ã€æ–°å¢ã€‘åˆ¤æ–­æ˜¯å¦ä¸ºå‹ç¼©æ—¥å¿—</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;To S%d nextIndex:%d LastIncludedIndex:%d&#34;</span>, <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>prevLogIndex</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>]<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>prevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ...... çœç•¥</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åŒç†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹<code>sendEntry2Server</code>æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendEntry2Server</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>args</span> <span style=color:#a6e22e>AppendEntriesArgs</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>reply</span> <span style=color:#a6e22e>AppendEntriesReply</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>appendEntries</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>StateLeader</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLeader</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%dæ‹’ç»AppendEntry&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å‡å°‘nextIdxï¼Œç„¶åé‡è¯•</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//if rf.nextIndex[server] &gt; 1 {</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// rf.nextIndex[server]--</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// extend</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;S%d XTerm == -1,nextIdx -&gt; reply.XLen + 1&#34;</span>, <span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>       } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader no XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>)
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>maxIdx</span>
</span></span><span style=display:flex><span>             <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Leader has XTerm%d ,S%d nextIdx -&gt; %d&#34;</span>, <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>, <span style=color:#a6e22e>server</span>, <span style=color:#a6e22e>maxIdx</span>)
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ã€æ–°å¢ã€‘åˆ¤æ–­æ˜¯å¦éœ€è¦å‘é€å¿«ç…§</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;nextIndex &lt; LastIncludedIndexï¼Œå‘é€å¿«ç…§&#34;</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendInstallSnapshot</span>(<span style=color:#a6e22e>server</span>)
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ......çœç•¥</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ä¿®æ”¹commitmsg>ä¿®æ”¹commitMsg</h4><p>åœ¨æäº¤Msgæ—¶ï¼Œéœ€è¦å°†*<code>rf</code><em><code>.lastApplied</code>ä¸</em><code>rf</code><em><code>.LastIncludedIndex</code>è¿›è¡Œæ¯”è¾ƒï¼Œè¾ƒå¤§çš„å€¼æ‰æ˜¯æœ€ç»ˆçš„</em><code>rf</code>*<code>.lastApplied</code>ã€‚</p><p>ä¸”åœ¨åˆå§‹åŒ–ApplyMsgæ•°ç»„æ—¶ï¼Œè¦æ³¨æ„capå€¼è¦ç¡®ä¿ä¸èƒ½ä¸ºè´Ÿæ•°ï¼Œ<em><code>rf</code></em><code>.lastApplied</code>æœ‰å¯èƒ½å¤§äº*<code>rf</code>*<code>.commitIndex</code>ï¼Œå› æ­¤æœ€å¥½å°†capå»æ‰ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>commitMsg</span>(<span style=color:#a6e22e>applyCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> !<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>killed</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>msg</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>ApplyMsg</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ã€æ–°å¢ã€‘</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> = max(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// lastAppliedä¸ºç´¢å¼•å·ï¼Œä»1å¼€å§‹</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>lastApplied</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>           <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ...çœç•¥</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ä¿®æ”¹logç›¸å…³å‡½æ•°>ä¿®æ”¹Logç›¸å…³å‡½æ•°</h4><p>å¢åŠ Snapshotä¹‹åï¼ŒåŸæœ¬çš„<code>rf.Log</code>åˆ‡ç‰‡å¹¶ä¸èƒ½è¡¨ç¤ºæ‰€æœ‰çš„æ—¥å¿—ï¼Œéœ€è¦ä¿®æ”¹Logç›¸å…³å‡½æ•°ï¼Œè€ƒè™‘æ—¥å¿—å› å¿«ç…§è¢«æˆªæ–­çš„æƒ…å†µã€‚</p><p>ä¿®æ”¹ä¹‹åçš„<code>TermRange</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>term</span> <span style=color:#66d9ef>int</span>) (<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>term</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>maxIdx</span> = <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>MaxInt</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>(); <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>i</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>term</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>minIdx</span> = min(<span style=color:#a6e22e>minIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>maxIdx</span> = max(<span style=color:#a6e22e>maxIdx</span>, <span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>minIdx</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¤§å°å€¼å‡+1ï¼Œè¡¨ç¤ºç´¢å¼•ï¼ˆç´¢å¼•ä»1å¼€å§‹ï¼‰</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>minIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>maxIdx</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¿®æ”¹<code>GetLog</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>index</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>index</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &lt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Panicf</span>(<span style=color:#e6db74>&#34;idx:%d &lt; 0&#34;</span>, <span style=color:#a6e22e>idx</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>{
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedTerm</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Command</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>idx</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>LogEntry</span>{
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Term</span>:    <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Command</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>idx</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¿®æ”¹<code>GetLogSlice</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>right</span> <span style=color:#66d9ef>int</span>) []<span style=color:#a6e22e>LogEntry</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &gt; <span style=color:#a6e22e>right</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;left &gt; right&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>left</span> &lt; <span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>right</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#e6db74>&#34;æ•°ç»„è¶Šç•Œ&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>left</span>, <span style=color:#a6e22e>right</span> = <span style=color:#a6e22e>left</span><span style=color:#f92672>-</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>, <span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newLog</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>LogEntry</span>, <span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#a6e22e>left</span>)
</span></span><span style=display:flex><span>    copy(<span style=color:#a6e22e>newLog</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>left</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:<span style=color:#a6e22e>right</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newLog</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä¿®æ”¹<code>LastLogIndex</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>LastLogIndex</span>() <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>idx</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>idx</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=ä¿®æ”¹appendentires>ä¿®æ”¹AppendEntires</h4><p>Followeræ¥æ”¶æ—¥å¿—æ—¶éœ€è¦åˆ¤æ–­SnapShotçš„çŠ¶æ€ã€‚ä»»åŠ¡è¦æ±‚å·²ç»è¯´æ˜ï¼ŒæœåŠ¡å±‚ä¼šå¯¹æ¯ä¸ªPeerè°ƒç”¨ Snapshot() ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨Leaderï¼Œè¿™å¯èƒ½ä¼šé€ æˆä¸€ç§æƒ…å†µï¼šFolloweræ¯”Leaderæ›´å…ˆè¿›è¡Œå¿«ç…§ã€‚</p><p>è¿™ç§æƒ…å†µå¯¼è‡´çš„ç»“æœä¾¿æ˜¯Leaderå‘é€çš„PrevLogIndexæ¯”Followerçš„LastIncludedIndexæ›´å°ï¼Œå› æ­¤æˆ‘ä»¬æ·»åŠ ä¸€æ¡åˆ¤æ–­è¯­å¥ï¼Œå¦‚æœå°äºï¼Œåˆ™è¿”å›trueï¼Œå¾…ä¸‹ä¸€æ¬¡åŒæ­¥æ—¥å¿—æ¢å¤ä¸€è‡´çŠ¶æ€ã€‚</p><p>æ­¤å¤–ï¼ŒSnapShotä¼šæ”¹å˜æ—¥å¿—æ•°ç»„çš„ç»“æ„ï¼Œéœ€è¦ä¿®æ”¹è°ƒç”¨GetLogSliceæ–¹æ³•çš„ä»£ç ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Go data-lang=Go><span style=display:flex><span><span style=color:#75715e>// AppendEntries RPC å‘é€å¿ƒè·³æˆ–è€…æ—¥å¿—æäº¤</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>AppendEntries</span>(<span style=color:#a6e22e>args</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesArgs</span>, <span style=color:#a6e22e>reply</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AppendEntriesReply</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ° S%d AppendEntries&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderId</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœæ”¶åˆ°çš„ä»»æœŸå°äºè‡ªèº«ï¼Œåˆ™æ‹’ç»Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„ä»»æœŸå·Term%då°äºè‡ªèº«ä»»æœŸå·Term%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;å½“å‰ä»»æœŸå·ï¼š%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> <span style=color:#75715e>// ä¸å­˜åœ¨</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// ä¸å­˜åœ¨</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;ç”±å€™é€‰è€…é™çº§ä¸ºè¿½éšè€…&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ”¶åˆ°çš„ä»»æœŸå¤§äºè‡ªèº«ï¼Œåˆ™è¿½éšè¯¥Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>       <span style=color:#75715e>// å¦‚æœæ˜¯Leaderæˆ–å€™é€‰äººï¼Œåˆ™é™çº§ä¸ºFollower</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateLeader</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>StateCandidate</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateFollower</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dClient</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°çš„æ–°çš„ä»»æœŸå·Term%dï¼Œé™çº§ä¸ºFollower&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥Leaderçš„PrevLogIndexæ˜¯å¦å°äºSnapShotIndex</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœå°äºï¼Œåˆ™ç›´æ¥è¿”å›trueï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡åŒæ­¥æ—¥å¿—</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &lt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥Leaderçš„æ—¥å¿—æ˜¯å¦ä¸è¿½éšè€…ç›¸åŒ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>//Extend: Followerçš„Logè¿‡çŸ­ï¼Œå¹¶éå‘ç”Ÿå†²çª</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ—¥å¿—Indexä¸ä¸€è‡´ï¼Œæ”¶åˆ°PrevLogIndex:%d,rf.LastLogIndex=%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>())
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœæ—¥å¿—åœ¨PrevLogIndexä¸­ä¸åŒ…å«Termä¸PrevLogTermåŒ¹é…çš„Entryï¼Œåˆ™å›å¤false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// Extend: å†²çªä¿¡æ¯</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XLen</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>()
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XIndex</span>, <span style=color:#a6e22e>_</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>TermRange</span>(<span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>XTerm</span>)
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ—¥å¿—Termä¸ä¸€è‡´ï¼Œæ”¶åˆ°çš„PrevLogTerm: %d,MyPrevLogTerm: %d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogTerm</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span>).<span style=color:#a6e22e>Term</span>)
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>entry</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ç¬¬ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶é˜²æ­¢å¹¶å‘è¿‡ç¨‹ä¸­æœ‰æ—§çš„æ•°æ®è¢«é‡æ–°æ”¶åˆ°</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ç¬¬äºŒä¸ªåˆ¤æ–­æ¡ä»¶æ˜¯æˆªæ–­æœªæäº¤çš„è¿‡æœŸæ•°æ®</span>
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastLogIndex</span>() &lt; <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLog</span>(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>).<span style=color:#a6e22e>Term</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>entry</span>.<span style=color:#a6e22e>Term</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// ã€ä¿®æ”¹ã€‘</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span> = append(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>GetLogSlice</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>LastIncludedIndex</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span><span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>), <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>[<span style=color:#a6e22e>i</span>:]<span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;Exist Entries: %v&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 5. å¦‚æœleaderCommit &gt; commitIndexï¼Œåˆ™commitIndexè®¾ç½®ä¸ºmin(leaderCommit,æœ€æ–°Entryçš„ç´¢å¼•)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> {
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dInfo</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ”¶åˆ°Leader CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>)
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ä¸èƒ½è¶…è¿‡Leaderçš„Commitã€‚å¦‚æœPeerçš„Logæ¯”è¾ƒæ»åï¼Œargs.PrevLogIndex+len(args.Entries)èƒ½å¿«é€Ÿæ›´æ–°commitIdx</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = min(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>LeaderCommit</span>, <span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>PrevLogIndex</span><span style=color:#f92672>+</span>len(<span style=color:#a6e22e>args</span>.<span style=color:#a6e22e>Entries</span>))
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>DebugPrintf</span>(<span style=color:#a6e22e>dCommit</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#e6db74>&#34;æ›´æ–°CommitIdxä¸º%d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTime</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=è¿è¡Œç»“æœ-3>è¿è¡Œç»“æœ</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Shell data-lang=Shell><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: snapshots basic ...
</span></span><span style=display:flex><span>  ... Passed --   9.3  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>548</span>  <span style=color:#ae81ff>213483</span>  <span style=color:#ae81ff>240</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>disconnect<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  64.1  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1202</span>  <span style=color:#ae81ff>621766</span>  <span style=color:#ae81ff>300</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>disconnect+unreliable<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  92.7  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1594</span>  <span style=color:#ae81ff>764054</span>  <span style=color:#ae81ff>336</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>crash<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>labgob warning: Decoding into a non-default variable/field int may not work
</span></span><span style=display:flex><span>  ... Passed --  48.5  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1052</span>  <span style=color:#ae81ff>609275</span>  <span style=color:#ae81ff>338</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: install snapshots <span style=color:#f92672>(</span>unreliable+crash<span style=color:#f92672>)</span> ...
</span></span><span style=display:flex><span>  ... Passed --  63.7  <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1118</span>  <span style=color:#ae81ff>639339</span>  <span style=color:#ae81ff>317</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: crash and restart all servers ...
</span></span><span style=display:flex><span>  ... Passed --  15.7  <span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>204</span>   <span style=color:#ae81ff>57418</span>   <span style=color:#ae81ff>45</span>
</span></span><span style=display:flex><span>Test <span style=color:#f92672>(</span>3D<span style=color:#f92672>)</span>: snapshot initialization after crash ...
</span></span><span style=display:flex><span>  ... Passed --   5.4  <span style=color:#ae81ff>3</span>   <span style=color:#ae81ff>68</span>   <span style=color:#ae81ff>18880</span>   <span style=color:#ae81ff>14</span>
</span></span><span style=display:flex><span>PASS
</span></span><span style=display:flex><span>ok      6.5840/raft     299.426s
</span></span></code></pre></div><h2 id=å‚è€ƒ>å‚è€ƒ</h2><ul><li><a href=https://raft.github.io/index.html target=_blank>https://raft.github.io/index.html</a></li><li><a href=https://zhuanlan.zhihu.com/p/682153208 target=_blank>https://zhuanlan.zhihu.com/p/682153208</a></li><li><a href=https://zhuanlan.zhihu.com/p/693936991 target=_blank>https://zhuanlan.zhihu.com/p/693936991</a></li><li><a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank>https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf</a></li><li><a href=https://blog.josejg.com/debugging-pretty/ target=_blank>https://blog.josejg.com/debugging-pretty/</a></li></ul></section><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=bestzy6/bestzy6.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div class="hidden lg:flex lg:flex-col lg:items-end"><nav id=TableOfContents><ul><li><a href=#å®éªŒå‡†å¤‡>å®éªŒå‡†å¤‡</a><ul><li><a href=#debugæ—¥å¿—>Debugæ—¥å¿—</a></li></ul></li><li><a href=#lab-3a---é¢†å¯¼äººé€‰ä¸¾>Lab-3A - é¢†å¯¼äººé€‰ä¸¾</a><ul><li><a href=#ä»»åŠ¡è¦æ±‚>ä»»åŠ¡è¦æ±‚</a></li><li><a href=#å®ç°-1>å®ç°</a></li><li><a href=#è¿è¡Œç»“æœ>è¿è¡Œç»“æœ</a></li></ul></li><li><a href=#lab-3b---æ—¥å¿—>Lab-3B - æ—¥å¿—</a><ul><li><a href=#ä»»åŠ¡è¦æ±‚-1>ä»»åŠ¡è¦æ±‚</a></li><li><a href=#å®ç°å‡†å¤‡æ­¥éª¤>å®ç°â€”â€”å‡†å¤‡æ­¥éª¤</a></li><li><a href=#å®ç°æ ¸å¿ƒæ­¥éª¤>å®ç°â€”â€”æ ¸å¿ƒæ­¥éª¤</a></li><li><a href=#è¿è¡Œç»“æœ-1>è¿è¡Œç»“æœ</a></li></ul></li><li><a href=#lab-3c---æŒä¹…åŒ–>Lab-3C - æŒä¹…åŒ–</a><ul><li><a href=#ä»»åŠ¡è¦æ±‚-2>ä»»åŠ¡è¦æ±‚</a></li><li><a href=#å®éªŒå‡†å¤‡-1>å®éªŒå‡†å¤‡</a></li><li><a href=#æŒä¹…åŒ–å®ç°>æŒä¹…åŒ–å®ç°</a></li><li><a href=#nextindexä¼˜åŒ–>nextIndexä¼˜åŒ–</a></li><li><a href=#è¿è¡Œç»“æœ-2>è¿è¡Œç»“æœ</a></li></ul></li><li><a href=#lab-3d-å¿«ç…§snapshot>Lab-3D-å¿«ç…§Snapshot</a><ul><li><a href=#ä»»åŠ¡è¦æ±‚-3>ä»»åŠ¡è¦æ±‚</a></li><li><a href=#å®ç°å‡†å¤‡æ­¥éª¤-1>å®ç°â€”â€”å‡†å¤‡æ­¥éª¤</a></li><li><a href=#å®ç°æ ¸å¿ƒæ­¥éª¤-1>å®ç°â€”â€”æ ¸å¿ƒæ­¥éª¤</a></li><li><a href=#è¿è¡Œç»“æœ-3>è¿è¡Œç»“æœ</a></li></ul></li><li><a href=#å‚è€ƒ>å‚è€ƒ</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card card-compact bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>ğŸ‘‹ Hi, This is Zheng Yi.</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2025 Bestzy's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'moon', status: 'y' },
    { name: 'sunny', status: 'n' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"zh"}).toFormat("yyyyå¹´MMæœˆddæ—¥")})}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-BR16XEQ6Y4"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-BR16XEQ6Y4")}</script><script type=module src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js></script><script nomodule src=https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js></script></body></html>